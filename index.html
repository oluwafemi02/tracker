<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="app.title">Expense Tracker</title>
    
    <!-- Security Headers -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https:; connect-src 'self' https:;">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">

    <meta http-equiv="X-XSS-Protection" content="1; mode=block">
    <meta name="referrer" content="strict-origin-when-cross-origin">
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Track, manage, and optimize your expenses with smart insights and analytics">
    <meta name="theme-color" content="#6366f1">
    <meta name="color-scheme" content="light dark">
    
    <!-- Apple PWA Meta Tags -->
            <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="ExpenseTracker">
    <meta name="format-detection" content="telephone=no">
    
    <!-- Microsoft PWA Meta Tags -->
    <meta name="msapplication-TileColor" content="#6366f1">
    <meta name="msapplication-tap-highlight" content="no">
    
    <!-- Manifest -->
    <link rel="manifest" href="/tracker/manifest.json">
    
    <!-- Icons -->
    <link rel="icon" type="image/svg+xml" sizes="32x32" href="/tracker/icons/favicon-32x32.svg">
    <link rel="icon" type="image/svg+xml" sizes="16x16" href="/tracker/icons/favicon-16x16.svg">
    <link rel="apple-touch-icon" href="/tracker/icons/apple-touch-icon.svg">
    <link rel="mask-icon" href="/tracker/icons/safari-pinned-tab.svg" color="#6366f1">
    
    <!-- Preconnect for performance -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    
            <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Modern Color Palette - Ocean Blues and Warm Accents */
            --primary-gradient: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            --secondary-gradient: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
            --success-gradient: linear-gradient(135deg, #10b981 0%, #059669 100%);
            --warning-gradient: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            --danger-gradient: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            --dark-gradient: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            --income-gradient: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            --neutral-gradient: linear-gradient(135deg, #64748b 0%, #475569 100%);
            --accent-gradient: linear-gradient(135deg, #ec4899 0%, #be185d 100%);
            --mint-gradient: linear-gradient(135deg, #6ee7b7 0%, #34d399 100%);
            
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --text-light: #94a3b8;
            --text-white: #ffffff;
            --text-accent: #6366f1;
            
            --background: #f8fafc;
            --background-alt: #f1f5f9;
            --card-bg: #ffffff;
            --card-bg-hover: #fefefe;
            --input-bg: #ffffff;
            --border-color: #e2e8f0;
            --border-color-light: #f1f5f9;
            --hover-bg: #f8fafc;
            --active-bg: #f0f4f8;
            
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --shadow-2xl: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            --shadow-inner: inset 0 2px 4px 0 rgba(0, 0, 0, 0.06);
            --shadow-colored: 0 4px 14px 0 rgba(99, 102, 241, 0.15);
            
            --border-radius: 12px;
            --border-radius-lg: 16px;
            --border-radius-xl: 20px;
            --border-radius-2xl: 24px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-fast: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-spring: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--background);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            background-image: 
                radial-gradient(circle at 25% 75%, rgba(99, 102, 241, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 75% 25%, rgba(139, 92, 246, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 50% 50%, rgba(6, 182, 212, 0.04) 0%, transparent 70%);
        }

        .project-subtitle {
            color: var(--text-secondary);
            font-size: 0.95rem;
            font-weight: 400;
            margin: 0.5rem 0 1rem 0;
            line-height: 1.5;
            opacity: 0.9;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .header {
            text-align: center;
            margin-bottom: 3rem;
            position: relative;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 300px;
            height: 300px;
            background: linear-gradient(45deg, rgba(99, 102, 241, 0.12), rgba(139, 92, 246, 0.12));
            border-radius: 50%;
            z-index: -1;
            filter: blur(80px);
            animation: pulse 4s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 0.8;
                transform: translate(-50%, -50%) scale(1);
            }
            50% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1.1);
            }
        }

        h1 {
            font-size: 3.5rem;
            font-weight: 700;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
            letter-spacing: -0.02em;
        }

        .subtitle {
            font-size: 1.2rem;
            color: var(--text-secondary);
            font-weight: 400;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .left-panel {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        .right-panel {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .card {
            background: var(--card-bg);
            border-radius: var(--border-radius-lg);
            padding: 2rem;
            box-shadow: var(--shadow-sm);
            transition: var(--transition-spring);
            border: 1px solid var(--border-color-light);
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--primary-gradient);
            opacity: 0;
            transition: var(--transition);
            border-radius: var(--border-radius-lg) var(--border-radius-lg) 0 0;
        }

        .card:hover::before {
            opacity: 1;
        }

        .card:hover {
            transform: translateY(-6px);
            box-shadow: var(--shadow-xl);
            background: var(--card-bg-hover);
            border-color: var(--border-color);
        }

        .card-enhanced {
            background: linear-gradient(145deg, var(--card-bg) 0%, rgba(255, 255, 255, 0.8) 100%);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: var(--shadow-md);
        }

        .card-enhanced:hover {
            box-shadow: var(--shadow-colored);
            transform: translateY(-8px);
        }

        .card h2 {
            color: var(--text-primary);
            margin-bottom: 1rem;
            font-size: 1.25rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .card-icon {
            font-size: 1.5rem;
        }

        .budget-card {
            background: var(--primary-gradient);
            color: white;
            border: none;
        }

        .budget-card::before {
            background: rgba(255, 255, 255, 0.3);
        }

        .budget-card h2 {
            color: white;
        }

        .budget-progress {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50px;
            height: 12px;
            margin: 1rem 0;
            overflow: hidden;
            position: relative;
        }

        .budget-fill {
            height: 100%;
            background: linear-gradient(90deg, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.7));
            border-radius: 50px;
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .budget-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .budget-warning {
            background: var(--danger-gradient);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        .total-display {
            font-size: 2.5rem;
            font-weight: 700;
            margin: 1rem 0;
            letter-spacing: -0.02em;
        }

        .budget-card .total-display {
            color: white;
        }

        .expense-form {
            background: var(--card-bg);
            padding: 2rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        label {
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        input, select, textarea {
            padding: 1rem;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            transition: var(--transition);
            background: var(--input-bg);
            color: var(--text-primary);
            font-family: inherit;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            padding: 0.875rem 1.75rem;
            border: none;
            border-radius: var(--border-radius);
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition-spring);
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
            background: var(--primary-gradient);
            color: white;
            min-width: 120px;
            justify-content: center;
            position: relative;
            overflow: hidden;
            letter-spacing: 0.025em;
            box-shadow: var(--shadow-sm);
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-lg);
            filter: brightness(1.1);
        }

        .btn:active {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-secondary {
            background: var(--secondary-gradient);
        }

        .btn-danger {
            background: var(--danger-gradient);
        }

        .btn-success {
            background: var(--success-gradient);
        }

        .btn-warning {
            background: var(--warning-gradient);
            color: var(--text-white);
        }

        .btn-accent {
            background: var(--accent-gradient);
        }

        .btn-mint {
            background: var(--mint-gradient);
            color: var(--text-primary);
        }

        .btn-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }

        .expense-list {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 2rem;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
        }

        .expense-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .expense-filters {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        /* Smart Search Styles */
        .search-container {
            position: relative;
            margin-bottom: 1rem;
        }

        .search-input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
            background: white;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 0.75rem;
            transition: var(--transition);
            box-shadow: var(--shadow-sm);
        }

        .search-input-wrapper:focus-within {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .search-icon {
            font-size: 1.2rem;
            margin-right: 0.75rem;
            color: var(--text-secondary);
        }

        #searchInput {
            border: none;
            outline: none;
            flex: 1;
            font-size: 1rem;
            background: transparent;
            padding: 0;
            color: var(--text-primary);
        }

        #searchInput::placeholder {
            color: var(--text-secondary);
            opacity: 0.7;
        }

        #travelSearchInput {
            border: none;
            outline: none;
            flex: 1;
            font-size: 1rem;
            background: transparent;
            padding: 0;
            color: var(--text-primary);
        }

        #travelSearchInput::placeholder {
            color: var(--text-secondary);
            opacity: 0.7;
        }

        #clearSearch {
            background: none;
            border: none;
            font-size: 1rem;
            cursor: pointer;
            color: var(--text-secondary);
            padding: 0.25rem;
            border-radius: 50%;
            transition: var(--transition);
        }

        #clearSearch:hover {
            background: rgba(0, 0, 0, 0.1);
            color: var(--text-primary);
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }

        .search-result-item {
            padding: 0.75rem;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: var(--transition);
            color: var(--text-primary);
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .search-result-item:hover {
            background: var(--hover-bg);
        }

        .search-highlight {
            background: yellow;
            font-weight: 600;
            padding: 0.1rem 0.2rem;
            border-radius: 3px;
        }

        /* View Mode Toggle */
        .view-mode-toggle {
            display: flex;
            background: var(--background);
            border-radius: 12px;
            padding: 0.25rem;
            gap: 0.25rem;
            border: 2px solid var(--border-color);
            margin-bottom: 1rem;
        }

        .view-mode-btn {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            border: none;
            background: transparent;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            transition: var(--transition);
        }

        .view-mode-btn.active {
            background: white;
            color: var(--text-primary);
            box-shadow: var(--shadow-sm);
        }

        .view-mode-btn:hover:not(.active) {
            background: rgba(255, 255, 255, 0.5);
        }

        .view-icon {
            font-size: 1rem;
        }

        /* Pagination Styles */
        .pagination-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
            border-top: 1px solid var(--border-color);
            margin-top: 1rem;
        }

        .pagination-info {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .pagination-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .pagination-controls button {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border-color);
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: var(--transition);
            font-size: 0.9rem;
        }

        .pagination-controls button:hover:not(:disabled) {
            background: var(--hover-bg);
            border-color: #667eea;
        }

        .pagination-controls button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        #pageInfo, #pageInfoBottom {
            font-weight: 500;
            color: var(--text-primary);
            min-width: 100px;
            text-align: center;
        }

        /* Custom Scrollbars */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--background);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 4px;
            transition: var(--transition);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #5a6fd8, #6a4190);
        }

        /* Firefox scrollbars */
        * {
            scrollbar-width: thin;
            scrollbar-color: #667eea var(--background);
        }

        /* Enhanced Animations */
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .expense-item-enhanced {
            animation: slideInUp 0.3s ease-out;
        }

        .search-container {
            animation: fadeInScale 0.3s ease-out;
        }

        .view-mode-toggle {
            animation: fadeInScale 0.3s ease-out 0.1s both;
        }

        /* Responsive Design Enhancements */
        @media (max-width: 768px) {
            .search-input-wrapper {
                padding: 0.5rem;
            }
            
            .view-mode-toggle {
                margin-bottom: 0.75rem;
            }
            
            .view-mode-btn {
                padding: 0.5rem 0.75rem;
                font-size: 0.8rem;
            }
            
            .pagination-container {
                flex-direction: column;
                gap: 1rem;
                padding: 0.75rem 0;
            }
            
            .pagination-controls {
                justify-content: center;
            }
            
            .expense-filters {
                gap: 0.5rem;
            }
            
            .filter-group {
                min-width: 140px;
            }
        }
        @media (max-width: 480px) {
            .search-input-wrapper {
                padding: 0.5rem;
            }
            
            #searchInput {
                font-size: 0.9rem;
            }
            
            .view-mode-btn span:last-child {
                display: none;
            }
            
                         .pagination-controls button {
                 padding: 0.4rem 0.8rem;
                 font-size: 0.8rem;
             }
         }



         /* Keyboard Shortcuts Styles */
         .keyboard-shortcuts {
             display: grid;
             grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
             gap: 0.75rem;
             margin-top: 1rem;
             padding: 1rem;
             background: var(--hover-bg);
             border-radius: var(--border-radius);
             border: 1px solid var(--border-color);
         }

         .shortcut-item {
             display: flex;
             justify-content: space-between;
             align-items: center;
             padding: 0.5rem 0;
         }

         .shortcut-key {
             font-family: 'Courier New', monospace;
             background: var(--card-bg);
             padding: 0.25rem 0.5rem;
             border-radius: 4px;
             border: 1px solid var(--border-color);
             font-size: 0.85rem;
             font-weight: 600;
             color: var(--text-primary);
             min-width: 80px;
             text-align: center;
             box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
         }

                   .shortcut-desc {
              color: var(--text-secondary);
              font-size: 0.9rem;
              margin-left: 1rem;
              flex: 1;
          }

          /* PWA Specific Styles */
          .install-button {
              position: fixed !important;
              bottom: 20px !important;
              right: 20px !important;
              z-index: 1000 !important;
              background: var(--primary-gradient) !important;
              color: white !important;
              border: none !important;
              border-radius: 50px !important;
              padding: 1rem 1.5rem !important;
              font-weight: 600 !important;
              box-shadow: var(--shadow-xl) !important;
              transition: var(--transition) !important;
              cursor: pointer !important;
          }

          .install-button:hover {
              transform: translateY(-2px);
              box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
          }

          @keyframes bounce {
              0%, 20%, 50%, 80%, 100% {
                  transform: translateY(0);
              }
              40% {
                  transform: translateY(-10px);
              }
              60% {
                  transform: translateY(-5px);
              }
          }

          .update-banner {
              position: fixed;
              top: 0;
              left: 0;
              right: 0;
              background: var(--primary-gradient);
              color: white;
              padding: 1rem;
              z-index: 1001;
              box-shadow: var(--shadow-lg);
              animation: slideDown 0.3s ease-out;
          }

          .update-content {
              display: flex;
              align-items: center;
              justify-content: center;
              gap: 1rem;
              max-width: 600px;
              margin: 0 auto;
          }

          .update-content .btn {
              padding: 0.5rem 1rem;
              font-size: 0.9rem;
              min-width: auto;
          }

          @keyframes slideDown {
              from {
                  transform: translateY(-100%);
              }
              to {
                  transform: translateY(0);
              }
          }

          /* PWA Mode specific styles */
          .pwa-mode {
              padding-top: env(safe-area-inset-top);
              padding-bottom: env(safe-area-inset-bottom);
          }

          .pwa-mode .container {
              padding-top: calc(2rem + env(safe-area-inset-top));
              padding-bottom: calc(2rem + env(safe-area-inset-bottom));
          }

          /* Offline indicator */
          .offline-indicator {
              position: fixed;
              top: 0;
              left: 0;
              right: 0;
              background: #ff6b6b;
              color: white;
              padding: 0.5rem;
              text-align: center;
              font-size: 0.9rem;
              z-index: 1000;
              animation: slideDown 0.3s ease-out;
          }

          /* Touch-friendly enhancements for mobile */
          @media (hover: none) and (pointer: coarse) {
              .btn {
                  min-height: 44px;
                  min-width: 44px;
              }
              
              .search-input-wrapper {
                  padding: 1rem;
              }
              
              .view-mode-btn {
                  padding: 1rem;
              }
              
              .pagination-controls button {
                  min-height: 44px;
                  padding: 0.75rem 1rem;
              }
          }

        .filter-group label {
            font-size: 0.8rem;
            margin-bottom: 0;
        }

        .filter-group select {
            padding: 0.5rem;
            font-size: 0.9rem;
            min-width: 120px;
        }

        .expense-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            transition: var(--transition);
            border-radius: 8px;
            margin-bottom: 0.5rem;
        }

        .expense-item:hover {
            background: #f8fafc;
            transform: translateX(4px);
            box-shadow: var(--shadow-sm);
        }

        .expense-item:last-child {
            border-bottom: none;
        }

        .expense-details {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .expense-main {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .expense-category-icon {
            font-size: 1.5rem;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: linear-gradient(45deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
        }

        .expense-amount {
            font-size: 1.4rem;
            font-weight: 700;
            color: #e74c3c;
        }

        .expense-meta {
            color: var(--text-secondary);
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .expense-actions {
            display: flex;
            gap: 0.5rem;
        }

        .expense-actions .btn {
            padding: 0.5rem 1rem;
            font-size: 0.8rem;
            min-width: auto;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin: 1rem 0;
        }

        .settings-panel {
            background: var(--card-bg);
            padding: 2rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
        }

        .settings-grid {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 1rem;
            align-items: end;
        }

        /* Subscription Section Styles */
        .subscription-section {
            margin-bottom: 2rem;
        }

        .subscription-section h3 {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
            font-size: 1.25rem;
            color: var(--text-primary);
        }

        .section-icon {
            font-size: 1.5rem;
        }

        .plan-status-card {
            background: var(--bg-secondary);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            border: 2px solid var(--border-color);
            position: relative;
            overflow: hidden;
        }

        .plan-status-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-color) 0%, var(--accent-color) 100%);
        }

        .plan-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .plan-badge {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            background: var(--bg-primary);
            border-radius: 50px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
        }

        .plan-badge.premium {
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            border: none;
            color: #333;
        }

        .plan-badge.trial {
            background: linear-gradient(135deg, #4caf50 0%, #8bc34a 100%);
            border: none;
            color: white;
        }

        .plan-icon {
            font-size: 1.25rem;
        }

        .plan-name {
            font-weight: 600;
            font-size: 1.1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .plan-validity {
            text-align: right;
        }

        .validity-label {
            display: block;
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
        }

        .validity-date {
            font-weight: 600;
            color: var(--text-primary);
        }

        .plan-details {
            margin-bottom: 1.5rem;
        }

        .plan-feature-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .plan-feature {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            background: var(--bg-primary);
            border-radius: var(--border-radius);
            font-size: 0.9rem;
        }

        .feature-icon {
            color: #4caf50;
        }

        .feature-icon.disabled {
            color: #999;
        }

        .plan-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            padding: 1rem;
            background: var(--bg-primary);
            border-radius: var(--border-radius);
        }

        .stat-item {
            text-align: center;
        }

        .stat-label {
            display: block;
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .plan-actions {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .plan-actions .btn {
            flex: 1;
            min-width: 150px;
        }

        .section-divider {
            margin: 2rem 0;
            border: none;
            border-top: 1px solid var(--border-color);
        }

        /* Subscription section responsive */
        @media (max-width: 768px) {
            .plan-header {
                flex-direction: column;
                text-align: center;
            }
            
            .plan-validity {
                text-align: center;
            }
            
            .plan-feature-list {
                grid-template-columns: 1fr;
            }
            
            .plan-stats {
                grid-template-columns: 1fr;
            }
            
            .plan-actions {
                flex-direction: column;
            }
            
            .plan-actions .btn {
                width: 100%;
            }
        }

        .no-expenses {
            text-align: center;
            color: var(--text-secondary);
            font-style: italic;
            padding: 3rem;
            background: #f8fafc;
            border-radius: 8px;
            border: 2px dashed var(--border-color);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--card-bg);
            padding: 1.5rem;
            border-radius: var(--border-radius);
            text-align: center;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            transform: translateX(100%);
            transition: var(--transition);
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: var(--success-gradient);
        }

        .notification.error {
            background: var(--danger-gradient);
        }

        .quick-actions {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .quick-action {
            background: var(--card-bg);
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .quick-action:hover {
            background: #f8fafc;
            transform: translateY(-2px);
        }

        /* Enhanced Dashboard Design */
        .dashboard-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--accent-color) 100%);
            color: white;
            padding: 2rem;
            border-radius: var(--border-radius);
            margin-bottom: 2rem;
            box-shadow: var(--shadow-lg);
        }

        .dashboard-title {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin: 0 0 1.5rem 0;
            font-size: 2rem;
            font-weight: 700;
        }

        .title-icon {
            font-size: 2.5rem;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
        }

        .dashboard-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .date-selector-group {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .custom-date-selector {
            display: flex;
            align-items: center;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50px;
            padding: 0.25rem;
            backdrop-filter: blur(10px);
        }

        .date-nav-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background: rgba(255, 255, 255, 0.3);
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .date-nav-btn:hover {
            background: rgba(255, 255, 255, 0.4);
            transform: scale(1.1);
        }

        .date-display {
            padding: 0 2rem;
            min-width: 200px;
            text-align: center;
        }

        .period-label {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .period-select {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 25px;
            font-size: 1rem;
            cursor: pointer;
            backdrop-filter: blur(10px);
        }

        .period-select option {
            background: var(--primary-color);
            color: white;
        }

        .dashboard-actions {
            display: flex;
            gap: 0.5rem;
        }

        .action-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .action-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(180deg);
        }

        /* Metrics Summary */
        .metrics-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .metric-card {
            background: var(--bg-primary);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .metric-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }

        .metric-card.primary {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--accent-color) 100%);
            color: white;
            border: none;
        }

        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, transparent 0%, rgba(255,255,255,0.1) 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .metric-card:hover::before {
            opacity: 1;
        }

        .metric-icon {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
        }

        .metric-content {
            position: relative;
            z-index: 1;
        }

        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .metric-label {
            font-size: 0.9rem;
            opacity: 0.8;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .metric-change {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }

        .change-arrow {
            font-size: 1.2rem;
        }

        .metric-change.positive {
            color: #4caf50;
        }

        .metric-change.negative {
            color: #f44336;
        }

        .metric-progress {
            margin-top: 0.75rem;
            height: 8px;
            background: rgba(0,0,0,0.1);
            border-radius: 4px;
            overflow: hidden;
        }

        .metric-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #4caf50 0%, #8bc34a 100%);
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .metric-subtitle {
            font-size: 0.85rem;
            opacity: 0.7;
            margin-top: 0.25rem;
        }

        .analytics-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 2rem;
            margin: 2rem 0;
        }

        .cash-flow-container {
            padding: 1.5rem;
        }

        .cash-flow-item {
            margin-bottom: 1.5rem;
        }

        .flow-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .flow-amount {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .flow-bar {
            height: 20px;
            background: var(--bg-secondary);
            border-radius: 10px;
            overflow: hidden;
        }

        .flow-fill {
            height: 100%;
            border-radius: 10px;
            transition: width 0.5s ease;
        }

        .inflow-fill {
            background: linear-gradient(135deg, #4caf50, #66bb6a);
        }

        .outflow-fill {
            background: linear-gradient(135deg, #f44336, #ef5350);
        }

        .cash-flow-balance {
            margin-top: 2rem;
            padding: 1.5rem;
            background: var(--bg-secondary);
            border-radius: var(--border-radius);
            text-align: center;
        }

        .balance-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .balance-amount {
            font-size: 2rem;
            font-weight: 700;
        }

        .smart-insights-section {
            margin: 2rem 0;
            padding: 2rem;
            background: var(--bg-secondary);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-sm);
        }

        .insights-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
        }

        .insights-icon {
            font-size: 1.8rem;
        }

        .insights-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1rem;
        }

        .insight-card {
            padding: 1.25rem;
            background: var(--bg-primary);
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .insight-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .insight-type {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }

        .insight-icon {
            font-size: 1.5rem;
        }

        .insight-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .insight-content {
            font-size: 1rem;
            line-height: 1.5;
            color: var(--text-primary);
        }

        .insight-value {
            font-weight: 600;
            color: var(--primary-color);
        }

        .insight-positive {
            color: #4caf50;
        }

        .insight-negative {
            color: #f44336;
        }

        .insight-neutral {
            color: #ff9800;
        }

        /* Dashboard Enhancement Responsive */
        @media (max-width: 768px) {
            .dashboard-header {
                padding: 1.5rem;
            }
            
            .dashboard-title {
                font-size: 1.5rem;
            }
            
            .dashboard-controls {
                flex-direction: column;
                gap: 1rem;
            }
            
            .date-selector-group {
                flex-direction: column;
                width: 100%;
            }
            
            .custom-date-selector {
                width: 100%;
                justify-content: space-between;
            }
            
            .date-display {
                flex: 1;
                padding: 0 1rem;
            }
            
            .metrics-summary {
                grid-template-columns: 1fr;
            }
            
            .metric-card {
                padding: 1.25rem;
            }
            
            .metric-value {
                font-size: 1.75rem;
            }
            
            .analytics-section {
                grid-template-columns: 1fr;
            }
            
            .insights-grid {
                grid-template-columns: 1fr;
            }
            
            .smart-insights-section {
                padding: 1rem;
            }
            
            .cash-flow-container {
                padding: 1rem;
            }
            
            .flow-amount {
                font-size: 1.25rem;
            }
            
            .balance-amount {
                font-size: 1.5rem;
            }
        }

        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
            
            .right-panel {
                order: -1;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            h1 {
                font-size: 2.5rem;
            }
            
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .settings-grid {
                grid-template-columns: 1fr;
            }
            
            .expense-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }
            
            .expense-actions {
                width: 100%;
                justify-content: flex-end;
            }
            
            .expense-filters {
                flex-direction: column;
                width: 100%;
            }
            
            .expense-list-header {
                flex-direction: column;
                align-items: stretch;
            }
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Enhanced Animations */
        .bounce-in {
            animation: bounceIn 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        /* Toggle Switch Styling */
        .toggle-switch {
            position: relative;
            display: inline-block;
        }

        .toggle-input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-label {
            display: block;
            width: 50px;
            height: 28px;
            background-color: #ccc;
            border-radius: 14px;
            cursor: pointer;
            position: relative;
            transition: background-color 0.3s ease;
        }

        .toggle-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 24px;
            height: 24px;
            background-color: white;
            border-radius: 50%;
            transition: transform 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .toggle-input:checked + .toggle-label {
            background-color: #667eea;
        }

        .toggle-input:checked + .toggle-label .toggle-slider {
            transform: translateX(22px);
        }

        .toggle-label:hover {
            opacity: 0.8;
        }

        .toggle-container {
            transition: all 0.2s ease;
        }

        .toggle-container:hover {
            background: var(--card-bg) !important;
        }

        /* Inline toggle functionality */
        #mainBudgetToggle:checked + span {
            background-color: #4285f4 !important;
        }

        #mainBudgetToggle:checked + span span {
            transform: translateX(26px) !important;
        }

        /* Recurring expense toggle functionality */
        #isRecurring:checked + .recurring-toggle-slider {
            background-color: #4285f4 !important;
        }

        #isRecurring:checked + .recurring-toggle-slider span {
            transform: translateX(22px) !important;
        }

        /* Fixed cost toggle functionality */
        #isFixedCost:checked + .fixed-cost-toggle-slider {
            background-color: #4CAF50 !important;
        }

        #isFixedCost:checked + .fixed-cost-toggle-slider span {
            transform: translateX(22px) !important;
        }

        #isFixedCost:not(:checked) + .fixed-cost-toggle-slider {
            background-color: #ccc !important;
        }

        #isFixedCost:not(:checked) + .fixed-cost-toggle-slider span {
            transform: translateX(0) !important;
        }

        /* Dark mode toggle functionality */
        #darkModeToggle:checked + .dark-mode-toggle-slider {
            background-color: #4285f4 !important;
        }

        #darkModeToggle:checked + .dark-mode-toggle-slider span {
            transform: translateX(22px) !important;
        }

        @keyframes bounceIn {
            0% { transform: scale(0.3) rotate(-5deg); opacity: 0; }
            50% { transform: scale(1.05) rotate(2deg); }
            70% { transform: scale(0.9) rotate(-1deg); }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }

        .slide-in-right {
            animation: slideInRight 0.4s ease-out;
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Enhanced Card Styles */
        .card-enhanced {
            background: var(--card-bg);
            border-radius: var(--border-radius-lg);
            padding: 2rem;
            box-shadow: var(--shadow-md);
            transition: var(--transition);
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        .card-enhanced::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--primary-gradient);
            opacity: 0;
            transition: var(--transition);
        }

        .card-enhanced:hover::before {
            opacity: 1;
        }

        .card-enhanced:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: var(--shadow-xl);
        }

        /* Modern Toggle Switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--border-color);
            transition: var(--transition);
            border-radius: 30px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background: white;
            transition: var(--transition);
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        input:checked + .toggle-slider {
            background: var(--primary-gradient);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(30px);
        }

        /* Enhanced Progress Bar */
        .progress-container {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50px;
            height: 16px;
            margin: 1rem 0;
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-inner);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.7));
            border-radius: 50px;
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 8px;
        }

        .progress-text {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.9);
            padding: 2px 6px;
            border-radius: 10px;
            margin-right: 4px;
        }

        /* Modern Input Styles */
        .input-group {
            position: relative;
            margin-bottom: 1.5rem;
        }

        .input-group input,
        .input-group select {
            width: 100%;
            padding: 1rem 1rem 1rem 3rem;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: var(--transition);
            background: var(--input-bg);
            color: var(--text-primary);
            font-family: inherit;
        }

        .input-group input:focus,
        .input-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            transform: translateY(-2px);
        }

        .input-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.2rem;
            color: var(--text-secondary);
            z-index: 10;
        }

        /* Enhanced Expense Item */
        .expense-item-enhanced {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            margin-bottom: 1rem;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .expense-item-enhanced::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: var(--primary-gradient);
            transform: scaleY(0);
            transition: var(--transition);
        }

        .expense-item-enhanced:hover::before {
            transform: scaleY(1);
        }

        .expense-item-enhanced:hover {
            background: var(--hover-bg);
            transform: translateX(8px);
            box-shadow: var(--shadow-md);
        }

        /* Floating Action Button */
        .fab {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--primary-gradient);
            color: white;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: var(--shadow-lg);
            transition: var(--transition);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .fab:hover {
            transform: scale(1.1) rotate(90deg);
            box-shadow: var(--shadow-xl);
        }

        /* Enhanced Statistics Cards */
        .stat-card-enhanced {
            background: var(--card-bg);
            padding: 2rem;
            border-radius: var(--border-radius-lg);
            text-align: center;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .stat-card-enhanced::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--primary-gradient);
            opacity: 0;
            transition: var(--transition);
            z-index: 1;
        }

        .stat-card-enhanced:hover::before {
            opacity: 0.05;
        }

        .stat-card-enhanced:hover {
            transform: translateY(-4px) scale(1.05);
            box-shadow: var(--shadow-lg);
        }

        .stat-card-enhanced > * {
            position: relative;
            z-index: 2;
        }

        .stat-icon {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            display: block;
        }
        /* Dark Mode Support */
        .dark-mode {
            --background: #1a202c;
            --background-alt: #2d3748;
            --card-bg: #2d3748;
            --text-primary: #f7fafc;
            --text-secondary: #a0aec0;
            --border-color: #4a5568;
            --hover-bg: #4a5568;
            --input-bg: #374151;
            --shadow: rgba(0, 0, 0, 0.2);
        }
        
        /* Fix text visibility in dark mode */
        .dark-mode input,
        .dark-mode textarea,
        .dark-mode select {
            background-color: var(--input-bg);
            color: var(--text-primary);
            border-color: var(--border-color);
        }
        
        .dark-mode input::placeholder,
        .dark-mode textarea::placeholder {
            color: var(--text-secondary);
            opacity: 0.7;
        }
        
        .dark-mode .search-input-wrapper {
            background-color: var(--input-bg);
        }
        
        .dark-mode #searchInput {
            color: var(--text-primary);
        }
        
        .dark-mode .modal-content {
            background-color: var(--card-bg);
            color: var(--text-primary);
        }
        
        .dark-mode .modal-content h2,
        .dark-mode .modal-content h3,
        .dark-mode .modal-content p {
            color: var(--text-primary);
        }
        
        .dark-mode .modal-content label {
            color: var(--text-secondary);
        }
        
        /* Additional dark mode fixes for better text visibility */
        .dark-mode .expense-item,
        .dark-mode .transaction-item {
            background-color: var(--card-bg);
            color: var(--text-primary);
        }
        
        .dark-mode .expense-item:hover,
        .dark-mode .transaction-item:hover {
            background-color: var(--hover-bg);
        }
        
        .dark-mode .expense-category,
        .dark-mode .expense-amount,
        .dark-mode .expense-date,
        .dark-mode .expense-description {
            color: var(--text-primary);
        }
        
        .dark-mode .search-results {
            background-color: var(--card-bg);
            border-color: var(--border-color);
        }
        
        .dark-mode .search-result-item {
            color: var(--text-primary);
        }
        
        .dark-mode .search-result-item:hover {
            background-color: var(--hover-bg);
        }
        
        .dark-mode .input-icon {
            color: var(--text-secondary);
        }
        
        .dark-mode .btn {
            background-color: var(--card-bg);
            color: var(--text-primary);
            border-color: var(--border-color);
        }
        
        .dark-mode .btn:hover {
            background-color: var(--hover-bg);
        }
        
        .dark-mode .btn-primary {
            background: var(--primary-gradient);
            color: white;
            border: none;
        }
        
        .dark-mode .section-header h2,
        .dark-mode .section-header p {
            color: var(--text-primary);
        }
        
        .dark-mode .stat-card {
            background-color: var(--card-bg);
        }
        
        .dark-mode .stat-value,
        .dark-mode .stat-label {
            color: var(--text-primary);
        }
        
        .dark-mode .budget-card {
            background-color: var(--card-bg);
        }
        
        .dark-mode .budget-name,
        .dark-mode .budget-amount {
            color: var(--text-primary);
        }
        
        .dark-mode .tab-content h2,
        .dark-mode .tab-content h3,
        .dark-mode .tab-content p {
            color: var(--text-primary);
        }
        
        .dark-mode .empty-state {
            color: var(--text-secondary);
        }
        
        .dark-mode .notification {
            background-color: var(--card-bg);
            color: var(--text-primary);
            border-color: var(--border-color);
        }

        /* Modern Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
        }

        .modal-content {
            background: var(--card-bg);
            margin: 5% auto;
            padding: 2rem;
            border-radius: var(--border-radius-xl);
            width: 90%;
            max-width: 600px;
            max-height: 85vh;
            box-shadow: var(--shadow-xl);
            animation: modalFadeIn 0.3s ease-out;
            overflow-y: auto;
            position: relative;
        }

        @keyframes modalFadeIn {
            from { opacity: 0; transform: scale(0.8) translateY(-50px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        /* Recurring Expense Styles */
        .recurring-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 999px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-left: 0.5rem;
            box-shadow: 0 2px 4px rgba(102, 126, 234, 0.3);
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }
        
        .recurring-indicator:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.4);
        }
        
        /* Fixed Cost Indicator Styles */
        .fixed-cost-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 0.3rem 0.85rem;
            border-radius: 999px;
            font-size: 0.85rem;
            font-weight: 700;
            margin-left: 0.5rem;
            box-shadow: 0 3px 6px rgba(16, 185, 129, 0.3);
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
            letter-spacing: 0.025em;
        }
        
        .fixed-cost-indicator::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent 30%, rgba(255, 255, 255, 0.2) 50%, transparent 70%);
            transform: rotate(45deg) translateX(-100%);
            transition: transform 0.6s ease;
        }
        
        .fixed-cost-indicator:hover {
            transform: translateY(-1px) scale(1.02);
            box-shadow: 0 5px 10px rgba(16, 185, 129, 0.4);
        }
        
        .fixed-cost-indicator:hover::before {
            transform: rotate(45deg) translateX(100%);
        }
        
        /* Dark mode adjustments */
        @media (prefers-color-scheme: dark) {
            :root {
                --primary-color: #6b5b95;
                --accent-color: #8b7bb9;
            }
            
            .dashboard-header {
                background: linear-gradient(135deg, #4a4a4a 0%, #2d2d2d 100%);
            }
            
            .custom-date-selector {
                background: rgba(255, 255, 255, 0.1);
            }
            
            .date-nav-btn {
                background: rgba(255, 255, 255, 0.1);
            }
            
            .date-nav-btn:hover {
                background: rgba(255, 255, 255, 0.2);
            }
            
            .period-select {
                background: rgba(255, 255, 255, 0.1);
                border-color: rgba(255, 255, 255, 0.2);
            }
            
            .action-btn {
                background: rgba(255, 255, 255, 0.1);
            }
            
            .action-btn:hover {
                background: rgba(255, 255, 255, 0.2);
            }
            
            .metric-card {
                background: #2d2d2d;
                border-color: #404040;
            }
            
            .metric-card.primary {
                background: linear-gradient(135deg, #4a4a4a 0%, #2d2d2d 100%);
            }
            
            .metric-progress {
                background: rgba(255, 255, 255, 0.1);
            }
            
            .smart-insights-section {
                background: #1a1a1a;
            }
            
            .insight-card {
                background: #2d2d2d;
                border-color: #404040;
            }
            
            .cash-flow-balance {
                background: #2d2d2d;
            }
            
            .flow-bar {
                background: #1a1a1a;
            }
        }

        @media (prefers-color-scheme: dark) {
            .recurring-indicator {
                background: linear-gradient(135deg, #7c3aed 0%, #a855f7 100%);
                box-shadow: 0 2px 4px rgba(124, 58, 237, 0.4);
            }
            
            .recurring-indicator:hover {
                box-shadow: 0 4px 8px rgba(168, 85, 247, 0.5);
            }
            
            .fixed-cost-indicator {
                background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
                box-shadow: 0 3px 6px rgba(52, 211, 153, 0.4);
            }
            
            .fixed-cost-indicator:hover {
                box-shadow: 0 5px 10px rgba(52, 211, 153, 0.5);
            }
        }

        /* Recurring Modal Specific Styles */
        #recurringContent {
            max-height: 60vh;
            overflow-y: auto;
            padding-right: 0.5rem;
        }

        #recurringList {
            max-height: 40vh;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 1rem;
            background: var(--bg-secondary);
            margin-top: 1rem;
        }

        .recurring-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            background: var(--card-bg);
            margin-bottom: 0.75rem;
            transition: all 0.2s ease;
        }

        .recurring-item:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .recurring-item:last-child {
            margin-bottom: 0;
        }

        .recurring-details {
            flex: 1;
        }

        .recurring-details h4 {
            margin: 0 0 0.25rem 0;
            color: var(--text-primary);
            font-size: 1rem;
        }

        .recurring-details p {
            margin: 0;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .recurring-amount {
            font-weight: 600;
            color: var(--primary-color);
            font-size: 1.1rem;
            margin-right: 1rem;
        }

        /* Mobile responsive for recurring modal */
        @media (max-width: 768px) {
            .modal-content {
                margin: 2% auto;
                padding: 1.5rem;
                width: 95%;
                max-height: 90vh;
            }

            #recurringContent {
                max-height: 70vh;
            }

            #recurringList {
                max-height: 50vh;
            }

            .recurring-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }

            .recurring-amount {
                margin-right: 0;
                align-self: flex-end;
            }
        }

        /* Interactive Guide Styles */
        .guide-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
            animation: guideOverlayFadeIn 0.3s ease-out;
        }

        .guide-content {
            background: var(--card-bg);
            border-radius: var(--border-radius-xl);
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            box-shadow: var(--shadow-xl);
            position: relative;
            animation: guideContentSlideUp 0.4s ease-out;
        }

        .guide-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .guide-header h2 {
            margin: 0;
            color: var(--text-primary);
            font-size: 1.5rem;
        }

        .guide-close {
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 50%;
            transition: all 0.2s ease;
            color: var(--text-secondary);
        }

        .guide-close:hover {
            background: var(--hover-bg);
            color: var(--text-primary);
        }

        .guide-body {
            margin-bottom: 2rem;
        }

        #guideText {
            min-height: 120px;
            margin-bottom: 1.5rem;
            line-height: 1.6;
            color: var(--text-primary);
        }

        #guideText h3 {
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }

        #guideText ul {
            margin: 1rem 0;
            padding-left: 1.5rem;
        }

        #guideText li {
            margin-bottom: 0.5rem;
        }

        .guide-progress {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .progress-bar {
            flex: 1;
            height: 8px;
            background: var(--bg-secondary);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary-gradient);
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            font-size: 0.9rem;
            color: var(--text-secondary);
            white-space: nowrap;
        }

        .guide-footer {
            display: flex;
            gap: 1rem;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .guide-spotlight {
            position: absolute;
            border: 3px solid var(--primary-color);
            border-radius: var(--border-radius);
            background: rgba(102, 126, 234, 0.1);
            pointer-events: none;
            z-index: 10000;
            opacity: 0;
            transition: all 0.3s ease;
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.5);
        }

        .guide-spotlight.active {
            opacity: 1;
            animation: guideSpotlightPulse 2s infinite;
        }

        @keyframes guideOverlayFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes guideContentSlideUp {
            from { opacity: 0; transform: translateY(50px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes guideSpotlightPulse {
            0%, 100% { transform: scale(1); box-shadow: 0 0 20px rgba(102, 126, 234, 0.5); }
            50% { transform: scale(1.05); box-shadow: 0 0 30px rgba(102, 126, 234, 0.8); }
        }

        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(100%); }
            to { opacity: 1; transform: translateX(0); }
        }

        /* Mobile responsive for guide */
        @media (max-width: 768px) {
            .guide-content {
                padding: 1.5rem;
                max-width: 95%;
            }

            .guide-header h2 {
                font-size: 1.3rem;
            }

            .guide-footer {
                gap: 0.5rem;
            }

            .guide-footer .btn {
                font-size: 0.9rem;
                padding: 0.5rem 1rem;
            }
        }

        /* Travel Tracker Styles */
        .travel-tracker {
            padding: 1rem;
            max-width: 1400px;
            margin: 0 auto;
        }

        .trip-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2.5rem;
            border-radius: 20px;
            margin-bottom: 2rem;
            position: relative;
            overflow: hidden;
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.2);
        }

        .trip-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 20%, rgba(255, 255, 255, 0.2) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(255, 255, 255, 0.1) 0%, transparent 50%);
            animation: float 6s ease-in-out infinite;
            pointer-events: none;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        .trip-info {
            position: relative;
            z-index: 1;
        }

        .trip-info h2 {
            margin: 0 0 1rem 0;
            font-size: 1.8rem;
            font-weight: 600;
        }

        .trip-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .current-trip {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
            justify-content: space-between;
            width: 100%;
        }

        .trip-action-buttons {
            display: flex;
            gap: 0.75rem;
            align-items: center;
            flex-wrap: wrap;
        }

        #tripName {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .trip-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .trip-stat-card {
            background: rgba(255, 255, 255, 0.15);
            padding: 1rem;
            border-radius: var(--border-radius);
            text-align: center;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .trip-stat-icon {
            font-size: 1.5rem;
            display: block;
            margin-bottom: 0.5rem;
        }

        .trip-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .trip-stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .travel-quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .travel-action {
            background: var(--card-bg);
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }

        .travel-action:hover {
            background: var(--primary-gradient);
            color: white;
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .travel-action span:first-child {
            font-size: 1.5rem;
        }

        .travel-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        .travel-form-panel, .travel-list-panel {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .travel-expense-form {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-xl);
            padding: 1.5rem;
            box-shadow: var(--shadow-md);
        }

        .travel-breakdown {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-xl);
            padding: 1.5rem;
            box-shadow: var(--shadow-md);
        }

        .category-breakdown {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .category-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            background: var(--bg-secondary);
            border-radius: var(--border-radius);
            border-left: 4px solid var(--primary-color);
        }

        .category-item-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .category-amount {
            font-weight: 600;
            color: var(--primary-color);
        }

        .travel-expense-list {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-xl);
            padding: 1.5rem;
            box-shadow: var(--shadow-md);
            height: fit-content;
        }

        .travel-list-header h3 {
            margin: 0 0 1rem 0;
        }

        .travel-filters {
            display: flex;
            gap: 1rem;
            align-items: flex-end;
            flex-wrap: wrap;
            margin-top: 1rem;
        }

        .travel-expense-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            background: var(--bg-secondary);
            margin-bottom: 0.75rem;
            transition: all 0.2s ease;
        }

        .travel-expense-item:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .travel-expense-details {
            flex: 1;
        }

        .travel-expense-details h4 {
            margin: 0 0 0.25rem 0;
            color: var(--text-primary);
            font-size: 1rem;
        }

        .travel-expense-details p {
            margin: 0;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .travel-expense-amount {
            font-weight: 600;
            color: var(--primary-color);
            font-size: 1.1rem;
            margin-right: 1rem;
        }

        .travel-expense-actions {
            display: flex;
            gap: 0.5rem;
        }

        /* Trip Management Modal Styles */
        .trip-form-section, .existing-trips-section {
            background: var(--bg-secondary);
            padding: 1.5rem;
            border-radius: var(--border-radius);
            margin-bottom: 1.5rem;
        }

        .trip-form-section h3, .existing-trips-section h3 {
            margin: 0 0 1rem 0;
            color: var(--primary-color);
        }

        .trip-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            background: linear-gradient(145deg, var(--card-bg) 0%, rgba(255, 255, 255, 0.9) 100%);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            margin-bottom: 1rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .trip-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }

        .trip-item:hover {
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            transform: translateY(-4px) scale(1.02);
            border-color: var(--primary);
        }

        .trip-item:hover::before {
            left: 100%;
        }

        .trip-item-info h4 {
            margin: 0 0 0.5rem 0;
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .trip-item-info p {
            margin: 0 0 0.5rem 0;
            color: var(--text-secondary);
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .trip-item-actions {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .trip-item-actions .btn {
            min-width: auto;
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .trip-item-actions .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .no-trips {
            text-align: center;
            color: var(--text-secondary);
            font-style: italic;
            padding: 3rem 2rem;
            background: linear-gradient(145deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);
            border: 2px dashed var(--border-color);
            border-radius: 16px;
            font-size: 1.1rem;
            margin: 1rem 0;
        }

        /* Your Trips Section */
        .your-trips-section {
            margin-top: 2rem;
            padding: 1.5rem;
            background: var(--card-bg);
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .trips-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border-color);
        }

        .trips-header h3 {
            margin: 0;
            color: var(--text-primary);
            font-size: 1.3rem;
            font-weight: 600;
        }

        .trips-list-container {
            max-height: 600px;
            overflow-y: auto;
            padding-right: 0.5rem;
        }

        .trips-list-container::-webkit-scrollbar {
            width: 6px;
        }

        .trips-list-container::-webkit-scrollbar-track {
            background: var(--bg-secondary);
            border-radius: 3px;
        }

        .trips-list-container::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 3px;
        }

        /* Sync Interface Styles */
        .sync-status-card {
            background: linear-gradient(145deg, var(--card-bg) 0%, rgba(102, 126, 234, 0.05) 100%);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
        }

        .sync-status-info h4 {
            margin: 0 0 0.5rem 0;
            color: var(--text-primary);
            font-size: 1.1rem;
        }

        .sync-status-info p {
            margin: 0 0 0.25rem 0;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .sync-status-info small {
            color: var(--text-secondary);
            font-size: 0.8rem;
        }

        .sync-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .sync-option {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            transition: var(--transition);
        }

        .sync-option:hover {
            border-color: var(--primary);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
        }

        .sync-option button {
            width: 100%;
            margin-bottom: 0.5rem;
        }

        .sync-option span {
            font-size: 0.85rem;
            color: var(--text-secondary);
            line-height: 1.3;
        }

        .sync-connected {
            border-color: var(--success) !important;
            background: linear-gradient(145deg, var(--card-bg) 0%, rgba(76, 175, 80, 0.05) 100%) !important;
        }

        .sync-error {
            border-color: var(--danger) !important;
            background: linear-gradient(145deg, var(--card-bg) 0%, rgba(244, 67, 54, 0.05) 100%) !important;
        }
        .sync-option-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin: 1.5rem 0;
        }

        .sync-provider-card {
            background: var(--card-bg);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .sync-provider-card:hover {
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
            transform: translateY(-2px);
        }

        .sync-provider-card h3 {
            margin: 0 0 1rem 0;
            color: var(--text-primary);
        }

        .sync-provider-card p {
            margin: 0 0 1rem 0;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .sync-provider-card ul {
            text-align: left;
            margin: 1rem 0;
            padding-left: 1.5rem;
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .sync-provider-card ul li {
            margin-bottom: 0.25rem;
        }

        .sync-provider-card button {
            width: 100%;
            margin-top: 1rem;
        }

        .trip-status {
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .trip-status.active {
            background: var(--success-gradient);
            color: white;
        }

        .trip-status.completed {
            background: var(--neutral-gradient);
            color: white;
        }

        .trip-status.upcoming {
            background: var(--warning-gradient);
            color: var(--text-primary);
        }

        .trip-status.ongoing {
            background: var(--success-gradient);
            color: white;
            animation: pulse 2s infinite;
        }

        /* Mobile responsive for travel tracker */
        @media (max-width: 768px) {
            .travel-grid {
                grid-template-columns: 1fr;
            }

            .trip-stats {
                grid-template-columns: repeat(2, 1fr);
            }

            .travel-quick-actions {
                grid-template-columns: repeat(3, 1fr);
            }

            .travel-filters {
                flex-direction: column;
                align-items: stretch;
            }

            .travel-expense-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }

            .travel-expense-amount {
                margin-right: 0;
                align-self: flex-end;
            }

            .trips-header {
                flex-direction: column;
                gap: 1rem;
                align-items: stretch;
            }

            .trips-header h3 {
                text-align: center;
            }

            .trip-item {
                flex-direction: column;
                gap: 1rem;
                align-items: stretch;
            }

            .trip-item-actions {
                justify-content: center;
            }
        }



        .recurring-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .recurring-frequency {
            background: var(--primary-gradient);
            color: white;
            padding: 0.2rem 0.6rem;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        /* Upcoming Recurring Expenses Widget */
        .upcoming-recurring-container {
            max-height: 300px;
            overflow-y: auto;
        }

        .upcoming-recurring-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            background: var(--hover-bg);
            border-radius: var(--border-radius);
            border-left: 4px solid var(--primary-gradient);
            transition: var(--transition);
        }

        .upcoming-recurring-item:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .upcoming-recurring-item:last-child {
            margin-bottom: 0;
        }

        .upcoming-recurring-info {
            flex: 1;
        }

        .upcoming-recurring-title {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
            font-size: 0.9rem;
        }

        .upcoming-recurring-date {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .upcoming-recurring-amount {
            font-weight: 600;
            color: var(--danger-gradient);
            font-size: 1rem;
        }

        .upcoming-recurring-due-soon {
            border-left-color: #f59e0b;
        }

        .upcoming-recurring-overdue {
            border-left-color: #ef4444;
            background: rgba(239, 68, 68, 0.05);
        }

        /* Projection Modal Styles */
        .projection-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
        }

        .projection-summary {
            background: var(--hover-bg);
            border-radius: var(--border-radius);
            padding: 1.5rem;
        }

        .projection-insights {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 1.5rem;
        }

        /* Spent Breakdown Modal Styles */
        .expense-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            transition: var(--transition);
        }

        .expense-item:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .expense-info {
            flex: 1;
            margin-right: 1rem;
        }

        .expense-description {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .expense-details {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .expense-amount {
            font-weight: 600;
            color: var(--danger-color);
            font-size: 1.1rem;
        }

        .category-summary {
            background: var(--hover-bg);
            border-radius: var(--border-radius);
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .category-row {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border-color-light);
        }

        .category-row:last-child {
            border-bottom: none;
        }

        .recurring-expense-item {
            background: rgba(99, 102, 241, 0.1);
            border-left: 4px solid var(--primary-color);
        }

        /* Remaining Breakdown Modal Styles */
        .remaining-section {
            margin-bottom: 1.5rem;
        }

        .remaining-section h3 {
            margin-bottom: 1rem;
            color: var(--text-primary);
        }

        .budget-breakdown {
            background: var(--hover-bg);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin-bottom: 1rem;
        }

        /* Expense Details Modal Styles */
        .expense-summary {
            background: var(--hover-bg);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .summary-stats {
            display: grid;
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .summary-stat {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border-color-light);
        }

        .summary-stat:last-child {
            border-bottom: none;
        }

        .summary-label {
            color: var(--text-secondary);
            font-weight: 500;
        }

        .summary-value {
            color: var(--text-primary);
            font-weight: 600;
        }

        .category-section {
            margin-bottom: 1.5rem;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            background: var(--card-bg);
        }

        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: var(--hover-bg);
            border-bottom: 1px solid var(--border-color);
            border-radius: var(--border-radius) var(--border-radius) 0 0;
        }

        .category-header h4 {
            margin: 0;
            color: var(--text-primary);
            font-size: 1.1rem;
        }

        .category-total {
            font-weight: 600;
            color: var(--primary-color);
            font-size: 1rem;
        }

        .category-expenses {
            padding: 0;
        }

        .expense-detail-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border-color-light);
            transition: var(--transition);
        }

        .expense-detail-item:hover {
            background: var(--hover-bg);
        }

        .expense-detail-item:last-child {
            border-bottom: none;
        }

        .expense-detail-info {
            flex: 1;
            margin-right: 1rem;
        }

        .expense-detail-description {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
            font-size: 0.95rem;
        }

        .expense-detail-meta {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .expense-detail-amount {
            font-weight: 600;
            color: var(--danger-color);
            font-size: 1rem;
        }

        @media (max-width: 768px) {
            .expense-detail-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }

            .expense-detail-amount {
                align-self: flex-end;
            }

            .summary-stats {
                gap: 0.5rem;
            }
        }

        /* Trip Status and Payer Breakdown Styles */
        .trip-status {
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.8rem;
            font-weight: 600;
            display: inline-block;
            margin-top: 0.5rem;
        }

        .trip-status.active {
            background: rgba(34, 197, 94, 0.1);
            color: #16a34a;
        }

        .trip-status.completed {
            background: rgba(99, 102, 241, 0.1);
            color: #6366f1;
        }

        .payer-breakdown {
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: var(--hover-bg);
            border-radius: var(--border-radius);
            border-left: 4px solid var(--primary-color);
        }

        .payer-breakdown h4 {
            margin: 0 0 0.75rem 0;
            color: var(--text-primary);
        }

        .payer-expenses {
            display: grid;
            gap: 0.5rem;
        }

        .payer-expense-item {
            padding: 0.5rem;
            background: var(--card-bg);
            border-radius: 0.5rem;
            border: 1px solid var(--border-color-light);
            font-size: 0.9rem;
        }

        .due-soon {
            background: var(--warning-gradient);
            color: var(--text-primary);
        }

        .overdue {
            background: var(--danger-gradient);
            color: white;
            animation: pulse 2s infinite;
        }

        .category-management {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 1rem;
            margin: 1rem 0;
        }

        .category-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        .category-item:last-child {
            border-bottom: none;
        }

        /* Tracker Type Selector */
        .tracker-type-selector {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            margin: 1.5rem 0;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: var(--border-radius);
            backdrop-filter: blur(10px);
        }

        .tracker-type-selector label {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 1rem;
        }

        .tracker-type-selector select {
            padding: 0.75rem 1rem;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            background: var(--card-bg);
            color: var(--text-primary);
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            min-width: 180px;
        }

        .tracker-type-selector select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            justify-content: center;
            gap: 0.75rem;
            margin: 2rem 0 1rem 0;
            flex-wrap: wrap;
            padding: 0.5rem;
            background: rgba(255, 255, 255, 0.6);
            border-radius: var(--border-radius-xl);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: var(--shadow-sm);
        }

        .nav-tab {
            padding: 0.875rem 1.75rem;
            border: none;
            border-radius: var(--border-radius-lg);
            background: transparent;
            color: var(--text-secondary);
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition-spring);
            backdrop-filter: blur(10px);
            border: 1px solid transparent;
            position: relative;
            overflow: hidden;
            letter-spacing: 0.025em;
        }

        .nav-tab::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.1));
            opacity: 0;
            transition: var(--transition);
            border-radius: var(--border-radius-lg);
        }

        .nav-tab:hover::before {
            opacity: 1;
        }

        .nav-tab:hover {
            color: var(--text-accent);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            border-color: rgba(99, 102, 241, 0.2);
        }

        .nav-tab.active {
            background: var(--primary-gradient);
            color: white;
            box-shadow: var(--shadow-lg);
            border-color: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }

        .nav-tab.active::before {
            opacity: 0;
        }

        .nav-tab.active:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: var(--shadow-xl);
        }

        .help-btn {
            background: var(--warning-gradient);
            color: white;
            border: none;
            padding: 0.75rem 1rem;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 1rem;
            min-width: 50px;
            position: relative;
            animation: helpPulse 3s infinite;
        }

        .help-btn:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: var(--shadow-lg);
        }

        @keyframes helpPulse {
            0%, 90%, 100% { 
                box-shadow: 0 0 0 0 rgba(255, 193, 7, 0.7);
            }
            10% { 
                box-shadow: 0 0 0 10px rgba(255, 193, 7, 0);
            }
        }

        /* Tab Content */
        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease-in;
        }

        .tab-content.active {
            display: block;
        }

        /* Enhanced Budget Summary */
        .budget-summary {
            background: var(--primary-gradient);
            color: white;
            padding: 2rem;
            border-radius: var(--border-radius-lg);
            margin-bottom: 2rem;
            text-align: center;
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow-xl);
        }

        .budget-summary::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, rgba(255, 255, 255, 0.1) 25%, transparent 25%, transparent 75%, rgba(255, 255, 255, 0.1) 75%);
            background-size: 20px 20px;
            animation: move 2s linear infinite;
        }

        @keyframes move {
            0% { background-position: 0 0; }
            100% { background-position: 20px 20px; }
        }

        .budget-summary > * {
            position: relative;
            z-index: 2;
        }

        .budget-amount {
            font-size: 3rem;
            font-weight: 700;
            margin: 1rem 0;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .budget-status {
            font-size: 1.2rem;
            margin-bottom: 1rem;
            opacity: 0.9;
        }

        .budget-progress-main {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50px;
            height: 20px;
            margin: 1.5rem 0;
            overflow: hidden;
            position: relative;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .budget-fill-main {
            height: 100%;
            background: linear-gradient(90deg, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.7));
            border-radius: 50px;
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 12px;
        }

        .budget-text-main {
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.9);
            padding: 4px 8px;
            border-radius: 12px;
            margin-right: 8px;
            text-shadow: none;
        }

        .warning-budget {
            background: var(--danger-gradient);
            animation: pulse 2s infinite;
        }

        /* Quick Stats Grid */
        .quick-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }

        .quick-stat-card {
            background: var(--card-bg);
            padding: 1.5rem;
            border-radius: var(--border-radius-lg);
            text-align: center;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .quick-stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--primary-gradient);
            opacity: 0;
            transition: var(--transition);
        }

        .quick-stat-card:hover::before {
            opacity: 1;
        }

        .quick-stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .quick-stat-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            display: block;
        }

        .quick-stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }
        .quick-stat-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-weight: 500;
        }

        /* Smart Suggestions */
        .smart-suggestions {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-lg);
            padding: 2rem;
            margin: 2rem 0;
            box-shadow: var(--shadow-md);
            position: relative;
            overflow: hidden;
        }

        .smart-suggestions::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--success-gradient);
            opacity: 0.8;
        }

        .suggestions-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .suggestions-icon {
            font-size: 1.8rem;
        }

        .suggestions-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .suggestion-item {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            padding: 1rem;
            background: rgba(76, 175, 80, 0.05);
            border-left: 4px solid #4caf50;
            border-radius: 0 var(--border-radius) var(--border-radius) 0;
            margin-bottom: 1rem;
            transition: var(--transition);
        }

        .suggestion-item:hover {
            background: rgba(76, 175, 80, 0.1);
            transform: translateX(4px);
        }

        .suggestion-item.priority {
            background: rgba(255, 193, 7, 0.1);
            border-left-color: #ffc107;
        }

        .suggestion-item.warning {
            background: rgba(244, 67, 54, 0.1);
            border-left-color: #f44336;
        }

        .suggestion-icon {
            font-size: 1.5rem;
            flex-shrink: 0;
            margin-top: 0.25rem;
        }

        .suggestion-content {
            flex: 1;
        }

        .suggestion-text {
            font-size: 1rem;
            line-height: 1.5;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .suggestion-amount {
            font-size: 1.2rem;
            font-weight: 700;
            color: #4caf50;
        }

        .suggestion-meta {
            font-size: 0.85rem;
            color: var(--text-secondary);
            font-style: italic;
        }

        .savings-goal {
            background: linear-gradient(135deg, #4caf50, #8bc34a);
            color: white;
            padding: 1.5rem;
            border-radius: var(--border-radius-lg);
            margin: 1rem 0;
            text-align: center;
        }

        .savings-amount {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .no-suggestions {
            text-align: center;
            color: var(--text-secondary);
            font-style: italic;
            padding: 2rem;
        }

        /* Responsive Enhancements */
        @media (max-width: 768px) {
            .fab {
                bottom: 1rem;
                right: 1rem;
                width: 50px;
                height: 50px;
                font-size: 1.2rem;
            }
            
            .card-enhanced:hover {
                transform: translateY(-4px) scale(1.01);
            }
            
            .input-group input,
            .input-group select {
                padding: 1rem;
            }
            
            .input-icon {
                display: none;
            }
            
            .recurring-item-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
            
            .nav-tabs {
                gap: 0.25rem;
                margin: 1rem 0;
            }
            
            .nav-tab {
                padding: 0.75rem 1rem;
                font-size: 0.9rem;
                min-width: auto;
            }
            
            .budget-amount {
                font-size: 2rem;
            }
            
            .budget-summary {
                padding: 1.5rem;
            }
            
            .quick-stats {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>💰 <span data-i18n="app.title">Expense Tracker</span></h1>
            <p class="subtitle" id="appSubtitle" data-i18n="app.subtitle">Track, manage, and optimize your expenses with smart insights</p>
            
            <!-- Tracker Type Selector -->
            <div class="tracker-type-selector">
                <label for="trackerType" data-i18n="tracker.mode">Tracker Mode:</label>
                <select id="trackerType" onchange="changeTrackerType()">
                    <option value="personal" data-i18n="tracker.personal">👤 Personal</option>
                    <option value="family" data-i18n="tracker.family">👨‍👩‍👧‍👦 Family</option>
                    <option value="group" data-i18n="tracker.group">👥 Group/Shared</option>
                </select>
            </div>
            
            <!-- Navigation Tabs -->
            <div class="nav-tabs">
                <button class="nav-tab active" data-tab="main">📋 <span data-i18n="nav.expenses">Expenses</span></button>
                <button class="nav-tab" data-tab="travel">🧳 <span data-i18n="nav.trips">Trips</span></button>
                <button class="nav-tab" data-tab="dashboard">📊 <span data-i18n="nav.dashboard">Dashboard</span></button>
                <button class="nav-tab" data-tab="settings">⚙️ <span data-i18n="nav.settings">Settings</span></button>
                <button class="help-btn" id="helpBtn" data-i18n-title="help.needHelp">❓</button>
            </div>
            
            <div style="margin-top: 1rem; display: flex; align-items: center; justify-content: center; gap: 1rem; padding: 0.75rem; background: #f5f5f5; border: 1px solid #ddd; border-radius: 8px;">
                <span style="font-size: 1rem;">🌙</span>
                <span style="font-size: 0.9rem; color: #333; font-weight: 500;" data-i18n="theme.dark">Dark Mode</span>
                <label style="position: relative; display: inline-block; width: 50px; height: 28px;">
                    <input type="checkbox" id="darkModeToggle" onchange="toggleDarkMode()" style="opacity: 0; width: 0; height: 0;">
                    <span class="dark-mode-toggle-slider" style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 28px;">
                        <span style="position: absolute; content: ''; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%;"></span>
                    </span>
                </label>
            </div>
        </div>

        <!-- Main Tab Content -->
        <div id="mainTab" class="tab-content active">
            <!-- Budget Summary -->
            <div class="budget-summary" id="budgetSummaryMain">
                <h2 style="margin: 0 0 1rem 0; font-size: 1.5rem;">💰 <span data-i18n="dashboard.monthlyOverview">Monthly Budget Overview</span></h2>
                <div class="budget-amount" id="budgetAmountMain">0</div>
                <div class="budget-status" id="budgetStatusMain" data-i18n="budget.setToStart">Set your monthly budget to get started</div>
                <div class="budget-progress-main">
                    <div class="budget-fill-main" id="budgetFillMain">
                        <span class="budget-text-main" id="budgetTextMain">0%</span>
                    </div>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 1rem; flex-wrap: wrap; gap: 1rem;">
                    <div>
                        <strong>Spent: </strong><span id="spentAmountMain">0</span>
                    </div>
                    <div>
                        <strong>Remaining: </strong><span id="remainingAmountMain">0</span>
                    </div>
                </div>
            </div>

            <!-- Quick Stats -->
            <div class="quick-stats">
                <div class="quick-stat-card">
                    <span class="quick-stat-icon">📊</span>
                    <div class="quick-stat-value" id="monthlyTotalMain">€0</div>
                    <div class="quick-stat-label" data-i18n="filters.thisMonth">This Month</div>
                </div>
                <div class="quick-stat-card">
                    <span class="quick-stat-icon">📅</span>
                    <div class="quick-stat-value" id="avgDailyMain">€0</div>
                    <div class="quick-stat-label" data-i18n="stats.avgDaily">Daily Average</div>
                </div>
                <div class="quick-stat-card">
                    <span class="quick-stat-icon">📝</span>
                    <div class="quick-stat-value" id="expenseCountMain">0</div>
                    <div class="quick-stat-label" data-i18n="nav.expenses">Expenses</div>
                </div>
                <div class="quick-stat-card">
                    <span class="quick-stat-icon">🏆</span>
                    <div class="quick-stat-value" id="topCategoryMain">-</div>
                    <div class="quick-stat-label" data-i18n="stats.topCategory">Top Category</div>
                </div>
            </div>

            <!-- Smart Suggestions -->
            <div class="smart-suggestions" id="smartSuggestions">
                <div class="suggestions-header">
                    <span class="suggestions-icon">💡</span>
                    <span class="suggestions-title" data-i18n="dashboard.smartSuggestions">Smart Money Suggestions</span>
                </div>
                <div id="suggestionsContent">
                    <div class="no-suggestions" data-i18n="dashboard.noSuggestions">Add some expenses and set a budget to see personalized suggestions!</div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="quick-actions">
                <div class="quick-action" data-action="quick-form" data-category="Groceries">
                    <span>🛒</span>
                    <span data-i18n="quickActions.groceries">Quick Groceries</span>
                </div>
                <div class="quick-action" data-action="quick-form" data-category="Utilities">
                    <span>⚡</span>
                    <span data-i18n="quickActions.utilities">Quick Utilities</span>
                </div>
                <div class="quick-action" data-action="quick-form" data-category="Transportation">
                    <span>🚗</span>
                    <span data-i18n="quickActions.transport">Quick Transport</span>
                </div>
                <div class="quick-action" data-action="quick-form" data-category="Mortgage">
                    <span>🏡</span>
                    <span data-i18n="quickActions.mortgage">Quick Mortgage</span>
                </div>
                <div class="quick-action" data-action="quick-form" data-category="Car Loan/Lease">
                    <span>🚙</span>
                    <span data-i18n="quickActions.carLoan">Quick Car Loan</span>
                </div>
                <div class="quick-action" data-action="show-insights">
                    <span>💡</span>
                    <span data-i18n="dashboard.insights">Insights</span>
                </div>
                <div class="quick-action" data-action="show-recurring">
                    <span>🔄</span>
                    <span data-i18n="nav.recurring">Recurring</span>
                </div>
            </div>

            <div class="main-grid">
                <div class="left-panel">
                    <!-- Add Expense Form -->
                    <div class="expense-form card-enhanced">
                        <h2><span class="card-icon">➕</span> <span data-i18n="expense.add">Add New Expense</span></h2>
                        <form id="expenseForm">
                            <div class="form-grid">
                                <div class="input-group">
                                    <span class="input-icon">💰</span>
                                    <label for="amount" data-i18n="expense.amount">Amount</label>
                                    <input type="number" id="amount" step="0.01" required placeholder="0.00" data-i18n-placeholder="placeholders.amount">
                                </div>
                                
                                <div class="input-group">
                                    <span class="input-icon">💱</span>
                                    <label for="currency" data-i18n="expense.currency">Currency</label>
                                    <select id="currency" required>
                                        <!-- Will be populated dynamically -->
                                    </select>
                                </div>
                                
                                <div class="input-group">
                                    <span class="input-icon">📋</span>
                                    <label for="category" data-i18n="expense.category">Category</label>
                                    <select id="category" required onchange="handleCategoryChange()">
                                        <option value="">Select category</option>
                                        <option value="Rent">🏠 Rent</option>
                                        <option value="Mortgage">🏡 Mortgage</option>
                                        <option value="Utilities">⚡ Utilities</option>
                                        <option value="Groceries">🛒 Groceries</option>
                                        <option value="Transportation">🚗 Transportation</option>
                                        <option value="Car Loan/Lease">🚙 Car Loan/Lease</option>
                                        <option value="Healthcare">🏥 Healthcare</option>
                                        <option value="Entertainment">🎬 Entertainment</option>
                                        <option value="Dining">🍽️ Dining</option>
                                        <option value="Shopping">🛍️ Shopping</option>
                                        <option value="Education">📚 Education</option>
                                        <option value="Insurance">🛡️ Insurance</option>
                                        <option value="Other Loan">💳 Other Loan</option>
                                        <option value="Other">📝 Other</option>
                                        <option value="__ADD_NEW__">➕ Add New Category</option>
                                    </select>
                                </div>
                                
                                <!-- Custom Category Input (Hidden by default) -->
                                <div class="input-group" id="customCategoryGroup" style="display: none;">
                                    <span class="input-icon">✨</span>
                                    <label for="customCategory">New Category Name</label>
                                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                                        <input type="text" id="customCategory" placeholder="Enter new category name">
                                        <input type="text" id="customCategoryIcon" placeholder="🏷️" maxlength="2" style="width: 60px; text-align: center;">
                                        <button type="button" id="addCustomCategoryBtn" class="btn btn-success" style="min-width: auto; padding: 0.5rem 1rem;" data-i18n="common.add">Add</button>
                                        <button type="button" id="cancelCustomCategoryBtn" class="btn btn-secondary" style="min-width: auto; padding: 0.5rem 1rem;" data-i18n="common.cancel">Cancel</button>
                                    </div>
                                </div>
                                
                                <div class="input-group" id="personGroup">
                                    <span class="input-icon">👥</span>
                                    <label for="person" id="personLabel" data-i18n="expense.person">Person</label>
                                    <select id="person" required>
                                        <option value="">Select person</option>
                                        <option value="You">👤 You</option>
                                        <option value="Partner">👥 Partner</option>
                                        <option value="Both">💏 Both</option>
                                    </select>
                                </div>
                                
                                <div class="input-group">
                                    <span class="input-icon">📅</span>
                                    <label for="date" data-i18n="expense.date">Date</label>
                                    <input type="date" id="date" required>
                                </div>
                                
                                <div class="input-group" style="grid-column: 1 / -1;">
                                    <span class="input-icon">📝</span>
                                    <label for="description" data-i18n="expense.descriptionOptional">Description (optional)</label>
                                    <input type="text" id="description" placeholder="e.g., Weekly grocery shopping">
                                </div>
                                
                                <!-- Recurring Expense Options -->
                                <div class="input-group" style="grid-column: 1 / -1;">
                                    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem; padding: 0.75rem; background: #f0f8ff; border: 2px solid #4285f4; border-radius: 8px;">
                                        <span style="font-size: 1.2rem;">🔄</span>
                                        <label for="isRecurring" style="flex: 1; margin: 0; cursor: pointer; font-weight: 500; color: #333;">
                                            <span data-i18n="expense.isRecurring">Make this a recurring expense</span>
                                        </label>
                                        <label style="position: relative; display: inline-block; width: 50px; height: 28px;">
                                            <input type="checkbox" id="isRecurring" onchange="toggleRecurringOptions()" style="opacity: 0; width: 0; height: 0;">
                                            <span class="recurring-toggle-slider" style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 28px;">
                                                <span style="position: absolute; content: ''; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%;"></span>
                                            </span>
                                        </label>
                                    </div>
                                    
                                    <div id="recurringOptions" style="display: none;">
                                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                            <div>
                                                <label for="recurringFrequency" data-i18n="recurring.frequency">Frequency</label>
                                                <select id="recurringFrequency">
                                                    <option value="weekly">📅 Weekly</option>
                                                    <option value="biweekly">📅 Bi-weekly</option>
                                                    <option value="monthly" selected>📅 Monthly</option>
                                                    <option value="quarterly">📅 Quarterly</option>
                                                    <option value="yearly">📅 Yearly</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label for="recurringEndDate" data-i18n="recurring.endDateOptional">End Date (optional)</label>
                                                <input type="date" id="recurringEndDate">
                                            </div>
                                        </div>
                                        <div style="margin-top: 1rem; display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem; background: #f3f4f6; border-radius: 8px;">
                                            <span style="font-size: 1.2rem;">💰</span>
                                            <label for="isFixedCost" style="flex: 1; margin: 0; cursor: pointer; font-weight: 500; color: #333;">
                                                Mark as Fixed Cost
                                            </label>
                                            <label style="position: relative; display: inline-block; width: 50px; height: 28px;">
                                                <input type="checkbox" id="isFixedCost" checked style="opacity: 0; width: 0; height: 0;">
                                                <span class="fixed-cost-toggle-slider" style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #4CAF50; transition: .4s; border-radius: 28px;">
                                                    <span style="position: absolute; content: ''; height: 20px; width: 20px; right: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%;"></span>
                                                </span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="btn-actions">
                                <button type="button" id="cancelEdit" style="display: none;" class="btn btn-secondary">✖️ <span data-i18n="common.cancel">Cancel</span></button>
                                <button type="submit" class="btn bounce-in">💾 <span data-i18n="buttons.saveExpense">Save Expense</span></button>
                            </div>
                        </form>
                    </div>
                </div>

                <div class="right-panel">
                    <!-- Expense List -->
                    <div class="expense-list">
                        <div class="expense-list-header">
                            <h2><span class="card-icon">📋</span> <span id="expenseListTitle">Recent Expenses</span></h2>
                            
                            <!-- Smart Search Bar -->
                            <div class="search-container">
                                                            <div class="search-input-wrapper">
                                <span class="search-icon">🔍</span>
                                <input type="text" id="searchInput" placeholder="Search expenses..." autocomplete="off">
                                <button id="clearSearch" style="display: none;">✖️</button>
                            </div>
                                <div id="searchResults" class="search-results"></div>
                            </div>
                            
                            <!-- View Mode Toggle -->
                            <div class="view-mode-toggle">
                                <button id="recentModeBtn" class="view-mode-btn active" data-view-mode="recent">
                                    <span class="view-icon">📅</span>
                                    <span>Recent (30 days)</span>
                                </button>
                                <button id="allModeBtn" class="view-mode-btn" data-view-mode="all">
                                    <span class="view-icon">📋</span>
                                    <span>All Expenses</span>
                                </button>
                            </div>
                            
                            <div class="expense-filters">
                                <div class="filter-group">
                                    <label>Filter by Category</label>
                                    <select id="categoryFilter" onchange="filterExpenses()">
                                        <option value="">All Categories</option>
                                        <option value="Rent">🏠 Rent</option>
                                        <option value="Mortgage">🏡 Mortgage</option>
                                        <option value="Utilities">⚡ Utilities</option>
                                        <option value="Groceries">🛒 Groceries</option>
                                        <option value="Transportation">🚗 Transportation</option>
                                        <option value="Car Loan/Lease">🚙 Car Loan/Lease</option>
                                        <option value="Healthcare">🏥 Healthcare</option>
                                        <option value="Entertainment">🎬 Entertainment</option>
                                        <option value="Dining">🍽️ Dining</option>
                                        <option value="Shopping">🛍️ Shopping</option>
                                        <option value="Education">📚 Education</option>
                                        <option value="Insurance">🛡️ Insurance</option>
                                        <option value="Other Loan">💳 Other Loan</option>
                                        <option value="Other">📝 Other</option>
                                    </select>
                                </div>
                                <div class="filter-group" id="personFilterGroup">
                                    <label id="personFilterLabel">Filter by Person</label>
                                    <select id="personFilter" onchange="filterExpenses()">
                                        <option value="">All People</option>
                                        <option value="You">👤 You</option>
                                        <option value="Partner">👥 Partner</option>
                                        <option value="Both">💏 Both</option>
                                    </select>
                                </div>
                                <button class="btn btn-success" id="exportCSVBtn">📥 <span data-i18n="buttons.exportCSV">Export CSV</span></button>
                                <button class="btn btn-success" id="exportJSONBtn">📥 <span data-i18n="buttons.exportJSON">Export JSON</span></button>
                                <button class="btn btn-warning" id="exportExcelBtn" data-premium-feature="excel_export">📊 <span data-i18n="buttons.exportExcel">Export Excel</span></button>
                                <button class="btn btn-warning" id="exportPDFBtn" data-premium-feature="pdf_export">📄 <span data-i18n="buttons.exportPDF">Export PDF</span></button>
                            </div>
                        </div>
                        
                        <!-- Pagination Controls -->
                        <div id="paginationTop" class="pagination-container" style="display: none;">
                            <div class="pagination-info">
                                <span id="paginationInfo">Showing 0 expenses</span>
                            </div>
                            <div class="pagination-controls">
                                <button id="prevPageBtn" disabled>← <span data-i18n="common.previous">Previous</span></button>
                                <span id="pageInfo">Page 1 of 1</span>
                                <button id="nextPageBtn" disabled><span data-i18n="common.next">Next</span> →</button>
                            </div>
                        </div>
                        
                        <div id="expensesList">
                            <div class="no-expenses" data-i18n="expense.noExpenses">No expenses added yet. Add your first expense above!</div>
                        </div>
                        
                        <!-- Bottom Pagination -->
                        <div id="paginationBottom" class="pagination-container" style="display: none;">
                            <div class="pagination-controls">
                                <button id="prevPageBtnBottom">← <span data-i18n="common.previous">Previous</span></button>
                                <span id="pageInfoBottom">Page 1 of 1</span>
                                <button id="nextPageBtnBottom"><span data-i18n="common.next">Next</span> →</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dashboard Tab Content -->
        <div id="dashboardTab" class="tab-content">
            <!-- Enhanced Date Range Filter -->
            <div class="dashboard-header">
                <h1 class="dashboard-title">
                    <span class="title-icon">📊</span>
                    <span data-i18n="dashboard.title">Financial Dashboard</span>
                </h1>
                <div class="dashboard-controls">
                    <div class="date-selector-group">
                        <div class="custom-date-selector">
                            <button class="date-nav-btn" id="prevPeriod">
                                <span>‹</span>
                            </button>
                            <div class="date-display" id="currentPeriodDisplay">
                                <span class="period-label">January 2024</span>
                            </div>
                            <button class="date-nav-btn" id="nextPeriod">
                                <span>›</span>
                            </button>
                        </div>
                        <div class="period-type-selector">
                            <select id="periodTypeSelector" class="period-select">
                                <option value="month" data-i18n="dateRange.month">Month</option>
                                <option value="quarter" data-i18n="dateRange.quarter">Quarter</option>
                                <option value="year" data-i18n="dateRange.year">Year</option>
                                <option value="custom" data-i18n="dateRange.custom">Custom Range</option>
                            </select>
                        </div>
                    </div>
                    <div class="dashboard-actions">
                        <button class="action-btn" id="refreshDashboard" data-i18n-title="dashboard.refresh">
                            <span>🔄</span>
                        </button>
                        <button class="action-btn" id="exportDashboard" data-i18n-title="dashboard.export">
                            <span>📤</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Key Metrics Summary -->
            <div class="metrics-summary">
                <div class="metric-card primary">
                    <div class="metric-icon">💰</div>
                    <div class="metric-content">
                        <div class="metric-value" id="totalSpentMetric">€0</div>
                        <div class="metric-label" data-i18n="metrics.totalSpent">Total Spent</div>
                        <div class="metric-change" id="spentChange">
                            <span class="change-arrow">↑</span>
                            <span class="change-value">0%</span>
                        </div>
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-icon">🎯</div>
                    <div class="metric-content">
                        <div class="metric-value" id="budgetUsageMetric">0%</div>
                        <div class="metric-label" data-i18n="metrics.budgetUsed">Budget Used</div>
                        <div class="metric-progress">
                            <div class="metric-progress-bar" id="budgetProgressBar"></div>
                        </div>
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-icon">📈</div>
                    <div class="metric-content">
                        <div class="metric-value" id="avgDailyMetric">€0</div>
                        <div class="metric-label" data-i18n="metrics.dailyAverage">Daily Average</div>
                        <div class="metric-subtitle" id="projectedMonthly">€0 projected</div>
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-icon">🏷️</div>
                    <div class="metric-content">
                        <div class="metric-value" id="transactionCountMetric">0</div>
                        <div class="metric-label" data-i18n="metrics.transactions">Transactions</div>
                        <div class="metric-subtitle" id="topCategoryMetric">No data</div>
                    </div>
                </div>
            </div>

            <div class="dashboard">
                <div class="card budget-card" id="budgetCard">
                    <h2><span class="card-icon">🎯</span> <span data-i18n="budget.monthly">Monthly Budget</span></h2>
                    <div class="total-display" id="budgetAmount">€0</div>
                    <div class="progress-container">
                        <div class="progress-fill" id="budgetFill">
                            <span class="progress-text" id="progressText">0%</span>
                        </div>
                    </div>
                    <div id="budgetStatus" data-i18n="budget.setMonthly">Set your monthly budget</div>
                </div>

                <div class="card">
                    <h2><span class="card-icon">📊</span> This Month's Total</h2>
                    <div class="total-display" id="monthlyTotal">€0</div>
                    <div id="expenseCount">0 expenses</div>
                </div>

                <div class="card">
                    <h2><span class="card-icon">📈</span> Expense Breakdown</h2>
                    <div class="chart-container">
                        <canvas id="expenseChart"></canvas>
                    </div>
                </div>

                <div class="card">
                    <h2><span class="card-icon">💰</span> Fixed vs Variable</h2>
                    <div class="chart-container">
                        <canvas id="fixedVariableChart"></canvas>
                    </div>
                </div>

                <div class="card">
                    <h2><span class="card-icon">🔄</span> Upcoming Recurring</h2>
                    <div id="upcomingRecurringList" class="upcoming-recurring-container">
                        <p style="color: var(--text-secondary); text-align: center; font-style: italic;">No upcoming recurring expenses</p>
                    </div>
                </div>
            </div>

            <!-- New Analytics Section -->
            <div class="analytics-section">
                <!-- Spending Trend Chart -->
                <div class="card">
                    <h2><span class="card-icon">📉</span> <span data-i18n="charts.spendingTrend">Spending Trend</span></h2>
                    <div class="chart-container">
                        <canvas id="spendingTrendChart"></canvas>
                    </div>
                </div>

                <!-- Category vs Budget Chart -->
                <div class="card">
                    <h2><span class="card-icon">🎯</span> <span data-i18n="charts.categoryBudget">Category vs Budget</span></h2>
                    <div class="chart-container">
                        <canvas id="categoryBudgetChart"></canvas>
                    </div>
                </div>

                <!-- Cash Flow Summary -->
                <div class="card">
                    <h2><span class="card-icon">💸</span> <span data-i18n="charts.cashFlow">Cash Flow Summary</span></h2>
                    <div class="cash-flow-container">
                        <div class="cash-flow-item inflow">
                            <div class="flow-label" data-i18n="cashFlow.budget">Budget</div>
                            <div class="flow-amount" id="inflowAmount">€0</div>
                            <div class="flow-bar">
                                <div class="flow-fill inflow-fill" id="inflowBar"></div>
                            </div>
                        </div>
                        <div class="cash-flow-item outflow">
                            <div class="flow-label" data-i18n="cashFlow.spent">Spent</div>
                            <div class="flow-amount" id="outflowAmount">€0</div>
                            <div class="flow-bar">
                                <div class="flow-fill outflow-fill" id="outflowBar"></div>
                            </div>
                        </div>
                        <div class="cash-flow-balance">
                            <div class="balance-label" data-i18n="cashFlow.balance">Balance</div>
                            <div class="balance-amount" id="cashBalanceAmount">€0</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Smart Insights Section -->
            <div class="smart-insights-section">
                <h2 class="insights-header">
                    <span class="insights-icon">💡</span>
                    <span data-i18n="insights.smart">Smart Insights</span>
                </h2>
                <div class="insights-grid" id="smartInsightsGrid">
                    <!-- Insights will be dynamically generated here -->
                </div>
            </div>

            <!-- Enhanced Statistics -->
            <div class="stats-grid">
                <div class="stat-card-enhanced">
                    <span class="stat-icon">📊</span>
                    <div class="stat-value" id="avgDaily">€0</div>
                    <div class="stat-label" data-i18n="stats.avgDaily">Avg Daily</div>
                </div>
                <div class="stat-card-enhanced">
                    <span class="stat-icon">🏆</span>
                    <div class="stat-value" id="topCategory">-</div>
                    <div class="stat-label" data-i18n="stats.topCategory">Top Category</div>
                </div>
                <div class="stat-card-enhanced">
                    <span class="stat-icon">⏰</span>
                    <div class="stat-value" id="daysLeft">0</div>
                    <div class="stat-label" data-i18n="stats.daysLeft">Days Left</div>
                </div>
                <div class="stat-card-enhanced">
                    <span class="stat-icon">📈</span>
                    <div class="stat-value" id="weeklyAvg">€0</div>
                    <div class="stat-label" data-i18n="stats.weeklyAvg">Weekly Avg</div>
                </div>
                <div class="stat-card-enhanced" id="projectionCard" style="cursor: pointer;" onclick="showProjectionModal()">
                    <span class="stat-icon">🔮</span>
                    <div class="stat-value" id="projectedSpend">€0</div>
                    <div class="stat-label" data-i18n="stats.projectedTotal">Projected Total</div>
                </div>
            </div>
        </div>
        <!-- Trips Tab Content -->
        <div id="travelTab" class="tab-content">
            <div class="travel-tracker">
                <!-- Project Management Header -->
                <div class="trip-header">
                    <div class="trip-info">
                        <h2><span class="card-icon">🧳</span> Trip Expense Tracker</h2>
                        <p class="project-subtitle">Track expenses for trips, events, business travel, or any specific travel spending goal</p>
                        <div class="trip-controls">
                            <div class="current-trip" id="currentTripDisplay">
                                <span id="tripName" data-i18n="travel.noActiveTrip">No active trip</span>
                                <div class="trip-action-buttons">
                                    <button class="btn btn-secondary" id="manageTripBtn">✈️ <span data-i18n="travel.newTrip">New Trip</span></button>
                                    <button class="btn btn-success" id="completeTripBtn" style="display: none;">✅ <span data-i18n="travel.completeTrip">Complete Trip</span></button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Trip Stats -->
                    <div class="trip-stats" id="tripStatsContainer">
                        <div class="trip-stat-card">
                            <span class="trip-stat-icon">💰</span>
                            <div class="trip-stat-value" id="tripTotal">€0</div>
                            <div class="trip-stat-label" data-i18n="travel.totalSpent">Total Spent</div>
                        </div>
                        <div class="trip-stat-card">
                            <span class="trip-stat-icon">📅</span>
                            <div class="trip-stat-value" id="tripDays">0</div>
                            <div class="trip-stat-label" data-i18n="travel.days">Days</div>
                        </div>
                        <div class="trip-stat-card">
                            <span class="trip-stat-icon">📝</span>
                            <div class="trip-stat-value" id="tripExpenseCount">0</div>
                            <div class="trip-stat-label" data-i18n="travel.expenses">Expenses</div>
                        </div>
                        <div class="trip-stat-card">
                            <span class="trip-stat-icon">📊</span>
                            <div class="trip-stat-value" id="tripAvgDaily">€0</div>
                            <div class="trip-stat-label" data-i18n="travel.dailyAvg">Daily Avg</div>
                        </div>
                    </div>
                </div>

                <!-- Project Quick Actions -->
                <div class="travel-quick-actions">
                    <div class="travel-action" data-travel-category="🍽️ Food & Dining">
                        <span>🍽️</span>
                        <span>Food/Dining</span>
                    </div>
                    <div class="travel-action" data-travel-category="🏨 Accommodation">
                        <span>🏨</span>
                        <span>Lodging</span>
                    </div>
                    <div class="travel-action" data-travel-category="🚗 Transportation">
                        <span>🚗</span>
                        <span>Transport</span>
                    </div>
                    <div class="travel-action" data-travel-category="🎯 Supplies">
                        <span>🎯</span>
                        <span>Supplies</span>
                    </div>
                    <div class="travel-action" data-travel-category="🎫 Events/Activities">
                        <span>🎫</span>
                        <span>Events</span>
                    </div>
                    <div class="travel-action" data-travel-category="💼 Services">
                        <span>💼</span>
                        <span>Services</span>
                    </div>
                </div>

                <div class="travel-grid">
                    <div class="travel-form-panel">
                        <!-- Project Expense Form -->
                        <div class="travel-expense-form card-enhanced">
                            <h3><span class="card-icon">➕</span> Add Trip Expense</h3>
                            <form id="travelExpenseForm">
                                <div class="form-grid">
                                    <div class="input-group">
                                        <span class="input-icon">💰</span>
                                        <label for="travelAmount" data-i18n="expense.amount">Amount</label>
                                        <input type="number" id="travelAmount" step="0.01" required placeholder="0.00">
                                    </div>
                                    
                                    <div class="input-group">
                                        <span class="input-icon">💱</span>
                                        <label for="travelCurrency" data-i18n="expense.currency">Currency</label>
                                        <select id="travelCurrency" required>
                                            <!-- Will be populated dynamically -->
                                        </select>
                                    </div>
                                    
                                    <div class="input-group">
                                        <span class="input-icon">📋</span>
                                        <label for="travelCategory" data-i18n="expense.category">Category</label>
                                        <select id="travelCategory" required>
                                            <option value="">Select category</option>
                                            <option value="🍽️ Food & Dining">🍽️ Food & Dining</option>
                                            <option value="🏨 Accommodation">🏨 Accommodation</option>
                                            <option value="🚗 Transportation">🚗 Transportation</option>
                                            <option value="🎯 Supplies">🎯 Supplies & Materials</option>
                                            <option value="🎫 Events/Activities">🎫 Events & Activities</option>
                                            <option value="💼 Services">💼 Professional Services</option>
                                            <option value="⛽ Fuel">⛽ Fuel & Gas</option>
                                            <option value="✈️ Flight">✈️ Flights</option>
                                            <option value="🚕 Taxi/Uber">🚕 Taxi/Rideshare</option>
                                            <option value="🛒 Shopping">🛒 Shopping</option>
                                            <option value="💊 Medical">💊 Medical & Health</option>
                                            <option value="📱 Communication">📱 Communication</option>
                                            <option value="🎨 Equipment">🎨 Equipment & Tools</option>
                                            <option value="📚 Education">📚 Education & Training</option>
                                            <option value="💱 Exchange">💱 Currency Exchange</option>
                                            <option value="📝 Other">📝 Other</option>
                                        </select>
                                    </div>
                                    
                                    <div class="input-group">
                                        <span class="input-icon">📅</span>
                                        <label for="travelDate" data-i18n="expense.date">Date</label>
                                        <input type="date" id="travelDate" required autocomplete="off">
                                    </div>
                                    
                                    <div class="input-group">
                                        <span class="input-icon">📍</span>
                                        <label for="travelLocation" data-i18n="travel.locationVendor">Location/Vendor</label>
                                        <input type="text" id="travelLocation" placeholder="e.g., Office Depot, Local Restaurant">
                                    </div>
                                    
                                    <div class="input-group">
                                        <span class="input-icon">👤</span>
                                        <label for="travelPayer" data-i18n="travel.payer">Payer</label>
                                        <input type="text" id="travelPayer" placeholder="Enter payer name (e.g., Me, John, Sarah)" required list="payerSuggestions">
                                        <datalist id="payerSuggestions">
                                            <option value="Me">
                                            <option value="You">
                                        </datalist>
                                    </div>

                                </div>
                                
                                <!-- Main Budget Toggle - Outside grid for visibility -->
                                <div style="margin: 1rem 0; padding: 1rem; background: #f0f8ff; border: 2px solid #4285f4; border-radius: 8px;">
                                    <div style="display: flex; align-items: center; gap: 1rem;">
                                        <span style="font-size: 1.5rem;">💰</span>
                                        <div style="flex: 1;">
                                            <label style="font-weight: 600; color: #333; cursor: pointer; display: block;" for="mainBudgetToggle">
                                                Deduct from Main Budget
                                            </label>
                                            <small style="color: #666; font-size: 0.85rem;">
                                                Also add this expense to main budget expenses
                                            </small>
                                        </div>
                                        <label style="position: relative; display: inline-block; width: 60px; height: 34px;">
                                            <input type="checkbox" id="mainBudgetToggle" style="opacity: 0; width: 0; height: 0;">
                                            <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px;">
                                                <span style="position: absolute; content: ''; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%;"></span>
                                            </span>
                                        </label>
                                    </div>
                                </div>
                                
                                <div class="form-grid" style="margin-top: 0;">
                                    <!-- Dummy div to restart grid -->
                                    
                                    <div class="input-group" style="grid-column: 1 / -1;">
                                        <span class="input-icon">📝</span>
                                        <label for="travelDescription" data-i18n="expense.descriptionOptional">Description (optional)</label>
                                        <input type="text" id="travelDescription" placeholder="e.g., Office supplies for event">
                                    </div>
                                </div>
                                
                                <div class="btn-actions">
                                    <button type="button" id="cancelTravelEdit" style="display: none;" class="btn btn-secondary">✖️ Cancel</button>
                                    <button type="submit" class="btn bounce-in">💾 Add to Trip</button>
                                </div>
                            </form>
                        </div>

                        <!-- Category Breakdown -->
                        <div class="travel-breakdown card-enhanced">
                            <h3><span class="card-icon">📊</span> Category Breakdown</h3>
                            <div id="travelCategoryBreakdown" class="category-breakdown">
                                <div class="no-breakdown" data-i18n="travel.noBreakdown">Add expenses to see category breakdown</div>
                            </div>
                        </div>
                    </div>

                    <div class="travel-list-panel">
                        <!-- Trip Expense List -->
                        <div class="travel-expense-list">
                            <div class="travel-list-header">
                                <h3><span class="card-icon">📋</span> Trip Expenses</h3>
                                
                                <!-- Trip Search -->
                                <div class="search-container">
                                    <div class="search-input-wrapper">
                                        <span class="search-icon">🔍</span>
                                        <input type="text" id="travelSearchInput" placeholder="Search trip expenses..." autocomplete="off">
                                        <button id="clearTravelSearch" style="display: none;">✖️</button>
                                    </div>
                                </div>

                                <!-- Project Filters -->
                                <div class="travel-filters">
                                    <div class="filter-group">
                                        <label>Filter by Category</label>
                                        <select id="travelCategoryFilter">
                                            <option value="">All Categories</option>
                                            <option value="🍽️ Food & Dining">🍽️ Food & Dining</option>
                                            <option value="🏨 Accommodation">🏨 Accommodation</option>
                                            <option value="🚗 Transportation">🚗 Transportation</option>
                                            <option value="🎯 Supplies">🎯 Supplies</option>
                                            <option value="🎫 Events/Activities">🎫 Events/Activities</option>
                                            <option value="💼 Services">💼 Services</option>
                                            <option value="⛽ Fuel">⛽ Fuel</option>
                                            <option value="✈️ Flight">✈️ Flights</option>
                                            <option value="🚕 Taxi/Uber">🚕 Taxi/Uber</option>
                                            <option value="🛒 Shopping">🛒 Shopping</option>
                                            <option value="💊 Medical">💊 Medical</option>
                                            <option value="📱 Communication">📱 Communication</option>
                                            <option value="🎨 Equipment">🎨 Equipment</option>
                                            <option value="📚 Education">📚 Education</option>
                                            <option value="💱 Exchange">💱 Exchange</option>
                                            <option value="📝 Other">📝 Other</option>
                                        </select>
                                    </div>
                                    <button class="btn btn-success" id="exportTravelCSVBtn">📥 Export Project</button>
                                </div>
                            </div>
                            
                            <div id="travelExpensesList">
                                <div class="no-expenses" data-i18n="travel.createProjectFirst">Create a project and start tracking your expenses!</div>
                            </div>
                        </div>

                        <!-- Your Trips Section -->
                        <div class="your-trips-section card-enhanced">
                            <div class="trips-header">
                                <h3><span class="card-icon">🧳</span> Your Trips</h3>
                                <button class="btn btn-primary" id="addNewTripBtn">✈️ Add New Trip</button>
                            </div>
                            <div id="mainTripsList" class="trips-list-container">
                                <div class="no-trips">✈️ No trips created yet. Start your first adventure!</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Trip Management Modal -->
        <div id="tripModal" class="modal">
            <div class="modal-content">
                <h2>✈️ <span data-i18n="travel.createNewTrip">Create New Trip</span></h2>
                <div id="tripModalContent">
                    <!-- Create New Trip -->
                    <div class="trip-form-section">
                        <h3>✈️ <span data-i18n="travel.startNewTrip">Start New Trip</span></h3>
                        <form id="newTripForm">
                            <div class="form-grid">
                                <div class="input-group">
                                    <span class="input-icon">🏷️</span>
                                    <label for="newTripName" data-i18n="travel.tripName">Trip Name</label>
                                    <input type="text" id="newTripName" required placeholder="e.g., Paris Vacation 2024">
                                </div>
                                
                                <div class="input-group">
                                    <span class="input-icon">📍</span>
                                    <label for="newTripDestination" data-i18n="travel.destination">Destination</label>
                                    <input type="text" id="newTripDestination" placeholder="e.g., Paris, France">
                                </div>
                                
                                <div class="input-group">
                                    <span class="input-icon">📅</span>
                                    <label for="newTripStartDate" data-i18n="travel.startDate">Start Date</label>
                                    <input type="date" id="newTripStartDate" required autocomplete="off">
                                </div>
                                
                                <div class="input-group">
                                    <span class="input-icon">📅</span>
                                    <label for="newTripEndDate" data-i18n="travel.endDate">End Date</label>
                                    <input type="date" id="newTripEndDate" autocomplete="off">
                                </div>
                                
                                <div class="input-group">
                                    <span class="input-icon">💰</span>
                                    <label for="newTripBudget" data-i18n="travel.budgetOptional">Budget (optional)</label>
                                    <input type="number" id="newTripBudget" step="0.01" placeholder="0.00">
                                </div>
                                
                                <div class="input-group">
                                    <span class="input-icon">💱</span>
                                    <label for="newTripCurrency" data-i18n="travel.currency">Trip Currency</label>
                                    <select id="newTripCurrency">
                                        <!-- Will be populated dynamically -->
                                    </select>
                                </div>
                            </div>
                            
                            <div style="margin-top: 1rem;">
                                <button type="submit" class="btn btn-primary">🚀 <span data-i18n="travel.startTrip">Start Trip</span></button>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Existing Trips -->
                    <div class="existing-trips-section">
                        <h3>📋 <span data-i18n="travel.yourTrips">Your Trips</span></h3>
                        <div id="tripsList">
                            <div class="no-trips" data-i18n="travel.noTrips">No trips created yet. Start your first trip above!</div>
                        </div>
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 2rem;">
                    <button class="btn" id="closeTripModalBtn">Close</button>
                </div>
            </div>
        </div>

        <!-- Complete Trip Modal -->
        <div id="completeTripModal" class="modal">
            <div class="modal-content">
                <h2>🎉 Complete Trip</h2>
                <p>When did your trip end?</p>
                <form id="completeTripForm">
                    <div class="input-group">
                        <label for="completionDate">Trip End Date</label>
                        <input type="date" id="completionDate" required>
                    </div>
                    <div class="modal-actions" style="display: flex; gap: 1rem; justify-content: center; margin-top: 2rem;">
                        <button type="button" class="btn btn-secondary" onclick="closeCompleteTripModal()">Cancel</button>
                        <button type="submit" class="btn btn-success">✅ Complete Trip</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- QR Code Display Modal -->
        <div id="qrModal" class="modal">
            <div class="modal-content">
                <h2>📱 QR Code - Data Transfer</h2>
                <div style="text-align: center; padding: 2rem;">
                    <div id="qrcode" style="margin: 0 auto 1rem auto;"></div>
                    <p>Scan this QR code with another device to transfer your data</p>
                    <p style="font-size: 0.9rem; color: var(--text-secondary);">Keep this QR code private as it contains all your expense data</p>
                </div>
                <div style="text-align: center; margin-top: 2rem;">
                    <button class="btn btn-secondary" onclick="closeQRModal()">Close</button>
                </div>
            </div>
        </div>

        <!-- QR Code Scanner Modal -->
        <div id="qrScannerModal" class="modal">
            <div class="modal-content">
                <h2>📷 Scan QR Code</h2>
                <div style="text-align: center; padding: 2rem;">
                    <div id="qrScannerContainer">
                        <video id="qrVideo" width="300" height="300" style="border-radius: 8px; border: 1px solid var(--border-color);"></video>
                        <canvas id="qrCanvas" width="300" height="300" style="display: none;"></canvas>
                    </div>
                    <p style="margin-top: 1rem;">Point your camera at a QR code from another device</p>
                    
                    <!-- Alternative manual input -->
                    <div style="margin-top: 2rem; padding: 1rem; background: var(--bg-secondary); border-radius: 8px;">
                        <h4>📋 Alternative: Paste shared link</h4>
                        <input type="text" id="manualQRInput" placeholder="Paste the shared link here..." style="width: 100%; margin: 0.5rem 0; padding: 0.5rem;">
                        <button class="btn btn-primary" onclick="processManualQRInput()">Import from Link</button>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 2rem;">
                    <button class="btn btn-secondary" onclick="closeQRScanner()">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Cloud Sync Setup Modal -->
        <div id="syncSetupModal" class="modal">
            <div class="modal-content">
                <h2>☁️ Setup Cloud Sync</h2>
                <div id="syncSetupContent">
                    <div class="sync-option-cards">
                        <div class="sync-provider-card" onclick="setupFirebaseSync()">
                            <h3>🔥 Firebase Sync</h3>
                            <p>Real-time sync across all devices</p>
                            <ul>
                                <li>Instant synchronization</li>
                                <li>Automatic backups</li>
                                <li>Works offline</li>
                                <li>Free for personal use</li>
                            </ul>
                            <button class="btn btn-primary">Setup Firebase</button>
                        </div>
                        
                        <div class="sync-provider-card" onclick="setupLocalSync()">
                            <h3>💾 Local Browser Sync</h3>
                            <p>Simple local storage synchronization</p>
                            <ul>
                                <li>No account required</li>
                                <li>Manual sync process</li>
                                <li>Export/Import based</li>
                                <li>Completely private</li>
                            </ul>
                            <button class="btn btn-secondary">Use Local Only</button>
                        </div>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 2rem;">
                    <button class="btn btn-secondary" onclick="closeSyncSetupModal()">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Settings Tab Content -->
        <div id="settingsTab" class="tab-content">
            <div class="settings-panel">
                <h2><span class="card-icon">⚙️</span> <span data-i18n="settings.title">Settings & Configuration</span></h2>
                
                <!-- Subscription Plan Section -->
                <div class="subscription-section">
                    <h3><span class="section-icon">👑</span> <span data-i18n="subscription.title">Subscription Plan</span></h3>
                    <div class="plan-status-card">
                        <div class="plan-header">
                            <div class="plan-badge" id="planBadge">
                                <span class="plan-icon">🆓</span>
                                <span class="plan-name" id="planName">Free</span>
                            </div>
                            <div class="plan-validity" id="planValidity">
                                <span class="validity-label" data-i18n="subscription.validUntil">Valid until</span>
                                <span class="validity-date" id="validityDate">-</span>
                            </div>
                        </div>
                        
                        <div class="plan-details">
                            <div class="plan-feature-list" id="planFeatures">
                                <!-- Features will be populated dynamically -->
                            </div>
                            
                            <div class="plan-stats">
                                <div class="stat-item">
                                    <span class="stat-label" data-i18n="subscription.daysRemaining">Days Remaining</span>
                                    <span class="stat-value" id="daysRemaining">∞</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label" data-i18n="subscription.status">Status</span>
                                    <span class="stat-value" id="subscriptionStatus">Active</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="plan-actions">
                            <button class="btn btn-primary" id="upgradePlanBtn" onclick="showUpgradeModal()">
                                <span>🚀</span>
                                <span data-i18n="subscription.upgrade">Upgrade to Premium</span>
                            </button>
                            <button class="btn btn-secondary" id="managePlanBtn" onclick="showSubscriptionDetails()" style="display: none;">
                                <span>📋</span>
                                <span data-i18n="subscription.manage">Manage Subscription</span>
                            </button>
                        </div>
                    </div>
                </div>
                
                <hr class="section-divider">
                <div class="settings-grid">
                    <div class="form-group">
                        <label for="languageSelect" data-i18n="settings.language">Language</label>
                        <select id="languageSelect">
                            <!-- Will be populated dynamically -->
                        </select>
                    </div>
                    <button class="btn" id="setLanguageBtn" onclick="changeLanguage()">🌐 <span data-i18n="buttons.changeLanguage">Change Language</span></button>
                    
                    <div class="form-group">
                        <label for="mainCurrencySelect" data-i18n="settings.mainCurrency">Main Currency</label>
                        <select id="mainCurrencySelect">
                            <!-- Will be populated dynamically -->
                        </select>
                    </div>
                    <button class="btn" id="setCurrencyBtn">💱 <span data-i18n="buttons.setCurrency">Set Currency</span></button>
                    
                    <div class="form-group">
                        <label for="monthlyBudget" data-i18n="budget.monthly">Monthly Budget</label>
                        <div style="display: flex; gap: 0.5rem;">
                            <span id="budgetCurrencySymbol" style="align-self: center; font-size: 1.2rem;"></span>
                            <input type="number" id="monthlyBudget" placeholder="1500" min="0" style="flex: 1;">
                        </div>
                    </div>
                    <button class="btn" id="setBudgetBtn">💾 Set Budget</button>
                </div>
                
                <div style="margin-top: 2rem;">
                    <h3>💱 <span data-i18n="settings.exchangeRateHistory">Exchange Rate History</span></h3>
                    <div id="exchangeRateHistory" style="margin-bottom: 2rem;">
                        <div class="exchange-rate-list" style="max-height: 200px; overflow-y: auto;">
                            <!-- Will be populated dynamically -->
                        </div>
                        <button class="btn btn-sm" onclick="clearExchangeHistory()" style="margin-top: 1rem;">🗑️ Clear History</button>
                    </div>
                </div>
                
                <div style="margin-top: 2rem;">
                    <h3>⌨️ <span data-i18n="help.keyboardShortcuts">Keyboard Shortcuts</span></h3>
                    <div class="keyboard-shortcuts">
                        <div class="shortcut-item">
                            <span class="shortcut-key">Ctrl + N</span>
                            <span class="shortcut-desc" data-i18n="help.newExpense">New Expense (scroll to form)</span>
                        </div>
                        <div class="shortcut-item">
                            <span class="shortcut-key">Ctrl + I</span>
                            <span class="shortcut-desc" data-i18n="help.showInsights">Show Insights</span>
                        </div>
                        <div class="shortcut-item">
                            <span class="shortcut-key">Ctrl + R</span>
                            <span class="shortcut-desc" data-i18n="help.recurringExpenses">Recurring Expenses</span>
                        </div>
                        <div class="shortcut-item">
                            <span class="shortcut-key">Ctrl + E</span>
                            <span class="shortcut-desc" data-i18n="help.exportCSV">Export CSV</span>
                        </div>
                        <div class="shortcut-item">
                            <span class="shortcut-key">Ctrl + D</span>
                            <span class="shortcut-desc">Dashboard Tab</span>
                        </div>
                        <div class="shortcut-item">
                            <span class="shortcut-key">Ctrl + M</span>
                            <span class="shortcut-desc">Main Tab</span>
                        </div>
                        <div class="shortcut-item">
                            <span class="shortcut-key">Ctrl + F</span>
                            <span class="shortcut-desc">Focus Search</span>
                        </div>
                        <div class="shortcut-item">
                            <span class="shortcut-key">Ctrl + S</span>
                            <span class="shortcut-desc">Save Form</span>
                        </div>
                        <div class="shortcut-item">
                            <span class="shortcut-key">Esc</span>
                            <span class="shortcut-desc">Close Modals/Clear Search</span>
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 2rem;">
                    <h3>🔔 Notification Settings</h3>
                    <div id="notificationStatus" style="margin-bottom: 1rem; padding: 0.75rem; border-radius: var(--border-radius); border: 1px solid var(--border-color);"></div>
                    
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap; margin-bottom: 1rem;">
                        <button class="btn btn-primary" id="testNotificationBtn">
                            📱 Test Notification
                        </button>
                        <button class="btn btn-warning" id="checkRemindersBtn">
                            🔍 Check Reminders Now
                        </button>
                        <button class="btn btn-secondary" id="createTestReminderBtn">
                            🧪 Create Test Reminder
                        </button>
                    </div>
                    
                    <div style="font-size: 0.9rem; color: var(--text-secondary);">
                        <p><strong>📍 Automatic Reminders:</strong></p>
                        <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
                            <li>3 days before each recurring expense</li>
                            <li>1 day before each recurring expense</li>
                            <li>When expenses become overdue</li>
                            <li>Checked every hour automatically</li>
                        </ul>
                    </div>
                </div>

                <div style="margin-top: 2rem;">
                    <h3>📚 <span data-i18n="help.title">User Guide</span></h3>
                    <div style="display: flex; gap: 1rem; margin-top: 1rem; flex-wrap: wrap;">
                        <button class="btn btn-info" id="startGuideBtn">
                            🎯 <span data-i18n="guide.startInteractive">Start Interactive Guide</span>
                        </button>
                        <button class="btn btn-secondary" id="quickTourBtn">
                            ⚡ <span data-i18n="guide.quickTour">Quick Feature Tour</span>
                        </button>
                    </div>
                </div>

                <div style="margin-top: 2rem;">
                    <h3>📱 <span data-i18n="sync.title">Data Synchronization</span></h3>
                    
                    <div class="sync-status-card">
                        <div class="sync-status-info">
                            <h4 id="syncStatusTitle">🔄 Cloud Sync</h4>
                            <p id="syncStatusText">Sync your data across all devices instantly</p>
                            <small id="syncStatusDetails">Status: Not configured</small>
                        </div>
                        <button id="toggleSyncBtn" class="btn btn-primary">Setup Sync</button>
                    </div>

                    <div class="sync-options">
                        <div class="sync-option">
                            <button id="exportDataBtn" class="btn btn-secondary">📤 Export Backup</button>
                            <span>Download all data as JSON backup file</span>
                        </div>
                        
                        <div class="sync-option">
                            <button id="importDataBtn" class="btn btn-secondary">📥 Import Backup</button>
                            <input type="file" id="importDataFile" accept=".json" style="display: none;">
                            <span>Upload backup from another device</span>
                        </div>
                        
                        <div class="sync-option">
                            <button id="generateQRBtn" class="btn btn-accent">📱 Generate QR Code</button>
                            <span>Create QR code to transfer data to another device</span>
                        </div>
                        
                        <div class="sync-option">
                            <button id="scanQRBtn" class="btn btn-accent">📷 Scan QR Code</button>
                            <span>Import data from another device's QR code</span>
                        </div>
                    </div>
                </div>

                <div style="margin-top: 2rem;">
                    <h3>🗑️ <span data-i18n="settings.dataManagement">Data Management</span></h3>
                    <div style="display: flex; gap: 1rem; margin-top: 1rem; flex-wrap: wrap;">
                        <button class="btn btn-warning" id="exportAllDataBtn">📥 <span data-i18n="buttons.exportData">Export All Data</span></button>
                        <button class="btn btn-danger" id="clearAllDataBtn">🗑️ <span data-i18n="buttons.clearData">Clear All Data</span></button>
                        <button class="btn btn-warning" id="clearCacheBtn">🔄 Clear Cache & Reload</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="notification"></div>
    
    <!-- Floating Action Button -->
    <button class="fab" id="fabScrollBtn" title="Add New Expense">
        ➕
    </button>
    
    <!-- Insights Modal -->
    <div id="insightsModal" class="modal">
        <div class="modal-content">
            <h2>📊 Spending Insights</h2>
            <div id="insightsContent">
                <div class="insight-item">
                    <h3>💡 Smart Recommendations</h3>
                    <div id="recommendations"></div>
                </div>
                <div class="insight-item" style="margin-top: 2rem;">
                    <h3>📈 Spending Trends</h3>
                    <div id="trends"></div>
                </div>
            </div>
            <div style="text-align: center; margin-top: 2rem;">
                <button class="btn" id="closeInsightsBtn">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Spent Breakdown Modal -->
    <div id="spentBreakdownModal" class="modal">
        <div class="modal-content">
            <h2>💰 Monthly Spending Breakdown</h2>
            <div id="spentBreakdownContent">
                <!-- Content will be populated by JavaScript -->
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeSpentBreakdownModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Remaining Breakdown Modal -->
    <div id="remainingBreakdownModal" class="modal">
        <div class="modal-content">
            <h2>📊 Remaining Budget & Upcoming Expenses</h2>
            <div id="remainingBreakdownContent">
                <!-- Content will be populated by JavaScript -->
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeRemainingBreakdownModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Expense Details Modal -->
    <div id="expenseDetailsModal" class="modal">
        <div class="modal-content">
            <h2>📋 What Your Expenses Are For</h2>
            <div id="expenseDetailsContent">
                <!-- Content will be populated by JavaScript -->
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeExpenseDetailsModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Budget Projection Modal -->
    <div id="projectionModal" class="modal">
        <div class="modal-content">
            <h2>🔮 Smart Budget Projection</h2>
            <div id="projectionContent">
                <!-- Content will be populated by JavaScript -->
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeProjectionModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Recurring Expenses Modal -->
    <div id="recurringModal" class="modal">
        <div class="modal-content">
            <h2>🔄 Recurring Expenses</h2>
            <div id="recurringContent">
                <div style="margin-bottom: 2rem;">
                    <h3>📋 Active Recurring Expenses</h3>
                    <div id="recurringList"></div>
                </div>
                <div>
                    <h3>⚡ Quick Actions</h3>
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap; margin-top: 1rem;">
                        <button class="btn btn-success" id="processRecurringBtn">📅 Process Due Expenses</button>
                        <button class="btn btn-warning" id="checkRecurringBtn">🔍 Check for Due Expenses</button>
                    </div>
                </div>
            </div>
            <div style="text-align: center; margin-top: 2rem;">
                <button class="btn" id="closeRecurringBtn">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Expense Detail View Modal -->
    <div id="expenseDetailModal" class="modal">
        <div class="modal-content expense-detail-modal">
            <div class="expense-detail-header">
                <h2 id="expenseDetailTitle">Expense Details</h2>
                <button class="modal-close-btn" onclick="closeExpenseDetailModal()">&times;</button>
            </div>
            
            <div class="expense-detail-body">
                <!-- Basic Information Card -->
                <div class="detail-card">
                    <h3>📋 Basic Information</h3>
                    <div class="detail-info-grid">
                        <div class="detail-info-item">
                            <span class="detail-label">Category</span>
                            <span id="detailCategory" class="detail-value"></span>
                        </div>
                        <div class="detail-info-item">
                            <span class="detail-label">Amount</span>
                            <span id="detailAmount" class="detail-value amount"></span>
                        </div>
                        <div class="detail-info-item">
                            <span class="detail-label">Person</span>
                            <span id="detailPerson" class="detail-value"></span>
                        </div>
                        <div class="detail-info-item">
                            <span class="detail-label">Description</span>
                            <span id="detailDescription" class="detail-value"></span>
                        </div>
                        <div class="detail-info-item">
                            <span class="detail-label">Date</span>
                            <span id="detailDate" class="detail-value"></span>
                        </div>
                        <div class="detail-info-item">
                            <span class="detail-label">Tags</span>
                            <div id="detailTags" class="detail-tags"></div>
                        </div>
                    </div>
                    <div id="detailNextPayment" class="next-payment-alert" style="display: none;">
                        <span class="next-payment-icon">📅</span>
                        <div>
                            <strong>Next Payment Due</strong>
                            <span id="nextPaymentDate"></span>
                        </div>
                    </div>
                </div>
                
                <!-- Payment History -->
                <div class="detail-card">
                    <h3>📅 Payment History</h3>
                    <div id="paymentHistoryTimeline" class="payment-timeline">
                        <!-- Timeline will be populated dynamically -->
                    </div>
                </div>
                
                <!-- Budget Impact Chart -->
                <div class="detail-card">
                    <h3>📊 Budget Impact Analysis</h3>
                    <div class="chart-container">
                        <canvas id="budgetImpactChart"></canvas>
                    </div>
                    <div id="budgetInsights" class="budget-insights">
                        <!-- Insights will be populated dynamically -->
                    </div>
                </div>
            </div>
            
            <div class="expense-detail-footer">
                <button class="btn btn-warning" id="detailEditBtn">
                    <span>✏️</span> Edit Expense
                </button>
                <button class="btn btn-danger" id="detailDeleteBtn">
                    <span>🗑️</span> Delete Expense
                </button>
                <button class="btn btn-secondary" onclick="closeExpenseDetailModal()">Close</button>
            </div>
        </div>
    </div>

    <style>
        /* Expense Detail Modal Styles */
        .expense-detail-modal {
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .expense-detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border-color);
        }
        
        .modal-close-btn {
            background: none;
            border: none;
            font-size: 2rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: color 0.2s ease;
            padding: 0;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }
        
        .modal-close-btn:hover {
            color: var(--danger-color);
            background: rgba(239, 68, 68, 0.1);
        }
        
        .expense-detail-body {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        
        .detail-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: var(--shadow-sm);
        }
        
        .detail-card h3 {
            margin: 0 0 1rem 0;
            color: var(--primary-color);
            font-size: 1.1rem;
        }
        
        .detail-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }
        
        .detail-info-item {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        
        .detail-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        .detail-value {
            font-size: 1rem;
            color: var(--text-primary);
            font-weight: 600;
        }
        
        .detail-value.amount {
            color: var(--danger-color);
            font-size: 1.2rem;
        }
        
        .detail-tags {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .next-payment-alert {
            margin-top: 1rem;
            padding: 1rem;
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.1) 0%, rgba(245, 158, 11, 0.1) 100%);
            border: 2px solid #f59e0b;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .next-payment-icon {
            font-size: 2rem;
        }
        
        .next-payment-alert strong {
            display: block;
            color: #f59e0b;
            margin-bottom: 0.25rem;
        }
        
        /* Payment Timeline Styles */
        .payment-timeline {
            position: relative;
            padding: 1rem 0;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .timeline-item {
            display: flex;
            align-items: center;
            margin-bottom: 1.5rem;
            position: relative;
            padding-left: 2rem;
        }
        
        .timeline-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0.5rem;
            width: 12px;
            height: 12px;
            background: var(--primary-color);
            border-radius: 50%;
            box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.2);
        }
        
        .timeline-item::after {
            content: '';
            position: absolute;
            left: 5px;
            top: 1.5rem;
            width: 2px;
            height: calc(100% + 1rem);
            background: var(--border-color);
        }
        
        .timeline-item:last-child::after {
            display: none;
        }
        
        .timeline-content {
            flex: 1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--hover-bg);
            padding: 0.75rem 1rem;
            border-radius: 8px;
        }
        
        .timeline-date {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-primary);
        }
        
        .timeline-amount {
            font-weight: 600;
            color: var(--danger-color);
        }
        
        /* Chart Container */
        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 1rem;
        }
        
        .budget-insights {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
        }
        
        .insight-item {
            text-align: center;
            padding: 1rem;
            background: var(--hover-bg);
            border-radius: 8px;
        }
        
        .insight-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
            display: block;
            margin-bottom: 0.25rem;
        }
        
        .insight-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        
        .expense-detail-footer {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border-color);
        }
        
        @media (max-width: 768px) {
            .expense-detail-modal {
                width: 95%;
                max-height: 95vh;
            }
            
            .detail-info-grid {
                grid-template-columns: 1fr;
            }
            
            .expense-detail-footer {
                flex-direction: column;
            }
            
            .expense-detail-footer button {
                width: 100%;
            }
        }
    </style>

    <!-- Interactive Guide Overlay -->
    <div id="guideOverlay" class="guide-overlay" style="display: none;">
        <div class="guide-content">
            <div class="guide-header">
                <h2 id="guideTitle" data-i18n="guide.welcome">Welcome to Expense Tracker! 🎉</h2>
                <button class="guide-close" id="closeGuideBtn">✖️</button>
            </div>
            <div class="guide-body">
                <div id="guideText">
                    <p>Let's take a quick tour to help you get started with managing your expenses like a pro!</p>
                </div>
                <div class="guide-progress">
                    <div class="progress-bar">
                        <div class="progress-fill" id="guideProgress"></div>
                    </div>
                    <span class="progress-text" id="guideProgressText" data-i18n="guide.progressText">Step 1 of 10</span>
                </div>
            </div>
            <div class="guide-footer">
                <button class="btn btn-secondary" id="guidePrevBtn" style="display: none;">← Previous</button>
                <button class="btn btn-secondary" id="guideSkipBtn">Skip Tour</button>
                <button class="btn btn-primary" id="guideNextBtn">Next →</button>
                <button class="btn btn-success" id="guideFinishBtn" style="display: none;">🎉 Start Using!</button>
            </div>
        </div>
        <div class="guide-spotlight" id="guideSpotlight"></div>
    </div>
    <!-- Premium Features Manager -->
    <script src="premium-features.js"></script>
    
    <!-- Error Logging System -->
    <script src="error-logging.js"></script>
    
    <!-- Payment Integration -->
    <script src="payment-integration.js"></script>
    
    <!-- Security Fixes -->
    <script src="security-fixes.js"></script>
    
    <!-- Analytics Implementation -->
    <!-- Privacy-Friendly Analytics with Conversion Tracking -->
    
    <!-- Option 1: Privacy-First Analytics (Default) -->
    <script>
        // Enhanced privacy-focused analytics with conversion tracking
        class PrivacyAnalytics {
            constructor() {
                this.events = [];
                this.sessionId = this.getSessionId();
                this.userId = this.getAnonymousUserId();
                this.conversionGoals = {
                    premium_upgrade: false,
                    email_signup: false,
                    first_expense: false,
                    budget_created: false,
                    export_used: false
                };
                this.init();
            }

            init() {
                // Check for DNT (Do Not Track)
                if (navigator.doNotTrack === "1" || window.doNotTrack === "1") {
                    console.log('Analytics disabled: DNT enabled');
                    this.disabled = true;
                    return;
                }

                // Check for consent
                const consent = localStorage.getItem('analytics_consent');
                if (consent === 'false') {
                    this.disabled = true;
                    return;
                }

                // Check URL parameters for campaigns
                this.trackCampaignData();
            }

            getSessionId() {
                let sessionId = sessionStorage.getItem('session_id');
                if (!sessionId) {
                    sessionId = `session_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                    sessionStorage.setItem('session_id', sessionId);
                }
                return sessionId;
            }

            getAnonymousUserId() {
                let userId = localStorage.getItem('anonymous_user_id');
                if (!userId) {
                    userId = `user_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                    localStorage.setItem('anonymous_user_id', userId);
                }
                return userId;
            }

            trackCampaignData() {
                const urlParams = new URLSearchParams(window.location.search);
                const campaignData = {
                    source: urlParams.get('utm_source') || urlParams.get('ref') || document.referrer,
                    medium: urlParams.get('utm_medium'),
                    campaign: urlParams.get('utm_campaign'),
                    upgrade: urlParams.get('upgrade')
                };

                if (Object.values(campaignData).some(v => v)) {
                    sessionStorage.setItem('campaign_data', JSON.stringify(campaignData));
                }
            }

            track(event, properties = {}) {
                if (this.disabled) return;

                const campaignData = JSON.parse(sessionStorage.getItem('campaign_data') || '{}');
                const analyticsData = {
                    event,
                    properties: { ...properties, ...campaignData },
                    timestamp: new Date().toISOString(),
                    sessionId: this.sessionId,
                    userId: this.userId,
                    userAgent: navigator.userAgent,
                    screenSize: `${window.screen.width}x${window.screen.height}`,
                    viewport: `${window.innerWidth}x${window.innerHeight}`,
                    language: navigator.language,
                    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone
                };

                // Store locally
                this.events.push(analyticsData);
                
                // Save to localStorage for persistence
                const storedEvents = JSON.parse(localStorage.getItem('analytics_events') || '[]');
                storedEvents.push(analyticsData);
                
                // Keep only last 500 events
                if (storedEvents.length > 500) {
                    storedEvents.splice(0, storedEvents.length - 500);
                }
                
                localStorage.setItem('analytics_events', JSON.stringify(storedEvents));
                
                // Check for conversions
                this.checkConversion(event, properties);
                
                // Log to console in development
                if (window.location.hostname === 'localhost') {
                    console.log('📊 Analytics Event:', event, properties);
                }

                // Send to privacy-friendly service if configured
                this.sendToService(analyticsData);
            }

            checkConversion(event, properties) {
                // Track conversion goals
                switch (event) {
                    case 'premium_trial_start':
                    case 'premium_purchase':
                        this.conversionGoals.premium_upgrade = true;
                        this.trackConversion('premium_upgrade', properties);
                        break;
                    case 'email_signup':
                        this.conversionGoals.email_signup = true;
                        this.trackConversion('email_signup', properties);
                        break;
                    case 'expense_added':
                        if (!this.conversionGoals.first_expense) {
                            this.conversionGoals.first_expense = true;
                            this.trackConversion('first_expense', properties);
                        }
                        break;
                    case 'budget_created':
                        this.conversionGoals.budget_created = true;
                        this.trackConversion('budget_created', properties);
                        break;
                    case 'export_completed':
                        this.conversionGoals.export_used = true;
                        this.trackConversion('export_used', properties);
                        break;
                }
            }

            trackConversion(conversionType, properties) {
                this.track('conversion', {
                    type: conversionType,
                    ...properties,
                    value: this.getConversionValue(conversionType)
                });
            }

            getConversionValue(conversionType) {
                const values = {
                    premium_upgrade: 4.99,
                    email_signup: 0.50,
                    first_expense: 0.10,
                    budget_created: 0.25,
                    export_used: 0.15
                };
                return values[conversionType] || 0;
            }

            sendToService(data) {
                // Option A: Plausible Analytics (privacy-friendly)
                if (window.plausible) {
                    window.plausible(data.event, { props: data.properties });
                }

                // Option B: Simple Analytics (privacy-friendly)
                if (window.sa_event) {
                    window.sa_event(data.event, data.properties);
                }

                // Option C: Custom endpoint
                if (window.ANALYTICS_ENDPOINT) {
                    fetch(window.ANALYTICS_ENDPOINT, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data),
                        mode: 'cors',
                        keepalive: true
                    }).catch(() => {}); // Fail silently
                }
            }

            trackPageView(customPath) {
                this.track('page_view', {
                    path: customPath || window.location.pathname,
                    title: document.title,
                    referrer: document.referrer
                });
            }

            trackExpenseAdded(category, amount) {
                this.track('expense_added', { 
                    category, 
                    amount,
                    currency: 'USD' // Update based on user preference
                });
            }

            trackFeatureUsed(feature) {
                this.track('feature_used', { feature });
            }

            trackError(error, context) {
                this.track('error', {
                    message: error.message || error,
                    stack: error.stack,
                    context,
                    url: window.location.href
                });
            }

            trackTiming(category, variable, time) {
                this.track('timing', {
                    category,
                    variable,
                    time,
                    label: `${category}_${variable}`
                });
            }

            getAnalyticsSummary() {
                const events = JSON.parse(localStorage.getItem('analytics_events') || '[]');
                const summary = {
                    totalEvents: events.length,
                    uniqueSessions: new Set(events.map(e => e.sessionId)).size,
                    uniqueUsers: new Set(events.map(e => e.userId)).size,
                    conversions: this.conversionGoals,
                    eventTypes: {},
                    topPages: {},
                    sources: {}
                };

                events.forEach(event => {
                    // Count event types
                    summary.eventTypes[event.event] = (summary.eventTypes[event.event] || 0) + 1;
                    
                    // Track page views
                    if (event.event === 'page_view') {
                        const path = event.properties.path;
                        summary.topPages[path] = (summary.topPages[path] || 0) + 1;
                    }
                    
                    // Track sources
                    if (event.properties.source) {
                        summary.sources[event.properties.source] = (summary.sources[event.properties.source] || 0) + 1;
                    }
                });

                return summary;
            }
        }

        // Initialize analytics
        window.analytics = new PrivacyAnalytics();
        
        // Track page view on load
        window.addEventListener('load', () => {
            window.analytics.trackPageView();
            
            // Track performance metrics
            if (window.performance && window.performance.timing) {
                const loadTime = window.performance.timing.loadEventEnd - window.performance.timing.navigationStart;
                window.analytics.trackTiming('performance', 'page_load', loadTime);
            }
        });

        // Track errors
        window.addEventListener('error', (e) => {
            window.analytics.trackError(e.error || e.message, 'window_error');
        });

        window.addEventListener('unhandledrejection', (e) => {
            window.analytics.trackError(e.reason, 'unhandled_promise');
        });

        // Track important user interactions
        document.addEventListener('DOMContentLoaded', () => {
            // Track PWA install prompt
            window.addEventListener('beforeinstallprompt', (e) => {
                window.analytics.track('pwa_install_prompt_shown');
                
                e.userChoice.then((result) => {
                    window.analytics.track('pwa_install_prompt_result', { 
                        outcome: result.outcome 
                    });
                });
            });

            // Track app standalone usage
            if (window.matchMedia('(display-mode: standalone)').matches) {
                window.analytics.track('pwa_standalone_usage');
            }
        });
    </script>

    <!-- Option 2: Google Analytics 4 (Uncomment and configure if preferred) -->
    <!--
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-XXXXXXXXXX"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      
      // Configure with privacy settings
      gtag('config', 'G-XXXXXXXXXX', {
        'anonymize_ip': true,
        'allow_google_signals': false,
        'allow_ad_personalization_signals': false,
        'restricted_data_processing': true
      });
      
      // Enhanced ecommerce and conversion tracking
      gtag('event', 'page_view', {
        'send_to': 'G-XXXXXXXXXX',
        'user_properties': {
          'user_type': localStorage.getItem('premium_user') ? 'premium' : 'free'
        }
      });
    </script>
    -->

    <!-- Option 3: Plausible Analytics (Privacy-friendly alternative) -->
    <!--
    <script defer data-domain="yourdomain.com" src="https://plausible.io/js/script.js"></script>
    <script>window.plausible = window.plausible || function() { (window.plausible.q = window.plausible.q || []).push(arguments) }</script>
    -->

    <!-- Option 4: Simple Analytics (Privacy-friendly alternative) -->
    <!--
    <script async defer src="https://scripts.simpleanalyticscdn.com/latest.js"></script>
    <noscript><img src="https://queue.simpleanalyticscdn.com/noscript.gif" alt="" referrerpolicy="no-referrer-when-downgrade" /></noscript>
    -->
    
    <script>
        // Global variables
        let expenses = JSON.parse(localStorage.getItem('familyExpenses')) || [];
        let monthlyBudget = parseFloat(localStorage.getItem('monthlyBudget')) || 0;
        let editingExpenseId = null;
        let expenseChart = null;
        let filteredExpenses = [...expenses];
        let customCategories = JSON.parse(localStorage.getItem('customCategories')) || [];
        
        // Supported languages - Define first before using
        const LANGUAGES = {
            'en': { name: 'English', flag: '🇬🇧' },
            'lt': { name: 'Lietuvių', flag: '🇱🇹' },
            'es': { name: 'Español', flag: '🇪🇸' },
            'fr': { name: 'Français', flag: '🇫🇷' },
            'de': { name: 'Deutsch', flag: '🇩🇪' }
        };
        
        // Currency settings
        let mainCurrency = localStorage.getItem('mainCurrency') || detectDefaultCurrency();
        let exchangeRates = JSON.parse(localStorage.getItem('exchangeRates')) || {};
        
        // i18n settings - Now LANGUAGES is available
        let currentLanguage = localStorage.getItem('appLanguage') || detectDefaultLanguage();
        let translations = {};
        
        // Supported currencies with symbols
        const CURRENCIES = {
            'USD': { symbol: '$', name: 'US Dollar' },
            'EUR': { symbol: '€', name: 'Euro' },
            'GBP': { symbol: '£', name: 'British Pound' },
            'NGN': { symbol: '₦', name: 'Nigerian Naira' },
            'JPY': { symbol: '¥', name: 'Japanese Yen' },
            'CNY': { symbol: '¥', name: 'Chinese Yuan' },
            'INR': { symbol: '₹', name: 'Indian Rupee' },
            'CAD': { symbol: '$', name: 'Canadian Dollar' },
            'AUD': { symbol: '$', name: 'Australian Dollar' },
            'CHF': { symbol: 'CHF', name: 'Swiss Franc' },
            'SEK': { symbol: 'kr', name: 'Swedish Krona' },
            'NOK': { symbol: 'kr', name: 'Norwegian Krone' },
            'DKK': { symbol: 'kr', name: 'Danish Krone' },
            'NZD': { symbol: '$', name: 'New Zealand Dollar' },
            'SGD': { symbol: '$', name: 'Singapore Dollar' },
            'HKD': { symbol: '$', name: 'Hong Kong Dollar' },
            'KRW': { symbol: '₩', name: 'South Korean Won' },
            'MXN': { symbol: '$', name: 'Mexican Peso' },
            'BRL': { symbol: 'R$', name: 'Brazilian Real' },
            'ZAR': { symbol: 'R', name: 'South African Rand' }
        };
        
        // Detect default currency based on locale
        function detectDefaultCurrency() {
            const locale = navigator.language || 'en-US';
            const currencyMap = {
                'en-US': 'USD',
                'en-GB': 'GBP',
                'en-NG': 'NGN',
                'fr-FR': 'EUR',
                'de-DE': 'EUR',
                'es-ES': 'EUR',
                'it-IT': 'EUR',
                'ja-JP': 'JPY',
                'zh-CN': 'CNY',
                'en-IN': 'INR',
                'en-CA': 'CAD',
                'en-AU': 'AUD',
                'en-NZ': 'NZD',
                'en-SG': 'SGD',
                'ko-KR': 'KRW',
                'pt-BR': 'BRL',
                'en-ZA': 'ZAR'
            };
            return currencyMap[locale] || 'USD';
        }
        
        // Detect default language based on browser settings
        function detectDefaultLanguage() {
            const locale = navigator.language || 'en-US';
            const lang = locale.split('-')[0];
            return LANGUAGES[lang] ? lang : 'en';
        }
        
        // i18n translation functions
        async function loadTranslations(lang) {
            try {
                // Always load English as fallback
                if (!window.enTranslations) {
                    const enResponse = await fetch(`locales/en.json`);
                    if (enResponse.ok) {
                        window.enTranslations = await enResponse.json();
                    }
                }
                
                const response = await fetch(`locales/${lang}.json`);
                if (!response.ok) {
                    throw new Error(`Failed to load ${lang} translations`);
                }
                translations = await response.json();
                currentLanguage = lang;
                localStorage.setItem('appLanguage', lang);
                updateUILanguage();
            } catch (error) {
                console.error('Error loading translations:', error);
                // Fallback to English
                if (lang !== 'en') {
                    await loadTranslations('en');
                }
            }
        }
        
        // Get translated text
        function t(key, params = {}) {
            const keys = key.split('.');
            let value = translations;
            
            for (const k of keys) {
                value = value?.[k];
                if (!value) break;
            }
            
            if (!value) {
                // In development, log missing translations
                if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                    console.warn(`[i18n] Missing key: ${key} in ${currentLanguage}`);
                }
                
                // Try to get from English as fallback
                if (currentLanguage !== 'en') {
                    const enTranslations = window.enTranslations || {};
                    let enValue = enTranslations;
                    for (const k of keys) {
                        enValue = enValue?.[k];
                        if (!enValue) break;
                    }
                    if (enValue) {
                        value = enValue;
                    }
                }
                
                // If still no value, return the key
                if (!value) {
                    return key;
                }
            }
            
            // Replace parameters like {{version}}
            let result = value;
            for (const [param, val] of Object.entries(params)) {
                result = result.replace(new RegExp(`{{${param}}}`, 'g'), val);
            }
            
            return result;
        }
        
        // Update all UI elements with translations
        function updateUILanguage() {
            // Update page title
            document.title = t('app.title');
            
            // Update navigation tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                const tabName = tab.getAttribute('onclick')?.match(/switchTab\('(\w+)'\)/)?.[1];
                if (tabName && t(`nav.${tabName}`)) {
                    tab.textContent = t(`nav.${tabName}`);
                }
            });
            
            // Update placeholders
            document.querySelectorAll('[data-i18n-placeholder]').forEach(element => {
                const key = element.getAttribute('data-i18n-placeholder');
                if (key) {
                    element.placeholder = t(key);
                }
            });
            
            // Update titles
            document.querySelectorAll('[data-i18n-title]').forEach(element => {
                const key = element.getAttribute('data-i18n-title');
                if (key) {
                    element.title = t(key);
                }
            });
            
            // Update text content
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                if (key) {
                    element.textContent = t(key);
                }
            });
            
            // Update other UI elements - we'll do this section by section
            updateMainTabLanguage();
            updateTravelTabLanguage();
            updateRecurringTabLanguage();
            updateReportsTabLanguage();
            updateSettingsTabLanguage();
            
            // Update categories and people dropdowns
            updateDropdownsLanguage();
        }
        
        // Update main tab language
        function updateMainTabLanguage() {
            // Budget overview
            const budgetTitle = document.querySelector('#mainTab h2');
            if (budgetTitle) budgetTitle.textContent = t('budget.title');
            
            // Budget labels
            const budgetLabel = document.querySelector('label[for="monthlyBudget"]');
            if (budgetLabel) budgetLabel.textContent = t('budget.monthly');
            
            // Set budget button
            const setBudgetBtn = document.querySelector('#setBudgetBtn');
            if (setBudgetBtn) setBudgetBtn.textContent = t('budget.set');
            
            // Expense form title
            const expenseTitle = document.querySelector('#mainTab h3');
            if (expenseTitle && expenseTitle.textContent.includes('Expense')) {
                expenseTitle.textContent = editingExpenseId ? t('expense.edit') : t('expense.add');
            }
            
            // Form labels
            const amountLabel = document.querySelector('label[for="amount"]');
            if (amountLabel) amountLabel.textContent = t('expense.amount');
            
            const categoryLabel = document.querySelector('label[for="category"]');
            if (categoryLabel) categoryLabel.textContent = t('expense.category');
            
            const currencyLabel = document.querySelector('label[for="currency"]');
            if (currencyLabel) currencyLabel.textContent = t('expense.currency');
            
            const personLabel = document.querySelector('label[for="person"]');
            if (personLabel) personLabel.textContent = t('expense.person');
            
            const descriptionLabel = document.querySelector('label[for="description"]');
            if (descriptionLabel) descriptionLabel.textContent = t('expense.description');
            
            const dateLabel = document.querySelector('label[for="date"]');
            if (dateLabel) dateLabel.textContent = t('expense.date');
            
            // Submit button
            const submitBtn = document.querySelector('#expenseForm button[type="submit"]');
            if (submitBtn) {
                submitBtn.textContent = editingExpenseId ? t('expense.update') : t('expense.save');
            }
            
            // Recent expenses title
            const recentTitle = document.querySelector('.recent-expenses-header h3');
            if (recentTitle) recentTitle.textContent = t('expense.recent');
        }
        
        // Update travel tab language
        function updateTravelTabLanguage() {
            const travelTitle = document.querySelector('#travelTab h2');
            if (travelTitle) travelTitle.textContent = t('travel.title');
            
            const travelDesc = document.querySelector('#travelTab p');
            if (travelDesc) travelDesc.textContent = t('travel.description');
            
            // Update trip buttons
            const newTripBtn = document.querySelector('#manageTripBtn');
            if (newTripBtn) newTripBtn.textContent = t('travel.newTrip');
            
            const completeTripBtn = document.querySelector('#completeTripBtn');
            if (completeTripBtn) completeTripBtn.textContent = t('travel.completeTrip');
        }
        
        // Update recurring tab language
        function updateRecurringTabLanguage() {
            const recurringTitle = document.querySelector('#recurringTab h2');
            if (recurringTitle) recurringTitle.textContent = t('recurring.title');
            
            const addRecurringBtn = document.querySelector('#addRecurringBtn');
            if (addRecurringBtn) addRecurringBtn.textContent = t('recurring.add');
        }
        
        // Update reports tab language
        function updateReportsTabLanguage() {
            const reportsTitle = document.querySelector('#reportsTab h2');
            if (reportsTitle) reportsTitle.textContent = t('reports.title');
            
            // Export buttons
            const exportExcelBtn = document.querySelector('.btn-excel');
            if (exportExcelBtn) exportExcelBtn.innerHTML = exportExcelBtn.innerHTML.replace(/Export Excel/i, t('reports.exportExcel'));
            
            const exportPdfBtn = document.querySelector('.btn-pdf');
            if (exportPdfBtn) exportPdfBtn.innerHTML = exportPdfBtn.innerHTML.replace(/Export PDF/i, t('reports.exportPDF'));
        }
        
        // Update settings tab language
        function updateSettingsTabLanguage() {
            const settingsTitle = document.querySelector('#settingsTab h2');
            if (settingsTitle) settingsTitle.textContent = t('settings.title');
            
            // Language label
            const languageLabel = document.querySelector('label[for="languageSelect"]');
            if (languageLabel) languageLabel.textContent = t('settings.language');
            
            // Currency settings
            const currencyLabel = document.querySelector('label[for="mainCurrencySelect"]');
            if (currencyLabel) currencyLabel.textContent = t('settings.mainCurrency');
            
            const setCurrencyBtn = document.querySelector('#setCurrencyBtn');
            if (setCurrencyBtn) setCurrencyBtn.textContent = t('settings.setCurrency');
            
            // Other settings labels will be updated similarly
        }
        
        // Update dropdowns language
        function updateDropdownsLanguage() {
            // Update tracker type dropdown
            const trackerSelect = document.getElementById('trackerType');
            if (trackerSelect) {
                trackerSelect.querySelectorAll('option').forEach(option => {
                    const value = option.value;
                    const icon = option.textContent.split(' ')[0];
                    if (value === 'personal') {
                        option.textContent = `${icon} ${t('tracker.personal')}`;
                    } else if (value === 'family') {
                        option.textContent = `${icon} ${t('tracker.family')}`;
                    } else if (value === 'group') {
                        option.textContent = `${icon} ${t('tracker.group')}`;
                    }
                });
            }
            
            // Update category options
            const categorySelects = document.querySelectorAll('select[id*="category"]');
            categorySelects.forEach(select => {
                select.querySelectorAll('option').forEach(option => {
                    const value = option.value;
                    if (value && t(`categories.${value.toLowerCase()}`)) {
                        option.textContent = t(`categories.${value.toLowerCase()}`);
                    }
                });
            });
            
            // Update person options
            const personSelects = document.querySelectorAll('select[id*="person"]');
            personSelects.forEach(select => {
                select.querySelectorAll('option').forEach(option => {
                    const value = option.value;
                    if (value && t(`person.${value.toLowerCase()}`)) {
                        option.textContent = t(`person.${value.toLowerCase()}`);
                    }
                });
            });
        }
        
        // Populate language dropdown
        function populateLanguageDropdown() {
            const languageSelect = document.getElementById('languageSelect');
            if (!languageSelect) return;
            
            languageSelect.innerHTML = '';
            
            for (const [code, lang] of Object.entries(LANGUAGES)) {
                const option = document.createElement('option');
                option.value = code;
                option.textContent = `${lang.flag} ${lang.name}`;
                if (code === currentLanguage) {
                    option.selected = true;
                }
                languageSelect.appendChild(option);
            }
        }
        
        // Change language
        async function changeLanguage() {
            const languageSelect = document.getElementById('languageSelect');
            if (!languageSelect) return;
            
            const newLang = languageSelect.value;
            if (newLang !== currentLanguage) {
                await loadTranslations(newLang);
                populateCurrencyDropdowns(); // Re-populate dropdowns with new language
                populateLanguageDropdown(); // Update language dropdown
                showNotification(t('common.success'), 'success');
            }
        }
        
        // Migrate existing expenses to include fixed field
        function migrateExpenses() {
            let migrated = false;
            expenses = expenses.map(expense => {
                if (expense.fixed === undefined) {
                    migrated = true;
                    // Default: recurring expenses are fixed, others are variable
                    expense.fixed = expense.isRecurring || false;
                }
                
                // Migrate currency fields
                if (expense.currency === undefined) {
                    migrated = true;
                    expense.currency = mainCurrency;
                    expense.convertedAmount = expense.amount;
                }
                
                return expense;
            });
            
            if (migrated) {
                localStorage.setItem('familyExpenses', JSON.stringify(expenses));
                filteredExpenses = [...expenses];
            }
        }
        
        // Run migration on load
        migrateExpenses();
        let recurringExpenses = JSON.parse(localStorage.getItem('recurringExpenses')) || [];
        let trackerType = localStorage.getItem('trackerType') || 'personal';
        let savingsGoal = parseFloat(localStorage.getItem('savingsGoal')) || 0;

        // Category icons mapping
        const categoryIcons = {
            'Rent': '🏠',
            'Mortgage': '🏡',
            'Utilities': '⚡',
            'Groceries': '🛒',
            'Transportation': '🚗',
            'Car Loan/Lease': '🚙',
            'Healthcare': '🏥',
            'Entertainment': '🎬',
            'Dining': '🍽️',
            'Shopping': '🛍️',
            'Education': '📚',
            'Insurance': '🛡️',
            'Other Loan': '💳',
            'Other': '📝'
        };

        // Global variables for new features
        let currentPage = 1;
        let itemsPerPage = 10;
        let currentViewMode = 'recent'; // 'recent' or 'all'
        let searchTerm = '';
        let totalFilteredExpenses = 0;

        // Travel tracker variables
        let travelExpenses = JSON.parse(localStorage.getItem('travelExpenses')) || [];
        let trips = JSON.parse(localStorage.getItem('trips')) || [];
        let currentTrip = JSON.parse(localStorage.getItem('currentTrip')) || null;
        let travelEditingId = null;

        // Initialize app
        document.addEventListener('DOMContentLoaded', async function() {
            document.getElementById('date').valueAsDate = new Date();
            document.getElementById('monthlyBudget').value = monthlyBudget;
            
            // Load translations first
            await loadTranslations(currentLanguage);
            
            // Initialize language dropdown
            populateLanguageDropdown();
            
            // Initialize currency dropdowns
            populateCurrencyDropdowns();
            
            // Initialize exchange rate history display
            updateExchangeRateHistoryDisplay();
            
            // Load dark mode preference
            const isDarkMode = localStorage.getItem('darkMode') === 'true';
            if (isDarkMode) {
                document.body.classList.add('dark-mode');
                document.getElementById('darkModeToggle').checked = true;
            }
            
            // Load custom categories
            loadCustomCategories();
            
            // Load tracker type
            loadTrackerType();
            
            // Auto-process past recurring expenses
            autoProcessPastRecurringExpenses();
            
            // Check for due recurring expenses on load
            checkRecurringExpenses();
            
            updateDashboard();
            filterAndRenderExpenses(); // Use new system
            
            // If dashboard is the active tab on load, initialize it
            const dashboardTab = document.getElementById('dashboardTab');
            if (dashboardTab && dashboardTab.classList.contains('active')) {
                setTimeout(() => {
                    initializeDashboard();
                }, 500);
            }
            
            // Setup keyboard shortcuts
            setupKeyboardShortcuts();
            
            document.getElementById('expenseForm').addEventListener('submit', handleExpenseSubmit);
            
            // Add loading states
            document.querySelectorAll('button').forEach(btn => {
                btn.addEventListener('click', function() {
                    if (this.type !== 'submit') {
                        this.classList.add('loading');
                        setTimeout(() => this.classList.remove('loading'), 300);
                    }
                });
            });
            
            // Add input animations
            document.querySelectorAll('input, select').forEach(input => {
                input.addEventListener('focus', function() {
                    this.parentElement.classList.add('bounce-in');
                });
                input.addEventListener('blur', function() {
                    this.parentElement.classList.remove('bounce-in');
                });
            });
        });

        // Show notification
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // ==================== DATA SYNC FUNCTIONALITY ====================

        // Data Sync Manager
        class DataSyncManager {
            constructor() {
                this.syncEnabled = localStorage.getItem('syncEnabled') === 'true';
                this.lastSync = localStorage.getItem('lastSync');
                this.updateSyncStatus();
            }

            // Get all app data for sync
            getAllData() {
                return {
                    expenses: expenses,
                    monthlyBudget: monthlyBudget,
                    customCategories: customCategories,
                    recurringExpenses: recurringExpenses,
                    travelExpenses: travelExpenses,
                    trips: trips,
                    currentTrip: currentTrip,
                    syncTimestamp: new Date().toISOString(),
                    version: '1.0'
                };
            }

            // Import all data from sync
            importAllData(data) {
                try {
                    if (data.expenses) {
                        expenses = data.expenses;
                        localStorage.setItem('familyExpenses', JSON.stringify(expenses));
                    }
                    if (data.monthlyBudget !== undefined) {
                        monthlyBudget = data.monthlyBudget;
                        localStorage.setItem('monthlyBudget', monthlyBudget.toString());
                    }
                    if (data.customCategories) {
                        customCategories = data.customCategories;
                        localStorage.setItem('customCategories', JSON.stringify(customCategories));
                    }
                    if (data.recurringExpenses) {
                        recurringExpenses = data.recurringExpenses;
                        localStorage.setItem('recurringExpenses', JSON.stringify(recurringExpenses));
                    }
                    if (data.travelExpenses) {
                        travelExpenses = data.travelExpenses;
                        localStorage.setItem('travelExpenses', JSON.stringify(travelExpenses));
                    }
                    if (data.trips) {
                        trips = data.trips;
                        localStorage.setItem('trips', JSON.stringify(trips));
                    }
                    if (data.currentTrip) {
                        currentTrip = data.currentTrip;
                        localStorage.setItem('currentTrip', JSON.stringify(currentTrip));
                    }

                    // Update all displays safely
                    try {
                        if (typeof updateDashboard === 'function') {
                            updateDashboard();
                        }
                        if (typeof filterAndRenderExpenses === 'function') {
                            filterAndRenderExpenses();
                        }
                        if (typeof renderRecurringList === 'function') {
                            renderRecurringList();
                        }
                        if (typeof initializeTravelTab === 'function') {
                            initializeTravelTab();
                        }
                        
                        // Force update of all UI elements
                        if (typeof updateCustomCategoryDropdown === 'function') {
                            updateCustomCategoryDropdown();
                        }
                    } catch (uiError) {
                        console.warn('Some UI updates failed:', uiError);
                        // Continue with the import even if UI updates fail
                    }
                    
                    this.lastSync = new Date().toISOString();
                    localStorage.setItem('lastSync', this.lastSync);
                    this.updateSyncStatus();
                    
                    return true;
                } catch (error) {
                    console.error('Import failed:', error);
                    showNotification(`❌ Import failed: ${error.message}`, 'error');
                    return false;
                }
            }

            // Export data as downloadable file
            exportData() {
                const data = this.getAllData();
                const dataStr = JSON.stringify(data, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `expense-tracker-backup-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showNotification('📤 Data exported successfully!', 'success');
            }

            // Import data from file
            importData(file) {
                if (!file) {
                    showNotification('❌ No file selected', 'error');
                    return;
                }
                
                if (!file.name.endsWith('.json')) {
                    showNotification('❌ Please select a JSON file', 'error');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        
                        // Basic validation
                        if (!data || typeof data !== 'object') {
                            throw new Error('Invalid data format');
                        }
                        
                        // Check if it looks like our backup format
                        const expectedFields = ['expenses', 'monthlyBudget', 'version', 'syncTimestamp'];
                        const hasExpectedFields = expectedFields.some(field => data.hasOwnProperty(field));
                        
                        if (!hasExpectedFields) {
                            throw new Error('This doesn\'t appear to be a valid Expense Tracker backup file');
                        }
                        
                        if (confirm('This will replace all your current data. Are you sure you want to continue?')) {
                            if (this.importAllData(data)) {
                                showNotification('📥 Data imported successfully!', 'success');
                            } else {
                                showNotification('❌ Failed to import data - check console for details', 'error');
                            }
                        }
                    } catch (error) {
                        console.error('JSON parsing error:', error);
                        showNotification(`❌ Invalid file: ${error.message}`, 'error');
                    }
                };
                reader.onerror = () => {
                    showNotification('❌ Failed to read file', 'error');
                };
                reader.readAsText(file);
            }

            // Generate QR Code for data transfer
            generateQRCode() {
                const data = this.getAllData();
                const dataStr = JSON.stringify(data);
                
                // Clear previous QR code
                document.getElementById('qrcode').innerHTML = '';
                
                // Generate new QR code
                this.createQRCodeElement(dataStr);
                document.getElementById('qrModal').style.display = 'block';
            }

            // Generate QR code using a simple canvas-based implementation
            createQRCodeElement(data) {
                const qrContainer = document.getElementById('qrcode');
                
                // For large data, compress it first
                if (data.length > 2000) {
                    // Create a shorter version with essential data only
                    const compressedData = this.createCompressedData();
                    this.generateQRCodeCanvas(compressedData, qrContainer);
                } else {
                    this.generateQRCodeCanvas(data, qrContainer);
                }
                
                // Add download button as alternative
                const downloadBtn = document.createElement('button');
                downloadBtn.className = 'btn btn-secondary';
                downloadBtn.textContent = '📤 Download Backup Instead';
                downloadBtn.style.marginTop = '1rem';
                downloadBtn.onclick = () => this.exportData();
                qrContainer.appendChild(downloadBtn);
                
                // Add instructions
                const instructions = document.createElement('div');
                instructions.style.marginTop = '1rem';
                instructions.style.fontSize = '0.85rem';
                instructions.style.color = 'var(--text-secondary)';
                instructions.innerHTML = `
                    <p><strong>📱 How to use:</strong></p>
                    <ol>
                        <li>Open the app on your other device</li>
                        <li>Go to Settings → Data Sync → Scan QR Code</li>
                        <li>Point your camera at this QR code</li>
                        <li>Your data will be transferred!</li>
                    </ol>
                `;
                qrContainer.appendChild(instructions);
            }

            // Create ultra-compressed data for QR code
            createCompressedData() {
                const data = this.getAllData();
                
                // Ultra-light compression - only most essential data
                const compressed = {
                    e: (data.expenses?.slice(-10) || []).map(e => ({
                        a: e.amount, // amount
                        c: e.category?.substring(0, 10) || '', // category (truncated)
                        d: e.date,
                        p: e.person?.substring(0, 5) || '' // person (truncated)
                    })),
                    b: data.monthlyBudget || 0,
                    r: (data.recurringExpenses?.slice(0, 5) || []).map(r => ({
                        a: r.amount,
                        c: r.category?.substring(0, 8) || '',
                        f: r.frequency?.substring(0, 1) || '' // m/w/q/y
                    })),
                    v: '2' // Ultra-compressed version
                };
                
                return JSON.stringify(compressed);
            }

            // Generate QR code using inline implementation (no external libraries needed)
            async generateQRCodeCanvas(data, container) {
                try {
                    // Store data temporarily and create a short URL
                    const dataId = 'qr_' + Date.now();
                    const shortData = this.createCompressedData();
                    const shareableData = btoa(shortData);
                    
                    // Check if URL would be too long for QR code
                    let shareUrl = `${window.location.origin}${window.location.pathname}?import=${encodeURIComponent(shareableData)}`;
                    
                    console.log('QR URL length:', shareUrl.length);
                    
                    if (shareUrl.length > 800) {
                        // Try even more aggressive compression
                        const minimalData = JSON.stringify({
                            b: this.getAllData().monthlyBudget || 0,
                            e: Math.round((this.getAllData().expenses?.length || 0) / 10) * 10, // Expense count (rounded)
                            v: '3' // Minimal version
                        });
                        const minimalUrl = `${window.location.origin}${window.location.pathname}?import=${encodeURIComponent(btoa(minimalData))}`;
                        
                        if (minimalUrl.length > 600) {
                            // Still too long, use text-based fallback
                            this.showQRFallback(shareUrl, container, 'Data too large for QR code');
                            return;
                        } else {
                            // Use minimal data for QR
                            shareUrl = minimalUrl;
                        }
                    }
                    
                    // Generate QR code with shorter URL
                    const qrImageUrl = `https://api.qrserver.com/v1/create-qr-code/?size=256x256&format=png&data=${encodeURIComponent(shareUrl)}`;
                    
                    const qrImage = document.createElement('img');
                    qrImage.src = qrImageUrl;
                    qrImage.style.width = '256px';
                    qrImage.style.height = '256px';
                    qrImage.style.border = '1px solid var(--border-color)';
                    qrImage.style.borderRadius = '8px';
                    qrImage.style.display = 'block';
                    qrImage.style.margin = '0 auto';
                    qrImage.alt = 'QR Code for data sharing';
                    
                    // Handle image load success
                    qrImage.onload = () => {
                        // Add success message
                        const successMsg = document.createElement('div');
                        successMsg.style.marginTop = '1rem';
                        successMsg.style.padding = '0.5rem';
                        successMsg.style.background = 'var(--success-bg, #e8f5e8)';
                        successMsg.style.color = 'var(--success-text, #2d5f2d)';
                        successMsg.style.borderRadius = '8px';
                        successMsg.style.fontSize = '0.85rem';
                        successMsg.style.textAlign = 'center';
                        const compressionLevel = shareUrl.length > 400 ? 'minimal data (budget only)' : 'compressed data (recent expenses)';
                        successMsg.innerHTML = `✅ Scannable QR Code Generated!<br><small>Contains ${compressionLevel}</small>`;
                        container.appendChild(successMsg);
                    };
                    
                    // Handle image load error
                    qrImage.onerror = () => {
                        container.removeChild(qrImage);
                        this.showQRFallback(shareUrl, container, 'QR Code service unavailable');
                    };
                    
                    container.appendChild(qrImage);
                    
                    // Add data URL for manual sharing (with full data)
                    const fullData = this.getAllData();
                    const fullShareableData = btoa(JSON.stringify(fullData));
                    const fullShareUrl = `${window.location.origin}${window.location.pathname}?import=${encodeURIComponent(fullShareableData)}`;
                    this.addShareLinkSection(fullShareUrl, container);
                    
                } catch (error) {
                    console.error('QR Code generation error:', error);
                    const fallbackUrl = `${window.location.origin}${window.location.pathname}`;
                    this.showQRFallback(fallbackUrl, container, 'QR Code generation failed');
                }
            }

            // Add share link section
            addShareLinkSection(shareUrl, container) {
                const dataUrl = document.createElement('div');
                dataUrl.style.marginTop = '1rem';
                dataUrl.style.padding = '1rem';
                dataUrl.style.background = 'var(--bg-secondary)';
                dataUrl.style.borderRadius = '8px';
                dataUrl.style.fontSize = '0.8rem';
                dataUrl.style.wordBreak = 'break-all';
                
                dataUrl.innerHTML = `
                    <strong>📋 Alternative: Share this link</strong><br>
                    <textarea readonly style="width: 100%; height: 60px; margin-top: 0.5rem; resize: none; font-size: 0.7rem; color: var(--text-primary);">${shareUrl}</textarea>
                    <button class="btn btn-secondary" style="width: 100%; margin-top: 0.5rem;" onclick="navigator.clipboard.writeText('${shareUrl}').then(() => showNotification('📋 Link copied to clipboard!', 'success'))">📋 Copy Link</button>
                `;
                
                container.appendChild(dataUrl);
            }

            // Fallback when QR generation fails
            showQRFallback(shareUrl, container, errorMessage) {
                const fallbackDiv = document.createElement('div');
                fallbackDiv.style.padding = '2rem';
                fallbackDiv.style.textAlign = 'center';
                fallbackDiv.style.background = 'var(--bg-secondary)';
                fallbackDiv.style.borderRadius = '8px';
                
                fallbackDiv.innerHTML = `
                    <p>❌ ${errorMessage}</p>
                    <p style="margin: 1rem 0;">📋 Use this link to share your data:</p>
                    <textarea readonly style="width: 100%; height: 60px; margin: 0.5rem 0; font-size: 0.7rem; color: var(--text-primary);">${shareUrl}</textarea>
                    <button class="btn btn-primary" onclick="navigator.clipboard.writeText('${shareUrl}').then(() => showNotification('📋 Link copied!', 'success'))">📋 Copy Link</button>
                    <p style="margin-top: 1rem; font-size: 0.8rem; color: var(--text-secondary);">You can share this link via messaging, email, or any other method</p>
                `;
                
                container.appendChild(fallbackDiv);
            }



            // Update sync status display
            updateSyncStatus() {
                const statusCard = document.querySelector('.sync-status-card');
                const statusTitle = document.getElementById('syncStatusTitle');
                const statusText = document.getElementById('syncStatusText');
                const statusDetails = document.getElementById('syncStatusDetails');
                const toggleBtn = document.getElementById('toggleSyncBtn');

                if (!statusCard) return; // Elements not loaded yet

                if (this.syncEnabled) {
                    statusCard.classList.add('sync-connected');
                    statusTitle.textContent = '✅ Cloud Sync Active';
                    statusText.textContent = t('sync.dataIsSynchronized');
                    statusDetails.textContent = this.lastSync ? 
                        `Last sync: ${new Date(this.lastSync).toLocaleString()}` : 
                        'Last sync: Just now';
                    toggleBtn.textContent = 'Disable Sync';
                    toggleBtn.className = 'btn btn-warning';
                } else {
                    statusCard.classList.remove('sync-connected');
                    statusTitle.textContent = '🔄 Cloud Sync';
                    statusText.textContent = 'Sync your data across all devices instantly';
                    statusDetails.textContent = 'Status: Not configured';
                    toggleBtn.textContent = 'Setup Sync';
                    toggleBtn.className = 'btn btn-primary';
                }
            }
        }

        // Initialize sync manager
        let syncManager;

        // Sync utility functions
        function toggleSync() {
            if (syncManager) {
                if (syncManager.syncEnabled) {
                    syncManager.syncEnabled = false;
                    localStorage.removeItem('syncEnabled');
                    showNotification('⏸️ Sync disabled', 'info');
                } else {
                    document.getElementById('syncSetupModal').style.display = 'block';
                }
                syncManager.updateSyncStatus();
            }
        }

        function setupFirebaseSync() {
            // Check premium access for cloud sync
            if (window.premiumManager && !window.premiumManager.hasFeature('cloudSync')) {
                window.premiumManager.showPaywall('cloud_sync', 'Cloud sync requires a Premium subscription');
                closeSyncSetupModal();
                return;
            }
            
            // Firebase setup placeholder
            showNotification('☁️ Cloud sync coming soon! (Premium feature in development)', 'info');
            closeSyncSetupModal();
            
            /* Implementation placeholder:
            // Initialize Firebase
            const firebaseConfig = {
                // Config will be added when payment integration is ready
            };
            firebase.initializeApp(firebaseConfig);
            */
        }

        function setupLocalSync() {
            if (syncManager) {
                syncManager.syncEnabled = true;
                localStorage.setItem('syncEnabled', 'true');
                localStorage.setItem('syncType', 'local');
                syncManager.updateSyncStatus();
                showNotification('✅ Local sync mode enabled - Use Export/Import to transfer data', 'success');
            }
            closeSyncSetupModal();
        }

        function closeSyncSetupModal() {
            document.getElementById('syncSetupModal').style.display = 'none';
        }

        function closeQRModal() {
            document.getElementById('qrModal').style.display = 'none';
        }

        // Check for URL import parameter
        function checkURLImport() {
            const urlParams = new URLSearchParams(window.location.search);
            const importData = urlParams.get('import');
            
            if (importData) {
                try {
                    // Decode the base64 data
                    const decodedData = atob(decodeURIComponent(importData));
                    const parsedData = JSON.parse(decodedData);
                    
                    // Check if it's compressed data
                    if (parsedData.v === '1.0c' || parsedData.v === '2' || parsedData.v === '3') {
                        let expandedData;
                        
                        if (parsedData.v === '3') {
                            // Minimal version - just budget and expense count
                            expandedData = {
                                expenses: [],
                                monthlyBudget: parsedData.b || 0,
                                recurringExpenses: [],
                                version: '1.0',
                                syncTimestamp: new Date().toISOString(),
                                note: `QR Code contained budget: $${parsedData.b}, approx. ${parsedData.e} expenses`
                            };
                        } else if (parsedData.v === '2') {
                            // Ultra-compressed format
                            expandedData = {
                                expenses: (parsedData.e || []).map(e => ({
                                    id: Date.now() + Math.random(),
                                    amount: e.a,
                                    category: e.c,
                                    date: e.d,
                                    person: e.p,
                                    description: `${e.c} (from QR)`,
                                    timestamp: new Date().toISOString(),
                                    isRecurring: false
                                })),
                                monthlyBudget: parsedData.b || 0,
                                recurringExpenses: (parsedData.r || []).map(r => ({
                                    id: Date.now() + Math.random(),
                                    amount: r.a,
                                    category: r.c,
                                    frequency: r.f === 'm' ? 'monthly' : r.f === 'w' ? 'weekly' : r.f === 'q' ? 'quarterly' : 'yearly',
                                    isActive: true,
                                    description: `${r.c} (from QR)`,
                                    person: 'Family',
                                    startDate: new Date().toISOString().split('T')[0]
                                })),
                                version: '1.0',
                                syncTimestamp: new Date().toISOString()
                            };
                        } else {
                            // Old compressed format
                            expandedData = {
                                expenses: parsedData.e || [],
                                monthlyBudget: parsedData.b || 0,
                                recurringExpenses: parsedData.r || [],
                                version: '1.0',
                                syncTimestamp: new Date().toISOString()
                            };
                        }
                        
                        if (confirm('🔗 Data received from shared link! Import this data?\n\nThis will replace your current data.')) {
                            if (syncManager && syncManager.importAllData(expandedData)) {
                                showNotification('📱 Data imported from shared link!', 'success');
                                // Clean up URL
                                window.history.replaceState({}, document.title, window.location.pathname);
                            }
                        }
                    } else {
                        // Regular data format
                        if (confirm('🔗 Data received from shared link! Import this data?\n\nThis will replace your current data.')) {
                            if (syncManager && syncManager.importAllData(parsedData)) {
                                showNotification('📱 Data imported from shared link!', 'success');
                                // Clean up URL
                                window.history.replaceState({}, document.title, window.location.pathname);
                            }
                        }
                    }
                } catch (error) {
                    console.error('URL import error:', error);
                    showNotification('❌ Invalid shared link format', 'error');
                    // Clean up URL anyway
                    window.history.replaceState({}, document.title, window.location.pathname);
                }
            }
        }

        // QR Scanner functionality
        let qrScanner = null;

        function startQRScanner() {
            document.getElementById('qrScannerModal').style.display = 'block';
            initQRScanner();
        }

        function closeQRScanner() {
            if (qrScanner && qrScanner.stop) {
                qrScanner.stop();
                qrScanner = null;
            }
            document.getElementById('qrScannerModal').style.display = 'none';
        }

        async function initQRScanner() {
            try {
                const video = document.getElementById('qrVideo');
                
                // Get camera stream
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment' }
                });
                
                video.srcObject = stream;
                video.play();
                
                showNotification('📷 Camera ready! Use manual link paste option below for now', 'info');
                
                // Store stream for cleanup
                qrScanner = { stream, stop: () => stream.getTracks().forEach(track => track.stop()) };

            } catch (error) {
                console.error('Camera error:', error);
                showNotification('❌ Camera access denied. Use manual link option below.', 'error');
            }
        }

        function processQRResult(data) {
            try {
                // Check if it's a URL with import parameter
                if (data.includes('?import=') || data.includes('&import=')) {
                    const url = new URL(data);
                    const importData = url.searchParams.get('import');
                    
                    if (importData) {
                        closeQRScanner();
                        
                        // Decode and import
                        const decodedData = atob(decodeURIComponent(importData));
                        const parsedData = JSON.parse(decodedData);
                        
                        if (confirm('📱 QR Code scanned successfully! Import this data?\n\nThis will replace your current data.')) {
                            if (syncManager && syncManager.importAllData(parsedData)) {
                                showNotification('✅ Data imported from QR Code!', 'success');
                            }
                        }
                        return;
                    }
                }
                
                // Try to parse as direct JSON data
                const parsedData = JSON.parse(data);
                if (parsedData && typeof parsedData === 'object') {
                    closeQRScanner();
                    
                    if (confirm('📱 QR Code scanned successfully! Import this data?\n\nThis will replace your current data.')) {
                        if (syncManager && syncManager.importAllData(parsedData)) {
                            showNotification('✅ Data imported from QR Code!', 'success');
                        }
                    }
                    return;
                }
                
                // If not recognized format
                showNotification('❌ QR Code not recognized as expense data', 'error');
                
            } catch (error) {
                console.error('QR processing error:', error);
                showNotification('❌ Invalid QR Code format', 'error');
            }
        }

        function processManualQRInput() {
            const input = document.getElementById('manualQRInput');
            const url = input.value.trim();
            
            if (!url) {
                showNotification('❌ Please paste a shared link', 'error');
                return;
            }

            try {
                // Extract import parameter from URL
                const urlObj = new URL(url);
                const importData = urlObj.searchParams.get('import');
                
                if (!importData) {
                    showNotification('❌ Invalid link - no data found', 'error');
                    return;
                }

                // Decode and import
                const decodedData = atob(decodeURIComponent(importData));
                const parsedData = JSON.parse(decodedData);
                
                closeQRScanner();
                
                if (confirm('📱 Data found in link! Import this data?\n\nThis will replace your current data.')) {
                    if (syncManager && syncManager.importAllData(parsedData)) {
                        showNotification('📱 Data imported successfully!', 'success');
                        input.value = ''; // Clear input
                    }
                }
            } catch (error) {
                console.error('Manual QR input error:', error);
                showNotification('❌ Invalid link format', 'error');
            }
        }

        // Quick form population
        function showForm(category) {
            document.getElementById('category').value = category;
            document.getElementById('amount').focus();
        }

        // Clear all data
        function clearAllData() {
            if (confirm('Are you sure you want to clear all expenses and budget data? This action cannot be undone.')) {
                localStorage.removeItem('familyExpenses');
                localStorage.removeItem('monthlyBudget');
                expenses = [];
                monthlyBudget = 0;
                filteredExpenses = [];
                document.getElementById('monthlyBudget').value = '';
                updateDashboard();
                renderExpensesList();
                showNotification('All data cleared successfully', 'success');
            }
        }

        // Set monthly budget
        function setBudget() {
            const budgetInput = document.getElementById('monthlyBudget');
            const budget = parseFloat(budgetInput.value) || 0;
            
            if (budget < 0) {
                showNotification(t('notifications.budgetNegative'), 'error');
                return;
            }
            
            monthlyBudget = budget;
            localStorage.setItem('monthlyBudget', monthlyBudget);
            updateDashboard();
            showNotification(t('notifications.budgetUpdated'), 'success');
        }
        // Currency Functions
        function populateCurrencyDropdowns() {
            const currencySelect = document.getElementById('currency');
            const mainCurrencySelect = document.getElementById('mainCurrencySelect');
            const tripCurrencySelect = document.getElementById('newTripCurrency');
            const travelCurrencySelect = document.getElementById('travelCurrency');
            
            Object.keys(CURRENCIES).forEach(code => {
                const option = new Option(`${code} - ${CURRENCIES[code].name}`, code);
                currencySelect.appendChild(option.cloneNode(true));
                mainCurrencySelect.appendChild(option.cloneNode(true));
                if (tripCurrencySelect) {
                    tripCurrencySelect.appendChild(option.cloneNode(true));
                }
                if (travelCurrencySelect) {
                    travelCurrencySelect.appendChild(option.cloneNode(true));
                }
            });
            
            // Set default values
            currencySelect.value = mainCurrency;
            mainCurrencySelect.value = mainCurrency;
            if (tripCurrencySelect) {
                tripCurrencySelect.value = mainCurrency;
            }
            if (travelCurrencySelect) {
                // Default to current trip currency or main currency
                travelCurrencySelect.value = (currentTrip && currentTrip.currency) || mainCurrency;
            }
            updateBudgetCurrencySymbol();
        }
        
        function updateBudgetCurrencySymbol() {
            const symbol = CURRENCIES[mainCurrency]?.symbol || mainCurrency;
            document.getElementById('budgetCurrencySymbol').textContent = symbol;
            
            // Update all currency displays
            document.querySelectorAll('[data-currency-display]').forEach(el => {
                el.textContent = symbol;
            });
        }
        
        function setCurrency() {
            const newCurrency = document.getElementById('mainCurrencySelect').value;
            if (newCurrency && newCurrency !== mainCurrency) {
                mainCurrency = newCurrency;
                localStorage.setItem('mainCurrency', mainCurrency);
                updateBudgetCurrencySymbol();
                showNotification(`Main currency set to ${newCurrency}`, 'success');
                
                // Update expense form currency dropdown default
                document.getElementById('currency').value = mainCurrency;
                
                // Refresh displays
                updateDashboard();
                filterAndRenderExpenses();
            }
        }
        
        let pendingExpenseData = null;
        
        function showExchangeRateModal(expenseCurrency, callback) {
            const rateKey = `${expenseCurrency}_${mainCurrency}`;
            const lastRate = exchangeRates[rateKey];
            
            document.getElementById('exchangeRatePrompt').innerHTML = 
                `Your expense is in <strong>${expenseCurrency}</strong> but your budget is in <strong>${mainCurrency}</strong>.<br>
                Please enter the exchange rate:`;
            
            document.getElementById('fromCurrency').textContent = expenseCurrency;
            document.getElementById('toCurrency').textContent = mainCurrency;
            
            if (lastRate) {
                document.getElementById('exchangeRateInput').value = lastRate;
                document.getElementById('lastRateHint').textContent = `Last used rate: ${lastRate}`;
            } else {
                document.getElementById('exchangeRateInput').value = '';
                document.getElementById('lastRateHint').textContent = 'Enter exchange rate';
            }
            
            document.getElementById('exchangeRateModal').style.display = 'block';
            document.getElementById('exchangeRateInput').focus();
            
            // Store callback
            window.exchangeRateCallback = callback;
        }
        
        function closeExchangeRateModal() {
            document.getElementById('exchangeRateModal').style.display = 'none';
            pendingExpenseData = null;
            window.exchangeRateCallback = null;
        }
        
        function confirmExchangeRate() {
            const rate = parseFloat(document.getElementById('exchangeRateInput').value);
            if (!rate || rate <= 0) {
                showNotification('Please enter a valid exchange rate', 'error');
                return;
            }
            
            const fromCurrency = document.getElementById('fromCurrency').textContent;
            const toCurrency = document.getElementById('toCurrency').textContent;
            const rateKey = `${fromCurrency}_${toCurrency}`;
            exchangeRates[rateKey] = rate;
            localStorage.setItem('exchangeRates', JSON.stringify(exchangeRates));
            
            // Track exchange rate history
            trackExchangeRateHistory(fromCurrency, toCurrency, rate);
            
            // Get callback before closing modal
            const callback = window.exchangeRateCallback;
            
            closeExchangeRateModal();
            
            if (callback) {
                // Execute callback after modal is closed
                setTimeout(() => callback(rate), 100);
            }
        }
        
        // Exchange rate history tracking
        let exchangeRateHistory = JSON.parse(localStorage.getItem('exchangeRateHistory')) || [];
        
        function trackExchangeRateHistory(fromCurrency, toCurrency, rate) {
            const entry = {
                from: fromCurrency,
                to: toCurrency,
                rate: rate,
                date: new Date().toISOString()
            };
            
            // Keep only last 50 entries
            exchangeRateHistory.unshift(entry);
            if (exchangeRateHistory.length > 50) {
                exchangeRateHistory = exchangeRateHistory.slice(0, 50);
            }
            
            localStorage.setItem('exchangeRateHistory', JSON.stringify(exchangeRateHistory));
            updateExchangeRateHistoryDisplay();
        }
        
        function updateExchangeRateHistoryDisplay() {
            const historyContainer = document.querySelector('.exchange-rate-list');
            if (!historyContainer) return;
            
            if (exchangeRateHistory.length === 0) {
                historyContainer.innerHTML = '<p style="color: var(--text-secondary); text-align: center;">No exchange rate history yet</p>';
                return;
            }
            
            const historyHtml = exchangeRateHistory.slice(0, 10).map(entry => {
                const date = new Date(entry.date);
                const dateStr = date.toLocaleDateString();
                const timeStr = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                
                return `
                    <div style="padding: 0.5rem; border-bottom: 1px solid var(--border-color);">
                        <strong>1 ${entry.from} = ${entry.rate} ${entry.to}</strong>
                        <br>
                        <small style="color: var(--text-secondary)">${dateStr} at ${timeStr}</small>
                    </div>
                `;
            }).join('');
            
            historyContainer.innerHTML = historyHtml;
        }
        
        function clearExchangeHistory() {
            if (confirm('Are you sure you want to clear all exchange rate history?')) {
                exchangeRateHistory = [];
                localStorage.removeItem('exchangeRateHistory');
                updateExchangeRateHistoryDisplay();
                showNotification('Exchange rate history cleared', 'success');
            }
        }
        
        function formatCurrencyAmount(amount, currency) {
            const symbol = CURRENCIES[currency]?.symbol || currency;
            return `${symbol}${amount.toFixed(2)}`;
        }
        
        function getConvertedAmount(amount, fromCurrency, toCurrency, rate) {
            if (fromCurrency === toCurrency) return amount;
            return amount * rate;
        }
        
        // Get the amount in main currency for calculations
        function getAmountInMainCurrency(expense) {
            if (!expense.currency || expense.currency === mainCurrency) {
                return expense.amount;
            }
            return expense.convertedAmount || expense.amount;
        }
        
        // Handle expense form submission
        function handleExpenseSubmit(e) {
            e.preventDefault();
            
            const amount = parseFloat(document.getElementById('amount').value);
            const category = document.getElementById('category').value;
            const person = document.getElementById('person').value;
            const description = document.getElementById('description').value;
            const date = document.getElementById('date').value;
            const currency = document.getElementById('currency').value;
            
            if (amount <= 0) {
                showNotification('Amount must be greater than 0', 'error');
                return;
            }
            
            const isRecurring = document.getElementById('isRecurring').checked;
            const recurringFrequency = document.getElementById('recurringFrequency').value;
            const recurringEndDate = document.getElementById('recurringEndDate').value;

            const isFixedCost = document.getElementById('isFixedCost') ? document.getElementById('isFixedCost').checked : isRecurring;
            
            const expense = {
                id: editingExpenseId || Date.now(),
                amount: amount,
                category: category,
                person: trackerType === 'personal' ? 'You' : person,
                description: description,
                date: date,
                currency: currency,
                timestamp: new Date().toISOString(),
                isRecurring: isRecurring,
                recurringFrequency: isRecurring ? recurringFrequency : null,
                recurringEndDate: isRecurring && recurringEndDate ? recurringEndDate : null,
                lastProcessedDate: isRecurring ? date : null,
                fixed: isFixedCost
            };
            
            // Check if currency conversion is needed
            if (currency !== mainCurrency) {
                showExchangeRateModal(currency, (rate) => {
                    expense.exchangeRate = rate;
                    expense.convertedAmount = getConvertedAmount(amount, currency, mainCurrency, rate);
                    saveExpense(expense);
                });
                return;
            } else {
                expense.convertedAmount = amount;
                saveExpense(expense);
            }
        }
        
        function saveExpense(expense) {
            if (editingExpenseId) {
                const index = expenses.findIndex(e => e.id === editingExpenseId);
                expenses[index] = expense;
                
                // Update recurring expense if it exists
                if (expense.isRecurring) {
                    const recurringIndex = recurringExpenses.findIndex(r => r.originalExpenseId === editingExpenseId);
                    if (recurringIndex !== -1) {
                        recurringExpenses[recurringIndex] = createRecurringTemplate(expense);
                        localStorage.setItem('recurringExpenses', JSON.stringify(recurringExpenses));
                    }
                }
                
                editingExpenseId = null;
                document.getElementById('cancelEdit').style.display = 'none';
                showNotification(t('notifications.expenseUpdated'), 'success');
            } else {
                expenses.push(expense);
                
                // Create recurring template if this is a recurring expense
                if (expense.isRecurring) {
                    const recurringTemplate = createRecurringTemplate(expense);
                    recurringExpenses.push(recurringTemplate);
                    localStorage.setItem('recurringExpenses', JSON.stringify(recurringExpenses));
                    showNotification(t('notifications.recurringCreated'), 'success');
                } else {
                    showNotification(t('notifications.expenseAdded'), 'success');
                }
            }
            
            localStorage.setItem('familyExpenses', JSON.stringify(expenses));
            filteredExpenses = [...expenses];
            updateDashboard();
            filterAndRenderExpenses(); // Use new pagination system
            resetForm();
            
            // Track expense added
            if (window.analytics) {
                window.analytics.trackExpenseAdded(expense.category, expense.amount);
            }
        }

        // Calculate total recurring expenses for the current month
        function calculateMonthlyRecurringTotal(month, year) {
            let total = 0;
            const currentDate = new Date();
            
            recurringExpenses.forEach(recurring => {
                if (!recurring.isActive) return;
                
                // Calculate how many times this recurring expense should have occurred this month
                const occurrences = calculateRecurringOccurrencesForMonth(recurring, month, year);
                total += recurring.amount * occurrences;
            });
            
            return total;
        }

        // Calculate how many times a recurring expense should occur in a given month
        function calculateRecurringOccurrencesForMonth(recurring, month, year) {
            // Use the most reliable date source available
            const baseDate = recurring.lastProcessedDate || recurring.startDate || recurring.date || new Date().toISOString().split('T')[0];
            const startDate = new Date(baseDate);
            const monthStart = new Date(year, month, 1);
            const monthEnd = new Date(year, month + 1, 0);
            const today = new Date();
            
            // Don't count future occurrences beyond today
            const endDate = monthEnd > today ? today : monthEnd;
            
            if (startDate > endDate) return 0;
            
            let count = 0;
            let currentDate = new Date(Math.max(startDate, monthStart));
            
            while (currentDate <= endDate) {
                count++;
                
                // Calculate next occurrence based on frequency
                switch (recurring.frequency) {
                    case 'daily':
                        currentDate.setDate(currentDate.getDate() + 1);
                        break;
                    case 'weekly':
                        currentDate.setDate(currentDate.getDate() + 7);
                        break;
                    case 'biweekly':
                        currentDate.setDate(currentDate.getDate() + 14);
                        break;
                    case 'monthly':
                        currentDate.setMonth(currentDate.getMonth() + 1);
                        break;
                    case 'quarterly':
                        currentDate.setMonth(currentDate.getMonth() + 3);
                        break;
                    case 'yearly':
                        currentDate.setFullYear(currentDate.getFullYear() + 1);
                        break;
                    default:
                        return count; // Exit if unknown frequency
                }
                
                // Check if end date is set and we've passed it
                if (recurring.endDate && currentDate > new Date(recurring.endDate)) {
                    break;
                }
            }
            
            return Math.max(0, count - 1); // Subtract 1 because we counted the first occurrence
        }

        // Auto-process all past recurring expenses for the current month
        function autoProcessPastRecurringExpenses() {
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            const today = new Date();
            let processedCount = 0;
            
            recurringExpenses.forEach(recurring => {
                if (!recurring.isActive) return;
                
                const baseDate = recurring.lastProcessedDate || recurring.startDate || recurring.date || new Date().toISOString().split('T')[0];
                let lastProcessed = new Date(baseDate);
                let nextDue = calculateNextDueDate(baseDate, recurring.frequency);
                
                // Process all overdue occurrences up to today
                while (nextDue <= today && nextDue.getMonth() === currentMonth && nextDue.getFullYear() === currentYear) {
                    // Check if this expense was already added
                    const existingExpense = expenses.find(e => 
                        e.parentRecurringId === recurring.id && 
                        e.date === nextDue.toISOString().split('T')[0]
                    );
                    
                    if (!existingExpense) {
                        // Create new expense for this occurrence
                        const newExpense = {
                            id: Date.now() + Math.random(),
                            amount: recurring.amount,
                            category: recurring.category,
                            person: recurring.person,
                            description: `${recurring.description} (Auto-recurring)`,
                            date: nextDue.toISOString().split('T')[0],
                            timestamp: new Date().toISOString(),
                            isRecurring: true,
                            recurringFrequency: recurring.frequency,
                            parentRecurringId: recurring.id,
                            fixed: recurring.fixed !== undefined ? recurring.fixed : true // Default recurring to fixed
                        };
                        
                        expenses.push(newExpense);
                        processedCount++;
                    }
                    
                    // Update last processed date
                    recurring.lastProcessedDate = nextDue.toISOString().split('T')[0];
                    
                    // Calculate next due date
                    nextDue = calculateNextDueDate(recurring.lastProcessedDate, recurring.frequency);
                    
                    // Safety check to prevent infinite loops
                    if (nextDue <= lastProcessed) break;
                    lastProcessed = nextDue;
                }
            });
            
            if (processedCount > 0) {
                // Save updated data
                localStorage.setItem('familyExpenses', JSON.stringify(expenses));
                localStorage.setItem('recurringExpenses', JSON.stringify(recurringExpenses));
                
                // Refresh display
                filteredExpenses = [...expenses];
                showNotification(`Auto-processed ${processedCount} past recurring expense(s)`, 'success');
            }
            
            return processedCount;
        }

        // Update dashboard statistics and charts
        function updateDashboard() {
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            const monthlyExpenses = expenses.filter(expense => {
                const expenseDate = new Date(expense.date);
                return expenseDate.getMonth() === currentMonth && expenseDate.getFullYear() === currentYear;
            });
            
            // Calculate total including recurring expenses that should be deducted
            const recurringTotal = calculateMonthlyRecurringTotal(currentMonth, currentYear);
            const expenseTotal = monthlyExpenses.reduce((total, expense) => total + getAmountInMainCurrency(expense), 0);
            const monthlyTotal = expenseTotal + recurringTotal;
            
            // Update budget display
            const currencySymbol = CURRENCIES[mainCurrency]?.symbol || mainCurrency;
            document.getElementById('budgetAmount').textContent = `${currencySymbol}${monthlyBudget.toFixed(2)}`;
            
            // Make monthly total clickable
            const monthlyTotalElement = document.getElementById('monthlyTotal');
            monthlyTotalElement.innerHTML = `<span style="cursor: pointer; text-decoration: underline;" onclick="showSpentBreakdownModal()">${currencySymbol}${monthlyTotal.toFixed(2)}</span>`;
            monthlyTotalElement.title = "Click to see detailed breakdown of spent amount";
            
            // Show breakdown if there are recurring expenses - make clickable
            const expenseCountElement = document.getElementById('expenseCount');
            if (recurringTotal > 0) {
                expenseCountElement.innerHTML = `
                    <span style="cursor: pointer; text-decoration: underline;" onclick="showExpenseDetailsModal()">${monthlyExpenses.length} expense${monthlyExpenses.length !== 1 ? 's' : ''}</span><br>
                    <span style="font-size: 0.8em; color: var(--text-secondary);">
                        Regular: ${currencySymbol}${expenseTotal.toFixed(2)} | Recurring: ${currencySymbol}${recurringTotal.toFixed(2)}
                    </span>
                `;
            } else {
                expenseCountElement.innerHTML = `<span style="cursor: pointer; text-decoration: underline;" onclick="showExpenseDetailsModal()">${monthlyExpenses.length} expense${monthlyExpenses.length !== 1 ? 's' : ''}</span>`;
            }
            expenseCountElement.title = "Click to see detailed breakdown of all expenses";
            
            // Update budget progress
            const budgetFill = document.getElementById('budgetFill');
            const budgetCard = document.getElementById('budgetCard');
            const budgetStatus = document.getElementById('budgetStatus');
            const progressText = document.getElementById('progressText');
            
            if (monthlyBudget > 0) {
                const percentage = Math.min((monthlyTotal / monthlyBudget) * 100, 100);
                budgetFill.style.width = `${percentage}%`;
                progressText.textContent = `${Math.round(percentage)}%`;
                
                const remaining = monthlyBudget - monthlyTotal;
                if (remaining >= 0) {
                    budgetStatus.innerHTML = `<span style="cursor: pointer; text-decoration: underline;" onclick="showRemainingBreakdownModal()">€${remaining.toFixed(2)} remaining</span>`;
                    budgetStatus.title = "Click to see remaining budget breakdown and upcoming recurring expenses";
                    budgetCard.classList.remove('budget-warning');
                } else {
                    budgetStatus.innerHTML = `<span style="cursor: pointer; text-decoration: underline;" onclick="showRemainingBreakdownModal()">€${Math.abs(remaining).toFixed(2)} over budget</span>`;
                    budgetStatus.title = "Click to see budget analysis and upcoming expenses";
                    budgetCard.classList.add('budget-warning');
                }
            } else {
                budgetFill.style.width = '0%';
                progressText.textContent = '0%';
                budgetStatus.textContent = 'Set your monthly budget';
            }
            
            // Update statistics
            const avgDaily = monthlyExpenses.length > 0 ? monthlyTotal / new Date().getDate() : 0;
            document.getElementById('avgDaily').textContent = `€${avgDaily.toFixed(2)}`;
            
            // Calculate weekly average
            const weeklyAvg = monthlyExpenses.length > 0 ? monthlyTotal / (new Date().getDate() / 7) : 0;
            document.getElementById('weeklyAvg').textContent = `€${weeklyAvg.toFixed(2)}`;
            
            // Calculate top category
            const categoryTotals = {};
            monthlyExpenses.forEach(expense => {
                categoryTotals[expense.category] = (categoryTotals[expense.category] || 0) + expense.amount;
            });
            
            let topCategory = '-';
            const categories = Object.keys(categoryTotals);
            if (categories.length > 0) {
                topCategory = categories.reduce((a, b) => 
                    categoryTotals[a] > categoryTotals[b] ? a : b);
            }
            document.getElementById('topCategory').textContent = topCategory;
            
            // Days left in month
            const today = new Date();
            const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
            const daysLeft = lastDay - today.getDate();
            document.getElementById('daysLeft').textContent = daysLeft;
            
            // Update budget projection
            const projection = calculateBudgetProjection();
            const projectedElement = document.getElementById('projectedSpend');
            const projectionCard = document.getElementById('projectionCard');
            
            projectedElement.textContent = `€${projection.totalProjected.toFixed(2)}`;
            
            // Color code based on budget status
            if (monthlyBudget > 0) {
                if (projection.totalProjected > monthlyBudget) {
                    projectionCard.style.background = 'var(--danger-gradient)';
                    projectionCard.style.color = 'white';
                } else if (projection.totalProjected > monthlyBudget * 0.8) {
                    projectionCard.style.background = 'var(--warning-gradient)';
                    projectionCard.style.color = 'white';
                } else {
                    projectionCard.style.background = 'var(--success-gradient)';
                    projectionCard.style.color = 'white';
                }
            }
            
            // Update chart
            updateExpenseChart(monthlyExpenses);
            
            // Update Fixed vs Variable chart
            updateFixedVariableChart(monthlyExpenses);
            
            // Update upcoming recurring expenses
            updateUpcomingRecurringExpenses();
            
            // Update new enhanced charts only if dashboard tab is active
            const dashboardTab = document.getElementById('dashboardTab');
            if (dashboardTab && dashboardTab.classList.contains('active')) {
                requestAnimationFrame(() => {
                    updateSpendingTrendChart();
                    updateCategoryBudgetChart();
                    updateCashFlowSummary();
                    generateSmartInsights();
                });
            }
        }

        // Update expense chart
        function updateExpenseChart(monthlyExpenses) {
            const ctx = document.getElementById('expenseChart').getContext('2d');
            
            // Calculate category totals with currency tracking
            const categoryTotals = {};
            const categoryOriginalAmounts = {}; // Track original amounts by currency
            
            monthlyExpenses.forEach(expense => {
                const category = expense.category;
                const convertedAmount = getAmountInMainCurrency(expense);
                
                categoryTotals[category] = (categoryTotals[category] || 0) + convertedAmount;
                
                // Track original amounts by currency for tooltips
                if (!categoryOriginalAmounts[category]) {
                    categoryOriginalAmounts[category] = {};
                }
                const currency = expense.currency || mainCurrency;
                if (!categoryOriginalAmounts[category][currency]) {
                    categoryOriginalAmounts[category][currency] = 0;
                }
                categoryOriginalAmounts[category][currency] += expense.amount;
            });
            
            const labels = Object.keys(categoryTotals);
            const data = Object.values(categoryTotals);
            const colors = [
                '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
                '#FF9F40', '#FF6384', '#C9CBCF', '#4BC0C0', '#FF6384', '#36A2EB'
            ];
            
            if (expenseChart) {
                expenseChart.destroy();
            }
            
            if (labels.length === 0) {
                return;
            }
            
            expenseChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors.slice(0, labels.length),
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const category = labels[context.dataIndex];
                                    const convertedAmount = context.parsed;
                                    const currencySymbol = CURRENCIES[mainCurrency]?.symbol || mainCurrency;
                                    
                                    let label = `${category}: ${currencySymbol}${convertedAmount.toFixed(2)}`;
                                    
                                    // Add original amounts if different currencies were used
                                    const originals = categoryOriginalAmounts[category];
                                    const currencyBreakdown = [];
                                    
                                    Object.entries(originals).forEach(([currency, amount]) => {
                                        if (currency !== mainCurrency) {
                                            const symbol = CURRENCIES[currency]?.symbol || currency;
                                            currencyBreakdown.push(`${symbol}${amount.toFixed(2)}`);
                                        }
                                    });
                                    
                                    if (currencyBreakdown.length > 0) {
                                        label += ` (includes: ${currencyBreakdown.join(', ')})`;
                                    }
                                    
                                    const total = data.reduce((a, b) => a + b, 0);
                                    const percentage = ((convertedAmount / total) * 100).toFixed(1);
                                    label += ` - ${percentage}%`;
                                    
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Update Fixed vs Variable chart
        let fixedVariableChart = null;
        function updateFixedVariableChart(monthlyExpenses) {
            const ctx = document.getElementById('fixedVariableChart').getContext('2d');
            
            // Calculate fixed and variable costs
            const fixedCosts = monthlyExpenses.filter(e => e.fixed).reduce((total, e) => total + e.amount, 0);
            const variableCosts = monthlyExpenses.filter(e => !e.fixed).reduce((total, e) => total + e.amount, 0);
            
            const labels = ['Fixed Costs', 'Variable Costs'];
            const data = [fixedCosts, variableCosts];
            const colors = ['#10b981', '#3b82f6'];
            
            if (fixedVariableChart) {
                fixedVariableChart.destroy();
            }
            
            if (fixedCosts === 0 && variableCosts === 0) {
                return;
            }
            
            fixedVariableChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors,
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true,
                                font: {
                                    size: 14
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${label}: €${value.toFixed(2)} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Update upcoming recurring expenses display
        function updateUpcomingRecurringExpenses() {
            const container = document.getElementById('upcomingRecurringList');
            
            // Get next 5 upcoming recurring expenses
            const upcomingExpenses = getUpcomingRecurringExpenses(5);
            
            if (upcomingExpenses.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; font-style: italic;">No upcoming recurring expenses</p>';
                return;
            }
            
            container.innerHTML = '';
            
            upcomingExpenses.forEach(item => {
                const itemElement = document.createElement('div');
                itemElement.className = 'upcoming-recurring-item';
                
                // Add special classes for urgency
                if (item.daysUntilDue < 0) {
                    itemElement.classList.add('upcoming-recurring-overdue');
                } else if (item.daysUntilDue <= 3) {
                    itemElement.classList.add('upcoming-recurring-due-soon');
                }
                
                const icon = categoryIcons[item.recurring.category] || '📝';
                
                itemElement.innerHTML = `
                    <div class="upcoming-recurring-info">
                        <div class="upcoming-recurring-title">${icon} ${escapeHtml(item.recurring.description)}</div>
                        <div class="upcoming-recurring-date">
                            ${item.daysUntilDue < 0 ? 
                                `Overdue by ${Math.abs(item.daysUntilDue)} day(s)` : 
                                item.daysUntilDue === 0 ? 
                                    'Due today' : 
                                    `Due in ${item.daysUntilDue} day(s)`
                            } • ${item.nextDue.toLocaleDateString()}
                        </div>
                    </div>
                    <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 0.5rem;">
                        <div class="upcoming-recurring-amount">€${item.recurring.amount.toFixed(2)}</div>
                        ${item.daysUntilDue <= 0 ? 
                            `<button class="btn btn-primary btn-sm" onclick="quickAddRecurring('${item.recurring.id}')" style="font-size: 0.7rem; padding: 0.25rem 0.5rem;">Add Now</button>` : 
                            ''
                        }
                    </div>
                `;
                
                container.appendChild(itemElement);
            });
        }

        // Get upcoming recurring expenses sorted by due date
        function getUpcomingRecurringExpenses(limit = 5) {
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Reset time to start of day for accurate comparison
            const upcomingList = [];
            
            recurringExpenses.forEach(recurring => {
                if (!recurring.isActive) return;
                
                // Use the startDate or lastProcessedDate, whichever is more recent
                const baseDate = recurring.lastProcessedDate || recurring.startDate || recurring.date;
                if (!baseDate) return;
                
                const nextDue = calculateNextDueDate(baseDate, recurring.frequency);
                const daysUntilDue = Math.ceil((nextDue - today) / (1000 * 60 * 60 * 24));
                
                // Include if it's due within the next 30 days or overdue
                if (daysUntilDue <= 30) {
                    upcomingList.push({
                        recurring: recurring,
                        nextDue: nextDue,
                        daysUntilDue: daysUntilDue
                    });
                }
            });
            
            // Sort by due date (overdue first, then by date)
            upcomingList.sort((a, b) => {
                // Overdue items first
                if (a.daysUntilDue < 0 && b.daysUntilDue >= 0) return -1;
                if (b.daysUntilDue < 0 && a.daysUntilDue >= 0) return 1;
                
                // Then by due date
                return a.nextDue - b.nextDue;
            });
            
            return upcomingList.slice(0, limit);
        }

        // Quick add a specific recurring expense
        function quickAddRecurring(recurringId) {
            const recurring = recurringExpenses.find(r => r.id === recurringId);
            if (!recurring) return;
            
            const nextDue = calculateNextDueDate(recurring.lastProcessedDate || recurring.startDate, recurring.frequency);
            
            // Create new expense
            const newExpense = {
                id: Date.now() + Math.random(),
                amount: recurring.amount,
                category: recurring.category,
                person: recurring.person,
                description: `${recurring.description} (Quick-added)`,
                date: nextDue.toISOString().split('T')[0],
                timestamp: new Date().toISOString(),
                isRecurring: true,
                recurringFrequency: recurring.frequency,
                parentRecurringId: recurring.id
            };
            
            expenses.push(newExpense);
            
            // Update last processed date
            recurring.lastProcessedDate = nextDue.toISOString().split('T')[0];
            
            // Save updated data
            localStorage.setItem('familyExpenses', JSON.stringify(expenses));
            localStorage.setItem('recurringExpenses', JSON.stringify(recurringExpenses));
            
            // Refresh display
            filteredExpenses = [...expenses];
            updateDashboard();
            filterAndRenderExpenses();
            
            showNotification(`Added recurring expense: ${recurring.description}`, 'success');
        }

        // Show projection modal with detailed breakdown
        function showProjectionModal() {
            const projection = calculateBudgetProjection();
            const content = document.getElementById('projectionContent');
            
            const budgetStatus = monthlyBudget > 0 ? 
                projection.budgetRemaining >= 0 ? 
                    `✅ Under budget by €${projection.budgetRemaining.toFixed(2)}` :
                    `⚠️ Over budget by €${Math.abs(projection.budgetRemaining).toFixed(2)}` :
                'No budget set';
                
            content.innerHTML = `
                <div style="display: grid; gap: 1.5rem;">
                    <div class="projection-summary">
                        <h3>📊 Monthly Projection Breakdown</h3>
                        <div style="display: grid; gap: 1rem; margin-top: 1rem;">
                            <div class="projection-row">
                                <span>💰 Current Spending:</span>
                                <strong>€${projection.currentSpent.toFixed(2)}</strong>
                            </div>
                            <div class="projection-row">
                                <span>📈 Projected Regular:</span>
                                <strong>€${projection.projectedRegular.toFixed(2)}</strong>
                            </div>
                            <div class="projection-row">
                                <span>🔄 Remaining Recurring:</span>
                                <strong>€${projection.remainingRecurring.toFixed(2)}</strong>
                            </div>
                            <hr style="border: 1px solid var(--border-color); margin: 0.5rem 0;">
                            <div class="projection-row" style="font-size: 1.1rem; font-weight: 600;">
                                <span>🔮 Total Projected:</span>
                                <strong>€${projection.totalProjected.toFixed(2)}</strong>
                            </div>
                            <div class="projection-row" style="color: ${projection.budgetRemaining >= 0 ? 'var(--success-color)' : 'var(--danger-color)'};">
                                <span>🎯 Budget Status:</span>
                                <strong>${budgetStatus}</strong>
                            </div>
                        </div>
                    </div>
                    
                    <div class="projection-insights">
                        <h3>💡 Smart Insights</h3>
                        <ul style="margin: 1rem 0; padding-left: 1.5rem; color: var(--text-secondary);">
                            <li>Daily average: €${projection.dailyAverage.toFixed(2)} (${projection.daysRemaining} days left)</li>
                            <li>Recommended daily budget: €${monthlyBudget > 0 ? ((monthlyBudget - projection.currentSpent - projection.remainingRecurring) / Math.max(1, projection.daysRemaining)).toFixed(2) : 'N/A'}</li>
                            <li>Track your spending to stay on budget!</li>
                        </ul>
                    </div>
                </div>
            `;
            
            document.getElementById('projectionModal').style.display = 'block';
        }

        function closeProjectionModal() {
            document.getElementById('projectionModal').style.display = 'none';
        }

        // Show detailed breakdown of all monthly spending
        function showSpentBreakdownModal() {
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            const monthlyExpenses = expenses.filter(expense => {
                const expenseDate = new Date(expense.date);
                return expenseDate.getMonth() === currentMonth && expenseDate.getFullYear() === currentYear;
            });

            const content = document.getElementById('spentBreakdownContent');
            
            if (monthlyExpenses.length === 0) {
                content.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                        <p>No expenses recorded for this month yet.</p>
                        <p style="margin-top: 1rem;">
                            <button class="btn btn-primary" onclick="closeSpentBreakdownModal(); showTab('mainTab')">Add Your First Expense</button>
                        </p>
                    </div>
                `;
                document.getElementById('spentBreakdownModal').style.display = 'block';
                return;
            }

            // Calculate category totals
            const categoryTotals = {};
            monthlyExpenses.forEach(expense => {
                categoryTotals[expense.category] = (categoryTotals[expense.category] || 0) + getAmountInMainCurrency(expense);
            });

            const total = monthlyExpenses.reduce((sum, expense) => sum + getAmountInMainCurrency(expense), 0);
            
            // Sort expenses by date (newest first)
            const sortedExpenses = [...monthlyExpenses].sort((a, b) => new Date(b.date) - new Date(a.date));

            let categoryHtml = '';
            Object.entries(categoryTotals)
                .sort(([,a], [,b]) => b - a)
                .forEach(([category, amount]) => {
                    const icon = categoryIcons[category] || '📝';
                    const percentage = ((amount / total) * 100).toFixed(1);
                    categoryHtml += `
                        <div class="category-row">
                            <span>${icon} ${category}</span>
                            <strong>€${amount.toFixed(2)} (${percentage}%)</strong>
                        </div>
                    `;
                });

            const expensesContainer = document.createElement('div');
            sortedExpenses.forEach(expense => {
                const icon = categoryIcons[expense.category] || '📝';
                const date = new Date(expense.date).toLocaleDateString();
                const isRecurring = expense.isRecurring || expense.parentRecurringId;
                
                const expenseDiv = document.createElement('div');
                expenseDiv.className = `expense-item ${isRecurring ? 'recurring-expense-item' : ''}`;
                expenseDiv.style.cursor = 'pointer';
                expenseDiv.title = 'Click to view/edit expense';
                expenseDiv.addEventListener('click', () => {
                    closeSpentBreakdownModal();
                    showExpenseDetailModal(expense.id);
                });
                
                expenseDiv.innerHTML = `
                    <div class="expense-info">
                        <div class="expense-description">
                            ${icon} ${escapeHtml(expense.description)}
                            ${isRecurring ? ' <span style="font-size: 0.8em; color: var(--primary-color);">🔄</span>' : ''}
                        </div>
                        <div class="expense-details">
                            ${expense.category} • ${expense.person} • ${date}
                        </div>
                    </div>
                    <div class="expense-amount">€${expense.amount.toFixed(2)}</div>
                `;
                
                expensesContainer.appendChild(expenseDiv);
            });
            const expensesHtml = expensesContainer.innerHTML;

            content.innerHTML = `
                <div style="max-height: 70vh; overflow-y: auto;">
                    <div class="category-summary">
                        <h3>📊 Spending by Category</h3>
                        ${categoryHtml}
                        <hr style="margin: 1rem 0; border: 1px solid var(--border-color);">
                        <div class="category-row" style="font-weight: 600; font-size: 1.1rem;">
                            <span>💰 Total Spent</span>
                            <strong>€${total.toFixed(2)}</strong>
                        </div>
                    </div>
                    
                    <div>
                        <h3>📋 All Expenses This Month (${monthlyExpenses.length} items)</h3>
                        <div style="max-height: 40vh; overflow-y: auto;">
                            ${expensesHtml}
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('spentBreakdownModal').style.display = 'block';
        }

        function closeSpentBreakdownModal() {
            document.getElementById('spentBreakdownModal').style.display = 'none';
        }

        // Show detailed breakdown of remaining budget and upcoming recurring expenses
        function showRemainingBreakdownModal() {
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            const monthlyExpenses = expenses.filter(expense => {
                const expenseDate = new Date(expense.date);
                return expenseDate.getMonth() === currentMonth && expenseDate.getFullYear() === currentYear;
            });

            const spent = monthlyExpenses.reduce((total, expense) => total + expense.amount, 0);
            const remaining = monthlyBudget - spent;
            const content = document.getElementById('remainingBreakdownContent');

            // Get upcoming recurring expenses for the rest of the month
            const upcomingRecurring = getUpcomingRecurringExpenses(10);
            const remainingRecurringTotal = upcomingRecurring.reduce((total, item) => total + item.recurring.amount, 0);

            // Calculate days left in month
            const today = new Date();
            const daysLeft = new Date(currentYear, currentMonth + 1, 0).getDate() - today.getDate();
            const dailyBudgetRemaining = daysLeft > 0 ? Math.max(0, remaining - remainingRecurringTotal) / daysLeft : 0;

            let upcomingHtml = '';
            if (upcomingRecurring.length > 0) {
                upcomingRecurring.forEach(item => {
                    const icon = categoryIcons[item.recurring.category] || '📝';
                    const urgencyClass = item.daysUntilDue <= 0 ? 'style="border-left-color: #ef4444;"' : 
                                       item.daysUntilDue <= 3 ? 'style="border-left-color: #f59e0b;"' : '';
                    
                    upcomingHtml += `
                        <div class="expense-item recurring-expense-item" ${urgencyClass}>
                            <div class="expense-info">
                                <div class="expense-description">
                                    ${icon} ${escapeHtml(item.recurring.description)}
                                </div>
                                <div class="expense-details">
                                    ${item.recurring.category} • 
                                    ${item.daysUntilDue <= 0 ? 
                                        `Overdue by ${Math.abs(item.daysUntilDue)} day(s)` : 
                                        item.daysUntilDue === 0 ? 'Due today' : 
                                        `Due in ${item.daysUntilDue} day(s)`} • 
                                    ${item.nextDue.toLocaleDateString()}
                                </div>
                            </div>
                            <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 0.5rem;">
                                <div class="expense-amount">€${item.recurring.amount.toFixed(2)}</div>
                                ${item.daysUntilDue <= 0 ? 
                                    `<button class="btn btn-primary btn-sm" onclick="quickAddRecurring('${item.recurring.id}'); closeRemainingBreakdownModal();" style="font-size: 0.7rem; padding: 0.25rem 0.5rem;">Add Now</button>` : 
                                    ''
                                }
                            </div>
                        </div>
                    `;
                });
            } else {
                upcomingHtml = '<p style="text-align: center; color: var(--text-secondary); font-style: italic; padding: 1rem;">No upcoming recurring expenses</p>';
            }

            const budgetStatus = remaining >= 0 ? 'positive' : 'negative';
            const statusColor = remaining >= 0 ? 'var(--success-color)' : 'var(--danger-color)';

            content.innerHTML = `
                <div style="max-height: 70vh; overflow-y: auto;">
                    <div class="budget-breakdown">
                        <h3>💰 <span data-i18n="insights.budgetAnalysis">Budget Analysis</span></h3>
                        <div class="projection-row">
                            <span data-i18n="insights.monthlyBudget">📊 Monthly Budget:</span>
                            <strong>€${monthlyBudget.toFixed(2)}</strong>
                        </div>
                        <div class="projection-row">
                            <span>💸 Already Spent:</span>
                            <strong>€${spent.toFixed(2)}</strong>
                        </div>
                        <hr style="margin: 0.5rem 0; border: 1px solid var(--border-color);">
                        <div class="projection-row" style="color: ${statusColor}; font-weight: 600;">
                            <span>${remaining >= 0 ? '💰' : '⚠️'} ${remaining >= 0 ? 'Remaining' : 'Over Budget'}:</span>
                            <strong>€${Math.abs(remaining).toFixed(2)}</strong>
                        </div>
                        ${remainingRecurringTotal > 0 ? `
                            <div class="projection-row">
                                <span>🔄 Upcoming Recurring:</span>
                                <strong>-€${remainingRecurringTotal.toFixed(2)}</strong>
                            </div>
                            <div class="projection-row" style="color: ${remaining - remainingRecurringTotal >= 0 ? 'var(--success-color)' : 'var(--danger-color)'};">
                                <span>📅 Available for Discretionary:</span>
                                <strong>€${(remaining - remainingRecurringTotal).toFixed(2)}</strong>
                            </div>
                        ` : ''}
                    </div>

                    <div class="remaining-section">
                        <h3>📅 Daily Budget Guidance</h3>
                        <div style="background: var(--card-bg); padding: 1rem; border-radius: var(--border-radius); border: 1px solid var(--border-color);">
                            <p style="margin: 0; color: var(--text-secondary);">
                                <strong>${daysLeft} days left</strong> in this month<br>
                                Recommended daily spending: <strong style="color: var(--primary-color);">€${dailyBudgetRemaining.toFixed(2)}</strong>
                                ${dailyBudgetRemaining < 10 ? ' <span style="color: var(--danger-color);">⚠️ Budget carefully!</span>' : ''}
                            </p>
                        </div>
                    </div>

                    <div class="remaining-section">
                        <h3>🔄 Upcoming Recurring Expenses</h3>
                        <div style="max-height: 30vh; overflow-y: auto;">
                            ${upcomingHtml}
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('remainingBreakdownModal').style.display = 'block';
        }

        function closeRemainingBreakdownModal() {
            document.getElementById('remainingBreakdownModal').style.display = 'none';
        }
        // Show expense detail view modal
        let currentExpenseDetail = null;
        let budgetImpactChart = null;

        function showExpenseDetailModal(expenseId) {
            const expense = expenses.find(e => e.id === expenseId);
            if (!expense) return;
            
            currentExpenseDetail = expense;
            
            // Update basic information
            document.getElementById('expenseDetailTitle').textContent = `${categoryIcons[expense.category] || '📝'} ${expense.category} Details`;
            document.getElementById('detailCategory').textContent = expense.category;
            
            // Format amount with currency
            const expenseCurrency = expense.currency || mainCurrency;
            let amountText = '';
            
            // Show amounts based on currency
            if (expenseCurrency === mainCurrency) {
                amountText = formatCurrencyAmount(expense.amount, mainCurrency);
            } else {
                // Show converted amount as primary
                const convertedAmount = expense.convertedAmount || expense.amount;
                amountText = formatCurrencyAmount(convertedAmount, mainCurrency);
                
                // Show original amount and exchange rate
                amountText += `\n(${formatCurrencyAmount(expense.amount, expenseCurrency)})`;
                if (expense.exchangeRate) {
                    amountText += `\n💱 Rate: 1 ${expenseCurrency} = ${expense.exchangeRate} ${mainCurrency}`;
                }
            }
            
            document.getElementById('detailAmount').textContent = amountText;
            document.getElementById('detailPerson').textContent = expense.person;
            document.getElementById('detailDescription').textContent = expense.description || 'No description';
            document.getElementById('detailDate').textContent = new Date(expense.date).toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            // Update tags
            const tagsContainer = document.getElementById('detailTags');
            tagsContainer.innerHTML = '';
            
            if (expense.isRecurring) {
                const recurringTag = document.createElement('span');
                recurringTag.className = 'recurring-indicator';
                recurringTag.textContent = '🔁 Recurring';
                tagsContainer.appendChild(recurringTag);
            }
            
            if (expense.fixed) {
                const fixedTag = document.createElement('span');
                fixedTag.className = 'fixed-cost-indicator';
                fixedTag.textContent = '💰 Fixed Cost';
                tagsContainer.appendChild(fixedTag);
            }
            
            // Update next payment (for recurring expenses)
            const nextPaymentDiv = document.getElementById('detailNextPayment');
            if (expense.isRecurring && expense.recurringFrequency) {
                const nextDate = calculateNextDueDate(
                    expense.lastProcessedDate || expense.date,
                    expense.recurringFrequency
                );
                document.getElementById('nextPaymentDate').textContent = nextDate.toLocaleDateString('en-US', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                nextPaymentDiv.style.display = 'flex';
            } else {
                nextPaymentDiv.style.display = 'none';
            }
            
            // Load payment history
            loadPaymentHistory(expense);
            
            // Load budget impact chart
            loadBudgetImpactChart(expense);
            
            // Setup action buttons
            document.getElementById('detailEditBtn').onclick = () => {
                closeExpenseDetailModal();
                editExpense(expense.id);
            };
            
            document.getElementById('detailDeleteBtn').onclick = () => {
                if (confirm('Are you sure you want to delete this expense?')) {
                    deleteExpense(expense.id);
                    closeExpenseDetailModal();
                }
            };
            
            // Show modal
            document.getElementById('expenseDetailModal').style.display = 'block';
        }

        // Close expense detail modal
        function closeExpenseDetailModal() {
            document.getElementById('expenseDetailModal').style.display = 'none';
            if (budgetImpactChart) {
                budgetImpactChart.destroy();
                budgetImpactChart = null;
            }
            currentExpenseDetail = null;
        }

        // Load payment history for the expense
        function loadPaymentHistory(expense) {
            const timeline = document.getElementById('paymentHistoryTimeline');
            timeline.innerHTML = '';
            
            // Find all related expenses (same category, person, and description)
            const relatedExpenses = expenses.filter(e => 
                e.category === expense.category &&
                e.person === expense.person &&
                (e.description === expense.description || 
                 (expense.parentRecurringId && e.parentRecurringId === expense.parentRecurringId) ||
                 (expense.isRecurring && e.parentRecurringId === expense.id))
            ).sort((a, b) => new Date(b.date) - new Date(a.date));
            
            if (relatedExpenses.length === 0) {
                timeline.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">No payment history available</p>';
                return;
            }
            
            // Create timeline items
            relatedExpenses.forEach((payment, index) => {
                const timelineItem = document.createElement('div');
                timelineItem.className = 'timeline-item';
                if (payment.id === expense.id) {
                    timelineItem.style.background = 'rgba(66, 133, 244, 0.05)';
                    timelineItem.style.borderRadius = '8px';
                    timelineItem.style.marginLeft = '-0.5rem';
                    timelineItem.style.paddingLeft = '2.5rem';
                }
                
                const content = document.createElement('div');
                content.className = 'timeline-content';
                
                const dateSpan = document.createElement('span');
                dateSpan.className = 'timeline-date';
                const paymentDate = new Date(payment.date);
                dateSpan.textContent = paymentDate.toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric'
                });
                if (payment.id === expense.id) {
                    dateSpan.innerHTML += ' <span style="color: var(--primary-color); font-size: 0.8rem;">(Current)</span>';
                }
                
                const amountSpan = document.createElement('span');
                amountSpan.className = 'timeline-amount';
                amountSpan.textContent = `€${payment.amount.toFixed(2)}`;
                
                content.appendChild(dateSpan);
                content.appendChild(amountSpan);
                timelineItem.appendChild(content);
                timeline.appendChild(timelineItem);
            });
        }

        // Load budget impact chart
        function loadBudgetImpactChart(expense) {
            const ctx = document.getElementById('budgetImpactChart').getContext('2d');
            
            // Destroy existing chart if any
            if (budgetImpactChart) {
                budgetImpactChart.destroy();
            }
            
            // Prepare data for the last 6 months
            const months = [];
            const expenseAmounts = [];
            const budgetAmounts = [];
            const percentages = [];
            
            const today = new Date();
            for (let i = 5; i >= 0; i--) {
                const date = new Date(today.getFullYear(), today.getMonth() - i, 1);
                const month = date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                months.push(month);
                
                // Calculate expense amount for this month
                const monthExpenses = expenses.filter(e => {
                    const expDate = new Date(e.date);
                    return expDate.getMonth() === date.getMonth() && 
                           expDate.getFullYear() === date.getFullYear() &&
                           e.category === expense.category &&
                           e.person === expense.person &&
                           (e.description === expense.description || 
                            (expense.parentRecurringId && e.parentRecurringId === expense.parentRecurringId));
                });
                
                const monthAmount = monthExpenses.reduce((sum, e) => sum + e.amount, 0);
                expenseAmounts.push(monthAmount);
                
                // Get budget for this month (use current budget as estimate)
                const monthlyBudget = parseFloat(localStorage.getItem('monthlyBudget')) || 0;
                budgetAmounts.push(monthlyBudget);
                
                // Calculate percentage
                const percentage = monthlyBudget > 0 ? (monthAmount / monthlyBudget) * 100 : 0;
                percentages.push(percentage.toFixed(1));
            }
            
            // Check if Chart.js is available
            if (typeof Chart === 'undefined') {
                // If Chart.js is not loaded, show a simple text visualization
                const chartContainer = document.querySelector('.chart-container');
                chartContainer.innerHTML = `
                    <div style="padding: 2rem; text-align: center; background: var(--hover-bg); border-radius: 8px;">
                        <h4 style="margin-bottom: 1rem;">Budget Impact (Last 6 Months)</h4>
                        <div style="display: grid; gap: 0.5rem; text-align: left; max-width: 300px; margin: 0 auto;">
                            ${months.map((month, i) => `
                                <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: var(--card-bg); border-radius: 4px;">
                                    <span>${month}</span>
                                    <span style="font-weight: 600; color: var(--danger-color);">€${expenseAmounts[i].toFixed(2)}</span>
                                    <span style="font-size: 0.85rem; color: var(--text-secondary);">${percentages[i]}%</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            } else {
                // Create chart with Chart.js
                budgetImpactChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: months,
                        datasets: [{
                            label: 'Expense Amount',
                            data: expenseAmounts,
                            backgroundColor: 'rgba(239, 68, 68, 0.8)',
                            borderColor: 'rgba(239, 68, 68, 1)',
                            borderWidth: 2,
                            yAxisID: 'y-amount'
                        }, {
                            label: 'Monthly Budget',
                            data: budgetAmounts,
                            type: 'line',
                            backgroundColor: 'rgba(66, 133, 244, 0.2)',
                            borderColor: 'rgba(66, 133, 244, 1)',
                            borderWidth: 2,
                            pointRadius: 4,
                            pointBackgroundColor: 'rgba(66, 133, 244, 1)',
                            yAxisID: 'y-amount'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false,
                        },
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            tooltip: {
                                callbacks: {
                                    afterLabel: function(context) {
                                        if (context.datasetIndex === 0) {
                                            return `${percentages[context.dataIndex]}% of budget`;
                                        }
                                    }
                                }
                            }
                        },
                        scales: {
                            'y-amount': {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                ticks: {
                                    callback: function(value) {
                                        return '€' + value.toFixed(0);
                                    }
                                }
                            },
                            x: {
                                display: true
                            }
                        }
                    }
                });
            }
            
            // Update insights
            updateBudgetInsights(expense, expenseAmounts, percentages);
        }

        // Update budget insights
        function updateBudgetInsights(expense, amounts, percentages) {
            const insightsDiv = document.getElementById('budgetInsights');
            
            const avgAmount = amounts.reduce((sum, amt) => sum + amt, 0) / amounts.filter(amt => amt > 0).length || 0;
            const avgPercentage = percentages.reduce((sum, pct) => sum + parseFloat(pct), 0) / percentages.filter(pct => parseFloat(pct) > 0).length || 0;
            const maxAmount = Math.max(...amounts);
            const trend = amounts[5] > amounts[0] ? 'increasing' : amounts[5] < amounts[0] ? 'decreasing' : 'stable';
            
            insightsDiv.innerHTML = `
                <div class="insight-item">
                    <span class="insight-value">€${avgAmount.toFixed(2)}</span>
                    <span class="insight-label">Average Monthly</span>
                </div>
                <div class="insight-item">
                    <span class="insight-value">${avgPercentage.toFixed(1)}%</span>
                    <span class="insight-label">Avg Budget Impact</span>
                </div>
                <div class="insight-item">
                    <span class="insight-value">€${maxAmount.toFixed(2)}</span>
                    <span class="insight-label">Highest Amount</span>
                </div>
                <div class="insight-item">
                    <span class="insight-value">${trend === 'increasing' ? '📈' : trend === 'decreasing' ? '📉' : '➡️'} ${trend}</span>
                    <span class="insight-label">Trend</span>
                </div>
            `;
        }

        // Show detailed expense breakdown focusing on what expenses are for
        function showExpenseDetailsModal() {
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            const monthlyExpenses = expenses.filter(expense => {
                const expenseDate = new Date(expense.date);
                return expenseDate.getMonth() === currentMonth && expenseDate.getFullYear() === currentYear;
            });

            const content = document.getElementById('expenseDetailsContent');
            
            if (monthlyExpenses.length === 0) {
                content.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                        <p>No expenses recorded for this month yet.</p>
                        <p style="margin-top: 1rem;">
                            <button class="btn btn-primary" onclick="closeExpenseDetailsModal(); showTab('mainTab')">Add Your First Expense</button>
                        </p>
                    </div>
                `;
                document.getElementById('expenseDetailsModal').style.display = 'block';
                return;
            }

            // Group expenses by category for better organization
            const expensesByCategory = {};
            monthlyExpenses.forEach(expense => {
                if (!expensesByCategory[expense.category]) {
                    expensesByCategory[expense.category] = [];
                }
                expensesByCategory[expense.category].push(expense);
            });

            // Calculate totals
            const total = monthlyExpenses.reduce((sum, expense) => sum + expense.amount, 0);
            const regularExpenses = monthlyExpenses.filter(e => !e.isRecurring && !e.parentRecurringId);
            const recurringExpenses = monthlyExpenses.filter(e => e.isRecurring || e.parentRecurringId);

            // Create category sections
            let categorySectionsHtml = '';
            Object.entries(expensesByCategory)
                .sort(([,a], [,b]) => b.reduce((sum, e) => sum + e.amount, 0) - a.reduce((sum, e) => sum + e.amount, 0))
                .forEach(([category, categoryExpenses]) => {
                    const categoryTotal = categoryExpenses.reduce((sum, e) => sum + e.amount, 0);
                    const percentage = ((categoryTotal / total) * 100).toFixed(1);
                    const icon = categoryIcons[category] || '📝';
                    
                    // Sort expenses within category by date (newest first)
                    const sortedCategoryExpenses = [...categoryExpenses].sort((a, b) => new Date(b.date) - new Date(a.date));
                    
                    let expensesHtml = '';
                    sortedCategoryExpenses.forEach(expense => {
                        const date = new Date(expense.date).toLocaleDateString();
                        const isRecurring = expense.isRecurring || expense.parentRecurringId;
                        
                        expensesHtml += `
                            <div class="expense-detail-item ${isRecurring ? 'recurring-expense-item' : ''}">
                                <div class="expense-detail-info">
                                    <div class="expense-detail-description">
                                        ${escapeHtml(expense.description)}
                                        ${isRecurring ? ' <span style="font-size: 0.8em; color: var(--primary-color);">🔄</span>' : ''}
                                    </div>
                                    <div class="expense-detail-meta">
                                        ${expense.person} • ${date}
                                    </div>
                                </div>
                                <div class="expense-detail-amount">€${expense.amount.toFixed(2)}</div>
                            </div>
                        `;
                    });

                    categorySectionsHtml += `
                        <div class="category-section">
                            <div class="category-header">
                                <h4>${icon} ${category}</h4>
                                <div class="category-total">
                                    €${categoryTotal.toFixed(2)} (${percentage}%)
                                </div>
                            </div>
                            <div class="category-expenses">
                                ${expensesHtml}
                            </div>
                        </div>
                    `;
                });

            // Summary stats
            const summaryHtml = `
                <div class="expense-summary">
                    <h3>📊 Monthly Overview</h3>
                    <div class="summary-stats">
                        <div class="summary-stat">
                            <span class="summary-label">Total Expenses:</span>
                            <span class="summary-value">€${total.toFixed(2)}</span>
                        </div>
                        <div class="summary-stat">
                            <span class="summary-label">Regular Expenses:</span>
                            <span class="summary-value">${regularExpenses.length} items (€${regularExpenses.reduce((sum, e) => sum + e.amount, 0).toFixed(2)})</span>
                        </div>
                        <div class="summary-stat">
                            <span class="summary-label">Recurring Expenses:</span>
                            <span class="summary-value">${recurringExpenses.length} items (€${recurringExpenses.reduce((sum, e) => sum + e.amount, 0).toFixed(2)})</span>
                        </div>
                        <div class="summary-stat">
                            <span class="summary-label">Categories:</span>
                            <span class="summary-value">${Object.keys(expensesByCategory).length} different</span>
                        </div>
                        <div class="summary-stat">
                            <span class="summary-label">Daily Average:</span>
                            <span class="summary-value">€${(total / new Date().getDate()).toFixed(2)}</span>
                        </div>
                    </div>
                </div>
            `;

            content.innerHTML = `
                <div style="max-height: 70vh; overflow-y: auto;">
                    ${summaryHtml}
                    
                    <div class="expenses-by-category">
                        <h3>📋 Expenses by Category</h3>
                        ${categorySectionsHtml}
                    </div>
                </div>
            `;

            document.getElementById('expenseDetailsModal').style.display = 'block';
        }

        function closeExpenseDetailsModal() {
            document.getElementById('expenseDetailsModal').style.display = 'none';
        }

        // Smart budget projection - predict monthly spending based on current trends
        function calculateBudgetProjection() {
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            const today = new Date();
            const dayOfMonth = today.getDate();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            
            // Calculate current month's spending
            const monthlyExpenses = expenses.filter(expense => {
                const expenseDate = new Date(expense.date);
                return expenseDate.getMonth() === currentMonth && expenseDate.getFullYear() === currentYear;
            });
            
            const currentSpent = monthlyExpenses.reduce((total, expense) => total + expense.amount, 0);
            
            // Calculate remaining recurring expenses for the month
            let remainingRecurring = 0;
            recurringExpenses.forEach(recurring => {
                if (!recurring.isActive) return;
                
                let checkDate = new Date(today);
                checkDate.setDate(checkDate.getDate() + 1);
                
                while (checkDate.getMonth() === currentMonth) {
                    const nextDue = calculateNextDueDate(recurring.lastProcessedDate || recurring.startDate, recurring.frequency);
                    if (nextDue.getMonth() === currentMonth && nextDue.getFullYear() === currentYear && nextDue >= checkDate) {
                        remainingRecurring += recurring.amount;
                    }
                    checkDate.setDate(checkDate.getDate() + 1);
                }
            });
            
            // Project based on current daily average
            const dailyAverage = currentSpent / dayOfMonth;
            const remainingDays = daysInMonth - dayOfMonth;
            const projectedRegular = dailyAverage * remainingDays;
            
            const totalProjected = currentSpent + projectedRegular + remainingRecurring;
            
            return {
                currentSpent,
                projectedRegular,
                remainingRecurring,
                totalProjected,
                daysRemaining: remainingDays,
                dailyAverage,
                budgetRemaining: monthlyBudget - totalProjected
            };
        }

        // HTML escape function to prevent XSS
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, function(m) { return map[m]; });
        }

        // Render expenses list (enhanced with search highlighting and pagination)
        function renderExpensesList(expensesToRender = null) {
            const expensesList = document.getElementById('expensesList');
            const expenses = expensesToRender || filteredExpenses;
            
            if (expenses.length === 0) {
                let message = 'No expenses found';
                if (searchTerm) {
                    message = `No expenses found matching "${searchTerm}"`;
                } else if (currentViewMode === 'recent') {
                    message = 'No expenses in the last 30 days';
                } else {
                    message = 'No expenses added yet. Add your first expense above!';
                }
                const noExpensesDiv = document.createElement('div');
                noExpensesDiv.className = 'no-expenses';
                noExpensesDiv.textContent = message;
                expensesList.innerHTML = '';
                expensesList.appendChild(noExpensesDiv);
                return;
            }
            
            // Sort expenses by date (newest first)
            const sortedExpenses = [...expenses].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // Clear existing content
            expensesList.innerHTML = '';
            
            // Create expense items securely
            sortedExpenses.forEach(expense => {
                const expenseElement = createExpenseElement(expense);
                expensesList.appendChild(expenseElement);
            });
        }

        // Secure function to create expense DOM elements
        function createExpenseElement(expense) {
            const icon = categoryIcons[expense.category] || '📝';
            const formattedDate = new Date(expense.date).toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric'
            });
            
            // Create main container
            const expenseDiv = document.createElement('div');
            expenseDiv.className = 'expense-item-enhanced slide-in-right';
            
            // Create details section
            const detailsDiv = document.createElement('div');
            detailsDiv.className = 'expense-details';
            detailsDiv.style.cursor = 'pointer';
            detailsDiv.title = 'Click to view/edit expense';
            detailsDiv.addEventListener('click', () => showExpenseDetailModal(expense.id));
            
            // Create main section
            const mainDiv = document.createElement('div');
            mainDiv.className = 'expense-main';
            
            // Icon
            const iconDiv = document.createElement('div');
            iconDiv.className = 'expense-category-icon';
            iconDiv.textContent = icon;
            
            // Category and description
            const contentDiv = document.createElement('div');
            const categoryStrong = document.createElement('strong');
            
            // Apply search highlighting safely
            const safeCategory = escapeHtml(expense.category);
            const highlightedCategory = highlightSearchTerms(safeCategory, searchTerm);
            categoryStrong.innerHTML = highlightedCategory;
            contentDiv.appendChild(categoryStrong);
            
            if (expense.description) {
                const safeDescription = escapeHtml(expense.description);
                const highlightedDescription = highlightSearchTerms(safeDescription, searchTerm);
                const descSpan = document.createElement('span');
                descSpan.innerHTML = ` - ${highlightedDescription}`;
                contentDiv.appendChild(descSpan);
            }
            
            if (expense.isRecurring) {
                const recurringSpan = document.createElement('span');
                recurringSpan.className = 'recurring-indicator';

                let frequency = expense.recurringFrequency;
                let lastDate = expense.lastProcessedDate || expense.date;

                // If this expense was generated from a recurring template, fall back to that template for date info
                if ((!frequency || !lastDate) && expense.parentRecurringId) {
                    const parent = recurringExpenses.find(r => r.id === expense.parentRecurringId);
                    if (parent) {
                        frequency = parent.frequency;
                        lastDate = parent.lastProcessedDate;
                    }
                }

                if (frequency && lastDate) {
                    const nextDue = calculateNextDueDate(lastDate, frequency);
                    recurringSpan.textContent = `🔄 Recurring • Next: ${nextDue.toLocaleDateString()}`;
                } else {
                    recurringSpan.textContent = '🔄 Recurring';
                }

                contentDiv.appendChild(recurringSpan);
            }

            // Add Fixed Cost badge
            if (expense.fixed) {
                const fixedSpan = document.createElement('span');
                fixedSpan.className = 'fixed-cost-indicator';
                fixedSpan.textContent = '💰 Fixed Cost';
                contentDiv.appendChild(fixedSpan);
            }
            
            mainDiv.appendChild(iconDiv);
            mainDiv.appendChild(contentDiv);
            
            // Meta section
            const metaDiv = document.createElement('div');
            metaDiv.className = 'expense-meta';
            
            const personSpan = document.createElement('span');
            const safePerson = escapeHtml(expense.person);
            const highlightedPerson = highlightSearchTerms(safePerson, searchTerm);
            personSpan.innerHTML = `👤 ${highlightedPerson}`;
            
            const dateSpan = document.createElement('span');
            const highlightedDate = highlightSearchTerms(formattedDate, searchTerm);
            dateSpan.innerHTML = `📅 ${highlightedDate}`;
            
            metaDiv.appendChild(personSpan);
            metaDiv.appendChild(dateSpan);
            
            detailsDiv.appendChild(mainDiv);
            detailsDiv.appendChild(metaDiv);
            
            // Amount section
            const amountDiv = document.createElement('div');
            amountDiv.className = 'expense-amount';
            
            // Format amount with currency
            const expenseCurrency = expense.currency || mainCurrency;
            
            let amountHtml = '';
            
            // If expense is in main currency, just show the amount
            if (expenseCurrency === mainCurrency) {
                amountHtml = highlightSearchTerms(formatCurrencyAmount(expense.amount, mainCurrency), searchTerm);
            } else {
                // If different currency, show converted amount as main display
                const convertedAmount = expense.convertedAmount || expense.amount;
                amountHtml = highlightSearchTerms(formatCurrencyAmount(convertedAmount, mainCurrency), searchTerm);
                
                // Show original amount as secondary info
                const originalAmount = formatCurrencyAmount(expense.amount, expenseCurrency);
                amountHtml += `<br><small style="opacity: 0.7;">(${highlightSearchTerms(originalAmount, searchTerm)})</small>`;
            }
            
            amountDiv.innerHTML = amountHtml;
            
            // Actions section
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'expense-actions';
            
            const editBtn = document.createElement('button');
            editBtn.className = 'btn btn-warning';
            editBtn.title = 'Edit expense';
            editBtn.textContent = '✏️';
            editBtn.addEventListener('click', () => editExpense(expense.id));
            
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'btn btn-danger';
            deleteBtn.title = 'Delete expense';
            deleteBtn.textContent = '🗑️';
            deleteBtn.addEventListener('click', () => deleteExpense(expense.id));
            
            actionsDiv.appendChild(editBtn);
            actionsDiv.appendChild(deleteBtn);
            
            // Assemble final element
            expenseDiv.appendChild(detailsDiv);
            expenseDiv.appendChild(amountDiv);
            expenseDiv.appendChild(actionsDiv);
            
            return expenseDiv;
        }

        // Filter expenses (updated for new features)
        function filterExpenses() {
            currentPage = 1; // Reset pagination when filters change
            filterAndRenderExpenses();
        }

        // Edit expense (enhanced with recurring support)
        function editExpense(id) {
            const expense = expenses.find(e => e.id === id);
            if (!expense) return;
            
            document.getElementById('amount').value = expense.amount;
            document.getElementById('category').value = expense.category;
            document.getElementById('person').value = expense.person;
            document.getElementById('description').value = expense.description;
            document.getElementById('date').value = expense.date;
            
            // Handle recurring options
            if (expense.isRecurring) {
                document.getElementById('isRecurring').checked = true;
                document.getElementById('recurringOptions').style.display = 'block';
                document.getElementById('recurringFrequency').value = expense.recurringFrequency || 'monthly';
                document.getElementById('recurringEndDate').value = expense.recurringEndDate || '';
                // Handle fixed cost toggle
                if (document.getElementById('isFixedCost')) {
                    document.getElementById('isFixedCost').checked = expense.fixed !== undefined ? expense.fixed : true;
                }
            } else {
                document.getElementById('isRecurring').checked = false;
                document.getElementById('recurringOptions').style.display = 'none';
            }
            
            editingExpenseId = id;
            document.getElementById('cancelEdit').style.display = 'inline-flex';
            
            // Scroll to form
            document.querySelector('.expense-form').scrollIntoView({ behavior: 'smooth' });
            showNotification('Editing expense...', 'success');
        }

        // Cancel edit
        function cancelEdit() {
            editingExpenseId = null;
            document.getElementById('cancelEdit').style.display = 'none';
            document.getElementById('expenseForm').reset();
            document.getElementById('date').valueAsDate = new Date();
            document.getElementById('isRecurring').checked = false;
            document.getElementById('recurringOptions').style.display = 'none';
            if (document.getElementById('isFixedCost')) {
                document.getElementById('isFixedCost').checked = true; // Reset to default
            }
            showNotification('Edit cancelled', 'success');
        }

        // Delete expense
        function deleteExpense(id) {
            if (confirm('Are you sure you want to delete this expense?')) {
                expenses = expenses.filter(e => e.id !== id);
                            filteredExpenses = filteredExpenses.filter(e => e.id !== id);
            localStorage.setItem('familyExpenses', JSON.stringify(expenses));
            updateDashboard();
            filterAndRenderExpenses(); // Use new pagination system
            showNotification(t('notifications.expenseDeleted'), 'success');
            }
        }

        // Export to CSV
        function exportToCSV() {
            const headers = ['Date', 'Amount', 'Category', 'Person', 'Description'];
            const rows = filteredExpenses.map(expense => [
                expense.date,
                expense.amount.toFixed(2),
                expense.category,
                expense.person,
                expense.description || ''
            ]);
            
            let csvContent = headers.join(',') + '\n';
            rows.forEach(row => {
                csvContent += row.map(field => `"${field}"`).join(',') + '\n';
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `expenses_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            
            showNotification('Expenses exported to CSV successfully!', 'success');
        }

        // Export to JSON
        function exportToJSON() {
            const exportData = {
                version: "1.0",
                exportDate: new Date().toISOString(),
                expenses: filteredExpenses,
                recurringExpenses: recurringExpenses,
                monthlyBudget: monthlyBudget,
                customCategories: customCategories,
                metadata: {
                    totalExpenses: filteredExpenses.length,
                    dateRange: {
                        from: filteredExpenses.length > 0 ? filteredExpenses[filteredExpenses.length - 1].date : null,
                        to: filteredExpenses.length > 0 ? filteredExpenses[0].date : null
                    }
                }
            };
            
            const jsonString = JSON.stringify(exportData, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `expenses_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showNotification('Expenses exported to JSON successfully!', 'success');
        }

        // Export to Excel (Premium Feature)
        function exportToExcel() {
            // Check premium access
            if (!window.premiumManager || !window.premiumManager.canExportExcel()) {
                if (window.premiumManager) {
                    window.premiumManager.showPaywall('excel_export', 'Excel export requires a Premium subscription');
                } else {
                    showNotification('Excel export is a premium feature (in progress)', 'warning');
                }
                return;
            }

            // Check if XLSX library is loaded
            if (typeof XLSX === 'undefined') {
                // Load XLSX library dynamically
                showNotification('Loading Excel export library...', 'info');
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js';
                script.onload = () => {
                    performExcelExport();
                };
                script.onerror = () => {
                    showNotification('Failed to load Excel export library', 'error');
                };
                document.head.appendChild(script);
            } else {
                performExcelExport();
            }
        }
        
        // Perform the actual Excel export
        function performExcelExport() {
            try {
                // Prepare data for export
                const exportData = filteredExpenses.map(expense => ({
                    Date: new Date(expense.date).toLocaleDateString(),
                    Category: expense.category,
                    Amount: expense.amount,
                    Currency: '€',
                    Person: expense.person,
                    Description: expense.description || '-',
                    Type: expense.isRecurring ? 'Recurring' : 'One-time',
                    'Fixed Cost': expense.fixed ? 'Yes' : 'No'
                }));

                // Create workbook and worksheet
                const ws = XLSX.utils.json_to_sheet(exportData);
                const wb = XLSX.utils.book_new();
                
                // Add column widths
                ws['!cols'] = [
                    { wch: 12 }, // Date
                    { wch: 15 }, // Category
                    { wch: 10 }, // Amount
                    { wch: 8 },  // Currency
                    { wch: 15 }, // Person
                    { wch: 30 }, // Description
                    { wch: 12 }, // Type
                    { wch: 10 }  // Fixed Cost
                ];
                
                XLSX.utils.book_append_sheet(wb, ws, "Expenses");
                
                // Add summary sheet
                const totalAmount = filteredExpenses.reduce((sum, e) => sum + e.amount, 0);
                const summaryData = [
                    { Metric: 'Total Expenses', Value: filteredExpenses.length },
                    { Metric: 'Total Amount', Value: `€${totalAmount.toFixed(2)}` },
                    { Metric: 'Average Expense', Value: `€${(totalAmount / filteredExpenses.length || 0).toFixed(2)}` },
                    { Metric: 'Monthly Budget', Value: `€${parseFloat(localStorage.getItem('monthlyBudget') || 0).toFixed(2)}` },
                    { Metric: 'Export Date', Value: new Date().toLocaleDateString() }
                ];
                
                const summaryWs = XLSX.utils.json_to_sheet(summaryData);
                summaryWs['!cols'] = [{ wch: 20 }, { wch: 20 }];
                XLSX.utils.book_append_sheet(wb, summaryWs, "Summary");
                
                // Generate filename and download
                const filename = `expense_tracker_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, filename);
                
                showNotification('✅ Expenses exported to Excel successfully!', 'success');
            } catch (error) {
                console.error('Excel export error:', error);
                showNotification('❌ Failed to export to Excel. Please try again.', 'error');
            }
        }

        // Export to PDF (Premium Feature)
        function exportToPDF() {
            // Check premium access
            if (!window.premiumManager || !window.premiumManager.canExportPDF()) {
                if (window.premiumManager) {
                    window.premiumManager.showPaywall('pdf_export', 'PDF export requires a Premium subscription');
                } else {
                    showNotification('PDF export is a premium feature (in progress)', 'warning');
                }
                return;
            }

            // Check if jsPDF library is loaded
            if (typeof jspdf === 'undefined' || !window.jspdf) {
                // Load jsPDF library dynamically
                showNotification('Loading PDF export library...', 'info');
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js';
                script.onload = () => {
                    // Load autotable plugin after jsPDF is loaded
                    const tableScript = document.createElement('script');
                    tableScript.src = 'https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.31/dist/jspdf.plugin.autotable.min.js';
                    tableScript.onload = () => {
                        performPDFExport();
                    };
                    tableScript.onerror = () => {
                        showNotification('Failed to load PDF table plugin', 'error');
                    };
                    document.head.appendChild(tableScript);
                };
                script.onerror = () => {
                    showNotification('Failed to load PDF export library', 'error');
                };
                document.head.appendChild(script);
            } else {
                performPDFExport();
            }
        }
        
        // Perform the actual PDF export
        function performPDFExport() {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Add title
                doc.setFontSize(20);
                doc.text('Expense Report', 14, 20);
                
                // Add metadata
                doc.setFontSize(12);
                const totalAmount = filteredExpenses.reduce((sum, e) => sum + e.amount, 0);
                doc.text(`Generated: ${new Date().toLocaleDateString()}`, 14, 30);
                doc.text(`Total Expenses: ${filteredExpenses.length}`, 14, 37);
                doc.text(`Total Amount: €${totalAmount.toFixed(2)}`, 14, 44);
                doc.text(`Monthly Budget: €${parseFloat(localStorage.getItem('monthlyBudget') || 0).toFixed(2)}`, 14, 51);
                
                // Prepare table data
                const tableData = filteredExpenses.map(expense => [
                    new Date(expense.date).toLocaleDateString(),
                    expense.category,
                    `€${expense.amount.toFixed(2)}`,
                    expense.person,
                    expense.description || '-',
                    expense.isRecurring ? '🔁' : '-',
                    expense.fixed ? '✓' : '-'
                ]);
                
                // Add table with autotable
                doc.autoTable({
                    head: [['Date', 'Category', 'Amount', 'Person', 'Description', 'Recurring', 'Fixed']],
                    body: tableData,
                    startY: 60,
                    theme: 'striped',
                    headStyles: {
                        fillColor: [66, 133, 244],
                        textColor: 255,
                        fontSize: 10,
                        fontStyle: 'bold'
                    },
                    bodyStyles: {
                        fontSize: 9
                    },
                    columnStyles: {
                        0: { cellWidth: 25 },  // Date
                        1: { cellWidth: 30 },  // Category
                        2: { cellWidth: 20 },  // Amount
                        3: { cellWidth: 25 },  // Person
                        4: { cellWidth: 50 },  // Description
                        5: { cellWidth: 20 },  // Recurring
                        6: { cellWidth: 15 }   // Fixed
                    }
                });
                
                // Add category summary
                const categoryTotals = {};
                filteredExpenses.forEach(expense => {
                    categoryTotals[expense.category] = (categoryTotals[expense.category] || 0) + expense.amount;
                });
                
                const finalY = doc.lastAutoTable.finalY || 60;
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text('Summary by Category:', 14, finalY + 15);
                doc.setFont(undefined, 'normal');
                doc.setFontSize(10);
                
                let yPos = finalY + 25;
                Object.entries(categoryTotals)
                    .sort((a, b) => b[1] - a[1])
                    .forEach(([category, total]) => {
                        const percentage = ((total / totalAmount) * 100).toFixed(1);
                        doc.text(`${category}: €${total.toFixed(2)} (${percentage}%)`, 14, yPos);
                        yPos += 7;
                    });
                
                // Save the PDF
                const filename = `expense_report_${new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(filename);
                
                showNotification('✅ Expense report exported to PDF successfully!', 'success');
            } catch (error) {
                console.error('PDF export error:', error);
                showNotification('❌ Failed to export to PDF. Please try again.', 'error');
            }
        }

        // Dark mode toggle
        function toggleDarkMode() {
            const isDarkMode = document.getElementById('darkModeToggle').checked;
            document.body.classList.toggle('dark-mode', isDarkMode);
            localStorage.setItem('darkMode', isDarkMode);
            
            if (isDarkMode) {
                showNotification('Dark mode enabled 🌙', 'success');
            } else {
                showNotification('Light mode enabled ☀️', 'success');
            }
        }

        // Scroll to form function
        function scrollToForm() {
            document.querySelector('.expense-form').scrollIntoView({ 
                behavior: 'smooth',
                block: 'center'
            });
            document.getElementById('amount').focus();
        }

        // Show insights modal
        function showInsights() {
            generateInsights();
            document.getElementById('insightsModal').style.display = 'block';
        }

        // Close insights modal
        function closeInsights() {
            document.getElementById('insightsModal').style.display = 'none';
        }

        // Generate spending insights
        function generateInsights() {
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            const monthlyExpenses = expenses.filter(expense => {
                const expenseDate = new Date(expense.date);
                return expenseDate.getMonth() === currentMonth && expenseDate.getFullYear() === currentYear;
            });

            const recommendations = document.getElementById('recommendations');
            const trends = document.getElementById('trends');

            // Generate recommendations
            let recommendationText = '';
            if (monthlyExpenses.length === 0) {
                recommendationText = '💡 ' + t('insights.startTracking');
            } else {
                const monthlyTotal = monthlyExpenses.reduce((total, expense) => total + expense.amount, 0);
                const avgDaily = monthlyTotal / new Date().getDate();
                
                if (monthlyBudget > 0) {
                    const budgetUsed = (monthlyTotal / monthlyBudget) * 100;
                    if (budgetUsed > 80) {
                        recommendationText = '⚠️ ' + t('insights.over80Budget');
                    } else if (budgetUsed < 50) {
                        recommendationText = '✅ ' + t('insights.wellWithinBudget');
                    } else {
                        recommendationText = '📊 ' + t('insights.onTrackBudget');
                    }
                } else {
                    recommendationText = '🎯 ' + t('insights.setBudgetForInsights');
                }

                // Category-based recommendations
                const categoryTotals = {};
                monthlyExpenses.forEach(expense => {
                    categoryTotals[expense.category] = (categoryTotals[expense.category] || 0) + expense.amount;
                });

                const topCategory = Object.keys(categoryTotals).reduce((a, b) => 
                    categoryTotals[a] > categoryTotals[b] ? a : b, '');
                
                if (topCategory && categoryTotals[topCategory] > monthlyTotal * 0.4) {
                    recommendationText += `<br><br>💰 ${t('insights.categoryHighSpending', { category: topCategory })}`;
                }
                
                // Fixed vs Variable costs analysis
                const fixedCosts = monthlyExpenses.filter(e => e.fixed).reduce((total, e) => total + e.amount, 0);
                const variableCosts = monthlyTotal - fixedCosts;
                const fixedCostPercentage = monthlyTotal > 0 ? (fixedCosts / monthlyTotal) * 100 : 0;
                
                recommendationText += `<br><br>💰 <strong>Fixed vs Variable Costs:</strong><br>`;
                recommendationText += `Fixed Costs: €${fixedCosts.toFixed(2)} (${fixedCostPercentage.toFixed(1)}%)<br>`;
                recommendationText += `Variable Costs: €${variableCosts.toFixed(2)} (${(100 - fixedCostPercentage).toFixed(1)}%)`;
                
                if (fixedCostPercentage > 70) {
                    recommendationText += `<br><br>⚠️ Your fixed costs are high (${fixedCostPercentage.toFixed(1)}%). Consider reviewing recurring expenses to increase financial flexibility.`;
                } else if (fixedCostPercentage < 50) {
                    recommendationText += `<br><br>✅ Good balance! Your fixed costs are manageable, giving you flexibility in spending.`;
                }
            }

            recommendations.innerHTML = recommendationText;

            // Generate trends
            let trendsText = '';
            if (monthlyExpenses.length >= 5) {
                const last7Days = monthlyExpenses.filter(expense => {
                    const expenseDate = new Date(expense.date);
                    const today = new Date();
                    const diffTime = Math.abs(today - expenseDate);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    return diffDays <= 7;
                });

                const recentTotal = last7Days.reduce((total, expense) => total + expense.amount, 0);
                const recentAvg = recentTotal / 7;
                const monthlyAvg = monthlyExpenses.reduce((total, expense) => total + expense.amount, 0) / new Date().getDate();

                if (recentAvg > monthlyAvg * 1.2) {
                    trendsText = '📈 ' + t('insights.spendingIncreased');
                } else if (recentAvg < monthlyAvg * 0.8) {
                    trendsText = '📉 ' + t('insights.spendingDecreased');
                } else {
                    trendsText = '📊 ' + t('insights.spendingConsistent');
                }

                // Most active day
                const dayTotals = {};
                monthlyExpenses.forEach(expense => {
                    const day = new Date(expense.date).toLocaleDateString('en-US', { weekday: 'long' });
                    dayTotals[day] = (dayTotals[day] || 0) + expense.amount;
                });

                const mostActiveDay = Object.keys(dayTotals).reduce((a, b) => 
                    dayTotals[a] > dayTotals[b] ? a : b, '');

                if (mostActiveDay) {
                    trendsText += `<br><br>📅 ${mostActiveDay} is your most expensive day of the week.`;
                }
            } else {
                trendsText = '📊 ' + t('insights.addMoreExpenses');
            }

            trends.innerHTML = trendsText;
        }

        // Enhanced form validation
        function validateExpenseForm() {
            const amount = parseFloat(document.getElementById('amount').value);
            const category = document.getElementById('category').value;
            const person = document.getElementById('person').value;
            const date = document.getElementById('date').value;

            if (!amount || amount <= 0) {
                showNotification('Please enter a valid amount greater than 0', 'error');
                return false;
            }

            if (amount > 10000) {
                if (!confirm('This is a large amount (€' + amount.toFixed(2) + '). Are you sure this is correct?')) {
                    return false;
                }
            }

            if (!category) {
                showNotification('Please select a category', 'error');
                return false;
            }

            // Only validate person if not personal tracker
            if (trackerType !== 'personal' && !person) {
                const personType = trackerType === 'family' ? 'family member' : 'group member';
                showNotification(`Please select a ${personType}`, 'error');
                return false;
            }

            if (!date) {
                showNotification('Please select a date', 'error');
                return false;
            }

            // Check if date is in the future
            const selectedDate = new Date(date);
            const today = new Date();
            today.setHours(23, 59, 59, 999); // Set to end of today

            if (selectedDate > today) {
                if (!confirm('The selected date is in the future. Do you want to continue?')) {
                    return false;
                }
            }

            return true;
        }

        // Auto-save functionality
        let autoSaveTimer;
        function autoSave() {
            clearTimeout(autoSaveTimer);
            autoSaveTimer = setTimeout(() => {
                const formData = {
                    amount: document.getElementById('amount').value,
                    category: document.getElementById('category').value,
                    person: document.getElementById('person').value,
                    date: document.getElementById('date').value,
                    description: document.getElementById('description').value
                };
                
                if (formData.amount || formData.category || formData.person || formData.description) {
                    localStorage.setItem('expenseFormDraft', JSON.stringify(formData));
                }
            }, 1000);
        }

        // Load draft on page load
        function loadDraft() {
            const draft = localStorage.getItem('expenseFormDraft');
            if (draft) {
                const formData = JSON.parse(draft);
                document.getElementById('amount').value = formData.amount || '';
                document.getElementById('category').value = formData.category || '';
                document.getElementById('person').value = formData.person || '';
                document.getElementById('date').value = formData.date || new Date().toISOString().split('T')[0];
                document.getElementById('description').value = formData.description || '';
                
                if (formData.amount || formData.category || formData.person || formData.description) {
                    showNotification('Draft restored from previous session', 'success');
                }
            }
        }

        // Clear draft
        function clearDraft() {
            localStorage.removeItem('expenseFormDraft');
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl/Cmd + N: Focus on new expense form
            if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
                e.preventDefault();
                scrollToForm();
            }
            
            // Ctrl/Cmd + I: Show insights
            if ((e.ctrlKey || e.metaKey) && e.key === 'i') {
                e.preventDefault();
                showInsights();
            }
            
            // Ctrl/Cmd + R: Show recurring expenses
            if ((e.ctrlKey || e.metaKey) && e.key === 'r') {
                e.preventDefault();
                showRecurringModal();
            }
            
            // Ctrl/Cmd + D: Switch to dashboard
            if ((e.ctrlKey || e.metaKey) && e.key === 'd') {
                e.preventDefault();
                document.querySelector('.nav-tab[onclick*="dashboard"]').click();
            }
            
            // Ctrl/Cmd + 1: Switch to main tab
            if ((e.ctrlKey || e.metaKey) && e.key === '1') {
                e.preventDefault();
                document.querySelector('.nav-tab[onclick*="main"]').click();
            }
            
            // Ctrl/Cmd + 2: Switch to dashboard tab
            if ((e.ctrlKey || e.metaKey) && e.key === '2') {
                e.preventDefault();
                document.querySelector('.nav-tab[onclick*="dashboard"]').click();
            }
            
            // Ctrl/Cmd + 3: Switch to settings tab
            if ((e.ctrlKey || e.metaKey) && e.key === '3') {
                e.preventDefault();
                document.querySelector('.nav-tab[onclick*="settings"]').click();
            }
            
            // Escape: Close modal
            if (e.key === 'Escape') {
                closeInsights();
                closeRecurringModal();
            }
        });

        // Update the form submission to include validation
        const originalHandleExpenseSubmit = handleExpenseSubmit;
        handleExpenseSubmit = function(e) {
            e.preventDefault();
            
            if (!validateExpenseForm()) {
                return;
            }
            
            // Clear draft after successful submission
            clearDraft();
            
            // Call original function
            originalHandleExpenseSubmit.call(this, e);
        };

        // Add auto-save listeners
        document.addEventListener('DOMContentLoaded', function() {
            loadDraft();
            
            // Add auto-save to form inputs
            document.querySelectorAll('#expenseForm input, #expenseForm select').forEach(input => {
                input.addEventListener('input', autoSave);
                input.addEventListener('change', autoSave);
            });
        });

        // Custom Categories Functions
        function loadCustomCategories() {
            const categorySelect = document.getElementById('category');
            const categoryFilter = document.getElementById('categoryFilter');
            
            // Remove existing custom categories
            const customOptions = categorySelect.querySelectorAll('.custom-category');
            customOptions.forEach(option => option.remove());
            
            const customFilterOptions = categoryFilter.querySelectorAll('.custom-category');
            customFilterOptions.forEach(option => option.remove());
            
            // Add custom categories
            customCategories.forEach(category => {
                // Add to main select
                const option = document.createElement('option');
                option.value = category.name;
                option.textContent = `${category.icon} ${category.name}`;
                option.className = 'custom-category';
                categorySelect.insertBefore(option, categorySelect.querySelector('option[value="__ADD_NEW__"]'));
                
                // Add to filter select
                const filterOption = document.createElement('option');
                filterOption.value = category.name;
                filterOption.textContent = `${category.icon} ${category.name}`;
                filterOption.className = 'custom-category';
                categoryFilter.appendChild(filterOption);
                
                // Add to category icons mapping
                categoryIcons[category.name] = category.icon;
            });
        }

        function handleCategoryChange() {
            const categorySelect = document.getElementById('category');
            const customCategoryGroup = document.getElementById('customCategoryGroup');
            
            if (categorySelect.value === '__ADD_NEW__') {
                customCategoryGroup.style.display = 'block';
                document.getElementById('customCategory').focus();
            } else {
                customCategoryGroup.style.display = 'none';
            }
        }
        function addCustomCategory() {
            const nameInput = document.getElementById('customCategory');
            const iconInput = document.getElementById('customCategoryIcon');
            const categoryName = nameInput.value.trim();
            const categoryIcon = iconInput.value.trim() || '🏷️';
            
            if (!categoryName) {
                showNotification('Please enter a category name', 'error');
                return;
            }
            
            // Check if category already exists
            const existingCategory = customCategories.find(cat => cat.name.toLowerCase() === categoryName.toLowerCase());
            if (existingCategory) {
                showNotification('Category already exists', 'error');
                return;
            }
            
            // Add new custom category
            const newCategory = {
                name: categoryName,
                icon: categoryIcon,
                id: Date.now()
            };
            
            customCategories.push(newCategory);
            localStorage.setItem('customCategories', JSON.stringify(customCategories));
            
            // Reload categories in selects
            loadCustomCategories();
            
            // Select the new category
            document.getElementById('category').value = categoryName;
            
            // Hide custom category input
            cancelCustomCategory();
            
            showNotification(`Category "${categoryName}" added successfully!`, 'success');
        }

        function cancelCustomCategory() {
            document.getElementById('customCategoryGroup').style.display = 'none';
            document.getElementById('category').value = '';
            document.getElementById('customCategory').value = '';
            document.getElementById('customCategoryIcon').value = '';
        }

        function deleteCustomCategory(categoryName) {
            if (confirm(`Are you sure you want to delete the category "${categoryName}"?`)) {
                customCategories = customCategories.filter(cat => cat.name !== categoryName);
                localStorage.setItem('customCategories', JSON.stringify(customCategories));
                loadCustomCategories();
                showNotification(`Category "${categoryName}" deleted`, 'success');
            }
        }

        // Recurring Expenses Functions
        function toggleRecurringOptions() {
            const isRecurring = document.getElementById('isRecurring').checked;
            const recurringOptions = document.getElementById('recurringOptions');
            
            recurringOptions.style.display = isRecurring ? 'block' : 'none';
        }

        function createRecurringTemplate(expense) {
            return {
                id: Date.now(),
                originalExpenseId: expense.id,
                amount: expense.amount,
                category: expense.category,
                person: expense.person,
                description: expense.description,
                frequency: expense.recurringFrequency,
                startDate: expense.date,
                endDate: expense.recurringEndDate,
                lastProcessedDate: expense.date,
                isActive: true,
                created: new Date().toISOString(),
                fixed: expense.fixed !== undefined ? expense.fixed : true // Default recurring to fixed
            };
        }

        function calculateNextDueDate(lastDate, frequency) {
            const lastProcessed = new Date(lastDate);
            const nextDue = new Date(lastProcessed);
            
            switch (frequency) {
                case 'weekly':
                    nextDue.setDate(nextDue.getDate() + 7);
                    break;
                case 'biweekly':
                    nextDue.setDate(nextDue.getDate() + 14);
                    break;
                case 'monthly':
                    nextDue.setMonth(nextDue.getMonth() + 1);
                    break;
                case 'quarterly':
                    nextDue.setMonth(nextDue.getMonth() + 3);
                    break;
                case 'yearly':
                    nextDue.setFullYear(nextDue.getFullYear() + 1);
                    break;
            }
            
            return nextDue;
        }

        function checkRecurringExpenses() {
            const today = new Date();
            const dueExpenses = [];
            
            recurringExpenses.forEach(recurring => {
                if (!recurring.isActive) return;
                
                // Check if end date has passed
                if (recurring.endDate && new Date(recurring.endDate) < today) {
                    recurring.isActive = false;
                    return;
                }
                
                const nextDue = calculateNextDueDate(recurring.lastProcessedDate, recurring.frequency);
                
                if (nextDue <= today) {
                    dueExpenses.push(recurring);
                }
            });
            
            if (dueExpenses.length > 0) {
                showNotification(`${dueExpenses.length} recurring expense(s) are due!`, 'warning');
            }
            
            // Save any inactive updates
            localStorage.setItem('recurringExpenses', JSON.stringify(recurringExpenses));
            
            return dueExpenses;
        }

        function processRecurringExpenses() {
            const dueExpenses = checkRecurringExpenses();
            
            if (dueExpenses.length === 0) {
                showNotification('No recurring expenses are due', 'success');
                return;
            }
            
            let processedCount = 0;
            
            dueExpenses.forEach(recurring => {
                const nextDue = calculateNextDueDate(recurring.lastProcessedDate, recurring.frequency);
                
                // Create new expense
                const newExpense = {
                    id: Date.now() + Math.random(),
                    amount: recurring.amount,
                    category: recurring.category,
                    person: recurring.person,
                    description: `${recurring.description} (Recurring)`,
                    date: nextDue.toISOString().split('T')[0],
                    timestamp: new Date().toISOString(),
                    isRecurring: true,
                    recurringFrequency: recurring.frequency,
                    parentRecurringId: recurring.id,
                    fixed: recurring.fixed !== undefined ? recurring.fixed : true // Recurring expenses default to fixed
                };
                
                expenses.push(newExpense);
                
                // Update last processed date
                recurring.lastProcessedDate = nextDue.toISOString().split('T')[0];
                processedCount++;
            });
            
            // Save updated data
            localStorage.setItem('familyExpenses', JSON.stringify(expenses));
            localStorage.setItem('recurringExpenses', JSON.stringify(recurringExpenses));
            
            // Refresh display
            filteredExpenses = [...expenses];
            updateDashboard();
            filterAndRenderExpenses(); // Use new pagination system
            
            showNotification(`Processed ${processedCount} recurring expense(s)`, 'success');
        }

        function showRecurringModal() {
            renderRecurringList();
            document.getElementById('recurringModal').style.display = 'block';
        }

        function closeRecurringModal() {
            document.getElementById('recurringModal').style.display = 'none';
        }

        function renderRecurringList() {
            const recurringList = document.getElementById('recurringList');
            
            // Clear existing content
            recurringList.innerHTML = '';
            
            if (recurringExpenses.length === 0) {
                const emptyMessage = document.createElement('p');
                emptyMessage.style.cssText = 'text-align: center; color: var(--text-secondary); font-style: italic; padding: 2rem;';
                emptyMessage.textContent = 'No recurring expenses set up yet.';
                recurringList.appendChild(emptyMessage);
                return;
            }
            
            const activeRecurring = recurringExpenses.filter(r => r.isActive);
            
            if (activeRecurring.length === 0) {
                const emptyMessage = document.createElement('p');
                emptyMessage.style.cssText = 'text-align: center; color: var(--text-secondary); font-style: italic; padding: 2rem;';
                emptyMessage.textContent = 'No active recurring expenses.';
                recurringList.appendChild(emptyMessage);
                return;
            }
            
            // Create scrollable container with items
            activeRecurring.forEach(recurring => {
                const recurringElement = createRecurringElement(recurring);
                recurringList.appendChild(recurringElement);
            });
        }

        // Secure function to create recurring expense DOM elements
        function createRecurringElement(recurring) {
            const nextDue = calculateNextDueDate(recurring.lastProcessedDate, recurring.frequency);
            const today = new Date();
            const daysUntilDue = Math.ceil((nextDue - today) / (1000 * 60 * 60 * 24));
            
            let statusClass = 'recurring-frequency';
            let statusText = `Next: ${nextDue.toLocaleDateString()}`;
            
            if (daysUntilDue < 0) {
                statusClass = 'recurring-frequency overdue';
                statusText = `Overdue by ${Math.abs(daysUntilDue)} day(s)`;
            } else if (daysUntilDue <= 3) {
                statusClass = 'recurring-frequency due-soon';
                statusText = `Due in ${daysUntilDue} day(s)`;
            }
            
            const icon = categoryIcons[recurring.category] || '📝';
            
            // Create main container
            const itemDiv = document.createElement('div');
            itemDiv.className = 'recurring-item';
            
            // Create details section
            const detailsDiv = document.createElement('div');
            detailsDiv.className = 'recurring-details';
            detailsDiv.style.cursor = 'pointer';
            detailsDiv.title = 'Click to view/edit recurring expense';
            detailsDiv.addEventListener('click', () => {
                // Find the most recent expense from this recurring template
                const recentExpense = expenses.find(e => e.parentRecurringId === recurring.id) || 
                                    expenses.find(e => e.id === recurring.originalExpenseId);
                if (recentExpense) {
                    closeRecurringModal();
                    editExpense(recentExpense.id);
                } else {
                    // Create a temporary expense object for editing
                    const tempExpense = {
                        id: recurring.originalExpenseId || recurring.id,
                        amount: recurring.amount,
                        category: recurring.category,
                        person: recurring.person,
                        description: recurring.description,
                        date: recurring.lastProcessedDate || new Date().toISOString().split('T')[0],
                        isRecurring: true,
                        recurringFrequency: recurring.frequency,
                        recurringEndDate: recurring.endDate || '',
                        fixed: recurring.fixed !== undefined ? recurring.fixed : true
                    };
                    closeRecurringModal();
                    // Fill the form manually
                    document.getElementById('amount').value = tempExpense.amount;
                    document.getElementById('category').value = tempExpense.category;
                    document.getElementById('person').value = tempExpense.person;
                    document.getElementById('description').value = tempExpense.description;
                    document.getElementById('date').value = tempExpense.date;
                    document.getElementById('isRecurring').checked = true;
                    document.getElementById('recurringOptions').style.display = 'block';
                    document.getElementById('recurringFrequency').value = tempExpense.recurringFrequency;
                    document.getElementById('recurringEndDate').value = tempExpense.recurringEndDate;
                    if (document.getElementById('isFixedCost')) {
                        document.getElementById('isFixedCost').checked = tempExpense.fixed;
                    }
                    editingExpenseId = tempExpense.id;
                    document.getElementById('cancelEdit').style.display = 'inline-flex';
                    document.querySelector('.expense-form').scrollIntoView({ behavior: 'smooth' });
                    showNotification('Editing recurring expense template...', 'success');
                }
            });
            
            // Create title
            const titleH4 = document.createElement('h4');
            titleH4.textContent = `${icon} ${recurring.category}`;
            
            // Create description
            const descP = document.createElement('p');
            descP.textContent = `${recurring.description} • ${recurring.frequency} • 👤 ${recurring.person}`;
            
            detailsDiv.appendChild(titleH4);
            detailsDiv.appendChild(descP);
            
            // Create amount section
            const amountDiv = document.createElement('div');
            amountDiv.className = 'recurring-amount';
            amountDiv.textContent = `€${recurring.amount.toFixed(2)}`;
            
            // Create status section
            const statusDiv = document.createElement('div');
            statusDiv.style.cssText = 'display: flex; flex-direction: column; align-items: flex-end; gap: 0.5rem;';
            
            const statusSpan = document.createElement('span');
            statusSpan.className = statusClass;
            statusSpan.textContent = statusText;
            
            // Create stop button
            const stopBtn = document.createElement('button');
            stopBtn.className = 'btn btn-danger';
            stopBtn.style.cssText = 'min-width: auto; padding: 0.25rem 0.5rem; font-size: 0.8rem;';
            stopBtn.textContent = 'Stop';
            stopBtn.addEventListener('click', () => {
                if (confirm('Are you sure you want to stop this recurring expense?')) {
                    deactivateRecurring(recurring.id);
                }
            });
            
            statusDiv.appendChild(statusSpan);
            statusDiv.appendChild(stopBtn);
            
            // Assemble final element
            itemDiv.appendChild(detailsDiv);
            itemDiv.appendChild(amountDiv);
            itemDiv.appendChild(statusDiv);
            
            return itemDiv;
        }

        function deactivateRecurring(recurringId) {
            if (confirm('Are you sure you want to stop this recurring expense?')) {
                const recurring = recurringExpenses.find(r => r.id === recurringId);
                if (recurring) {
                    recurring.isActive = false;
                    localStorage.setItem('recurringExpenses', JSON.stringify(recurringExpenses));
                    renderRecurringList();
                    showNotification('Recurring expense stopped', 'success');
                }
            }
        }

        // Enhanced form reset
        function resetForm() {
            document.getElementById('expenseForm').reset();
            document.getElementById('date').valueAsDate = new Date();
            document.getElementById('isRecurring').checked = false;
            document.getElementById('recurringOptions').style.display = 'none';
            document.getElementById('customCategoryGroup').style.display = 'none';
            if (document.getElementById('isFixedCost')) {
                document.getElementById('isFixedCost').checked = true; // Default to checked
            }
        }



        // Tab switching functionality
        function switchTab(tabName) {
            // Hide all tab contents
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all nav tabs
            const navTabs = document.querySelectorAll('.nav-tab');
            navTabs.forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            // Add active class to clicked nav tab
            event.target.classList.add('active');
            
            // Update dashboard if switching to dashboard tab
            if (tabName === 'dashboard') {
                setTimeout(() => {
                    initializeDashboard();
                }, 100);
            }
            
            // Initialize travel tab if switching to travel tab
            if (tabName === 'travel') {
                initializeTravelTab();
            }
            
            // Update subscription status if switching to settings tab
            if (tabName === 'settings') {
                updateSubscriptionStatus();
            }
        }

        // Update main page budget summary
        function updateMainBudgetSummary() {
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            const monthlyExpenses = expenses.filter(expense => {
                const expenseDate = new Date(expense.date);
                return expenseDate.getMonth() === currentMonth && expenseDate.getFullYear() === currentYear;
            });
            
            // Calculate total using converted amounts for foreign currencies
            const monthlyTotal = monthlyExpenses.reduce((total, expense) => total + getAmountInMainCurrency(expense), 0);
            const remaining = monthlyBudget - monthlyTotal;
            
            // Update main page elements with clickable amounts
            const currencySymbol = CURRENCIES[mainCurrency]?.symbol || mainCurrency;
            document.getElementById('budgetAmountMain').textContent = `${currencySymbol}${monthlyBudget.toFixed(2)}`;
            
            // Make spent amount clickable
            const spentElement = document.getElementById('spentAmountMain');
            spentElement.innerHTML = `<span style="cursor: pointer; text-decoration: underline;" onclick="showSpentBreakdownModal()">${currencySymbol}${monthlyTotal.toFixed(2)}</span>`;
            spentElement.title = "Click to see detailed breakdown of spent amount";
            
            // Make remaining amount clickable
            const remainingElement = document.getElementById('remainingAmountMain');
            remainingElement.innerHTML = `<span style="cursor: pointer; text-decoration: underline;" onclick="showRemainingBreakdownModal()">${currencySymbol}${remaining.toFixed(2)}</span>`;
            remainingElement.title = "Click to see remaining budget breakdown and upcoming recurring expenses";
            
            // Make monthly total clickable too
            const monthlyTotalMainElement = document.getElementById('monthlyTotalMain');
            monthlyTotalMainElement.innerHTML = `<span style="cursor: pointer; text-decoration: underline;" onclick="showSpentBreakdownModal()">€${monthlyTotal.toFixed(2)}</span>`;
            monthlyTotalMainElement.title = "Click to see detailed breakdown of this month's expenses";
            
            // Make main page expense count clickable
            const expenseCountMainElement = document.getElementById('expenseCountMain');
            expenseCountMainElement.innerHTML = `<span style="cursor: pointer; text-decoration: underline;" onclick="showExpenseDetailsModal()">${monthlyExpenses.length}</span>`;
            expenseCountMainElement.title = "Click to see detailed breakdown of all expenses";
            
            // Update budget status and progress
            const budgetSummary = document.getElementById('budgetSummaryMain');
            const budgetFillMain = document.getElementById('budgetFillMain');
            const budgetTextMain = document.getElementById('budgetTextMain');
            const budgetStatusMain = document.getElementById('budgetStatusMain');
            
            if (monthlyBudget > 0) {
                const percentage = Math.min((monthlyTotal / monthlyBudget) * 100, 100);
                budgetFillMain.style.width = `${percentage}%`;
                budgetTextMain.textContent = `${Math.round(percentage)}%`;
                
                if (remaining >= 0) {
                    budgetStatusMain.innerHTML = `<span style="cursor: pointer; text-decoration: underline;" onclick="showRemainingBreakdownModal()">${currencySymbol}${remaining.toFixed(2)} remaining this month</span>`;
                    budgetStatusMain.title = "Click to see remaining budget breakdown and upcoming recurring expenses";
                    budgetSummary.classList.remove('warning-budget');
                } else {
                    budgetStatusMain.innerHTML = `<span style="cursor: pointer; text-decoration: underline;" onclick="showRemainingBreakdownModal()">${currencySymbol}${Math.abs(remaining).toFixed(2)} over budget this month</span>`;
                    budgetStatusMain.title = "Click to see budget analysis and upcoming expenses";
                    budgetSummary.classList.add('warning-budget');
                }
            } else {
                budgetFillMain.style.width = '0%';
                budgetTextMain.textContent = '0%';
                budgetStatusMain.textContent = 'Set your monthly budget in Settings to track progress';
                budgetSummary.classList.remove('warning-budget');
            }
            
            // Update quick stats
            const avgDaily = monthlyExpenses.length > 0 ? monthlyTotal / new Date().getDate() : 0;
            document.getElementById('avgDailyMain').textContent = `${currencySymbol}${avgDaily.toFixed(2)}`;
            
            // Calculate top category for main page
            const categoryTotals = {};
            monthlyExpenses.forEach(expense => {
                categoryTotals[expense.category] = (categoryTotals[expense.category] || 0) + getAmountInMainCurrency(expense);
            });
            
            let topCategory = '-';
            const categories = Object.keys(categoryTotals);
            if (categories.length > 0) {
                topCategory = categories.reduce((a, b) => 
                    categoryTotals[a] > categoryTotals[b] ? a : b);
            }
            document.getElementById('topCategoryMain').textContent = topCategory;
        }

        // Keyboard shortcuts
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', function(e) {
                // Check if user is typing in an input field
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
                    // Allow Ctrl+S for save even in input fields
                    if (e.ctrlKey && e.key === 's') {
                        e.preventDefault();
                        document.getElementById('expenseForm').dispatchEvent(new Event('submit'));
                        return;
                    }
                    return;
                }
                
                if (e.ctrlKey) {
                    switch(e.key) {
                        case 'n':
                        case 'N':
                            e.preventDefault();
                            scrollToForm();
                            break;
                        case 'i':
                        case 'I':
                            e.preventDefault();
                            showInsights();
                            break;
                        case 'r':
                        case 'R':
                            e.preventDefault();
                            showRecurringModal();
                            break;
                        case 'e':
                        case 'E':
                            e.preventDefault();
                            exportToCSV();
                            break;
                        case 'd':
                        case 'D':
                            e.preventDefault();
                            switchTab('dashboard');
                            break;
                        case 'm':
                        case 'M':
                            e.preventDefault();
                            switchTab('main');
                            break;
                        case 'f':
                        case 'F':
                            e.preventDefault();
                            document.getElementById('searchInput').focus();
                            break;
                    }
                }
                
                // ESC key to close modals or clear search
                if (e.key === 'Escape') {
                    closeInsights();
                    closeRecurringModal();
                    if (searchTerm) {
                        clearSearchFunction();
                    }
                }
            });
        }

        // Smart Search Functions
        function handleSearch() {
            const input = document.getElementById('searchInput');
            searchTerm = input.value.toLowerCase().trim();
            const clearBtn = document.getElementById('clearSearch');
            
            if (searchTerm) {
                clearBtn.style.display = 'block';
            } else {
                clearBtn.style.display = 'none';
            }
            
            currentPage = 1; // Reset to first page when searching
            filterAndRenderExpenses();
        }

        function clearSearchFunction() {
            document.getElementById('searchInput').value = '';
            document.getElementById('clearSearch').style.display = 'none';
            searchTerm = '';
            currentPage = 1;
            filterAndRenderExpenses();
        }

        function highlightSearchTerms(text, term) {
            if (!term) return text;
            const regex = new RegExp(`(${term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
            return text.replace(regex, '<span class="search-highlight">$1</span>');
        }

        // View Mode Functions
        function setViewMode(mode) {
            currentViewMode = mode;
            currentPage = 1; // Reset pagination
            
            // Update button states
            document.getElementById('recentModeBtn').classList.toggle('active', mode === 'recent');
            document.getElementById('allModeBtn').classList.toggle('active', mode === 'all');
            
            // Update title
            const title = document.getElementById('expenseListTitle');
            title.textContent = mode === 'recent' ? 'Recent Expenses (30 days)' : 'All Expenses';
            
            filterAndRenderExpenses();
        }

        function getViewModeExpenses() {
            if (currentViewMode === 'recent') {
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                return expenses.filter(expense => new Date(expense.date) >= thirtyDaysAgo);
            }
            return expenses;
        }

        // Enhanced Filter and Render Function
        function filterAndRenderExpenses() {
            let baseExpenses = getViewModeExpenses();
            
            // Apply existing filters
            const categoryFilter = document.getElementById('categoryFilter').value;
            const personFilter = document.getElementById('personFilter').value;
            
            filteredExpenses = baseExpenses.filter(expense => {
                const categoryMatch = !categoryFilter || expense.category === categoryFilter;
                const personMatch = !personFilter || expense.person === personFilter;
                
                // Search filter
                let searchMatch = true;
                if (searchTerm) {
                    const searchFields = [
                        expense.category?.toLowerCase(),
                        expense.description?.toLowerCase(),
                        expense.person?.toLowerCase(),
                        expense.amount?.toString(),
                        new Date(expense.date).toLocaleDateString().toLowerCase()
                    ].filter(Boolean);
                    
                    searchMatch = searchFields.some(field => field.includes(searchTerm));
                }
                
                return categoryMatch && personMatch && searchMatch;
            });
            
            totalFilteredExpenses = filteredExpenses.length;
            renderExpensesWithPagination();
        }

        // Pagination Functions
        function renderExpensesWithPagination() {
            const totalPages = Math.ceil(totalFilteredExpenses / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedExpenses = filteredExpenses.slice(startIndex, endIndex);
            
            // Update pagination controls
            updatePaginationControls(totalPages);
            
            // Render expenses
            renderExpensesList(paginatedExpenses);
            
            // Show/hide pagination based on total items
            const showPagination = totalFilteredExpenses > itemsPerPage;
            document.getElementById('paginationTop').style.display = showPagination ? 'flex' : 'none';
            document.getElementById('paginationBottom').style.display = showPagination ? 'flex' : 'none';
        }

        function updatePaginationControls(totalPages) {
            const prevBtn = document.getElementById('prevPageBtn');
            const nextBtn = document.getElementById('nextPageBtn');
            const pageInfo = document.getElementById('pageInfo');
            const pageInfoBottom = document.getElementById('pageInfoBottom');
            const paginationInfo = document.getElementById('paginationInfo');
            
            // Update page info
            pageInfo.textContent = t('pagination.pageInfo', { current: currentPage, total: totalPages || 1 });
            pageInfoBottom.textContent = t('pagination.pageInfo', { current: currentPage, total: totalPages || 1 });
            
            // Update pagination info
            const startItem = totalFilteredExpenses === 0 ? 0 : (currentPage - 1) * itemsPerPage + 1;
            const endItem = Math.min(currentPage * itemsPerPage, totalFilteredExpenses);
            paginationInfo.textContent = t('pagination.showingExpenses', { start: startItem, end: endItem, total: totalFilteredExpenses });
            
            // Update button states
            prevBtn.disabled = currentPage <= 1;
            nextBtn.disabled = currentPage >= totalPages;
            
            // Update bottom pagination buttons
            const bottomPrevBtn = document.querySelector('#paginationBottom button:first-child');
            const bottomNextBtn = document.querySelector('#paginationBottom button:last-child');
            bottomPrevBtn.disabled = currentPage <= 1;
            bottomNextBtn.disabled = currentPage >= totalPages;
        }

        function changePage(direction) {
            const totalPages = Math.ceil(totalFilteredExpenses / itemsPerPage);
            const newPage = currentPage + direction;
            
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                renderExpensesWithPagination();
                
                // Scroll to top of expense list
                document.getElementById('expensesList').scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'start' 
                });
            }
        }

        // Enhanced updateDashboard to also update main page
        const originalUpdateDashboard = updateDashboard;
        updateDashboard = function() {
            // Call original dashboard update
            originalUpdateDashboard();
            
            // Also update main page summary
            updateMainBudgetSummary();
        };

        // Scroll to form function (updated for new layout)
        function scrollToForm() {
            // Switch to main tab if not already there
            if (!document.getElementById('mainTab').classList.contains('active')) {
                switchTab('main');
                // Update the active nav tab manually since event.target won't work here
                document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
                document.querySelector('.nav-tab[onclick*="main"]').classList.add('active');
            }
            
            setTimeout(() => {
                document.querySelector('.expense-form').scrollIntoView({ 
                    behavior: 'smooth',
                    block: 'center'
                });
                document.getElementById('amount').focus();
            }, 100);
        }

        // Tracker Type Management
        function loadTrackerType() {
            document.getElementById('trackerType').value = trackerType;
            updateTrackerInterface();
        }

        function changeTrackerType() {
            trackerType = document.getElementById('trackerType').value;
            localStorage.setItem('trackerType', trackerType);
            updateTrackerInterface();
            updateMainBudgetSummary(); // Refresh suggestions
        }

        function updateTrackerInterface() {
            const personGroup = document.getElementById('personGroup');
            const personSelect = document.getElementById('person');
            const personLabel = document.getElementById('personLabel');
            const personFilterGroup = document.getElementById('personFilterGroup');
            const personFilter = document.getElementById('personFilter');
            const personFilterLabel = document.getElementById('personFilterLabel');
            const appSubtitle = document.getElementById('appSubtitle');

            // Clear existing options
            personSelect.innerHTML = '<option value="">Select...</option>';
            personFilter.innerHTML = '<option value="">All...</option>';

            if (trackerType === 'personal') {
                appSubtitle.textContent = 'Track, manage, and optimize your personal spending';
                personGroup.style.display = 'none'; // Hide person selector for personal
                personFilterGroup.style.display = 'none';
            } else if (trackerType === 'family') {
                appSubtitle.textContent = 'Track, manage, and optimize your family\'s spending';
                personGroup.style.display = 'block';
                personFilterGroup.style.display = 'block';
                personLabel.textContent = 'Family Member';
                personFilterLabel.textContent = 'Filter by Family Member';
                
                // Family options
                personSelect.innerHTML = `
                    <option value="">Select family member</option>
                    <option value="You">👤 You</option>
                    <option value="Partner">💕 Partner</option>
                    <option value="Child1">👧 Child 1</option>
                    <option value="Child2">👦 Child 2</option>
                    <option value="Family">👨‍👩‍👧‍👦 Whole Family</option>
                `;
                personFilter.innerHTML = `
                    <option value="">All Family Members</option>
                    <option value="You">👤 You</option>
                    <option value="Partner">💕 Partner</option>
                    <option value="Child1">👧 Child 1</option>
                    <option value="Child2">👦 Child 2</option>
                    <option value="Family">👨‍👩‍👧‍👦 Whole Family</option>
                `;
            } else if (trackerType === 'group') {
                appSubtitle.textContent = 'Track, manage, and optimize your group\'s shared spending';
                personGroup.style.display = 'block';
                personFilterGroup.style.display = 'block';
                personLabel.textContent = 'Group Member';
                personFilterLabel.textContent = 'Filter by Group Member';
                
                // Group options
                personSelect.innerHTML = `
                    <option value="">Select group member</option>
                    <option value="You">👤 You</option>
                    <option value="Member1">👥 Member 1</option>
                    <option value="Member2">👥 Member 2</option>
                    <option value="Member3">👥 Member 3</option>
                    <option value="Group">👥 Whole Group</option>
                `;
                personFilter.innerHTML = `
                    <option value="">All Group Members</option>
                    <option value="You">👤 You</option>
                    <option value="Member1">👥 Member 1</option>
                    <option value="Member2">👥 Member 2</option>
                    <option value="Member3">👥 Member 3</option>
                    <option value="Group">👥 Whole Group</option>
                `;
            }

            // Update form validation
            if (trackerType === 'personal') {
                personSelect.removeAttribute('required');
            } else {
                personSelect.setAttribute('required', 'required');
            }
        }
        // Smart Suggestions Engine
        function generateSmartSuggestions() {
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            const monthlyExpenses = expenses.filter(expense => {
                const expenseDate = new Date(expense.date);
                return expenseDate.getMonth() === currentMonth && expenseDate.getFullYear() === currentYear;
            });

            const monthlyTotal = monthlyExpenses.reduce((total, expense) => total + getAmountInMainCurrency(expense), 0);
            const remaining = monthlyBudget - monthlyTotal;
            const daysLeft = new Date(currentYear, currentMonth + 1, 0).getDate() - new Date().getDate();
            const dailyBudgetLeft = daysLeft > 0 ? remaining / daysLeft : 0;

            const suggestions = [];

            if (monthlyBudget === 0) {
                suggestions.push({
                    type: 'setup',
                    icon: '🎯',
                    text: t('suggestions.setBudget'),
                    action: t('suggestions.goToSettings'),
                    priority: 'high'
                });
                return suggestions;
            }

            if (monthlyExpenses.length === 0) {
                suggestions.push({
                    type: 'start',
                    icon: '🚀',
                    text: t('suggestions.startTracking'),
                    action: t('suggestions.addFirstExpense'),
                    priority: 'normal'
                });
                return suggestions;
            }

            // Budget-based suggestions
            if (remaining > 0) {
                const savingsPercentage = (remaining / monthlyBudget) * 100;
                
                if (savingsPercentage >= 30) {
                    suggestions.push({
                        type: 'savings',
                        icon: '💰',
                        text: t('suggestions.excellentSavings', { 
                            remaining: formatCurrencyAmount(remaining, mainCurrency), 
                            percentage: Math.floor(savingsPercentage * 0.6) 
                        }),
                        amount: formatCurrencyAmount(remaining * 0.6, mainCurrency),
                        action: t('suggestions.buildEmergencyFund'),
                        priority: 'high'
                    });
                } else if (savingsPercentage >= 15) {
                    suggestions.push({
                        type: 'savings',
                        icon: '💡',
                        text: t('suggestions.goodJob', {
                            remaining: formatCurrencyAmount(remaining, mainCurrency),
                            saveable: formatCurrencyAmount(remaining * 0.5, mainCurrency)
                        }),
                        amount: formatCurrencyAmount(remaining * 0.5, mainCurrency),
                        action: t('suggestions.buildSavingsHabit'),
                        priority: 'normal'
                    });
                } else if (savingsPercentage >= 5) {
                    suggestions.push({
                        type: 'caution',
                        icon: '⚠️',
                        text: t('suggestions.beMindful', {
                            remaining: formatCurrencyAmount(remaining, mainCurrency),
                            days: daysLeft,
                            daily: formatCurrencyAmount(dailyBudgetLeft, mainCurrency)
                        }),
                        action: t('suggestions.focusOnEssentials'),
                        priority: 'warning'
                    });
                }

                // Daily spending recommendations
                if (daysLeft > 0) {
                    suggestions.push({
                        type: 'daily',
                        icon: '📅',
                        text: t('suggestions.dailyBudget', {
                            remaining: formatCurrencyAmount(remaining, mainCurrency),
                            days: daysLeft,
                            daily: formatCurrencyAmount(dailyBudgetLeft, mainCurrency)
                        }),
                        amount: `${formatCurrencyAmount(dailyBudgetLeft, mainCurrency)}/day`,
                        action: t('suggestions.trackDaily'),
                        priority: 'normal'
                    });
                }
            } else if (remaining < 0) {
                suggestions.push({
                    type: 'overspent',
                    icon: '🚨',
                    text: t('suggestions.overBudget', {
                        amount: formatCurrencyAmount(Math.abs(remaining), mainCurrency)
                    }),
                    action: t('suggestions.reviewExpenses'),
                    priority: 'urgent'
                });
            }

            // Category-based suggestions
            const categoryTotals = {};
            monthlyExpenses.forEach(expense => {
                categoryTotals[expense.category] = (categoryTotals[expense.category] || 0) + getAmountInMainCurrency(expense);
            });

            const sortedCategories = Object.entries(categoryTotals).sort((a, b) => b[1] - a[1]);
            
            if (sortedCategories.length > 0) {
                const topCategory = sortedCategories[0];
                const topCategoryPercentage = (topCategory[1] / monthlyTotal) * 100;

                if (topCategoryPercentage > 40) {
                    suggestions.push({
                        type: 'category',
                        icon: '📊',
                        text: t('suggestions.categoryHigh', {
                            category: topCategory[0],
                            percentage: topCategoryPercentage.toFixed(1),
                            amount: formatCurrencyAmount(topCategory[1], mainCurrency)
                        }),
                        action: t('suggestions.considerAlternatives'),
                        priority: 'normal'
                    });
                }
            }

            // Savings goal suggestions
            if (remaining > 50 && savingsGoal === 0) {
                suggestions.push({
                    type: 'goal',
                    icon: '🎯',
                    text: t('suggestions.setSavingsGoal', {
                        min: formatCurrencyAmount(50, mainCurrency),
                        max: formatCurrencyAmount(100, mainCurrency)
                    }),
                    action: t('suggestions.setMonthlyTarget'),
                    priority: 'normal'
                });
            }

            // Tracker-specific suggestions
            if (trackerType === 'family') {
                const familyMembers = [...new Set(monthlyExpenses.map(e => e.person).filter(p => p))];
                if (familyMembers.length > 1) {
                    suggestions.push({
                        type: 'family',
                        icon: '👨‍👩‍👧‍👦',
                        text: t('suggestions.trackFamilySpending'),
                        action: t('suggestions.reviewIndividual'),
                        priority: 'normal'
                    });
                }
            } else if (trackerType === 'group') {
                suggestions.push({
                    type: 'group',
                    icon: '👥',
                    text: t('suggestions.groupSavingsGoals'),
                    action: t('suggestions.discussGroupGoals'),
                    priority: 'normal'
                });
            }

            return suggestions;
        }

        function renderSmartSuggestions() {
            const suggestions = generateSmartSuggestions();
            const suggestionsContent = document.getElementById('suggestionsContent');

            if (suggestions.length === 0) {
                suggestionsContent.innerHTML = `<div class="no-suggestions">${t('suggestions.noDataYet')}</div>`;
                return;
            }

            suggestionsContent.innerHTML = suggestions.map(suggestion => {
                let itemClass = 'suggestion-item';
                if (suggestion.priority === 'urgent' || suggestion.priority === 'high') {
                    itemClass += ' priority';
                } else if (suggestion.priority === 'warning') {
                    itemClass += ' warning';
                }

                return `
                    <div class="${itemClass}">
                        <span class="suggestion-icon">${suggestion.icon}</span>
                        <div class="suggestion-content">
                            <div class="suggestion-text">${suggestion.text}</div>
                            ${suggestion.amount ? `<div class="suggestion-amount">${suggestion.amount}</div>` : ''}
                            <div class="suggestion-meta">${suggestion.action}</div>
                        </div>
                    </div>
                `;
            }).join('');

            // Add savings goal display if applicable
            if (monthlyBudget > 0 && expenses.length > 0) {
                const remaining = monthlyBudget - expenses.filter(expense => {
                    const expenseDate = new Date(expense.date);
                    const now = new Date();
                    return expenseDate.getMonth() === now.getMonth() && expenseDate.getFullYear() === now.getFullYear();
                }).reduce((total, expense) => total + expense.amount, 0);

                if (remaining > 0) {
                    const recommendedSavings = Math.max(remaining * 0.2, 10);
                    suggestionsContent.innerHTML += `
                        <div class="savings-goal">
                            <div class="savings-amount">💰 €${recommendedSavings.toFixed(2)}</div>
                            <div data-i18n="suggestions.recommendedSavings">Recommended monthly savings from remaining budget</div>
                        </div>
                    `;
                }
            }
        }

        // Enhanced updateMainBudgetSummary to include suggestions
        const originalUpdateMainBudgetSummary = updateMainBudgetSummary;
        updateMainBudgetSummary = function() {
            // Call original function
            originalUpdateMainBudgetSummary();
            
            // Generate and render suggestions
            renderSmartSuggestions();
        };

        // Close modal when clicking outside
        window.onclick = function(event) {
            const insightsModal = document.getElementById('insightsModal');
            const recurringModal = document.getElementById('recurringModal');
            
            if (event.target === insightsModal) {
                closeInsights();
            } else if (event.target === recurringModal) {
                closeRecurringModal();
            }
        };

        // PWA Installation and Notification Management
        let deferredPrompt;
        let swRegistration = null;
        let notificationPermission = 'default';

        // Register Service Worker and setup PWA features with aggressive updates
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', async () => {
                try {
                    swRegistration = await navigator.serviceWorker.register('/tracker/sw.js');
                    console.log('✅ Service Worker registered:', swRegistration);
                    
                    // Force immediate update check
                    swRegistration.update();
                    
                    // Check for updates
                    swRegistration.addEventListener('updatefound', () => {
                        const newWorker = swRegistration.installing;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed') {
                                if (navigator.serviceWorker.controller) {
                                    // New version available - force immediate reload
                                    console.log('🔄 New app version detected, force reloading...');
                                    showNotification('App updated! Reloading to get latest features...', 'success');
                                    setTimeout(() => {
                                        window.location.reload(true);
                                    }, 1500);
                                } else {
                                    // First install
                                    console.log('✅ App installed and ready to use offline');
                                }
                            }
                        });
                    });
                    
                    // Also listen for controller changes
                    navigator.serviceWorker.addEventListener('controllerchange', () => {
                        console.log('🔄 Service Worker updated, reloading for latest version...');
                        window.location.reload(true);
                    });
                    
                } catch (error) {
                    console.error('❌ Service Worker registration failed:', error);
                }
            });
        }

        // PWA Install prompt
        window.addEventListener('beforeinstallprompt', (e) => {
            console.log('💾 PWA install prompt available');
            e.preventDefault();
            deferredPrompt = e;
            showInstallButton();
        });

        // Handle successful PWA installation
        window.addEventListener('appinstalled', () => {
            console.log('✅ PWA installed successfully');
            hideInstallButton();
            showNotification('App installed! You can now use Expense Tracker offline.', 'success');
        });

        // Show/hide install button
        function showInstallButton() {
            // Create install button if it doesn't exist
            if (!document.getElementById('installButton')) {
                const installBtn = document.createElement('button');
                installBtn.id = 'installButton';
                installBtn.className = 'btn btn-primary install-button';
                installBtn.textContent = '📱 Install App';
                installBtn.addEventListener('click', installPWA);
                installBtn.style.cssText = `
                    position: fixed;
                    bottom: 20px;
                    right: 20px;
                    z-index: 1000;
                    display: flex;
                    align-items: center;
                    gap: 0.5rem;
                    box-shadow: var(--shadow-lg);
                    animation: bounce 2s infinite;
                `;
                document.body.appendChild(installBtn);
            }
        }

        function hideInstallButton() {
            const installBtn = document.getElementById('installButton');
            if (installBtn) {
                installBtn.remove();
            }
        }

        // Install PWA
        async function installPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                
                if (outcome === 'accepted') {
                    console.log('✅ User accepted PWA install');
                } else {
                    console.log('❌ User declined PWA install');
                }
                
                deferredPrompt = null;
                hideInstallButton();
            }
        }

        // Notification Permission Management
        async function requestNotificationPermission() {
            if (!('Notification' in window)) {
                console.log('❌ This browser does not support notifications');
                return false;
            }

            if (Notification.permission === 'granted') {
                return true;
            }

            if (Notification.permission === 'denied') {
                showNotification('Notifications are blocked. Please enable them in your browser settings.', 'error');
                return false;
            }

            try {
                const permission = await Notification.requestPermission();
                notificationPermission = permission;
                
                if (permission === 'granted') {
                    console.log('✅ Notification permission granted');
                    setupPushNotifications();
                    return true;
                } else {
                    console.log('❌ Notification permission denied');
                    return false;
                }
            } catch (error) {
                console.error('❌ Error requesting notification permission:', error);
                return false;
            }
        }

        // Setup Push Notifications
        async function setupPushNotifications() {
            if (!swRegistration) {
                console.log('❌ Service Worker not registered');
                return;
            }

            try {
                // Setup local notifications
                setupLocalNotifications();
                
            } catch (error) {
                console.error('❌ Error setting up push notifications:', error);
            }
        }

        // Setup local notifications for budget alerts and reminders
        function setupLocalNotifications() {
            // Check budget status daily
            setInterval(checkBudgetAndNotify, 24 * 60 * 60 * 1000); // 24 hours
            
            // Check for recurring expense reminders every hour
            setInterval(checkRecurringReminders, 60 * 60 * 1000); // 1 hour
            
            // Also check immediately when app loads
            setTimeout(checkRecurringReminders, 5000); // 5 seconds after load
            
            console.log('🔔 Notification system initialized - will check recurring expenses every hour');
        }

        // Check budget and send notification if needed
        function checkBudgetAndNotify() {
            if (Notification.permission !== 'granted') return;

            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            const monthlyExpenses = expenses.filter(expense => {
                const expenseDate = new Date(expense.date);
                return expenseDate.getMonth() === currentMonth && expenseDate.getFullYear() === currentYear;
            });

            const monthlyTotal = monthlyExpenses.reduce((total, expense) => total + expense.amount, 0);
            const budgetUsedPercentage = monthlyBudget > 0 ? (monthlyTotal / monthlyBudget) * 100 : 0;

            if (budgetUsedPercentage >= 80 && budgetUsedPercentage < 100) {
                new Notification(t('notifications.budgetAlert'), {
                    body: t('notifications.budgetUsedPercent', { percentage: Math.round(budgetUsedPercentage) }),
                    icon: '/icons/icon-192x192.png',
                    tag: 'budget-warning'
                });
            } else if (budgetUsedPercentage >= 100) {
                new Notification('Budget Exceeded!', {
                    body: `You've exceeded your monthly budget by €${Math.abs(monthlyBudget - monthlyTotal).toFixed(2)}.`,
                    icon: '/icons/icon-192x192.png',
                    tag: 'budget-exceeded'
                });
            }
        }

        // Check recurring expenses and send reminders
        function checkRecurringReminders() {
            if (Notification.permission !== 'granted') {
                console.log('📵 Notifications not permitted - cannot send reminders');
                return;
            }

            if (!recurringExpenses || recurringExpenses.length === 0) {
                console.log('📝 No recurring expenses to check');
                return;
            }

            const today = new Date();
            const todayDateString = today.toDateString();
            
            // Get or initialize notification tracking
            let notificationHistory = JSON.parse(localStorage.getItem('notificationHistory') || '{}');
            
            console.log(`🔍 Checking ${recurringExpenses.length} recurring expenses for reminders...`);

            recurringExpenses.forEach(recurring => {
                if (!recurring.isActive) return;

                const nextDueDate = calculateNextDueDate(recurring.lastProcessedDate, recurring.frequency);
                const daysUntilDue = Math.ceil((nextDueDate - today) / (1000 * 60 * 60 * 24));
                
                const expenseId = recurring.id;
                const nextDueDateString = nextDueDate.toDateString();
                
                // Create unique keys for 3-day and 1-day reminders
                const reminder3DayKey = `${expenseId}_3day_${nextDueDateString}`;
                const reminder1DayKey = `${expenseId}_1day_${nextDueDateString}`;
                
                // Check for 3-day reminder
                if (daysUntilDue === 3 && !notificationHistory[reminder3DayKey]) {
                    const icon = categoryIcons[recurring.category] || '📝';
                    
                    new Notification('Upcoming Expense Reminder', {
                        body: `${icon} ${recurring.category} (€${recurring.amount.toFixed(2)}) is due in 3 days on ${nextDueDate.toLocaleDateString()}`,
                        icon: '/icons/icon-192x192.png',
                        badge: '/icons/badge-72x72.png',
                        tag: `recurring-3day-${expenseId}`,
                        requireInteraction: false,
                        actions: [
                            {
                                action: 'add-expense',
                                title: 'Add Now'
                            },
                            {
                                action: 'view-recurring',
                                title: 'View Details'
                            }
                        ],
                        data: {
                            type: 'recurring-reminder',
                            recurringId: expenseId,
                            daysUntilDue: 3,
                            category: recurring.category,
                            amount: recurring.amount
                        }
                    });
                    
                    // Mark as sent
                    notificationHistory[reminder3DayKey] = {
                        sent: true,
                        timestamp: Date.now(),
                        type: '3-day-reminder'
                    };
                    
                    console.log(`📱 Sent 3-day reminder for: ${recurring.category} (€${recurring.amount})`);
                }
                
                // Check for 1-day reminder
                if (daysUntilDue === 1 && !notificationHistory[reminder1DayKey]) {
                    const icon = categoryIcons[recurring.category] || '📝';
                    
                    new Notification('Expense Due Tomorrow!', {
                        body: `${icon} ${recurring.category} (€${recurring.amount.toFixed(2)}) is due tomorrow!`,
                        icon: '/icons/icon-192x192.png',
                        badge: '/icons/badge-72x72.png',
                        tag: `recurring-1day-${expenseId}`,
                        requireInteraction: true, // More urgent
                        actions: [
                            {
                                action: 'add-expense',
                                title: 'Add Now'
                            },
                            {
                                action: 'remind-later',
                                title: 'Remind Later'
                            }
                        ],
                        data: {
                            type: 'recurring-reminder',
                            recurringId: expenseId,
                            daysUntilDue: 1,
                            category: recurring.category,
                            amount: recurring.amount
                        }
                    });
                    
                    // Mark as sent
                    notificationHistory[reminder1DayKey] = {
                        sent: true,
                        timestamp: Date.now(),
                        type: '1-day-reminder'
                    };
                    
                    console.log(`📱 Sent 1-day reminder for: ${recurring.category} (€${recurring.amount})`);
                }
                
                // Check for overdue expenses
                if (daysUntilDue < 0) {
                    const overdueDays = Math.abs(daysUntilDue);
                    const overdueKey = `${expenseId}_overdue_${nextDueDateString}`;
                    
                    if (!notificationHistory[overdueKey]) {
                        const icon = categoryIcons[recurring.category] || '📝';
                        
                        new Notification('Overdue Expense!', {
                            body: `${icon} ${recurring.category} (€${recurring.amount.toFixed(2)}) is overdue by ${overdueDays} day${overdueDays > 1 ? 's' : ''}!`,
                            icon: '/icons/icon-192x192.png',
                            badge: '/icons/badge-72x72.png',
                            tag: `recurring-overdue-${expenseId}`,
                            requireInteraction: true,
                            actions: [
                                {
                                    action: 'add-expense',
                                    title: 'Add Now'
                                },
                                {
                                    action: 'view-recurring',
                                    title: 'Manage'
                                }
                            ],
                            data: {
                                type: 'recurring-overdue',
                                recurringId: expenseId,
                                daysOverdue: overdueDays,
                                category: recurring.category,
                                amount: recurring.amount
                            }
                        });
                        
                        notificationHistory[overdueKey] = {
                            sent: true,
                            timestamp: Date.now(),
                            type: 'overdue-reminder'
                        };
                        
                        console.log(`📱 Sent overdue reminder for: ${recurring.category} (€${recurring.amount}) - ${overdueDays} days overdue`);
                    }
                }
            });
            
            // Clean up old notification history (older than 30 days)
            const thirtyDaysAgo = Date.now() - (30 * 24 * 60 * 60 * 1000);
            Object.keys(notificationHistory).forEach(key => {
                if (notificationHistory[key].timestamp < thirtyDaysAgo) {
                    delete notificationHistory[key];
                }
            });
            
            // Save updated notification history
            localStorage.setItem('notificationHistory', JSON.stringify(notificationHistory));
            
            console.log('✅ Recurring expense reminder check completed');
        }

        // Test notification function
        function testNotification() {
            if (Notification.permission !== 'granted') {
                requestNotificationPermission().then(() => {
                    if (Notification.permission === 'granted') {
                        sendTestNotification();
                    }
                });
            } else {
                sendTestNotification();
            }
        }

        function sendTestNotification() {
            new Notification('Test Notification 📱', {
                body: 'Notifications are working! You will receive reminders for recurring expenses.',
                icon: '/icons/icon-192x192.png',
                badge: '/icons/badge-72x72.png',
                tag: 'test-notification',
                requireInteraction: false,
                actions: [
                    {
                        action: 'view',
                        title: 'View App'
                    },
                    {
                        action: 'dismiss',
                        title: 'Dismiss'
                    }
                ]
            });
            
            showNotification('Test notification sent! 📱', 'success');
            updateNotificationStatus();
        }
        // Update notification status display
        function updateNotificationStatus() {
            const statusDiv = document.getElementById('notificationStatus');
            if (!statusDiv) return;

            const permission = Notification.permission;
            let statusText = '';
            let statusClass = '';

            if (permission === 'granted') {
                statusText = '✅ Notifications enabled - You will receive reminders for recurring expenses';
                statusClass = 'status-success';
                statusDiv.style.backgroundColor = 'var(--success-light, #d4edda)';
                statusDiv.style.color = 'var(--success-dark, #155724)';
                statusDiv.style.borderColor = 'var(--success-color, #28a745)';
            } else if (permission === 'denied') {
                statusText = '❌ Notifications blocked - Please enable in browser settings to receive reminders';
                statusClass = 'status-error';
                statusDiv.style.backgroundColor = 'var(--danger-light, #f8d7da)';
                statusDiv.style.color = 'var(--danger-dark, #721c24)';
                statusDiv.style.borderColor = 'var(--danger-color, #dc3545)';
            } else {
                statusText = '⚠️ Notifications not enabled - Click "Test Notification" to enable reminders';
                statusClass = 'status-warning';
                statusDiv.style.backgroundColor = 'var(--warning-light, #fff3cd)';
                statusDiv.style.color = 'var(--warning-dark, #856404)';
                statusDiv.style.borderColor = 'var(--warning-color, #ffc107)';
            }

            statusDiv.textContent = statusText;
            statusDiv.className = statusClass;

            // Show reminder count if there are active recurring expenses
            const activeRecurring = recurringExpenses.filter(r => r.isActive);
            if (activeRecurring.length > 0 && permission === 'granted') {
                statusDiv.textContent += ` (${activeRecurring.length} recurring expense${activeRecurring.length > 1 ? 's' : ''} being monitored)`;
                         }
         }

         // Interactive Guide System
         function getGuideSteps() {
             return [
            {
                title: t('guide.step1.title'),
                content: `
                    <p>${t('guide.step1.intro')}</p>
                    <p><strong>🌟 ${t('guide.step1.featuresTitle')}</strong></p>
                    <ul>
                        <li>💰 ${t('guide.step1.feature1')}</li>
                        <li>🧳 ${t('guide.step1.feature2')}</li>
                        <li>📊 ${t('guide.step1.feature3')}</li>
                        <li>📱 ${t('guide.step1.feature4')}</li>
                        <li>🔔 ${t('guide.step1.feature5')}</li>
                        <li>📈 ${t('guide.step1.feature6')}</li>
                    </ul>
                    <p><strong>${t('guide.step1.letsExplore')}</strong></p>
                `,
                target: null,
                action: null
            },
            {
                title: t('guide.step2.title'),
                content: `
                    <h3>${t('guide.step2.intro')}</h3>
                    <p><strong>🚀 ${t('guide.step2.appExperience')}</strong></p>
                    <ul>
                        <li>📱 ${t('guide.step2.offline')}</li>
                        <li>🔔 ${t('guide.step2.notifications')}</li>
                        <li>🏠 ${t('guide.step2.homeScreen')}</li>
                        <li>⚡ ${t('guide.step2.performance')}</li>
                        <li>🔒 ${t('guide.step2.secure')}</li>
                        <li>🔄 ${t('guide.step2.updates')}</li>
                    </ul>
                    <p><strong>💡 Pro tip:</strong> Add this to your home screen for the best mobile experience!</p>
                `,
                target: null,
                action: null
            },
            {
                title: "💰 Smart Expense Tracking",
                content: `
                    <h3>Master the expense form!</h3>
                    <p><strong>🎯 Each field explained:</strong></p>
                    <ul>
                        <li><strong>💵 Amount:</strong> How much you spent (auto-calculates in budget)</li>
                        <li><strong>📂 Category:</strong> Smart categorization with custom emojis</li>
                        <li><strong>📝 Description:</strong> Optional details for better tracking</li>
                        <li><strong>👤 Person:</strong> Who made the purchase (multi-person support)</li>
                        <li><strong>📅 Date:</strong> When it occurred (defaults to today)</li>
                        <li><strong>🔄 Recurring:</strong> Set up automatic recurring expenses</li>
                    </ul>
                    <p><strong>✨ Try adding a test expense to see the magic!</strong></p>
                `,
                target: "#expenseForm",
                action: "scrollTo"
            },
            {
                title: "🎯 Lightning-Fast Quick Actions",
                content: `
                    <h3>One-click expense entry!</h3>
                    <p><strong>⚡ Quick action buttons for common expenses:</strong></p>
                    <ul>
                        <li>🛒 <strong>Quick Groceries</strong> - Pre-fills grocery category</li>
                        <li>⚡ <strong>Quick Utilities</strong> - Bills and utilities</li>
                        <li>🚗 <strong>Quick Transport</strong> - Gas, taxi, public transport</li>
                        <li>🏡 <strong>Quick Mortgage</strong> - Housing payments</li>
                        <li>🚙 <strong>Quick Car Loan</strong> - Vehicle payments</li>
                        <li>🍽️ <strong>Dining Out</strong> - Restaurant expenses</li>
                    </ul>
                    <p><strong>💡 Click any button to see intelligent pre-filling in action!</strong></p>
                `,
                target: ".quick-actions",
                action: "highlight"
            },
            {
                title: "🔍 Advanced Search & Filtering",
                content: `
                    <h3>Find anything instantly!</h3>
                    <p><strong>🎯 Search by multiple criteria:</strong></p>
                    <ul>
                        <li>💰 <strong>Amount:</strong> "50", "€25", ">100" (range searches)</li>
                        <li>📝 <strong>Category:</strong> Any category name</li>
                        <li>📄 <strong>Description:</strong> Any text in descriptions</li>
                        <li>👤 <strong>Person:</strong> Who paid for it</li>
                        <li>📅 <strong>Date:</strong> Specific dates or ranges</li>
                    </ul>
                    <p><strong>📊 Smart View Modes:</strong></p>
                    <ul>
                        <li><strong>Recent:</strong> Last 30 days (optimized for speed)</li>
                        <li><strong>All:</strong> Complete expense history with pagination</li>
                    </ul>
                `,
                target: ".search-container",
                action: "highlight"
            },
            {
                title: "📊 Interactive Dashboard & Analytics",
                content: `
                    <h3>Your financial command center!</h3>
                    <p><strong>📈 Real-time insights:</strong></p>
                    <ul>
                        <li>💹 <strong>Dynamic charts:</strong> Visual spending breakdown</li>
                        <li>📊 <strong>Monthly trends:</strong> Track spending patterns</li>
                        <li>🎯 <strong>Budget progress:</strong> Visual budget vs. actual</li>
                        <li>🔮 <strong>Smart projections:</strong> Predict monthly spending</li>
                        <li>💡 <strong>AI insights:</strong> Personalized financial advice</li>
                        <li>📅 <strong>Upcoming recurring:</strong> See what's due next</li>
                    </ul>
                    <p><strong>✨ Click Dashboard tab to see your financial story!</strong></p>
                `,
                target: '[data-tab="dashboard"]',
                action: "highlight"
            },
            {
                title: "🔄 Intelligent Recurring Expenses",
                content: `
                    <h3>Never forget a bill again!</h3>
                    <p><strong>⚡ Auto-processing features:</strong></p>
                    <ul>
                        <li>🏠 <strong>Housing:</strong> Rent, mortgage, utilities</li>
                        <li>📱 <strong>Subscriptions:</strong> Netflix, Spotify, gym memberships</li>
                        <li>🚗 <strong>Vehicle:</strong> Car payments, insurance, fuel</li>
                        <li>🛒 <strong>Regular shopping:</strong> Weekly groceries</li>
                        <li>💳 <strong>Bills:</strong> Credit cards, loans</li>
                    </ul>
                    <p><strong>🤖 Smart Features:</strong></p>
                    <ul>
                        <li>Auto-deducts from budget when due</li>
                        <li>Shows next 5 upcoming payments</li>
                        <li>Quick-add buttons for overdue payments</li>
                        <li>Visual urgency indicators (green/yellow/red)</li>
                    </ul>
                `,
                target: '[data-action="show-recurring"]',
                action: "highlight"
            },
            {
                title: "🧳 Trip Expense Management",
                content: `
                    <h3>Track group trips like a pro!</h3>
                    <p><strong>✈️ Smart trip features:</strong></p>
                    <ul>
                        <li>📅 <strong>Auto-status tracking:</strong> Upcoming → Ongoing → Completed</li>
                        <li>👥 <strong>Custom payer names:</strong> Track who paid what (no more "Friend 1"!)</li>
                        <li>📊 <strong>Expense breakdown:</strong> By category and by person</li>
                        <li>📱 <strong>Instant trip switching:</strong> Manage multiple trips easily</li>
                        <li>✅ <strong>Trip completion:</strong> Choose exact end date</li>
                        <li>🔄 <strong>Reopen completed trips:</strong> If plans change</li>
                    </ul>
                    <p><strong>💡 Perfect for group vacations, business trips, and events!</strong></p>
                `,
                target: '[data-tab="travel"]',
                action: "highlight"
            },
            {
                title: "📱 Cross-Device Data Sync",
                content: `
                    <h3>Access your data everywhere!</h3>
                    <p><strong>☁️ Multiple sync options:</strong></p>
                    <ul>
                        <li>📤 <strong>Export/Import:</strong> JSON backup files (works now!)</li>
                        <li>📱 <strong>QR Code transfer:</strong> Device-to-device sharing</li>
                        <li>🔥 <strong>Firebase sync:</strong> Real-time cloud sync (coming soon)</li>
                        <li>💾 <strong>Local sync mode:</strong> Privacy-focused option</li>
                    </ul>
                    <p><strong>🛡️ Data safety features:</strong></p>
                    <ul>
                        <li>✅ Validation before import</li>
                        <li>⚠️ Confirmation for data replacement</li>
                        <li>📋 Complete backup of all data</li>
                        <li>🔒 Your data, your control</li>
                    </ul>
                `,
                target: ".sync-status-card",
                action: "scrollTo"
            },
            {
                title: "💡 Interactive Budget Features",
                content: `
                    <h3>Budget management made smart!</h3>
                    <p><strong>🎯 Clickable budget elements:</strong></p>
                    <ul>
                        <li>💰 <strong>Click "Spent":</strong> See detailed breakdown by category</li>
                        <li>📊 <strong>Click "Remaining":</strong> View upcoming recurring payments</li>
                        <li>📋 <strong>Click expense count:</strong> See what expenses are for</li>
                        <li>🔮 <strong>Click projection:</strong> Detailed spending forecast</li>
                    </ul>
                    <p><strong>📈 Smart projections:</strong></p>
                    <ul>
                        <li>Predicts end-of-month spending</li>
                        <li>Factors in remaining recurring expenses</li>
                        <li>Shows daily budget recommendations</li>
                        <li>Warns about potential overspending</li>
                    </ul>
                `,
                target: ".stats-grid",
                action: "highlight"
            },
            {
                title: "🔔 Advanced Notification System",
                content: `
                    <h3>Stay on top of your finances!</h3>
                    <p><strong>🤖 Intelligent reminders:</strong></p>
                    <ul>
                        <li>📅 <strong>3 days before</strong> recurring expenses due</li>
                        <li>⚠️ <strong>1 day before</strong> with urgent priority</li>
                        <li>🚨 <strong>Overdue alerts</strong> for missed payments</li>
                        <li>💰 <strong>Budget warnings</strong> when approaching limit</li>
                        <li>📊 <strong>Monthly summaries</strong> and insights</li>
                    </ul>
                    <p><strong>⚡ Quick actions from notifications:</strong></p>
                    <ul>
                        <li>Click notification to open app</li>
                        <li>Quick-add expenses directly</li>
                        <li>Mark recurring expenses as paid</li>
                    </ul>
                `,
                target: "#notificationStatus",
                action: "scrollTo"
            },
            {
                title: "⚙️ Powerful Settings & Customization",
                content: `
                    <h3>Make the app truly yours!</h3>
                    <p><strong>🎨 Personalization options:</strong></p>
                    <ul>
                        <li>💰 <strong>Monthly budget:</strong> Set goals and get alerts</li>
                        <li>🎯 <strong>Custom categories:</strong> Create categories with emojis</li>
                        <li>📱 <strong>Data sync:</strong> Export, import, QR codes</li>
                        <li>🔔 <strong>Notification preferences:</strong> Test and configure</li>
                        <li>⌨️ <strong>Keyboard shortcuts:</strong> Power user features</li>
                        <li>📊 <strong>Data management:</strong> Export, clear, backup</li>
                    </ul>
                    <p><strong>🔧 Advanced features:</strong></p>
                    <ul>
                        <li>Theme customization (coming soon)</li>
                        <li>Currency settings</li>
                        <li>Export formats (CSV, JSON)</li>
                    </ul>
                `,
                target: '[data-tab="settings"]',
                action: "highlight"
            },
            {
                title: "🚀 You're Ready to Master Your Finances!",
                content: `
                    <h3>Your complete financial toolkit!</h3>
                    <p><strong>🎯 Immediate next steps:</strong></p>
                    <ul>
                        <li>📱 Add app to home screen for quick access</li>
                        <li>🔔 Enable notifications for smart reminders</li>
                        <li>💰 Set your monthly budget goal</li>
                        <li>📝 Add your first few expenses</li>
                        <li>🔄 Set up recurring bills and subscriptions</li>
                        <li>🧳 Create a trip for vacation planning</li>
                        <li>📤 Export data as backup</li>
                    </ul>
                    <p><strong>💡 Pro power-user tips:</strong></p>
                    <ul>
                        <li>Use Ctrl+N to quickly add expenses</li>
                        <li>Click budget elements for detailed breakdowns</li>
                        <li>Set up recurring expenses to automate tracking</li>
                        <li>Use trip mode for group expense management</li>
                        <li>Export data regularly as backup</li>
                        <li>Sync across devices for everywhere access</li>
                    </ul>
                    <p><strong>🎉 Welcome to effortless expense tracking!</strong></p>
                `,
                target: null,
                action: null
            }
        ];
         }

         let currentGuideStep = 0;
         let isGuideActive = false;

         function startGuide(isQuickTour = false) {
             if (isQuickTour) {
                 // Quick tour shows only essential steps: Expense tracking, Dashboard, Trip management, Data sync
                 currentGuideStep = 0;
                                 const allSteps = getGuideSteps();
                const quickSteps = [
                    allSteps[2],  // Smart Expense Tracking
                    allSteps[5],  // Interactive Dashboard
                    allSteps[7],  // Trip Management
                    allSteps[8],  // Data Sync
                    allSteps[12]  // Final steps
                ];
                                 showGuideStep(quickSteps, 0, true);
            } else {
                // Full guide shows all steps
                currentGuideStep = 0;
                showGuideStep(getGuideSteps(), 0, false);
            }
             
             isGuideActive = true;
             document.getElementById('guideOverlay').style.display = 'flex';
             
             // Mark that user has seen the guide
             localStorage.setItem('hasSeenGuide', 'true');
         }

         function showGuideStep(steps, stepIndex, isQuickTour) {
             const step = steps[stepIndex];
             if (!step) return;

             // Update content
             document.getElementById('guideTitle').innerHTML = step.title;
             document.getElementById('guideText').innerHTML = step.content;
             
             // Update progress
             const progress = ((stepIndex + 1) / steps.length) * 100;
             document.getElementById('guideProgress').style.width = progress + '%';
             document.getElementById('guideProgressText').textContent = 
                 `Step ${stepIndex + 1} of ${steps.length}`;

             // Update buttons
             const prevBtn = document.getElementById('guidePrevBtn');
             const nextBtn = document.getElementById('guideNextBtn');
             const finishBtn = document.getElementById('guideFinishBtn');

             prevBtn.style.display = stepIndex > 0 ? 'block' : 'none';
             nextBtn.style.display = stepIndex < steps.length - 1 ? 'block' : 'none';
             finishBtn.style.display = stepIndex === steps.length - 1 ? 'block' : 'none';

             // Handle spotlight
             handleGuideAction(step);

             // Store current state
             window.currentGuideSteps = steps;
             window.currentStepIndex = stepIndex;
             window.isQuickTour = isQuickTour;
         }

         function handleGuideAction(step) {
             const spotlight = document.getElementById('guideSpotlight');
             spotlight.classList.remove('active');

             if (step.target && step.action) {
                 const targetElement = document.querySelector(step.target);
                 if (targetElement) {
                     setTimeout(() => {
                         if (step.action === 'highlight') {
                             highlightElement(targetElement);
                         } else if (step.action === 'scrollTo') {
                             scrollToElement(targetElement);
                         }
                     }, 300);
                 }
             }
         }

         function highlightElement(element) {
             const rect = element.getBoundingClientRect();
             const spotlight = document.getElementById('guideSpotlight');
             
             spotlight.style.left = (rect.left - 10) + 'px';
             spotlight.style.top = (rect.top - 10) + 'px';
             spotlight.style.width = (rect.width + 20) + 'px';
             spotlight.style.height = (rect.height + 20) + 'px';
             spotlight.classList.add('active');
         }

         function scrollToElement(element) {
             element.scrollIntoView({ 
                 behavior: 'smooth', 
                 block: 'center' 
             });
             setTimeout(() => highlightElement(element), 500);
         }

         function nextGuideStep() {
             const steps = window.currentGuideSteps;
             const currentIndex = window.currentStepIndex;
             
             if (currentIndex < steps.length - 1) {
                 showGuideStep(steps, currentIndex + 1, window.isQuickTour);
             }
         }

         function prevGuideStep() {
             const steps = window.currentGuideSteps;
             const currentIndex = window.currentStepIndex;
             
             if (currentIndex > 0) {
                 showGuideStep(steps, currentIndex - 1, window.isQuickTour);
             }
         }

         function closeGuide() {
             document.getElementById('guideOverlay').style.display = 'none';
             document.getElementById('guideSpotlight').classList.remove('active');
             isGuideActive = false;
         }

         function skipGuide() {
             if (confirm('Are you sure you want to skip the guide? You can access it anytime from Settings.')) {
                 closeGuide();
             }
         }

         function showWelcomeBackMessage() {
             // Create main container
             const messageDiv = document.createElement('div');
             messageDiv.style.cssText = `
                 position: fixed; 
                 top: 20px; 
                 right: 20px; 
                 background: var(--card-bg); 
                 border: 2px solid var(--primary-color);
                 border-radius: var(--border-radius-xl);
                 padding: 1.5rem; 
                 box-shadow: var(--shadow-xl);
                 z-index: 1000;
                 max-width: 350px;
                 animation: slideInRight 0.5s ease-out;
             `;
             
             // Create header
             const headerDiv = document.createElement('div');
             headerDiv.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;';
             
             const title = document.createElement('h3');
             title.style.cssText = 'margin: 0; color: var(--primary-color);';
             title.textContent = '🎉 Welcome Back!';
             
             const closeBtn = document.createElement('button');
             closeBtn.style.cssText = `
                 background: none; 
                 border: none; 
                 font-size: 1.2rem; 
                 cursor: pointer;
                 color: var(--text-secondary);
             `;
             closeBtn.textContent = '✖️';
             closeBtn.addEventListener('click', () => {
                 messageDiv.remove();
             });
             
             headerDiv.appendChild(title);
             headerDiv.appendChild(closeBtn);
             
             // Create message text
             const messageText = document.createElement('p');
             messageText.style.cssText = 'margin: 0 0 1rem 0; color: var(--text-primary);';
             messageText.textContent = "We've added new features! Want a quick tour to see what's new?";
             
             // Create button container
             const buttonContainer = document.createElement('div');
             buttonContainer.style.cssText = 'display: flex; gap: 0.5rem;';
             
             // Create Quick Tour button
             const quickTourBtn = document.createElement('button');
             quickTourBtn.className = 'btn btn-primary';
             quickTourBtn.style.cssText = 'font-size: 0.9rem; padding: 0.5rem 1rem;';
             quickTourBtn.textContent = '⚡ Quick Tour';
             quickTourBtn.addEventListener('click', () => {
                 startGuide(true);
                 messageDiv.remove();
             });
             
             // Create Maybe Later button
             const laterBtn = document.createElement('button');
             laterBtn.className = 'btn btn-secondary';
             laterBtn.style.cssText = 'font-size: 0.9rem; padding: 0.5rem 1rem;';
             laterBtn.textContent = 'Maybe Later';
             laterBtn.addEventListener('click', () => {
                 messageDiv.remove();
             });
             
             // Assemble the message
             buttonContainer.appendChild(quickTourBtn);
             buttonContainer.appendChild(laterBtn);
             
             messageDiv.appendChild(headerDiv);
             messageDiv.appendChild(messageText);
             messageDiv.appendChild(buttonContainer);
             
             // Add to DOM
             document.body.appendChild(messageDiv);
             
             // Auto-remove after 10 seconds
             setTimeout(() => {
                 if (messageDiv && messageDiv.parentNode) {
                     messageDiv.remove();
                 }
             }, 10000);
         }

         // Add keyboard support for guide navigation
         document.addEventListener('keydown', (e) => {
             if (!isGuideActive) return;
             
             if (e.key === 'ArrowRight' || e.key === 'Enter') {
                 e.preventDefault();
                 const nextBtn = document.getElementById('guideNextBtn');
                 const finishBtn = document.getElementById('guideFinishBtn');
                 
                 if (nextBtn.style.display !== 'none') {
                     nextGuideStep();
                 } else if (finishBtn.style.display !== 'none') {
                     closeGuide();
                 }
             } else if (e.key === 'ArrowLeft') {
                 e.preventDefault();
                 const prevBtn = document.getElementById('guidePrevBtn');
                 if (prevBtn.style.display !== 'none') {
                     prevGuideStep();
                 }
             } else if (e.key === 'Escape') {
                 e.preventDefault();
                 skipGuide();
             }
         });

         // Create a test recurring expense that will trigger a reminder soon
         function createTestReminder() {
             // Create a test recurring expense due in 3 days
             const testDate = new Date();
             testDate.setDate(testDate.getDate() - 27); // Set last processed to 27 days ago for monthly (30 days)
             
             const testRecurring = {
                 id: Date.now(),
                 category: 'Test Reminder',
                 amount: 25.00,
                 description: 'Test recurring expense for notifications',
                 person: 'Test User',
                 frequency: 'Monthly',
                 isActive: true,
                 startDate: testDate.toISOString().split('T')[0],
                 lastProcessedDate: testDate.toISOString().split('T')[0],
                 endDate: null
             };
             
             recurringExpenses.push(testRecurring);
             localStorage.setItem('recurringExpenses', JSON.stringify(recurringExpenses));
             
             showNotification('🧪 Test reminder created! Due in 3 days. Check console for details.', 'success');
             console.log('🧪 Test recurring expense created:', testRecurring);
             console.log('📅 This expense will trigger a reminder in 3 days');
             
             // Update the notification status to show the new recurring expense
             updateNotificationStatus();
             
             // Refresh recurring list if modal is open
             if (document.getElementById('recurringModal').style.display === 'block') {
                 renderRecurringList();
             }
         }

         // Handle URL parameters for deep linking
        function handleURLParameters() {
            const urlParams = new URLSearchParams(window.location.search);
            
            if (urlParams.get('action') === 'add') {
                scrollToForm();
                
                // Pre-fill form if category and amount are provided (from notification)
                const category = urlParams.get('category');
                const amount = urlParams.get('amount');
                
                if (category) {
                    const categorySelect = document.getElementById('category');
                    if (categorySelect) {
                        categorySelect.value = decodeURIComponent(category);
                    }
                }
                
                if (amount) {
                    const amountInput = document.getElementById('amount');
                    if (amountInput) {
                        amountInput.value = amount;
                    }
                }
                
                console.log('📝 Pre-filled form from notification:', { category, amount });
            } else if (urlParams.get('tab')) {
                const tab = urlParams.get('tab');
                if (tab === 'dashboard' || tab === 'settings') {
                    switchTab(tab);
                }
            } else if (urlParams.get('action') === 'recurring') {
                showRecurringModal();
            }
        }

        // Force cache clear and app reload (for debugging cache issues)
        async function forceClearCacheAndReload() {
            try {
                // Clear all caches
                if ('caches' in window) {
                    const cacheNames = await caches.keys();
                    await Promise.all(cacheNames.map(name => caches.delete(name)));
                    console.log('🗑️ All caches cleared');
                }
                
                // Unregister service worker
                if ('serviceWorker' in navigator) {
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    await Promise.all(registrations.map(reg => reg.unregister()));
                    console.log('🚫 Service worker unregistered');
                }
                
                // Force hard reload
                window.location.reload(true);
            } catch (error) {
                console.error('❌ Error clearing cache:', error);
                window.location.reload(true);
            }
        }

        // Add to window for debugging
        window.forceClearCacheAndReload = forceClearCacheAndReload;

        // Check version on app load and force update if needed
        window.addEventListener('load', () => {
            // Add version to console for debugging
            console.log('📱 App Version: 2.1.1-all-toggles-fix');
            console.log('🔧 If you have cache issues, run: forceClearCacheAndReload()');
        });

        // Listen for messages from service worker
        navigator.serviceWorker.addEventListener('message', event => {
            console.log('📨 Message from SW:', event.data);
            
            if (event.data.type === 'notification-action') {
                const { action, data, url } = event.data;
                
                if (action === 'add-expense' && data && data.category) {
                    // Pre-fill the form
                    scrollToForm();
                    
                    const categorySelect = document.getElementById('category');
                    const amountInput = document.getElementById('amount');
                    
                    if (categorySelect && data.category) {
                        categorySelect.value = data.category;
                    }
                    
                    if (amountInput && data.amount) {
                        amountInput.value = data.amount;
                    }
                    
                    console.log('📝 Pre-filled form from SW message:', data);
                } else if (action === 'view-recurring') {
                    showRecurringModal();
                }
            }
        });

        // Show update notification when new version is available
        function showUpdateNotification() {
            showNotification('🔄 New version available! Refresh to update.', 'info');
        }
        // Setup secure event listeners (replaces inline onclick handlers)
        function setupEventListeners() {
            // Navigation tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabName = this.getAttribute('data-tab');
                    if (tabName) {
                        switchTab(tabName);
                        // Update active state
                        document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                        this.classList.add('active');
                    }
                });
            });

            // Quick actions
            document.querySelectorAll('.quick-action').forEach(action => {
                action.addEventListener('click', function() {
                    const actionType = this.getAttribute('data-action');
                    const category = this.getAttribute('data-category');
                    
                    if (actionType === 'quick-form' && category) {
                        showForm(category);
                    } else if (actionType === 'show-insights') {
                        showInsights();
                    } else if (actionType === 'show-recurring') {
                        showRecurringModal();
                    }
                });
            });

            // Search functionality
            const searchInput = document.getElementById('searchInput');
            const clearSearch = document.getElementById('clearSearch');
            
            if (searchInput) {
                searchInput.addEventListener('input', handleSearch);
                searchInput.addEventListener('keyup', handleSearch);
            }
            
            if (clearSearch) {
                clearSearch.addEventListener('click', function() {
                    clearSearchFunction();
                });
            }

            // View mode toggle
            document.querySelectorAll('.view-mode-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const mode = this.getAttribute('data-view-mode');
                    if (mode) {
                        setViewMode(mode);
                    }
                });
            });

            // Filter selects
            const categoryFilter = document.getElementById('categoryFilter');
            const personFilter = document.getElementById('personFilter');
            
            if (categoryFilter) {
                categoryFilter.addEventListener('change', filterExpenses);
            }
            
            if (personFilter) {
                personFilter.addEventListener('change', filterExpenses);
            }

            // Dark mode toggle
            const darkModeToggle = document.getElementById('darkModeToggle');
            if (darkModeToggle) {
                darkModeToggle.addEventListener('change', toggleDarkMode);
            }

            // Pagination buttons
            const prevPageBtn = document.getElementById('prevPageBtn');
            const nextPageBtn = document.getElementById('nextPageBtn');
            const prevPageBtnBottom = document.getElementById('prevPageBtnBottom');
            const nextPageBtnBottom = document.getElementById('nextPageBtnBottom');
            
            if (prevPageBtn) {
                prevPageBtn.addEventListener('click', () => changePage(-1));
            }
            
            if (nextPageBtn) {
                nextPageBtn.addEventListener('click', () => changePage(1));
            }

            if (prevPageBtnBottom) {
                prevPageBtnBottom.addEventListener('click', () => changePage(-1));
            }
            
            if (nextPageBtnBottom) {
                nextPageBtnBottom.addEventListener('click', () => changePage(1));
            }

            // FAB button
            const fabBtn = document.getElementById('fabScrollBtn');
            if (fabBtn) {
                fabBtn.addEventListener('click', scrollToForm);
            }

            // Data management buttons
            const exportAllDataBtn = document.getElementById('exportAllDataBtn');
            const clearAllDataBtn = document.getElementById('clearAllDataBtn');
            
            if (exportAllDataBtn) {
                exportAllDataBtn.addEventListener('click', exportToCSV);
            }
            
            if (clearAllDataBtn) {
                clearAllDataBtn.addEventListener('click', clearAllData);
            }

            // Clear cache button
            const clearCacheBtn = document.getElementById('clearCacheBtn');
            if (clearCacheBtn) {
                clearCacheBtn.addEventListener('click', () => {
                    if (confirm('This will clear the app cache and reload. Your data will be preserved. Continue?')) {
                        forceClearCacheAndReload();
                    }
                });
            }

            // Initialize sync manager after DOM is loaded
            syncManager = new DataSyncManager();
            
            // Check for URL import parameter
            checkURLImport();

            // Sync functionality event listeners
            const toggleSyncBtn = document.getElementById('toggleSyncBtn');
            if (toggleSyncBtn) {
                toggleSyncBtn.addEventListener('click', toggleSync);
            }

            const exportDataBtn = document.getElementById('exportDataBtn');
            if (exportDataBtn) {
                exportDataBtn.addEventListener('click', () => {
                    if (syncManager) syncManager.exportData();
                });
            }

            const importDataBtn = document.getElementById('importDataBtn');
            const importDataFile = document.getElementById('importDataFile');
            if (importDataBtn && importDataFile) {
                importDataBtn.addEventListener('click', () => {
                    importDataFile.click();
                });
                importDataFile.addEventListener('change', (e) => {
                    if (e.target.files[0] && syncManager) {
                        syncManager.importData(e.target.files[0]);
                    }
                });
            }

            const generateQRBtn = document.getElementById('generateQRBtn');
            if (generateQRBtn) {
                generateQRBtn.addEventListener('click', () => {
                    if (syncManager) syncManager.generateQRCode();
                });
            }

            const scanQRBtn = document.getElementById('scanQRBtn');
            if (scanQRBtn) {
                scanQRBtn.addEventListener('click', () => {
                    startQRScanner();
                });
            }

            // Custom category buttons
            const addCustomCategoryBtn = document.getElementById('addCustomCategoryBtn');
            const cancelCustomCategoryBtn = document.getElementById('cancelCustomCategoryBtn');
            
            if (addCustomCategoryBtn) {
                addCustomCategoryBtn.addEventListener('click', addCustomCategory);
            }
            
            if (cancelCustomCategoryBtn) {
                cancelCustomCategoryBtn.addEventListener('click', cancelCustomCategory);
            }

            // Cancel edit button
            const cancelEditBtn = document.getElementById('cancelEdit');
            if (cancelEditBtn) {
                cancelEditBtn.addEventListener('click', cancelEdit);
            }

            // Export CSV button
            const exportCSVBtn = document.getElementById('exportCSVBtn');
            if (exportCSVBtn) {
                exportCSVBtn.addEventListener('click', exportToCSV);
            }

            // Export JSON button
            const exportJSONBtn = document.getElementById('exportJSONBtn');
            if (exportJSONBtn) {
                exportJSONBtn.addEventListener('click', exportToJSON);
            }

            // Export Excel button (Premium)
            const exportExcelBtn = document.getElementById('exportExcelBtn');
            if (exportExcelBtn) {
                exportExcelBtn.addEventListener('click', exportToExcel);
            }

            // Export PDF button (Premium)
            const exportPDFBtn = document.getElementById('exportPDFBtn');
            if (exportPDFBtn) {
                exportPDFBtn.addEventListener('click', exportToPDF);
            }

            // Set budget button
            const setBudgetBtn = document.getElementById('setBudgetBtn');
            if (setBudgetBtn) {
                setBudgetBtn.addEventListener('click', setBudget);
            }
            
            // Set currency button
            const setCurrencyBtn = document.getElementById('setCurrencyBtn');
            if (setCurrencyBtn) {
                setCurrencyBtn.addEventListener('click', setCurrency);
            }

            // Recurring modal buttons
            const processRecurringBtn = document.getElementById('processRecurringBtn');
            const checkRecurringBtn = document.getElementById('checkRecurringBtn');
            const closeRecurringBtn = document.getElementById('closeRecurringBtn');
            
            if (processRecurringBtn) {
                processRecurringBtn.addEventListener('click', processRecurringExpenses);
            }
            
            if (checkRecurringBtn) {
                checkRecurringBtn.addEventListener('click', checkRecurringExpenses);
            }
            
            if (closeRecurringBtn) {
                closeRecurringBtn.addEventListener('click', closeRecurringModal);
            }

            // Insights modal close button
            const closeInsightsBtn = document.getElementById('closeInsightsBtn');
            if (closeInsightsBtn) {
                closeInsightsBtn.addEventListener('click', closeInsights);
            }

            // Notification test buttons
            const testNotificationBtn = document.getElementById('testNotificationBtn');
            const checkRemindersBtn = document.getElementById('checkRemindersBtn');
            const createTestReminderBtn = document.getElementById('createTestReminderBtn');
            
            if (testNotificationBtn) {
                testNotificationBtn.addEventListener('click', testNotification);
            }
            
            if (checkRemindersBtn) {
                checkRemindersBtn.addEventListener('click', checkRecurringReminders);
            }
            
            if (createTestReminderBtn) {
                createTestReminderBtn.addEventListener('click', createTestReminder);
            }

            // Guide buttons
            const startGuideBtn = document.getElementById('startGuideBtn');
            const quickTourBtn = document.getElementById('quickTourBtn');
            const closeGuideBtn = document.getElementById('closeGuideBtn');
            const helpBtn = document.getElementById('helpBtn');
            const guideNextBtn = document.getElementById('guideNextBtn');
            const guidePrevBtn = document.getElementById('guidePrevBtn');
            const guideSkipBtn = document.getElementById('guideSkipBtn');
            const guideFinishBtn = document.getElementById('guideFinishBtn');

            if (startGuideBtn) {
                startGuideBtn.addEventListener('click', () => startGuide(false));
            }

            if (quickTourBtn) {
                quickTourBtn.addEventListener('click', () => startGuide(true));
            }

            if (helpBtn) {
                helpBtn.addEventListener('click', () => startGuide(true));
            }

            if (closeGuideBtn) {
                closeGuideBtn.addEventListener('click', closeGuide);
            }

            if (guideNextBtn) {
                guideNextBtn.addEventListener('click', nextGuideStep);
            }

            if (guidePrevBtn) {
                guidePrevBtn.addEventListener('click', prevGuideStep);
            }

            if (guideSkipBtn) {
                guideSkipBtn.addEventListener('click', skipGuide);
            }

            if (guideFinishBtn) {
                guideFinishBtn.addEventListener('click', closeGuide);
            }

            // Close guide on overlay click
            document.getElementById('guideOverlay').addEventListener('click', (e) => {
                if (e.target.id === 'guideOverlay') {
                    skipGuide();
                }
            });

            // Travel tracker event listeners
            setupTravelEventListeners();
        }

        function setupTravelEventListeners() {
            // Travel quick actions
            document.querySelectorAll('.travel-action').forEach(action => {
                action.addEventListener('click', function() {
                    const category = this.getAttribute('data-travel-category');
                    if (category) {
                        document.getElementById('travelCategory').value = category;
                        document.getElementById('travelAmount').focus();
                    }
                });
            });

            // Travel expense form
            const travelExpenseForm = document.getElementById('travelExpenseForm');
            if (travelExpenseForm) {
                travelExpenseForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const formData = {
                        amount: document.getElementById('travelAmount').value,
                        category: document.getElementById('travelCategory').value,
                        currency: document.getElementById('travelCurrency').value,
                        date: document.getElementById('travelDate').value,
                        location: document.getElementById('travelLocation').value,
                        payer: document.getElementById('travelPayer').value,
                        description: document.getElementById('travelDescription').value,
                        deductFromMainBudget: document.getElementById('mainBudgetToggle').checked
                    };

                    if (travelEditingId) {
                        // Update existing expense
                        const expense = travelExpenses.find(e => e.id === travelEditingId);
                        if (expense) {
                            const oldDeductStatus = expense.deductFromMainBudget;
                            
                            expense.amount = parseFloat(formData.amount);
                            expense.category = formData.category;
                            expense.date = formData.date;
                            expense.location = formData.location;
                            expense.payer = formData.payer;
                            expense.description = formData.description;
                            expense.deductFromMainBudget = formData.deductFromMainBudget;
                            
                            // Handle main budget changes
                            if (oldDeductStatus && !formData.deductFromMainBudget) {
                                // Was deducting, now not - remove from main expenses
                                const mainExpenseIndex = expenses.findIndex(e => e.travelExpenseId === expense.id);
                                if (mainExpenseIndex !== -1) {
                                    expenses.splice(mainExpenseIndex, 1);
                                    localStorage.setItem('familyExpenses', JSON.stringify(expenses));
                                }
                            } else if (!oldDeductStatus && formData.deductFromMainBudget) {
                                // Wasn't deducting, now is - add to main expenses
                                addTravelExpenseToMain(expense);
                            } else if (oldDeductStatus && formData.deductFromMainBudget) {
                                // Was deducting and still is - update main expense
                                const mainExpense = expenses.find(e => e.travelExpenseId === expense.id);
                                if (mainExpense) {
                                    mainExpense.amount = expense.amount;
                                    mainExpense.category = expense.category;
                                    mainExpense.date = expense.date;
                                    mainExpense.description = `${expense.description} (Trip: ${currentTrip?.name || 'Unknown'})`;
                                    localStorage.setItem('familyExpenses', JSON.stringify(expenses));
                                }
                            }
                            
                            localStorage.setItem('travelExpenses', JSON.stringify(travelExpenses));
                            
                            cancelTravelEdit();
                            renderTravelExpensesList();
                            updateTravelCategoryBreakdown();
                            updateTripStats();
                            
                            showNotification('✈️ Travel expense updated!', 'success');
                        }
                    } else {
                        // Add new expense
                        const needsCurrencyConversion = formData.deductFromMainBudget && 
                            formData.currency !== mainCurrency;
                        
                        addTravelExpense(formData);
                        
                        // Only reset form if no currency conversion is needed
                        // (if conversion is needed, form will be reset in the callback)
                        if (!needsCurrencyConversion) {
                            this.reset();
                            document.getElementById('travelDate').valueAsDate = new Date();
                            document.getElementById('mainBudgetToggle').checked = false;
                        }
                    }
                });
            }

            // Cancel travel edit button
            const cancelTravelEditBtn = document.getElementById('cancelTravelEdit');
            if (cancelTravelEditBtn) {
                cancelTravelEditBtn.addEventListener('click', cancelTravelEdit);
            }

            // Trip management button (now focuses on creating new trips)
            const manageTripBtn = document.getElementById('manageTripBtn');
            if (manageTripBtn) {
                manageTripBtn.addEventListener('click', function() {
                    document.getElementById('tripModal').style.display = 'block';
                    renderTripsList();
                });
            }

            // Add new trip button (from main tab)
            const addNewTripBtn = document.getElementById('addNewTripBtn');
            if (addNewTripBtn) {
                addNewTripBtn.addEventListener('click', function() {
                    document.getElementById('tripModal').style.display = 'block';
                    renderTripsList();
                });
            }

            // Complete trip button
            const completeTripBtn = document.getElementById('completeTripBtn');
            if (completeTripBtn) {
                completeTripBtn.addEventListener('click', function() {
                    if (currentTrip) {
                        completeTrip(currentTrip.id);
                    }
                });
            }

            // Complete trip form
            const completeTripForm = document.getElementById('completeTripForm');
            if (completeTripForm) {
                completeTripForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const tripId = parseInt(document.getElementById('completeTripModal').dataset.tripId);
                    const completionDate = document.getElementById('completionDate').value;
                    finalizeCompleteTrip(tripId, completionDate);
                });
            }

            // New trip form
            const newTripForm = document.getElementById('newTripForm');
            if (newTripForm) {
                newTripForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const tripData = {
                        name: document.getElementById('newTripName').value,
                        destination: document.getElementById('newTripDestination').value,
                        startDate: document.getElementById('newTripStartDate').value,
                        endDate: document.getElementById('newTripEndDate').value,
                        budget: document.getElementById('newTripBudget').value,
                        currency: document.getElementById('newTripCurrency').value
                    };

                    if (window.editingTripId) {
                        // Update existing trip
                        updateTrip(window.editingTripId, tripData);
                        window.editingTripId = null;
                        
                        // Reset form button and modal title
                        document.querySelector('#newTripForm button[type="submit"]').textContent = '✈️ Create Trip';
                        document.querySelector('#tripModal h2').textContent = '✈️ Create New Trip';
                    } else {
                        // Create new trip
                        createNewTrip(tripData);
                    }
                    
                    this.reset();
                    document.getElementById('tripModal').style.display = 'none';
                });
            }

            // Close trip modal button
            const closeTripModalBtn = document.getElementById('closeTripModalBtn');
            if (closeTripModalBtn) {
                closeTripModalBtn.addEventListener('click', function() {
                    // Reset edit mode
                    if (window.editingTripId) {
                        window.editingTripId = null;
                        document.querySelector('#newTripForm button[type="submit"]').textContent = '✈️ Create Trip';
                        document.querySelector('#tripModal h2').textContent = '✈️ Create New Trip';
                    }
                    document.getElementById('tripModal').style.display = 'none';
                });
            }

            // Export travel CSV button
            const exportTravelCSVBtn = document.getElementById('exportTravelCSVBtn');
            if (exportTravelCSVBtn) {
                exportTravelCSVBtn.addEventListener('click', exportTravelExpensesToCSV);
            }

            // Travel search and filters
            const travelSearchInput = document.getElementById('travelSearchInput');
            const clearTravelSearch = document.getElementById('clearTravelSearch');
            const travelCategoryFilter = document.getElementById('travelCategoryFilter');

            if (travelSearchInput) {
                travelSearchInput.addEventListener('input', handleTravelSearch);
                travelSearchInput.addEventListener('keyup', handleTravelSearch);
            }

            if (clearTravelSearch) {
                clearTravelSearch.addEventListener('click', function() {
                    travelSearchInput.value = '';
                    clearTravelSearch.style.display = 'none';
                    renderTravelExpensesList();
                });
            }

            if (travelCategoryFilter) {
                travelCategoryFilter.addEventListener('change', filterTravelExpenses);
            }
        }

        function handleTravelSearch() {
            const searchTerm = document.getElementById('travelSearchInput').value.toLowerCase();
            const clearBtn = document.getElementById('clearTravelSearch');
            
            if (searchTerm.length > 0) {
                clearBtn.style.display = 'block';
                filterTravelExpenses();
            } else {
                clearBtn.style.display = 'none';
                renderTravelExpensesList();
            }
        }

        function filterTravelExpenses() {
            if (!currentTrip) return;

            const searchTerm = document.getElementById('travelSearchInput').value.toLowerCase();
            const categoryFilter = document.getElementById('travelCategoryFilter').value;
            
            let tripExpenses = travelExpenses.filter(e => e.tripId === currentTrip.id);
            
            // Apply search filter
            if (searchTerm) {
                tripExpenses = tripExpenses.filter(expense => 
                    expense.category.toLowerCase().includes(searchTerm) ||
                    expense.description.toLowerCase().includes(searchTerm) ||
                    expense.location.toLowerCase().includes(searchTerm) ||
                    expense.amount.toString().includes(searchTerm)
                );
            }
            
            // Apply category filter
            if (categoryFilter) {
                tripExpenses = tripExpenses.filter(expense => expense.category === categoryFilter);
            }
            
            // Render filtered expenses
            const travelExpensesList = document.getElementById('travelExpensesList');
            
            if (tripExpenses.length === 0) {
                travelExpensesList.innerHTML = '<div class="no-expenses">No expenses match your search criteria.</div>';
                return;
            }

            // Sort by date (newest first)
            const sortedExpenses = [...tripExpenses].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            travelExpensesList.innerHTML = '';
            
            sortedExpenses.forEach(expense => {
                const expenseElement = createTravelExpenseElement(expense);
                travelExpensesList.appendChild(expenseElement);
            });
        }

        // Enhanced DOMContentLoaded to include PWA features
        document.addEventListener('DOMContentLoaded', function() {
            // Setup secure event listeners
            setupEventListeners();
            
            // Handle URL parameters for deep linking
            handleURLParameters();
            
            // Initialize notification status display
            setTimeout(updateNotificationStatus, 1000);
            
            // Check if first-time user and show guide
            setTimeout(() => {
                const hasSeenGuide = localStorage.getItem('hasSeenGuide');
                const hasExpenses = expenses.length > 0;
                const hasRecurring = recurringExpenses.length > 0;
                const hasBudget = monthlyBudget > 0;
                
                // Show guide if it's a truly new user (no data at all)
                if (!hasSeenGuide && !hasExpenses && !hasRecurring && !hasBudget) {
                    console.log('👋 Welcome new user! Starting interactive guide...');
                    setTimeout(() => startGuide(false), 2000); // Delay to let page settle
                } else if (!hasSeenGuide) {
                    // User has some data but hasn't seen guide - offer quick tour
                    console.log('💡 Existing data detected. Offering quick tour...');
                    showWelcomeBackMessage();
                }
            }, 1500);
            
            // Setup notification permission request
            if ('Notification' in window && Notification.permission === 'default') {
                // Show notification permission request after user interacts with the app
                setTimeout(() => {
                    if (expenses.length > 0 || monthlyBudget > 0) {
                        requestNotificationPermission();
                    }
                }, 30000); // Wait 30 seconds before asking
            }
            
            // Check if running as PWA
            if (window.matchMedia('(display-mode: standalone)').matches || 
                window.navigator.standalone === true) {
                console.log('✅ Running as PWA');
                document.body.classList.add('pwa-mode');
            }
            
            // Online/offline status handling
            window.addEventListener('online', () => {
                showNotification('You\'re back online!', 'success');
            });
            
            window.addEventListener('offline', () => {
                showNotification('You\'re offline. Changes will sync when you\'re back online.', 'info');
            });
            
            // Initialize travel tab when it becomes active
            if (document.getElementById('travelTab')) {
                initializeTravelTab();
            }
        });

        // ==================== TRAVEL TRACKER FUNCTIONALITY ====================

        // Travel tab initialization
        function initializeTravelTab() {
            // Update all trip statuses first
            updateTripsStatusBasedOnDates();
            updateTripDisplay();
            renderTravelExpensesList();
            updateTravelCategoryBreakdown();
            updateTripStats();
            updatePayerSuggestions();
            renderTripsList(); // Render trips list on the main tab
            
            // Set today's date for travel form
            if (document.getElementById('travelDate')) {
                document.getElementById('travelDate').valueAsDate = new Date();
            }
        }

        // Trip Management Functions
        function createNewTrip(tripData) {
            const trip = {
                id: Date.now(),
                name: tripData.name,
                destination: tripData.destination,
                startDate: tripData.startDate,
                endDate: tripData.endDate,
                budget: tripData.budget || 0,
                currency: tripData.currency || mainCurrency,
                status: 'active',
                createdAt: new Date().toISOString()
            };
            
            trips.push(trip);
            currentTrip = trip;
            
            // Save to localStorage
            localStorage.setItem('trips', JSON.stringify(trips));
            localStorage.setItem('currentTrip', JSON.stringify(currentTrip));
            
            updateTripDisplay();
            updateTripStats();
            renderTripsList();
            
            showNotification(`🚀 Trip "${trip.name}" started!`, 'success');
        }

        function switchToTrip(tripId) {
            const trip = trips.find(t => t.id === tripId);
            if (trip) {
                currentTrip = trip;
                localStorage.setItem('currentTrip', JSON.stringify(currentTrip));
                updateTripDisplay();
                updateTripStats();
                renderTravelExpensesList();
                updateTravelCategoryBreakdown();
                showNotification(`📍 Switched to "${trip.name}"`, 'success');
            }
        }

        function completeTrip(tripId) {
            const trip = trips.find(t => t.id === tripId);
            if (trip) {
                trip.status = 'completed';
                trip.completedAt = new Date().toISOString();
                
                if (currentTrip && currentTrip.id === tripId) {
                    currentTrip = null;
                    localStorage.setItem('currentTrip', JSON.stringify(currentTrip));
                }
                
                localStorage.setItem('trips', JSON.stringify(trips));
                updateTripDisplay();
                renderTripsList();
                showNotification(`✅ Trip "${trip.name}" completed!`, 'success');
            }
        }

        function deleteTrip(tripId) {
            if (confirm('Are you sure you want to delete this trip? This will also delete all associated expenses.')) {
                // Remove trip expenses
                travelExpenses = travelExpenses.filter(expense => expense.tripId !== tripId);
                
                // Remove trip
                trips = trips.filter(t => t.id !== tripId);
                
                // Clear current trip if it was deleted
                if (currentTrip && currentTrip.id === tripId) {
                    currentTrip = null;
                    localStorage.setItem('currentTrip', JSON.stringify(currentTrip));
                }
                
                localStorage.setItem('trips', JSON.stringify(trips));
                localStorage.setItem('travelExpenses', JSON.stringify(travelExpenses));
                
                updateTripDisplay();
                renderTripsList();
                renderTravelExpensesList();
                updateTravelCategoryBreakdown();
                updateTripStats();
                
                showNotification('🗑️ Trip deleted successfully', 'success');
            }
        }

        // Trip Management Functions
        function completeTrip(tripId) {
            // Set the trip ID and show the completion modal
            document.getElementById('completeTripModal').dataset.tripId = tripId;
            document.getElementById('completionDate').value = new Date().toISOString().split('T')[0]; // Set to today by default
            document.getElementById('completeTripModal').style.display = 'block';
        }

        function closeCompleteTripModal() {
            document.getElementById('completeTripModal').style.display = 'none';
        }

        function finalizeCompleteTrip(tripId, completionDate) {
            const trip = trips.find(t => t.id === tripId);
            if (trip) {
                trip.status = 'completed';
                trip.completedDate = completionDate;
                trip.endDate = completionDate; // Update the actual end date
                localStorage.setItem('trips', JSON.stringify(trips));
                
                // Clear current trip if it was the completed one
                if (currentTrip && currentTrip.id === tripId) {
                    currentTrip = null;
                    localStorage.removeItem('currentTrip');
                }
                
                updateTripDisplay();
                renderTripsList();
                closeCompleteTripModal();
                showNotification(`🎉 Trip "${trip.name}" completed successfully!`, 'success');
            }
        }

        function reopenTrip(tripId) {
            const trip = trips.find(t => t.id === tripId);
            if (trip) {
                // First, remove completed status so updateTripsStatusBasedOnDates can work
                trip.status = 'ongoing'; // Force to ongoing first
                delete trip.completedDate;
                
                // If there's an end date and it's in the past, remove it so trip can continue
                if (trip.endDate && new Date(trip.endDate) < new Date()) {
                    delete trip.endDate;
                }
                
                // Save the changes first
                localStorage.setItem('trips', JSON.stringify(trips));
                
                // Set as current active trip immediately
                currentTrip = trip;
                localStorage.setItem('currentTrip', JSON.stringify(currentTrip));
                
                // Update all UI elements
                updateTripDisplay();
                initializeTravelTab();
                renderTripsList();
                
                // Update trip statuses after reopening
                updateTripsStatusBasedOnDates();
                localStorage.setItem('trips', JSON.stringify(trips));
                
                showNotification(`🔄 Trip "${trip.name}" reopened and activated!`, 'success');
            }
        }
        function viewTripDetails(tripId) {
            const trip = trips.find(t => t.id === tripId);
            if (!trip) return;
            
            const tripExpenses = travelExpenses.filter(e => e.tripId === tripId);
            const total = tripExpenses.reduce((sum, e) => sum + e.amount, 0);
            
            // Group expenses by payer
            const expensesByPayer = {};
            tripExpenses.forEach(expense => {
                const payer = expense.payer || 'Unknown';
                if (!expensesByPayer[payer]) {
                    expensesByPayer[payer] = { total: 0, expenses: [] };
                }
                expensesByPayer[payer].total += expense.amount;
                expensesByPayer[payer].expenses.push(expense);
            });

            let payerBreakdown = '';
            Object.entries(expensesByPayer)
                .sort(([,a], [,b]) => b.total - a.total)
                .forEach(([payer, data]) => {
                    payerBreakdown += `
                        <div class="payer-breakdown">
                            <h4>👤 ${payer}: €${data.total.toFixed(2)} (${data.expenses.length} expenses)</h4>
                            <div class="payer-expenses">
                                ${data.expenses.map(e => `
                                    <div class="payer-expense-item">
                                        ${e.category} - €${e.amount.toFixed(2)} 
                                        <span style="color: var(--text-secondary);">(${new Date(e.date).toLocaleDateString()})</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                });

            const modalContent = `
                <div style="max-height: 60vh; overflow-y: auto;">
                    <div style="margin-bottom: 1.5rem;">
                        <h3>🧳 ${trip.name}</h3>
                        <p><strong>📍 Destination:</strong> ${trip.destination}</p>
                        <p><strong>📅 Dates:</strong> ${new Date(trip.startDate).toLocaleDateString()} - ${trip.endDate ? new Date(trip.endDate).toLocaleDateString() : 'Ongoing'}</p>
                        <p><strong>💰 Total Spent:</strong> €${total.toFixed(2)}</p>
                        <p><strong>📊 Status:</strong> ${trip.status === 'completed' ? '✅ Completed' : '🔄 Active'}</p>
                        ${trip.completedDate ? `<p><strong>🎉 Completed:</strong> ${new Date(trip.completedDate).toLocaleDateString()}</p>` : ''}
                    </div>
                    
                    ${payerBreakdown ? `
                        <div style="margin-bottom: 1.5rem;">
                            <h3>💳 Expenses by Payer</h3>
                            ${payerBreakdown}
                        </div>
                    ` : ''}
                    
                    <div class="trip-actions" style="display: flex; gap: 1rem; justify-content: center; margin-top: 1.5rem;">
                        ${trip.status === 'completed' ? 
                            `<button class="btn btn-primary" onclick="reopenTrip('${trip.id}'); closeTripDetailsModal();">🔄 Reopen Trip</button>` :
                            `<button class="btn btn-success" onclick="completeTrip('${trip.id}'); closeTripDetailsModal();">✅ Complete Trip</button>`
                        }
                        <button class="btn btn-secondary" onclick="closeTripDetailsModal()">Close</button>
                    </div>
                </div>
            `;

            // Create trip details modal if it doesn't exist
            let tripDetailsModal = document.getElementById('tripDetailsModal');
            if (!tripDetailsModal) {
                tripDetailsModal = document.createElement('div');
                tripDetailsModal.id = 'tripDetailsModal';
                tripDetailsModal.className = 'modal';
                tripDetailsModal.innerHTML = `
                    <div class="modal-content">
                        <h2>🧳 Trip Details</h2>
                        <div id="tripDetailsContent"></div>
                    </div>
                `;
                document.body.appendChild(tripDetailsModal);
            }

            document.getElementById('tripDetailsContent').innerHTML = modalContent;
            tripDetailsModal.style.display = 'block';
        }

        function closeTripDetailsModal() {
            const modal = document.getElementById('tripDetailsModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // Travel Expense Functions
        // Helper function to add travel expense to main budget
        function addTravelExpenseToMain(travelExpense) {
            const mainExpense = {
                id: Date.now() + Math.random(), // Ensure unique ID
                amount: travelExpense.convertedAmount || travelExpense.amount,
                currency: mainCurrency,
                originalAmount: travelExpense.amount,
                originalCurrency: travelExpense.currency,
                exchangeRate: travelExpense.exchangeRate,
                convertedAmount: travelExpense.convertedAmount || travelExpense.amount,
                category: travelExpense.category,
                person: travelExpense.payer || 'Family',
                description: `${travelExpense.description} (Trip: ${currentTrip?.name || 'Unknown'})`,
                date: travelExpense.date,
                timestamp: new Date().toISOString(),
                isRecurring: false,
                travelExpenseId: travelExpense.id, // Link back to travel expense
                source: 'trip'
            };
            
            expenses.push(mainExpense);
            localStorage.setItem('familyExpenses', JSON.stringify(expenses));
            
            // Update dashboard if we're on the main page
            if (typeof updateDashboard === 'function') {
                updateDashboard();
            }
            if (typeof filterAndRenderExpenses === 'function') {
                filterAndRenderExpenses();
            }
        }

        function addTravelExpense(expenseData) {
            if (!currentTrip) {
                showNotification('Please start a trip first!', 'error');
                return;
            }

            const expense = {
                id: Date.now(),
                tripId: currentTrip.id,
                amount: parseFloat(expenseData.amount),
                currency: expenseData.currency || currentTrip.currency || mainCurrency,
                category: expenseData.category,
                date: expenseData.date,
                location: expenseData.location || '',
                payer: expenseData.payer || 'Me',
                description: expenseData.description || '',
                deductFromMainBudget: expenseData.deductFromMainBudget || false,
                createdAt: new Date().toISOString()
            };

            // Check if currency conversion is needed for main budget deduction
            if (expense.deductFromMainBudget && expense.currency !== mainCurrency) {
                showExchangeRateModal(expense.currency, (rate) => {
                    expense.exchangeRate = rate;
                    expense.convertedAmount = getConvertedAmount(expense.amount, expense.currency, mainCurrency, rate);
                    
                    travelExpenses.push(expense);
                    localStorage.setItem('travelExpenses', JSON.stringify(travelExpenses));
                    
                    addTravelExpenseToMain(expense);
                    
                    renderTravelExpensesList();
                    updateTravelCategoryBreakdown();
                    updateTripStats();
                    
                    // Reset the travel expense form
                    document.getElementById('travelExpenseForm').reset();
                    document.getElementById('travelDate').valueAsDate = new Date();
                    document.getElementById('mainBudgetToggle').checked = false;
                    
                    // Reset currency to trip default
                    const travelCurrencySelect = document.getElementById('travelCurrency');
                    if (travelCurrencySelect) {
                        travelCurrencySelect.value = (currentTrip && currentTrip.currency) || mainCurrency;
                    }
                    
                    showNotification('✈️ Travel expense added!', 'success');
                });
                return;
            }
            
            // If same currency or not deducting from main budget
            expense.convertedAmount = expense.amount;

            travelExpenses.push(expense);
            localStorage.setItem('travelExpenses', JSON.stringify(travelExpenses));

            // Add to main expenses if toggle is enabled
            if (expense.deductFromMainBudget) {
                addTravelExpenseToMain(expense);
            }
            
            renderTravelExpensesList();
            updateTravelCategoryBreakdown();
            updateTripStats();
            
            showNotification('✈️ Travel expense added!', 'success');
        }

        function editTravelExpense(expenseId) {
            const expense = travelExpenses.find(e => e.id === expenseId);
            if (expense) {
                travelEditingId = expenseId;
                
                document.getElementById('travelAmount').value = expense.amount;
                document.getElementById('travelCategory').value = expense.category;
                document.getElementById('travelDate').value = expense.date;
                document.getElementById('travelLocation').value = expense.location;
                document.getElementById('travelPayer').value = expense.payer || 'Me';
                document.getElementById('travelDescription').value = expense.description;
                document.getElementById('mainBudgetToggle').checked = expense.deductFromMainBudget || false;
                
                document.getElementById('cancelTravelEdit').style.display = 'block';
                document.querySelector('#travelExpenseForm button[type="submit"]').textContent = '💾 Update Expense';
                
                // Scroll to form
                document.getElementById('travelExpenseForm').scrollIntoView({ behavior: 'smooth' });
            }
        }

        function deleteTravelExpense(expenseId) {
            if (confirm('Are you sure you want to delete this travel expense?')) {
                // Find the expense before deleting
                const expenseToDelete = travelExpenses.find(e => e.id === expenseId);
                
                // Remove from travel expenses
                travelExpenses = travelExpenses.filter(expense => expense.id !== expenseId);
                localStorage.setItem('travelExpenses', JSON.stringify(travelExpenses));
                
                // If it was linked to main budget, remove from main expenses too
                if (expenseToDelete && expenseToDelete.deductFromMainBudget) {
                    const mainExpenseIndex = expenses.findIndex(e => e.travelExpenseId === expenseId);
                    if (mainExpenseIndex !== -1) {
                        expenses.splice(mainExpenseIndex, 1);
                        localStorage.setItem('familyExpenses', JSON.stringify(expenses));
                        
                        // Update main dashboard
                        if (typeof updateDashboard === 'function') {
                            updateDashboard();
                        }
                        if (typeof filterAndRenderExpenses === 'function') {
                            filterAndRenderExpenses();
                        }
                    }
                }
                
                renderTravelExpensesList();
                updateTravelCategoryBreakdown();
                updateTripStats();
                
                showNotification('🗑️ Travel expense deleted', 'success');
            }
        }

        function cancelTravelEdit() {
            travelEditingId = null;
            document.getElementById('travelExpenseForm').reset();
            document.getElementById('travelDate').valueAsDate = new Date();
            document.getElementById('mainBudgetToggle').checked = false; // Reset toggle
            document.getElementById('cancelTravelEdit').style.display = 'none';
            document.querySelector('#travelExpenseForm button[type="submit"]').textContent = '💾 Add to Trip';
        }

        // Display Functions
        function updateTripDisplay() {
            const tripNameElement = document.getElementById('tripName');
            const manageTripBtn = document.getElementById('manageTripBtn');
            const completeTripBtn = document.getElementById('completeTripBtn');
            
            // Auto-update trip statuses first
            updateTripsStatusBasedOnDates();
            
            // Find the most relevant active trip (ongoing first, then upcoming)
            const ongoingTrips = trips.filter(t => t.status === 'ongoing');
            const upcomingTrips = trips.filter(t => t.status === 'upcoming');
            
            let activeTrip = null;
            if (ongoingTrips.length > 0) {
                activeTrip = ongoingTrips[0]; // Take the first ongoing trip
            } else if (upcomingTrips.length > 0) {
                activeTrip = upcomingTrips[0]; // Take the first upcoming trip
            }
            
            // Update currentTrip if we found a better match or if current is outdated
            if (activeTrip && (!currentTrip || currentTrip.status === 'completed')) {
                currentTrip = activeTrip;
                localStorage.setItem('currentTrip', JSON.stringify(currentTrip));
            }
            
            if (currentTrip && (currentTrip.status === 'ongoing' || currentTrip.status === 'upcoming')) {
                const statusEmoji = currentTrip.status === 'ongoing' ? '🟢' : '🟡';
                const currencyText = currentTrip.currency && currentTrip.currency !== mainCurrency ? ` [${currentTrip.currency}]` : '';
                tripNameElement.textContent = `${statusEmoji} ${currentTrip.name} (${currentTrip.destination})${currencyText}`;
                manageTripBtn.textContent = '✈️ New Trip';
                completeTripBtn.style.display = currentTrip.status === 'ongoing' ? 'block' : 'none';
            } else {
                tripNameElement.textContent = 'No active trip';
                manageTripBtn.textContent = '✈️ New Trip';
                completeTripBtn.style.display = 'none';
            }
        }

        function updateTripStats() {
            if (!currentTrip) {
                const defaultCurrency = mainCurrency || 'USD';
                document.getElementById('tripTotal').textContent = formatCurrencyAmount(0, defaultCurrency);
                document.getElementById('tripDays').textContent = '0';
                document.getElementById('tripExpenseCount').textContent = '0';
                document.getElementById('tripAvgDaily').textContent = formatCurrencyAmount(0, defaultCurrency);
                return;
            }

            const tripExpenses = travelExpenses.filter(e => e.tripId === currentTrip.id);
            const tripCurrency = currentTrip.currency || mainCurrency;
            
            // Check if all expenses use the same currency
            const expenseCurrencies = [...new Set(tripExpenses.map(e => e.currency || tripCurrency))];
            const displayCurrency = expenseCurrencies.length === 1 ? expenseCurrencies[0] : tripCurrency;
            
            // Calculate total
            const total = tripExpenses.reduce((sum, expense) => {
                const expenseCurrency = expense.currency || tripCurrency;
                // If we're displaying in the expense's currency, just add it
                if (displayCurrency === expenseCurrency) {
                    return sum + expense.amount;
                }
                // If mixed currencies and this expense was deducted from main budget with conversion
                if (expense.deductFromMainBudget && expense.convertedAmount && displayCurrency === mainCurrency) {
                    return sum + expense.convertedAmount;
                }
                // Otherwise just add the amount (simplified - in real app would need proper conversion)
                return sum + expense.amount;
            }, 0);
            
            // Calculate days
            const startDate = new Date(currentTrip.startDate);
            const endDate = currentTrip.endDate ? new Date(currentTrip.endDate) : new Date();
            const days = Math.max(1, Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1);
            
            const avgDaily = days > 0 ? total / days : 0;

            // Add indicator if mixed currencies
            let totalText = formatCurrencyAmount(total, displayCurrency);
            if (expenseCurrencies.length > 1) {
                totalText += ' *';
            }

            document.getElementById('tripTotal').textContent = totalText;
            document.getElementById('tripDays').textContent = days;
            document.getElementById('tripExpenseCount').textContent = tripExpenses.length;
            document.getElementById('tripAvgDaily').textContent = formatCurrencyAmount(avgDaily, displayCurrency);
        }

        function renderTravelExpensesList() {
            const travelExpensesList = document.getElementById('travelExpensesList');
            
            if (!currentTrip) {
                travelExpensesList.innerHTML = '<div class="no-expenses">Start a trip and add expenses to track your travel spending!</div>';
                return;
            }

            const tripExpenses = travelExpenses.filter(e => e.tripId === currentTrip.id);
            
            if (tripExpenses.length === 0) {
                travelExpensesList.innerHTML = '<div class="no-expenses">No expenses added for this trip yet. Start tracking your travel spending!</div>';
                return;
            }

            // Sort by date (newest first)
            const sortedExpenses = [...tripExpenses].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            travelExpensesList.innerHTML = '';
            
            sortedExpenses.forEach(expense => {
                const expenseElement = createTravelExpenseElement(expense);
                travelExpensesList.appendChild(expenseElement);
            });
        }

        function createTravelExpenseElement(expense) {
            const expenseDiv = document.createElement('div');
            expenseDiv.className = 'travel-expense-item';
            
            // Add visual indicator for main budget deduction
            if (expense.deductFromMainBudget) {
                expenseDiv.style.borderLeft = '4px solid var(--primary-color, #667eea)';
                expenseDiv.style.background = 'linear-gradient(90deg, rgba(102, 126, 234, 0.05) 0%, var(--bg-primary) 10%)';
            }
            
            const detailsDiv = document.createElement('div');
            detailsDiv.className = 'travel-expense-details';
            
            const title = document.createElement('h4');
            const expenseCurrency = expense.currency || currentTrip?.currency || mainCurrency;
            const currencySymbol = CURRENCIES[expenseCurrency]?.symbol || expenseCurrency;
            title.textContent = `${expense.category} - ${formatCurrencyAmount(expense.amount, expenseCurrency)}`;
            
            const details = document.createElement('p');
            const formattedDate = new Date(expense.date).toLocaleDateString();
            let detailsText = `📅 ${formattedDate}`;
            
            if (expense.payer) {
                detailsText += ` • 👤 Paid by: ${expense.payer}`;
            }
            
            if (expense.location) {
                detailsText += ` • 📍 ${expense.location}`;
            }
            
            if (expense.description) {
                detailsText += ` • ${expense.description}`;
            }
            
            if (expense.deductFromMainBudget) {
                detailsText += ` • 💰 Deducted from main budget`;
                // Show converted amount if different currency
                if (expenseCurrency !== mainCurrency && expense.convertedAmount) {
                    detailsText += ` (${formatCurrencyAmount(expense.convertedAmount, mainCurrency)})`;
                }
            }
            
            details.textContent = detailsText;
            
            detailsDiv.appendChild(title);
            detailsDiv.appendChild(details);
            
            const amountDiv = document.createElement('div');
            amountDiv.className = 'travel-expense-amount';
            
            // Show original amount
            amountDiv.innerHTML = formatCurrencyAmount(expense.amount, expenseCurrency);
            
            // Show converted amount below if different currency and deducted from main budget
            if (expense.deductFromMainBudget && expenseCurrency !== mainCurrency && expense.convertedAmount) {
                const convertedDiv = document.createElement('div');
                convertedDiv.style.fontSize = '0.85rem';
                convertedDiv.style.color = 'var(--text-secondary)';
                convertedDiv.style.marginTop = '2px';
                convertedDiv.textContent = `≈ ${formatCurrencyAmount(expense.convertedAmount, mainCurrency)}`;
                amountDiv.appendChild(convertedDiv);
            }
            
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'travel-expense-actions';
            
            const editBtn = document.createElement('button');
            editBtn.className = 'btn btn-warning';
            editBtn.textContent = '✏️';
            editBtn.title = 'Edit expense';
            editBtn.addEventListener('click', () => editTravelExpense(expense.id));
            
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'btn btn-danger';
            deleteBtn.textContent = '🗑️';
            deleteBtn.title = 'Delete expense';
            deleteBtn.addEventListener('click', () => deleteTravelExpense(expense.id));
            
            actionsDiv.appendChild(editBtn);
            actionsDiv.appendChild(deleteBtn);
            
            expenseDiv.appendChild(detailsDiv);
            expenseDiv.appendChild(amountDiv);
            expenseDiv.appendChild(actionsDiv);
            
            return expenseDiv;
        }

        function updateTravelCategoryBreakdown() {
            const breakdownContainer = document.getElementById('travelCategoryBreakdown');
            
            if (!currentTrip) {
                breakdownContainer.innerHTML = '<div class="no-breakdown">Start a trip to see category breakdown</div>';
                return;
            }

            const tripExpenses = travelExpenses.filter(e => e.tripId === currentTrip.id);
            
            if (tripExpenses.length === 0) {
                breakdownContainer.innerHTML = '<div class="no-breakdown">Add expenses to see category breakdown</div>';
                return;
            }

            // Calculate category totals
            const tripCurrency = currentTrip.currency || mainCurrency;
            
            // Check if all expenses use the same currency
            const expenseCurrencies = [...new Set(tripExpenses.map(e => e.currency || tripCurrency))];
            const displayCurrency = expenseCurrencies.length === 1 ? expenseCurrencies[0] : tripCurrency;
            
            const categoryTotals = {};
            
            tripExpenses.forEach(expense => {
                const expenseCurrency = expense.currency || tripCurrency;
                let amount = expense.amount;
                
                // If displaying in a different currency than the expense
                if (displayCurrency !== expenseCurrency) {
                    // If this expense was deducted from main budget with conversion
                    if (expense.deductFromMainBudget && expense.convertedAmount && displayCurrency === mainCurrency) {
                        amount = expense.convertedAmount;
                    }
                    // Otherwise use original amount (simplified)
                }
                
                categoryTotals[expense.category] = (categoryTotals[expense.category] || 0) + amount;
            });

            // Sort categories by amount (highest first)
            const sortedCategories = Object.entries(categoryTotals)
                .sort(([,a], [,b]) => b - a);

            breakdownContainer.innerHTML = '';
            
            sortedCategories.forEach(([category, amount]) => {
                const categoryItem = document.createElement('div');
                categoryItem.className = 'category-item';
                
                const categoryInfo = document.createElement('div');
                categoryInfo.className = 'category-item-info';
                categoryInfo.textContent = category;
                
                const categoryAmount = document.createElement('div');
                categoryAmount.className = 'category-amount';
                categoryAmount.textContent = formatCurrencyAmount(amount, displayCurrency);
                
                categoryItem.appendChild(categoryInfo);
                categoryItem.appendChild(categoryAmount);
                breakdownContainer.appendChild(categoryItem);
            });
        }

        function renderTripsList() {
            const mainTripsList = document.getElementById('mainTripsList');
            const modalTripsList = document.getElementById('tripsList');
            
            // Update both lists (main tab and modal if it exists)
            [mainTripsList, modalTripsList].forEach(tripsList => {
                if (!tripsList) return;
                
                if (trips.length === 0) {
                    tripsList.innerHTML = '<div class="no-trips">✈️ No trips created yet. Start your first adventure!</div>';
                    return;
                }

                tripsList.innerHTML = '';
                
                // Auto-update trip statuses based on dates
                updateTripsStatusBasedOnDates();
                
                // Sort trips: ongoing first, then upcoming, then completed (by start date)
                const sortedTrips = [...trips].sort((a, b) => {
                    const statusOrder = { 'ongoing': 1, 'upcoming': 2, 'active': 3, 'completed': 4 };
                    const aOrder = statusOrder[a.status] || 5;
                    const bOrder = statusOrder[b.status] || 5;
                    
                    if (aOrder !== bOrder) return aOrder - bOrder;
                    return new Date(b.startDate) - new Date(a.startDate);
                });

                sortedTrips.forEach(trip => {
                    const tripElement = createTripElement(trip, tripsList.id === 'mainTripsList');
                    tripsList.appendChild(tripElement);
                });
            });
            
            // Update payer suggestions
            updatePayerSuggestions();
        }

        function updateTripsStatusBasedOnDates() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            trips.forEach(trip => {
                if (trip.status === 'completed') return; // Don't auto-change completed trips
                
                const startDate = new Date(trip.startDate);
                const endDate = trip.endDate ? new Date(trip.endDate) : null;
                
                startDate.setHours(0, 0, 0, 0);
                if (endDate) endDate.setHours(0, 0, 0, 0);
                
                if (startDate > today) {
                    trip.status = 'upcoming';
                } else if (endDate && endDate < today) {
                    trip.status = 'completed';
                    trip.completedDate = trip.endDate;
                } else {
                    trip.status = 'ongoing';
                }
            });
            
            localStorage.setItem('trips', JSON.stringify(trips));
        }

        function updatePayerSuggestions() {
            // Get unique payer names from existing expenses
            const payerNames = [...new Set(travelExpenses.map(e => e.payer).filter(p => p))];
            const datalist = document.getElementById('payerSuggestions');
            
            // Clear existing options except default ones
            datalist.innerHTML = '<option value="Me"><option value="You">';
            
            // Add unique payer names
            payerNames.forEach(payer => {
                if (payer !== 'Me' && payer !== 'You') {
                    datalist.innerHTML += `<option value="${payer}">`;
                }
            });
        }

        function updateTrip(tripId, tripData) {
            const trip = trips.find(t => t.id === tripId);
            if (!trip) return;
            
            // Update trip data
            trip.name = tripData.name;
            trip.destination = tripData.destination;
            trip.startDate = tripData.startDate;
            trip.endDate = tripData.endDate || null;
            trip.budget = tripData.budget ? parseFloat(tripData.budget) : null;
            
            // Save to localStorage
            localStorage.setItem('trips', JSON.stringify(trips));
            
            // Update current trip if this is the current one
            if (currentTrip && currentTrip.id === tripId) {
                currentTrip = trip;
                localStorage.setItem('currentTrip', JSON.stringify(currentTrip));
                updateTripDisplay();
            }
            
            // Update trip statuses and refresh display
            updateTripsStatusBasedOnDates();
            renderTripsList();
            
            showNotification(`✅ Trip "${trip.name}" updated successfully!`, 'success');
        }

        function editTrip(tripId) {
            const trip = trips.find(t => t.id === tripId);
            if (!trip) return;
            
            // Populate the trip form with existing data
            document.getElementById('newTripName').value = trip.name;
            document.getElementById('newTripDestination').value = trip.destination;
            document.getElementById('newTripStartDate').value = trip.startDate;
            document.getElementById('newTripEndDate').value = trip.endDate || '';
            document.getElementById('newTripBudget').value = trip.budget || '';
            document.getElementById('newTripCurrency').value = trip.currency || mainCurrency;
            
            // Store the ID for updating
            window.editingTripId = tripId;
            
            // Change form button text and modal title
            document.querySelector('#newTripForm button[type="submit"]').textContent = '💾 Update Trip';
            document.querySelector('#tripModal h2').textContent = '✏️ Edit Trip';
            
            // Show the modal
            document.getElementById('tripModal').style.display = 'block';
            
            // Scroll to form
            document.getElementById('tripForm').scrollIntoView({ behavior: 'smooth' });
        }

        function createTripElement(trip, isMainTab = false) {
            const tripDiv = document.createElement('div');
            tripDiv.className = 'trip-item';
            
            const infoDiv = document.createElement('div');
            infoDiv.className = 'trip-item-info';
            
            const title = document.createElement('h4');
            title.textContent = trip.name;
            
            const details = document.createElement('p');
            const startDate = new Date(trip.startDate).toLocaleDateString();
            const endDate = trip.endDate ? new Date(trip.endDate).toLocaleDateString() : 'Ongoing';
            details.textContent = `📍 ${trip.destination} • 📅 ${startDate} - ${endDate}`;
            
            const status = document.createElement('span');
            status.className = `trip-status ${trip.status}`;
            
            switch(trip.status) {
                case 'upcoming':
                    status.textContent = '🟡 Upcoming';
                    break;
                case 'ongoing':
                    status.textContent = '🟢 Ongoing';
                    break;
                case 'active':
                    status.textContent = '🟢 Active';
                    break;
                case 'completed':
                    status.textContent = '✅ Completed';
                    break;
                default:
                    status.textContent = '🟢 Active';
            }
            
            infoDiv.appendChild(title);
            infoDiv.appendChild(details);
            infoDiv.appendChild(status);
            
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'trip-item-actions';
            
            if (trip.status === 'upcoming') {
                const switchBtn = document.createElement('button');
                switchBtn.className = 'btn btn-primary';
                switchBtn.textContent = '🚀 Start Trip';
                switchBtn.addEventListener('click', () => {
                    switchToTrip(trip.id);
                    if (!isMainTab) {
                        document.getElementById('tripModal').style.display = 'none';
                    }
                });
                actionsDiv.appendChild(switchBtn);
                
                const editBtn = document.createElement('button');
                editBtn.className = 'btn btn-secondary';
                editBtn.textContent = '✏️ Edit';
                editBtn.addEventListener('click', () => editTrip(trip.id));
                actionsDiv.appendChild(editBtn);
            } else if (trip.status === 'ongoing' || trip.status === 'active') {
                const switchBtn = document.createElement('button');
                switchBtn.className = 'btn btn-primary';
                switchBtn.textContent = '📍 Switch To';
                switchBtn.addEventListener('click', () => {
                    switchToTrip(trip.id);
                    if (!isMainTab) {
                        document.getElementById('tripModal').style.display = 'none';
                    }
                });
                actionsDiv.appendChild(switchBtn);
                
                const completeBtn = document.createElement('button');
                completeBtn.className = 'btn btn-success';
                completeBtn.textContent = '✅ Complete';
                completeBtn.addEventListener('click', () => completeTrip(trip.id));
                actionsDiv.appendChild(completeBtn);
            } else {
                // Completed trip actions
                const viewBtn = document.createElement('button');
                viewBtn.className = 'btn btn-info';
                viewBtn.textContent = '👁️ View Details';
                viewBtn.addEventListener('click', () => {
                    viewTripDetails(trip.id);
                    if (!isMainTab) {
                        document.getElementById('tripModal').style.display = 'none';
                    }
                });
                actionsDiv.appendChild(viewBtn);
                
                const reopenBtn = document.createElement('button');
                reopenBtn.className = 'btn btn-warning';
                reopenBtn.textContent = '🔄 Reopen';
                reopenBtn.addEventListener('click', () => reopenTrip(trip.id));
                actionsDiv.appendChild(reopenBtn);
            }
            
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'btn btn-danger';
            deleteBtn.textContent = '🗑️';
            deleteBtn.addEventListener('click', () => deleteTrip(trip.id));
            actionsDiv.appendChild(deleteBtn);
            
            tripDiv.appendChild(infoDiv);
            tripDiv.appendChild(actionsDiv);
            
            return tripDiv;
        }

        function exportTravelExpensesToCSV() {
            if (!currentTrip) {
                showNotification('No active trip to export!', 'error');
                return;
            }

            const tripExpenses = travelExpenses.filter(e => e.tripId === currentTrip.id);
            
            if (tripExpenses.length === 0) {
                showNotification('No expenses to export for this trip!', 'error');
                return;
            }

            const csvContent = [
                ['Date', 'Category', 'Amount (€)', 'Location', 'Description'],
                ...tripExpenses.map(expense => [
                    expense.date,
                    expense.category,
                    expense.amount.toFixed(2),
                    expense.location || '',
                    expense.description || ''
                ])
            ].map(row => row.map(field => `"${field}"`).join(',')).join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${currentTrip.name.replace(/[^a-z0-9]/gi, '_')}_expenses.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
            
            showNotification('📥 Trip expenses exported!', 'success');
        }

        // Version Management System
        let currentVersion = '0.0.1';
        let updateAvailable = false;

        // Check for updates
        async function checkForUpdates() {
            try {
                const response = await fetch('version.json?t=' + Date.now());
                const latestVersionData = await response.json();
                const latestVersion = latestVersionData.version;
                
                // Get current version from localStorage or default
                const storedVersion = localStorage.getItem('appVersion') || currentVersion;
                
                if (compareVersions(latestVersion, storedVersion) > 0) {
                    updateAvailable = true;
                    showUpdateNotification(latestVersion, storedVersion);
                    
                    // Update version in localStorage after notification
                    localStorage.setItem('appVersion', latestVersion);
                    currentVersion = latestVersion;
                } else if (storedVersion !== currentVersion) {
                    // App was updated in background
                    showUpdateSuccessNotification(latestVersion);
                    currentVersion = latestVersion;
                }
                
                // Update version display
                updateVersionDisplay(latestVersion);
                
            } catch (error) {
                console.error('Error checking for updates:', error);
            }
        }

        // Compare version strings (returns 1 if v1 > v2, -1 if v1 < v2, 0 if equal)
        function compareVersions(v1, v2) {
            const parts1 = v1.split('.').map(Number);
            const parts2 = v2.split('.').map(Number);
            
            for (let i = 0; i < 3; i++) {
                if (parts1[i] > parts2[i]) return 1;
                if (parts1[i] < parts2[i]) return -1;
            }
            return 0;
        }

        // Show update notification
        function showUpdateNotification(newVersion, oldVersion) {
            const notification = document.createElement('div');
            notification.className = 'update-notification';
            notification.innerHTML = `
                <div class="update-content">
                    <span class="update-icon">🎉</span>
                    <div class="update-text">
                        <strong>New Update Available!</strong>
                        <span>Version ${newVersion} is ready (current: ${oldVersion})</span>
                    </div>
                    <div class="update-actions">
                        <button class="btn btn-primary btn-sm" onclick="refreshApp()">
                            <span>🔄</span> Refresh
                        </button>
                        <button class="btn btn-secondary btn-sm" onclick="dismissUpdateNotification(this)">
                            Later
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(notification);
            
            // Auto-dismiss after 10 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 10000);
        }

        // Show update success notification
        function showUpdateSuccessNotification(version) {
            const notification = document.createElement('div');
            notification.className = 'update-notification success';
            notification.innerHTML = `
                <div class="update-content">
                    <span class="update-icon">✅</span>
                    <div class="update-text">
                        <strong>Updated Successfully!</strong>
                        <span>Expense Tracker has been updated to v${version}</span>
                    </div>
                </div>
            `;
            document.body.appendChild(notification);
            
            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }

        // Refresh app
        function refreshApp() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistrations().then(function(registrations) {
                    registrations.forEach(function(registration) {
                        registration.unregister();
                    });
                });
            }
            // Clear caches and reload
            if ('caches' in window) {
                caches.keys().then(names => {
                    names.forEach(name => {
                        caches.delete(name);
                    });
                });
            }
            setTimeout(() => {
                window.location.reload(true);
            }, 100);
        }

        // Dismiss update notification
        function dismissUpdateNotification(btn) {
            btn.closest('.update-notification').remove();
        }

        // Update version display
        function updateVersionDisplay(version) {
            const versionElements = document.querySelectorAll('.app-version');
            versionElements.forEach(el => {
                el.textContent = `v${version}`;
            });
        }

        // Initialize version checking
        document.addEventListener('DOMContentLoaded', function() {
            // Check for updates on load
            checkForUpdates();
            
            // Check for updates every 30 minutes
            setInterval(checkForUpdates, 30 * 60 * 1000);
            
            // Listen for service worker updates
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.addEventListener('controllerchange', function() {
                    showUpdateSuccessNotification(currentVersion);
                });
            }
        });
    </script>

    <!-- App Footer -->
    <footer class="app-footer">
        <div class="footer-content">
            <span class="footer-item">
                <span>📊</span> Expense Tracker PWA
            </span>
            <span class="footer-divider">•</span>
            <span class="footer-item">
                <span>🔖</span> Version <span class="app-version">0.0.1</span>
            </span>
        </div>
    </footer>

    <style>
        /* App Footer Styles */
        .app-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--card-bg);
            border-top: 1px solid var(--border-color);
            padding: 0.75rem;
            text-align: center;
            font-size: 0.85rem;
            color: var(--text-secondary);
            z-index: 100;
        }

        .footer-content {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .footer-item {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .footer-item a {
            color: var(--primary-color);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .footer-item a:hover {
            text-decoration: underline;
        }

        .footer-divider {
            color: var(--border-color);
        }

        .app-version {
            font-weight: 600;
            color: var(--primary-color);
        }

        /* Update Notification Styles */
        .update-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--card-bg);
            border: 2px solid var(--primary-color);
            border-radius: 12px;
            padding: 1rem;
            box-shadow: var(--shadow-lg);
            z-index: 10000;
            animation: slideIn 0.3s ease-out;
            max-width: 400px;
        }

        .update-notification.success {
            border-color: var(--success-color);
        }

        .update-content {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .update-icon {
            font-size: 2rem;
            flex-shrink: 0;
        }

        .update-text {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .update-text strong {
            color: var(--text-primary);
            font-size: 1rem;
        }

        .update-text span {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .update-actions {
            display: flex;
            gap: 0.5rem;
            flex-shrink: 0;
        }

        .btn-sm {
            padding: 0.25rem 0.75rem;
            font-size: 0.85rem;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @media (max-width: 768px) {
            .update-notification {
                right: 10px;
                left: 10px;
                max-width: none;
            }

            .update-content {
                flex-wrap: wrap;
            }

            .update-actions {
                width: 100%;
                justify-content: flex-end;
                margin-top: 0.5rem;
            }

            .app-footer {
                padding-bottom: 60px; /* Account for FAB */
            }
        }

        /* Adjust main content to account for footer */
        body {
            padding-bottom: 50px;
        }
    </style>
    
    <!-- Complete Premium UI State Fix -->
    <script>
    (function() {
        // Fix 1: Ensure validateLicense saves state properly
        function fixPremiumManager() {
            if (!window.premiumManager) {
                setTimeout(fixPremiumManager, 100);
                return;
            }
            
            // Override validateLicense to be synchronous and save all state
            window.premiumManager.validateLicense = function(licenseKey) {
                if (licenseKey && licenseKey.startsWith('PREMIUM-')) {
                    this.licenseKey = licenseKey;
                    this.currentTier = 'PREMIUM';
                    localStorage.setItem('premium_license', licenseKey);
                    localStorage.setItem('premium_tier', 'PREMIUM');
                    
                    // Handle demo/trial licenses
                    if (licenseKey.includes('DEMO')) {
                        const trialEndDate = new Date();
                        trialEndDate.setDate(trialEndDate.getDate() + 7);
                        this.trialEndDate = trialEndDate;
                        localStorage.setItem('premium_trial_end', trialEndDate.toISOString());
                    }
                    
                    return true;
                }
                return false;
            };
            
            // Fix 2: Reload premium state from localStorage
            const savedTier = localStorage.getItem('premium_tier');
            const savedLicense = localStorage.getItem('premium_license');
            
            if (savedTier === 'PREMIUM' && savedLicense) {
                window.premiumManager.currentTier = 'PREMIUM';
                window.premiumManager.licenseKey = savedLicense;
            }
            
            // Check trial status
            const trialEnd = localStorage.getItem('premium_trial_end');
            if (trialEnd) {
                const trialEndDate = new Date(trialEnd);
                if (new Date() < trialEndDate) {
                    window.premiumManager.currentTier = 'PREMIUM';
                    window.premiumManager.trialEndDate = trialEndDate;
                } else {
                    // Trial expired
                    localStorage.removeItem('premium_trial_end');
                    localStorage.removeItem('premium_tier');
                    if (savedLicense && savedLicense.includes('DEMO')) {
                        localStorage.removeItem('premium_license');
                        window.premiumManager.currentTier = 'FREE';
                        window.premiumManager.licenseKey = null;
                    }
                }
            }
        }
        
        // Fix 3: Update UI function
        function updatePremiumUIState() {
            if (!window.premiumManager) {
                setTimeout(updatePremiumUIState, 500);
                return;
            }
            
            console.log('Premium state:', {
                tier: window.premiumManager.currentTier,
                canExportExcel: window.premiumManager.canExportExcel(),
                canExportPDF: window.premiumManager.canExportPDF()
            });
            
            // Update Export Excel button
            const exportExcelBtn = document.getElementById('exportExcelBtn');
            if (exportExcelBtn) {
                if (window.premiumManager.canExportExcel()) {
                    exportExcelBtn.classList.remove('btn-warning');
                    exportExcelBtn.classList.add('btn-success');
                    exportExcelBtn.innerHTML = '📊 Export Excel';
                    const badge = exportExcelBtn.querySelector('.premium-badge');
                    if (badge) badge.remove();
                } else {
                    exportExcelBtn.classList.remove('btn-success');
                    exportExcelBtn.classList.add('btn-warning');
                }
            }
            
            // Update Export PDF button
            const exportPDFBtn = document.getElementById('exportPDFBtn');
            if (exportPDFBtn) {
                if (window.premiumManager.canExportPDF()) {
                    exportPDFBtn.classList.remove('btn-warning');
                    exportPDFBtn.classList.add('btn-success');
                    exportPDFBtn.innerHTML = '📄 Export PDF';
                    const badge = exportPDFBtn.querySelector('.premium-badge');
                    if (badge) badge.remove();
                } else {
                    exportPDFBtn.classList.remove('btn-success');
                    exportPDFBtn.classList.add('btn-warning');
                }
            }
        }
        
        // Fix 4: Override the demo activation
        function overrideDemoActivation() {
            if (!window.premiumManager || !window.premiumManager.redirectToCheckout) {
                setTimeout(overrideDemoActivation, 100);
                return;
            }
            
            window.premiumManager.redirectToCheckout = function() {
                if (window.analytics) {
                    window.analytics.track('checkout_started', {
                        source: 'paywall',
                        tier: 'premium'
                    });
                }
                
                alert('Payment integration coming soon! For now, enjoy the free version.');
                
                const mockLicense = `PREMIUM-${Date.now()}-DEMO-KEY`;
                if (confirm('Would you like to activate a demo Premium license for testing?')) {
                    // Use the fixed validateLicense
                    this.validateLicense(mockLicense);
                    
                    // Close modal
                    document.querySelector('.premium-paywall-modal')?.remove();
                    
                    // Update UI immediately
                    setTimeout(updatePremiumUIState, 100);
                    
                    // Show success message
                    if (window.showNotification) {
                        window.showNotification('🎉 Demo Premium license activated! Export features are now available.', 'success');
                    }
                }
            };
        }
        
        // Initialize everything
        fixPremiumManager();
        overrideDemoActivation();
        
        // Enhanced Dashboard Functions
        let dashboardState = {
            periodType: 'month',
            currentDate: new Date(),
            selectedMonth: new Date().getMonth(),
            selectedYear: new Date().getFullYear(),
            selectedQuarter: Math.floor(new Date().getMonth() / 3),
            charts: {
                spending: null,
                category: null,
                trend: null
            }
        };

        // Initialize Dashboard
        function initializeDashboard() {
            setupDashboardControls();
            updatePeriodDisplay();
            updateDashboardData();
        }

        // Setup Dashboard Controls
        function setupDashboardControls() {
            // Period type selector
            const periodSelector = document.getElementById('periodTypeSelector');
            if (periodSelector) {
                periodSelector.addEventListener('change', function() {
                    dashboardState.periodType = this.value;
                    updatePeriodDisplay();
                    updateDashboardData();
                });
            }

            // Previous/Next buttons
            const prevBtn = document.getElementById('prevPeriod');
            const nextBtn = document.getElementById('nextPeriod');
            
            if (prevBtn) {
                prevBtn.addEventListener('click', () => navigatePeriod(-1));
            }
            
            if (nextBtn) {
                nextBtn.addEventListener('click', () => navigatePeriod(1));
            }

            // Refresh button
            const refreshBtn = document.getElementById('refreshDashboard');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', () => {
                    updateDashboardData();
                    showNotification(t('dashboard.refreshed') || 'Dashboard refreshed', 'success');
                });
            }

            // Export button
            const exportBtn = document.getElementById('exportDashboard');
            if (exportBtn) {
                exportBtn.addEventListener('click', exportDashboardData);
            }
        }

        // Navigate periods
        function navigatePeriod(direction) {
            switch(dashboardState.periodType) {
                case 'month':
                    dashboardState.selectedMonth += direction;
                    if (dashboardState.selectedMonth < 0) {
                        dashboardState.selectedMonth = 11;
                        dashboardState.selectedYear--;
                    } else if (dashboardState.selectedMonth > 11) {
                        dashboardState.selectedMonth = 0;
                        dashboardState.selectedYear++;
                    }
                    break;
                case 'quarter':
                    dashboardState.selectedQuarter += direction;
                    if (dashboardState.selectedQuarter < 0) {
                        dashboardState.selectedQuarter = 3;
                        dashboardState.selectedYear--;
                    } else if (dashboardState.selectedQuarter > 3) {
                        dashboardState.selectedQuarter = 0;
                        dashboardState.selectedYear++;
                    }
                    break;
                case 'year':
                    dashboardState.selectedYear += direction;
                    break;
            }
            updatePeriodDisplay();
            updateDashboardData();
        }

        // Update period display
        function updatePeriodDisplay() {
            const display = document.getElementById('currentPeriodDisplay');
            if (!display) return;
            
            let periodText = '';
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                               'July', 'August', 'September', 'October', 'November', 'December'];
            
            switch(dashboardState.periodType) {
                case 'month':
                    periodText = `${monthNames[dashboardState.selectedMonth]} ${dashboardState.selectedYear}`;
                    break;
                case 'quarter':
                    periodText = `Q${dashboardState.selectedQuarter + 1} ${dashboardState.selectedYear}`;
                    break;
                case 'year':
                    periodText = `${dashboardState.selectedYear}`;
                    break;
                case 'custom':
                    periodText = 'Custom Range';
                    break;
            }
            
            display.querySelector('.period-label').textContent = periodText;
        }

        // Get date range based on selected period
        function getDateRangeFilter() {
            const startDate = new Date();
            const endDate = new Date();
            
            switch(dashboardState.periodType) {
                case 'month':
                    startDate.setFullYear(dashboardState.selectedYear, dashboardState.selectedMonth, 1);
                    startDate.setHours(0, 0, 0, 0);
                    endDate.setFullYear(dashboardState.selectedYear, dashboardState.selectedMonth + 1, 0);
                    endDate.setHours(23, 59, 59, 999);
                    break;
                case 'quarter':
                    const startMonth = dashboardState.selectedQuarter * 3;
                    startDate.setFullYear(dashboardState.selectedYear, startMonth, 1);
                    startDate.setHours(0, 0, 0, 0);
                    endDate.setFullYear(dashboardState.selectedYear, startMonth + 3, 0);
                    endDate.setHours(23, 59, 59, 999);
                    break;
                case 'year':
                    startDate.setFullYear(dashboardState.selectedYear, 0, 1);
                    startDate.setHours(0, 0, 0, 0);
                    endDate.setFullYear(dashboardState.selectedYear, 11, 31);
                    endDate.setHours(23, 59, 59, 999);
                    break;
            }
            
            return { start: startDate, end: endDate };
        }

        // Update all dashboard data
        function updateDashboardData() {
            // Only update if dashboard is active
            const dashboardTab = document.getElementById('dashboardTab');
            if (!dashboardTab || !dashboardTab.classList.contains('active')) {
                return;
            }
            
            const dateRange = getDateRangeFilter();
            
            // Filter expenses for the selected period
            const periodExpenses = expenses.filter(expense => {
                const expenseDate = new Date(expense.date);
                return expenseDate >= dateRange.start && expenseDate <= dateRange.end;
            });
            
            // Update metrics
            updateDashboardMetrics(periodExpenses, dateRange);
            
            // Update existing dashboard components
            updateDashboard();
            
            // Update new charts with a slight delay to ensure DOM is ready
            requestAnimationFrame(() => {
                updateSpendingTrendChart();
                updateCategoryBudgetChart();
                updateCashFlowSummary();
                generateSmartInsights();
            });
        }

        // Update dashboard metrics
        function updateDashboardMetrics(periodExpenses, dateRange) {
            const currencySymbol = CURRENCIES[mainCurrency]?.symbol || mainCurrency;
            
            // Calculate total spent
            const totalSpent = periodExpenses.reduce((sum, expense) => sum + getAmountInMainCurrency(expense), 0);
            const totalSpentEl = document.getElementById('totalSpentMetric');
            if (totalSpentEl) {
                totalSpentEl.textContent = formatCurrencyAmount(totalSpent, mainCurrency);
            }
            
            // Calculate comparison with previous period
            const prevRange = getPreviousPeriodRange();
            const prevExpenses = expenses.filter(expense => {
                const expenseDate = new Date(expense.date);
                return expenseDate >= prevRange.start && expenseDate <= prevRange.end;
            });
            const prevTotal = prevExpenses.reduce((sum, expense) => sum + getAmountInMainCurrency(expense), 0);
            
            const changeEl = document.getElementById('spentChange');
            if (changeEl && prevTotal > 0) {
                const percentChange = ((totalSpent - prevTotal) / prevTotal) * 100;
                const arrow = percentChange > 0 ? '↑' : '↓';
                const changeClass = percentChange > 0 ? 'negative' : 'positive';
                changeEl.className = `metric-change ${changeClass}`;
                changeEl.innerHTML = `<span class="change-arrow">${arrow}</span><span class="change-value">${Math.abs(percentChange).toFixed(1)}%</span>`;
            }
            
            // Calculate budget usage
            const budgetUsageEl = document.getElementById('budgetUsageMetric');
            const progressBar = document.getElementById('budgetProgressBar');
            if (budgetUsageEl && monthlyBudget > 0) {
                const usage = (totalSpent / monthlyBudget) * 100;
                budgetUsageEl.textContent = `${Math.round(usage)}%`;
                if (progressBar) {
                    progressBar.style.width = `${Math.min(usage, 100)}%`;
                    progressBar.style.background = usage > 100 ? 'linear-gradient(90deg, #f44336 0%, #ff5252 100%)' : 
                                                 usage > 80 ? 'linear-gradient(90deg, #ff9800 0%, #ffc107 100%)' :
                                                 'linear-gradient(90deg, #4caf50 0%, #8bc34a 100%)';
                }
            }
            
            // Calculate daily average
            const days = Math.ceil((dateRange.end - dateRange.start) / (1000 * 60 * 60 * 24)) + 1;
            const dailyAvg = totalSpent / days;
            const avgDailyEl = document.getElementById('avgDailyMetric');
            if (avgDailyEl) {
                avgDailyEl.textContent = formatCurrencyAmount(dailyAvg, mainCurrency);
            }
            
            // Calculate projected monthly
            const projectedEl = document.getElementById('projectedMonthly');
            if (projectedEl) {
                const projected = dailyAvg * 30;
                projectedEl.textContent = `${formatCurrencyAmount(projected, mainCurrency)} ${t('metrics.projected') || 'projected'}`;
            }
            
            // Transaction count and top category
            const transactionCountEl = document.getElementById('transactionCountMetric');
            if (transactionCountEl) {
                transactionCountEl.textContent = periodExpenses.length;
            }
            
            // Find top category
            const categoryTotals = {};
            periodExpenses.forEach(expense => {
                categoryTotals[expense.category] = (categoryTotals[expense.category] || 0) + getAmountInMainCurrency(expense);
            });
            
            const topCategory = Object.entries(categoryTotals).sort((a, b) => b[1] - a[1])[0];
            const topCategoryEl = document.getElementById('topCategoryMetric');
            if (topCategoryEl) {
                if (topCategory) {
                    const icon = categoryIcons[topCategory[0]] || '📝';
                    topCategoryEl.textContent = `${icon} ${topCategory[0]}`;
                } else {
                    topCategoryEl.textContent = t('metrics.noData') || 'No data';
                }
            }
        }

        // Get previous period range for comparison
        function getPreviousPeriodRange() {
            const startDate = new Date();
            const endDate = new Date();
            
            switch(dashboardState.periodType) {
                case 'month':
                    startDate.setFullYear(dashboardState.selectedYear, dashboardState.selectedMonth - 1, 1);
                    startDate.setHours(0, 0, 0, 0);
                    endDate.setFullYear(dashboardState.selectedYear, dashboardState.selectedMonth, 0);
                    endDate.setHours(23, 59, 59, 999);
                    break;
                case 'quarter':
                    const prevQuarter = dashboardState.selectedQuarter - 1;
                    const prevYear = prevQuarter < 0 ? dashboardState.selectedYear - 1 : dashboardState.selectedYear;
                    const adjustedQuarter = prevQuarter < 0 ? 3 : prevQuarter;
                    const startMonth = adjustedQuarter * 3;
                    startDate.setFullYear(prevYear, startMonth, 1);
                    startDate.setHours(0, 0, 0, 0);
                    endDate.setFullYear(prevYear, startMonth + 3, 0);
                    endDate.setHours(23, 59, 59, 999);
                    break;
                case 'year':
                    startDate.setFullYear(dashboardState.selectedYear - 1, 0, 1);
                    startDate.setHours(0, 0, 0, 0);
                    endDate.setFullYear(dashboardState.selectedYear - 1, 11, 31);
                    endDate.setHours(23, 59, 59, 999);
                    break;
            }
            
            return { start: startDate, end: endDate };
        }

        // Export dashboard data
        function exportDashboardData() {
            const dateRange = getDateRangeFilter();
            const periodExpenses = expenses.filter(expense => {
                const expenseDate = new Date(expense.date);
                return expenseDate >= dateRange.start && expenseDate <= dateRange.end;
            });
            
            // Create CSV data
            let csv = 'Date,Description,Category,Amount,Currency,Converted Amount,Tags\n';
            
            periodExpenses.forEach(expense => {
                const tags = [];
                if (expense.isRecurring) tags.push('Recurring');
                if (expense.isFixedCost) tags.push('Fixed Cost');
                
                csv += `${expense.date},"${expense.description}","${expense.category}",${expense.amount},${expense.currency || mainCurrency},${expense.convertedAmount || expense.amount},"${tags.join(', ')}"\n`;
            });
            
            // Download CSV
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `dashboard-export-${dateRange.start.toISOString().split('T')[0]}-to-${dateRange.end.toISOString().split('T')[0]}.csv`;
            a.click();
            
            showNotification(t('dashboard.exported') || 'Dashboard data exported', 'success');
        }

        // Update spending trend chart
        function updateSpendingTrendChart() {
            const canvas = document.getElementById('spendingTrendChart');
            if (!canvas) return; // Element not found, skip update
            
            const ctx = canvas.getContext('2d');
            const dateRange = getDateRangeFilter();
            
            // Filter expenses by date range
            const filteredExpenses = expenses.filter(expense => {
                const expenseDate = new Date(expense.date);
                return expenseDate >= dateRange.start && expenseDate <= dateRange.end;
            });
            
            // Group by day/week based on range
            const groupedData = dashboardState.periodType === 'year' ? 
                groupExpensesByWeek(filteredExpenses) : 
                groupExpensesByDay(filteredExpenses);
            
            const labels = Object.keys(groupedData).sort();
            const data = labels.map(date => groupedData[date]);
            
            // If no data, show empty state
            if (labels.length === 0) {
                if (dashboardState.charts.spending) {
                    dashboardState.charts.spending.destroy();
                    dashboardState.charts.spending = null;
                }
                // Clear the canvas and show message
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.font = '16px system-ui';
                ctx.fillStyle = '#666';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('No expense data for selected period', canvas.width / 2, canvas.height / 2);
                return;
            }
            
            if (dashboardState.charts.spending) {
                dashboardState.charts.spending.destroy();
            }
            
            // Format labels for display
            const formattedLabels = labels.map(label => {
                if (dashboardState.periodType === 'year' && label.includes('-W')) {
                    // Convert week format to readable
                    const [year, week] = label.split('-W');
                    return `Week ${parseInt(week)}`;
                } else {
                    // Convert date to readable format
                    const date = new Date(label);
                    return date.toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
                }
            });

            dashboardState.charts.spending = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: formattedLabels,
                    datasets: [{
                        label: t('charts.dailySpending') || 'Daily Spending',
                        data: data,
                        borderColor: '#007bff',
                        backgroundColor: 'rgba(0, 123, 255, 0.1)',
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return formatCurrencyAmount(context.parsed.y, mainCurrency);
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                autoSkip: true,
                                maxTicksLimit: 10
                            }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrencyAmount(value, mainCurrency);
                                }
                            }
                        }
                    }
                }
            });
        }

        // Update category vs budget chart
        function updateCategoryBudgetChart() {
            const canvas = document.getElementById('categoryBudgetChart');
            if (!canvas) return; // Element not found, skip update
            
            const ctx = canvas.getContext('2d');
            const dateRange = getDateRangeFilter();
            
            // Calculate category totals
            const categoryTotals = {};
            const categoryBudgets = {};
            
            expenses.filter(expense => {
                const expenseDate = new Date(expense.date);
                return expenseDate >= dateRange.start && expenseDate <= dateRange.end;
            }).forEach(expense => {
                const category = expense.category;
                categoryTotals[category] = (categoryTotals[category] || 0) + getAmountInMainCurrency(expense);
            });
            
            // Calculate appropriate budget based on period
            let periodBudget = monthlyBudget;
            if (dashboardState.periodType === 'year') {
                periodBudget = monthlyBudget * 12;
            } else if (dashboardState.periodType === 'quarter') {
                periodBudget = monthlyBudget * 3;
            }
            
            // Calculate category budgets (proportional to period budget)
            const totalSpent = Object.values(categoryTotals).reduce((sum, val) => sum + val, 0);
            if (totalSpent > 0 && periodBudget > 0) {
                Object.keys(categoryTotals).forEach(category => {
                    // Allocate budget proportionally based on spending
                    categoryBudgets[category] = (categoryTotals[category] / totalSpent) * periodBudget;
                });
            }
            
            const categories = Object.keys(categoryTotals);
            const spent = categories.map(cat => categoryTotals[cat]);
            const budgets = categories.map(cat => categoryBudgets[cat]);
            
            // If no data, show empty state
            if (categories.length === 0) {
                if (dashboardState.charts.category) {
                    dashboardState.charts.category.destroy();
                    dashboardState.charts.category = null;
                }
                // Clear the canvas and show message
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.font = '16px system-ui';
                ctx.fillStyle = '#666';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('No category data for selected period', canvas.width / 2, canvas.height / 2);
                return;
            }
            
            if (dashboardState.charts.category) {
                dashboardState.charts.category.destroy();
            }
            
            dashboardState.charts.category = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: categories,
                    datasets: [
                        {
                            label: t('charts.spent') || 'Spent',
                            data: spent,
                            backgroundColor: 'rgba(244, 67, 54, 0.8)',
                            borderColor: '#f44336',
                            borderWidth: 1
                        },
                        {
                            label: t('charts.budget') || 'Budget',
                            data: budgets,
                            backgroundColor: 'rgba(76, 175, 80, 0.8)',
                            borderColor: '#4caf50',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + formatCurrencyAmount(context.parsed.x, mainCurrency);
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrencyAmount(value, mainCurrency);
                                }
                            }
                        }
                    }
                }
            });
        }

        // Update cash flow summary
        function updateCashFlowSummary() {
            // Check if elements exist
            const inflowAmountEl = document.getElementById('inflowAmount');
            const outflowAmountEl = document.getElementById('outflowAmount');
            const cashBalanceAmountEl = document.getElementById('cashBalanceAmount');
            const inflowBarEl = document.getElementById('inflowBar');
            const outflowBarEl = document.getElementById('outflowBar');
            
            if (!inflowAmountEl || !outflowAmountEl || !cashBalanceAmountEl) return;
            
            const dateRange = getDateRangeFilter();
            
            // Calculate totals based on period type
            let totalBudget = monthlyBudget;
            if (dashboardState.periodType === 'year') {
                totalBudget = monthlyBudget * 12;
            } else if (dashboardState.periodType === 'quarter') {
                totalBudget = monthlyBudget * 3;
            }
            
            const totalSpent = expenses.filter(expense => {
                const expenseDate = new Date(expense.date);
                return expenseDate >= dateRange.start && expenseDate <= dateRange.end;
            }).reduce((sum, expense) => sum + getAmountInMainCurrency(expense), 0);
            
            const balance = totalBudget - totalSpent;
            const currencySymbol = CURRENCIES[mainCurrency]?.symbol || mainCurrency;
            
            // Update displays
            inflowAmountEl.textContent = formatCurrencyAmount(totalBudget, mainCurrency);
            outflowAmountEl.textContent = formatCurrencyAmount(totalSpent, mainCurrency);
            cashBalanceAmountEl.textContent = formatCurrencyAmount(balance, mainCurrency);
            
            // Update bar widths
            const maxAmount = Math.max(totalBudget, totalSpent, 1); // Avoid division by zero
            if (inflowBarEl) inflowBarEl.style.width = `${maxAmount > 0 ? (totalBudget / maxAmount) * 100 : 0}%`;
            if (outflowBarEl) outflowBarEl.style.width = `${maxAmount > 0 ? (totalSpent / maxAmount) * 100 : 0}%`;
            
            // Update balance color
            if (cashBalanceAmountEl) {
                if (balance < 0) {
                    cashBalanceAmountEl.style.color = '#f44336';
                } else if (balance < totalBudget * 0.1) {
                    cashBalanceAmountEl.style.color = '#ff9800';
                } else {
                    cashBalanceAmountEl.style.color = '#4caf50';
                }
            }
        }

        // Generate smart insights
        function generateSmartInsights() {
            const insightsGrid = document.getElementById('smartInsightsGrid');
            if (!insightsGrid) return; // Element not found, skip update
            
            const insights = [];
            const dateRange = getDateRangeFilter();
            
            // Filter expenses by date range
            const filteredExpenses = expenses.filter(expense => {
                const expenseDate = new Date(expense.date);
                return expenseDate >= dateRange.start && expenseDate <= dateRange.end;
            });
            
            // Insight 1: Spending trend
            const thisWeekTotal = getThisWeekTotal(filteredExpenses);
            const lastWeekTotal = getLastWeekTotal(filteredExpenses);
            if (thisWeekTotal !== null && lastWeekTotal !== null && lastWeekTotal > 0) {
                const percentChange = ((thisWeekTotal - lastWeekTotal) / lastWeekTotal) * 100;
                insights.push({
                    icon: percentChange < 0 ? '📉' : '📈',
                    label: t('insights.weeklyTrend') || 'Weekly Trend',
                    content: percentChange < 0 ? 
                        t('insights.spentLess', { percent: Math.abs(percentChange).toFixed(1) }) || `You spent ${Math.abs(percentChange).toFixed(1)}% less this week than last week` :
                        t('insights.spentMore', { percent: percentChange.toFixed(1) }) || `You spent ${percentChange.toFixed(1)}% more this week than last week`,
                    type: percentChange < 0 ? 'positive' : percentChange > 20 ? 'negative' : 'neutral'
                });
            }
            
            // Insight 2: Subscription percentage
            const recurringTotal = filteredExpenses.filter(e => e.isRecurring).reduce((sum, e) => sum + getAmountInMainCurrency(e), 0);
            const totalSpent = filteredExpenses.reduce((sum, e) => sum + getAmountInMainCurrency(e), 0);
            if (totalSpent > 0) {
                const recurringPercent = (recurringTotal / totalSpent) * 100;
                insights.push({
                    icon: '🔄',
                    label: t('insights.subscriptions') || 'Subscriptions',
                    content: t('insights.subscriptionPercent', { percent: recurringPercent.toFixed(1) }) || 
                        `Subscriptions make up ${recurringPercent.toFixed(1)}% of your expenses`,
                    type: recurringPercent > 30 ? 'negative' : 'neutral'
                });
            }
            
            // Insight 3: Biggest category
            const categoryTotals = {};
            filteredExpenses.forEach(expense => {
                categoryTotals[expense.category] = (categoryTotals[expense.category] || 0) + getAmountInMainCurrency(expense);
            });
            const topCategory = Object.entries(categoryTotals).sort((a, b) => b[1] - a[1])[0];
            if (topCategory) {
                const categoryPercent = (topCategory[1] / totalSpent) * 100;
                insights.push({
                    icon: categoryIcons[topCategory[0]] || '📊',
                    label: t('insights.topSpending') || 'Top Spending',
                    content: t('insights.topCategorySpend', { 
                        category: topCategory[0], 
                        percent: categoryPercent.toFixed(1) 
                    }) || `${topCategory[0]} is your biggest expense at ${categoryPercent.toFixed(1)}% of total`,
                    type: 'neutral'
                });
            }
            
            // Insight 4: Budget status
            if (monthlyBudget > 0) {
                const budgetUsed = (totalSpent / monthlyBudget) * 100;
                const daysInMonth = new Date(dateRange.end.getFullYear(), dateRange.end.getMonth() + 1, 0).getDate();
                const daysPassed = new Date().getDate();
                const expectedUsage = (daysPassed / daysInMonth) * 100;
                
                insights.push({
                    icon: '🎯',
                    label: t('insights.budgetPace') || 'Budget Pace',
                    content: budgetUsed < expectedUsage ?
                        t('insights.underBudget', { percent: (expectedUsage - budgetUsed).toFixed(1) }) || 
                        `You're ${(expectedUsage - budgetUsed).toFixed(1)}% under expected budget usage` :
                        t('insights.overBudget', { percent: (budgetUsed - expectedUsage).toFixed(1) }) ||
                        `You're ${(budgetUsed - expectedUsage).toFixed(1)}% over expected budget usage`,
                    type: budgetUsed < expectedUsage ? 'positive' : 'negative'
                });
            }
            
            // Render insights
            insightsGrid.innerHTML = insights.map(insight => `
                <div class="insight-card">
                    <div class="insight-type">
                        <span class="insight-icon">${insight.icon}</span>
                        <span class="insight-label">${insight.label}</span>
                    </div>
                    <div class="insight-content insight-${insight.type}">
                        ${insight.content}
                    </div>
                </div>
            `).join('');
        }

        // Helper functions
        function groupExpensesByDay(expenses) {
            const grouped = {};
            expenses.forEach(expense => {
                const expenseDate = new Date(expense.date);
                // Format date as YYYY-MM-DD for proper sorting
                const dateKey = expenseDate.toISOString().split('T')[0];
                grouped[dateKey] = (grouped[dateKey] || 0) + getAmountInMainCurrency(expense);
            });
            return grouped;
        }

        function groupExpensesByWeek(expenses) {
            const grouped = {};
            expenses.forEach(expense => {
                const date = new Date(expense.date);
                const weekNum = getWeekNumber(date);
                const year = date.getFullYear();
                const key = `${year}-W${weekNum.toString().padStart(2, '0')}`;
                grouped[key] = (grouped[key] || 0) + getAmountInMainCurrency(expense);
            });
            return grouped;
        }

        function getWeekNumber(date) {
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
            return Math.ceil((((d - yearStart) / 86400000) + 1)/7);
        }

        function getThisWeekTotal(expenses) {
            const now = new Date();
            const weekStart = new Date(now);
            weekStart.setDate(now.getDate() - now.getDay());
            weekStart.setHours(0, 0, 0, 0);
            
            return expenses.filter(e => new Date(e.date) >= weekStart)
                .reduce((sum, e) => sum + getAmountInMainCurrency(e), 0);
        }

        function getLastWeekTotal(expenses) {
            const now = new Date();
            const weekEnd = new Date(now);
            weekEnd.setDate(now.getDate() - now.getDay() - 1);
            weekEnd.setHours(23, 59, 59, 999);
            
            const weekStart = new Date(weekEnd);
            weekStart.setDate(weekEnd.getDate() - 6);
            weekStart.setHours(0, 0, 0, 0);
            
            return expenses.filter(e => {
                const date = new Date(e.date);
                return date >= weekStart && date <= weekEnd;
            }).reduce((sum, e) => sum + getAmountInMainCurrency(e), 0);
        }

        // Update subscription status display
        function updateSubscriptionStatus() {
            const planBadge = document.getElementById('planBadge');
            const planName = document.getElementById('planName');
            const planIcon = planBadge?.querySelector('.plan-icon');
            const validityDate = document.getElementById('validityDate');
            const daysRemaining = document.getElementById('daysRemaining');
            const subscriptionStatus = document.getElementById('subscriptionStatus');
            const planFeatures = document.getElementById('planFeatures');
            const upgradePlanBtn = document.getElementById('upgradePlanBtn');
            const managePlanBtn = document.getElementById('managePlanBtn');
            
            // Get current premium status
            const premiumState = window.premiumManager?.getCurrentState() || { tier: 'FREE' };
            const licenseInfo = JSON.parse(localStorage.getItem('premiumLicense') || '{}');
            
            // Define features for each plan
            const planFeaturesList = {
                FREE: [
                    { icon: '✅', text: 'Basic expense tracking', enabled: true },
                    { icon: '✅', text: 'Up to 100 expenses/month', enabled: true },
                    { icon: '✅', text: 'Basic categories', enabled: true },
                    { icon: '❌', text: 'Excel/PDF export', enabled: false },
                    { icon: '❌', text: 'Advanced analytics', enabled: false },
                    { icon: '❌', text: 'Priority support', enabled: false }
                ],
                TRIAL: [
                    { icon: '✅', text: 'All Premium features', enabled: true },
                    { icon: '✅', text: 'Unlimited expenses', enabled: true },
                    { icon: '✅', text: 'Excel/PDF export', enabled: true },
                    { icon: '✅', text: 'Advanced analytics', enabled: true },
                    { icon: '⏰', text: '7-day trial period', enabled: true },
                    { icon: '❌', text: 'Priority support', enabled: false }
                ],
                PREMIUM: [
                    { icon: '✅', text: 'Unlimited expenses', enabled: true },
                    { icon: '✅', text: 'Excel/PDF export', enabled: true },
                    { icon: '✅', text: 'Advanced analytics', enabled: true },
                    { icon: '✅', text: 'Custom categories', enabled: true },
                    { icon: '✅', text: 'Multi-device sync', enabled: true },
                    { icon: '✅', text: 'Priority support', enabled: true }
                ]
            };
            
            // Update plan display based on tier
            if (premiumState.tier === 'PREMIUM' || (licenseInfo.type === 'trial' && new Date(licenseInfo.expiresAt) > new Date())) {
                const isTrial = licenseInfo.type === 'trial';
                
                if (planBadge) {
                    planBadge.className = `plan-badge ${isTrial ? 'trial' : 'premium'}`;
                }
                if (planIcon) {
                    planIcon.textContent = isTrial ? '🎁' : '👑';
                }
                if (planName) {
                    planName.textContent = isTrial ? 'Premium Trial' : 'Premium';
                }
                
                // Calculate days remaining
                if (licenseInfo.expiresAt) {
                    const expiryDate = new Date(licenseInfo.expiresAt);
                    const today = new Date();
                    const msPerDay = 24 * 60 * 60 * 1000;
                    const daysLeft = Math.ceil((expiryDate - today) / msPerDay);
                    
                    if (validityDate) {
                        validityDate.textContent = expiryDate.toLocaleDateString();
                    }
                    if (daysRemaining) {
                        daysRemaining.textContent = daysLeft > 0 ? daysLeft : '0';
                        daysRemaining.style.color = daysLeft <= 3 ? '#f44336' : 'var(--primary-color)';
                    }
                    if (subscriptionStatus) {
                        subscriptionStatus.textContent = daysLeft > 0 ? 'Active' : 'Expired';
                        subscriptionStatus.style.color = daysLeft > 0 ? '#4caf50' : '#f44336';
                    }
                } else {
                    if (validityDate) validityDate.textContent = 'Lifetime';
                    if (daysRemaining) daysRemaining.textContent = '∞';
                    if (subscriptionStatus) subscriptionStatus.textContent = 'Active';
                }
                
                // Show appropriate buttons
                if (upgradePlanBtn) upgradePlanBtn.style.display = isTrial ? 'flex' : 'none';
                if (managePlanBtn) managePlanBtn.style.display = isTrial ? 'none' : 'flex';
                
                // Display features
                const features = isTrial ? planFeaturesList.TRIAL : planFeaturesList.PREMIUM;
                if (planFeatures) {
                    planFeatures.innerHTML = features.map(feature => `
                        <div class="plan-feature">
                            <span class="feature-icon ${!feature.enabled ? 'disabled' : ''}">${feature.icon}</span>
                            <span>${feature.text}</span>
                        </div>
                    `).join('');
                }
            } else {
                // Free plan
                if (planBadge) {
                    planBadge.className = 'plan-badge';
                }
                if (planIcon) {
                    planIcon.textContent = '🆓';
                }
                if (planName) {
                    planName.textContent = 'Free';
                }
                if (validityDate) validityDate.textContent = '-';
                if (daysRemaining) daysRemaining.textContent = '∞';
                if (subscriptionStatus) {
                    subscriptionStatus.textContent = 'Active';
                    subscriptionStatus.style.color = '#4caf50';
                }
                
                if (upgradePlanBtn) upgradePlanBtn.style.display = 'flex';
                if (managePlanBtn) managePlanBtn.style.display = 'none';
                
                // Display free features
                if (planFeatures) {
                    planFeatures.innerHTML = planFeaturesList.FREE.map(feature => `
                        <div class="plan-feature">
                            <span class="feature-icon ${!feature.enabled ? 'disabled' : ''}">${feature.icon}</span>
                            <span>${feature.text}</span>
                        </div>
                    `).join('');
                }
            }
        }

        // Show upgrade modal
        function showUpgradeModal() {
            // This would typically show a more detailed upgrade modal
            // For now, we'll use the existing premium activation
            if (window.premiumManager) {
                window.premiumManager.showPaywall('subscription_upgrade');
            }
        }

        // Show subscription details modal
        function showSubscriptionDetails() {
            showNotification(t('subscription.manageInfo') || 'Subscription management coming soon!', 'info');
        }

        // Make functions globally accessible
        window.updateSubscriptionStatus = updateSubscriptionStatus;
        window.showUpgradeModal = showUpgradeModal;
        window.showSubscriptionDetails = showSubscriptionDetails;

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(updatePremiumUIState, 1000);
            
            // Setup navigation tab click handlers
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', function(event) {
                    const tabName = this.dataset.tab;
                    
                    // Hide all tab contents
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    
                    // Remove active class from all nav tabs
                    document.querySelectorAll('.nav-tab').forEach(navTab => {
                        navTab.classList.remove('active');
                    });
                    
                    // Show selected tab content
                    document.getElementById(tabName + 'Tab').classList.add('active');
                    
                    // Add active class to clicked nav tab
                    this.classList.add('active');
                    
                    // Update dashboard if switching to dashboard tab
                    if (tabName === 'dashboard') {
                        initializeDashboard();
                    }
                    
                    // Initialize travel tab if switching to travel tab
                    if (tabName === 'travel') {
                        initializeTravelTab();
                    }
                    
                    // Update subscription status if switching to settings tab
                    if (tabName === 'settings') {
                        updateSubscriptionStatus();
                    }
                });
            });
        });
        
        // Also run immediately if DOM is ready
        if (document.readyState === 'interactive' || document.readyState === 'complete') {
            setTimeout(updatePremiumUIState, 500);
        }
    })();
    </script>
    
    <!-- Exchange Rate Modal -->
    <div id="exchangeRateModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h2>💱 Currency Conversion</h2>
                <button class="close-btn" onclick="closeExchangeRateModal()">&times;</button>
            </div>
            <div style="padding: 1.5rem;">
                <p id="exchangeRatePrompt" style="margin-bottom: 1.5rem; text-align: center;">
                    <!-- Dynamic content -->
                </p>
                <div class="form-group">
                    <label for="exchangeRateInput">Exchange Rate</label>
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <span>1 <span id="fromCurrency"></span> =</span>
                        <input type="number" id="exchangeRateInput" step="0.000001" placeholder="0.00" style="flex: 1;" onkeypress="if(event.key === 'Enter') confirmExchangeRate()">
                        <span id="toCurrency"></span>
                    </div>
                    <small style="color: var(--text-secondary); display: block; margin-top: 0.5rem;">
                        <span id="lastRateHint"></span>
                    </small>
                </div>
                <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                    <button class="btn btn-primary" onclick="confirmExchangeRate()" style="flex: 1;">
                        ✅ Confirm
                    </button>
                    <button class="btn" onclick="closeExchangeRateModal()" style="flex: 1;">
                        ❌ Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>