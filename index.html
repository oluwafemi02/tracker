<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expense Tracker Pro</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Track, manage, and optimize your spending with smart insights and analytics">
    <meta name="theme-color" content="#667eea">
    <meta name="color-scheme" content="light dark">
    
    <!-- Apple PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="ExpenseTracker">
    <meta name="format-detection" content="telephone=no">
    
    <!-- Microsoft PWA Meta Tags -->
    <meta name="msapplication-TileColor" content="#667eea">
    <meta name="msapplication-tap-highlight" content="no">
    
    <!-- Manifest -->
    <link rel="manifest" href="/manifest.json">
    
    <!-- Icons -->
    <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">
    <link rel="apple-touch-icon" href="/icons/apple-touch-icon.png">
    <link rel="mask-icon" href="/icons/safari-pinned-tab.svg" color="#667eea">
    
    <!-- Preconnect for performance -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --warning-gradient: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            --danger-gradient: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            --dark-gradient: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            --income-gradient: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
            --neutral-gradient: linear-gradient(135deg, #bdc3c7 0%, #2c3e50 100%);
            
            --text-primary: #2c3e50;
            --text-secondary: #6c757d;
            --text-light: #95a5a6;
            --text-white: #ffffff;
            
            --background: #f8fafc;
            --card-bg: #ffffff;
            --border-color: #e2e8f0;
            --hover-bg: #f1f5f9;
            
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 20px 25px rgba(0, 0, 0, 0.1);
            --shadow-inner: inset 0 2px 4px rgba(0, 0, 0, 0.06);
            
            --border-radius: 12px;
            --border-radius-lg: 16px;
            --border-radius-xl: 20px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-fast: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--background);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            background-image: 
                radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.1) 0%, transparent 50%);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .header {
            text-align: center;
            margin-bottom: 3rem;
            position: relative;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 200px;
            background: linear-gradient(45deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            border-radius: 50%;
            z-index: -1;
            filter: blur(60px);
        }

        h1 {
            font-size: 3.5rem;
            font-weight: 700;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
            letter-spacing: -0.02em;
        }

        .subtitle {
            font-size: 1.2rem;
            color: var(--text-secondary);
            font-weight: 400;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .left-panel {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        .right-panel {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 2rem;
            box-shadow: var(--shadow-md);
            transition: var(--transition);
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--primary-gradient);
            opacity: 0;
            transition: var(--transition);
        }

        .card:hover::before {
            opacity: 1;
        }

        .card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .card h2 {
            color: var(--text-primary);
            margin-bottom: 1rem;
            font-size: 1.25rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .card-icon {
            font-size: 1.5rem;
        }

        .budget-card {
            background: var(--primary-gradient);
            color: white;
            border: none;
        }

        .budget-card::before {
            background: rgba(255, 255, 255, 0.3);
        }

        .budget-card h2 {
            color: white;
        }

        .budget-progress {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50px;
            height: 12px;
            margin: 1rem 0;
            overflow: hidden;
            position: relative;
        }

        .budget-fill {
            height: 100%;
            background: linear-gradient(90deg, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.7));
            border-radius: 50px;
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .budget-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .budget-warning {
            background: var(--danger-gradient);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        .total-display {
            font-size: 2.5rem;
            font-weight: 700;
            margin: 1rem 0;
            letter-spacing: -0.02em;
        }

        .budget-card .total-display {
            color: white;
        }

        .expense-form {
            background: var(--card-bg);
            padding: 2rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        label {
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        input, select, textarea {
            padding: 1rem;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            transition: var(--transition);
            background: white;
            font-family: inherit;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            padding: 1rem 2rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
            background: var(--primary-gradient);
            color: white;
            min-width: 120px;
            justify-content: center;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: var(--text-secondary);
        }

        .btn-danger {
            background: var(--danger-gradient);
        }

        .btn-success {
            background: var(--success-gradient);
        }

        .btn-warning {
            background: var(--warning-gradient);
            color: var(--text-primary);
        }

        .btn-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }

        .expense-list {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 2rem;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
        }

        .expense-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .expense-filters {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        /* Smart Search Styles */
        .search-container {
            position: relative;
            margin-bottom: 1rem;
        }

        .search-input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
            background: white;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 0.75rem;
            transition: var(--transition);
            box-shadow: var(--shadow-sm);
        }

        .search-input-wrapper:focus-within {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .search-icon {
            font-size: 1.2rem;
            margin-right: 0.75rem;
            color: var(--text-secondary);
        }

        #searchInput {
            border: none;
            outline: none;
            flex: 1;
            font-size: 1rem;
            background: transparent;
            padding: 0;
        }

        #clearSearch {
            background: none;
            border: none;
            font-size: 1rem;
            cursor: pointer;
            color: var(--text-secondary);
            padding: 0.25rem;
            border-radius: 50%;
            transition: var(--transition);
        }

        #clearSearch:hover {
            background: rgba(0, 0, 0, 0.1);
            color: var(--text-primary);
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }

        .search-result-item {
            padding: 0.75rem;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: var(--transition);
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .search-result-item:hover {
            background: var(--hover-bg);
        }

        .search-highlight {
            background: yellow;
            font-weight: 600;
            padding: 0.1rem 0.2rem;
            border-radius: 3px;
        }

        /* View Mode Toggle */
        .view-mode-toggle {
            display: flex;
            background: var(--background);
            border-radius: 12px;
            padding: 0.25rem;
            gap: 0.25rem;
            border: 2px solid var(--border-color);
            margin-bottom: 1rem;
        }

        .view-mode-btn {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            border: none;
            background: transparent;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            transition: var(--transition);
        }

        .view-mode-btn.active {
            background: white;
            color: var(--text-primary);
            box-shadow: var(--shadow-sm);
        }

        .view-mode-btn:hover:not(.active) {
            background: rgba(255, 255, 255, 0.5);
        }

        .view-icon {
            font-size: 1rem;
        }

        /* Pagination Styles */
        .pagination-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
            border-top: 1px solid var(--border-color);
            margin-top: 1rem;
        }

        .pagination-info {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .pagination-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .pagination-controls button {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border-color);
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: var(--transition);
            font-size: 0.9rem;
        }

        .pagination-controls button:hover:not(:disabled) {
            background: var(--hover-bg);
            border-color: #667eea;
        }

        .pagination-controls button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        #pageInfo, #pageInfoBottom {
            font-weight: 500;
            color: var(--text-primary);
            min-width: 100px;
            text-align: center;
        }

        /* Custom Scrollbars */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--background);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 4px;
            transition: var(--transition);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #5a6fd8, #6a4190);
        }

        /* Firefox scrollbars */
        * {
            scrollbar-width: thin;
            scrollbar-color: #667eea var(--background);
        }

        /* Enhanced Animations */
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .expense-item-enhanced {
            animation: slideInUp 0.3s ease-out;
        }

        .search-container {
            animation: fadeInScale 0.3s ease-out;
        }

        .view-mode-toggle {
            animation: fadeInScale 0.3s ease-out 0.1s both;
        }

        /* Responsive Design Enhancements */
        @media (max-width: 768px) {
            .search-input-wrapper {
                padding: 0.5rem;
            }
            
            .view-mode-toggle {
                margin-bottom: 0.75rem;
            }
            
            .view-mode-btn {
                padding: 0.5rem 0.75rem;
                font-size: 0.8rem;
            }
            
            .pagination-container {
                flex-direction: column;
                gap: 1rem;
                padding: 0.75rem 0;
            }
            
            .pagination-controls {
                justify-content: center;
            }
            
            .expense-filters {
                gap: 0.5rem;
            }
            
            .filter-group {
                min-width: 140px;
            }
        }

        @media (max-width: 480px) {
            .search-input-wrapper {
                padding: 0.5rem;
            }
            
            #searchInput {
                font-size: 0.9rem;
            }
            
            .view-mode-btn span:last-child {
                display: none;
            }
            
                         .pagination-controls button {
                 padding: 0.4rem 0.8rem;
                 font-size: 0.8rem;
             }
         }

         /* Keyboard Shortcuts Styles */
         .keyboard-shortcuts {
             display: grid;
             grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
             gap: 0.75rem;
             margin-top: 1rem;
             padding: 1rem;
             background: var(--hover-bg);
             border-radius: var(--border-radius);
             border: 1px solid var(--border-color);
         }

         .shortcut-item {
             display: flex;
             justify-content: space-between;
             align-items: center;
             padding: 0.5rem 0;
         }

         .shortcut-key {
             font-family: 'Courier New', monospace;
             background: var(--card-bg);
             padding: 0.25rem 0.5rem;
             border-radius: 4px;
             border: 1px solid var(--border-color);
             font-size: 0.85rem;
             font-weight: 600;
             color: var(--text-primary);
             min-width: 80px;
             text-align: center;
             box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
         }

                   .shortcut-desc {
              color: var(--text-secondary);
              font-size: 0.9rem;
              margin-left: 1rem;
              flex: 1;
          }

          /* PWA Specific Styles */
          .install-button {
              position: fixed !important;
              bottom: 20px !important;
              right: 20px !important;
              z-index: 1000 !important;
              background: var(--primary-gradient) !important;
              color: white !important;
              border: none !important;
              border-radius: 50px !important;
              padding: 1rem 1.5rem !important;
              font-weight: 600 !important;
              box-shadow: var(--shadow-xl) !important;
              transition: var(--transition) !important;
              cursor: pointer !important;
          }

          .install-button:hover {
              transform: translateY(-2px);
              box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
          }

          @keyframes bounce {
              0%, 20%, 50%, 80%, 100% {
                  transform: translateY(0);
              }
              40% {
                  transform: translateY(-10px);
              }
              60% {
                  transform: translateY(-5px);
              }
          }

          .update-banner {
              position: fixed;
              top: 0;
              left: 0;
              right: 0;
              background: var(--primary-gradient);
              color: white;
              padding: 1rem;
              z-index: 1001;
              box-shadow: var(--shadow-lg);
              animation: slideDown 0.3s ease-out;
          }

          .update-content {
              display: flex;
              align-items: center;
              justify-content: center;
              gap: 1rem;
              max-width: 600px;
              margin: 0 auto;
          }

          .update-content .btn {
              padding: 0.5rem 1rem;
              font-size: 0.9rem;
              min-width: auto;
          }

          @keyframes slideDown {
              from {
                  transform: translateY(-100%);
              }
              to {
                  transform: translateY(0);
              }
          }

          /* PWA Mode specific styles */
          .pwa-mode {
              padding-top: env(safe-area-inset-top);
              padding-bottom: env(safe-area-inset-bottom);
          }

          .pwa-mode .container {
              padding-top: calc(2rem + env(safe-area-inset-top));
              padding-bottom: calc(2rem + env(safe-area-inset-bottom));
          }

          /* Offline indicator */
          .offline-indicator {
              position: fixed;
              top: 0;
              left: 0;
              right: 0;
              background: #ff6b6b;
              color: white;
              padding: 0.5rem;
              text-align: center;
              font-size: 0.9rem;
              z-index: 1000;
              animation: slideDown 0.3s ease-out;
          }

          /* Touch-friendly enhancements for mobile */
          @media (hover: none) and (pointer: coarse) {
              .btn {
                  min-height: 44px;
                  min-width: 44px;
              }
              
              .search-input-wrapper {
                  padding: 1rem;
              }
              
              .view-mode-btn {
                  padding: 1rem;
              }
              
              .pagination-controls button {
                  min-height: 44px;
                  padding: 0.75rem 1rem;
              }
          }

        .filter-group label {
            font-size: 0.8rem;
            margin-bottom: 0;
        }

        .filter-group select {
            padding: 0.5rem;
            font-size: 0.9rem;
            min-width: 120px;
        }

        .expense-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            transition: var(--transition);
            border-radius: 8px;
            margin-bottom: 0.5rem;
        }

        .expense-item:hover {
            background: #f8fafc;
            transform: translateX(4px);
            box-shadow: var(--shadow-sm);
        }

        .expense-item:last-child {
            border-bottom: none;
        }

        .expense-details {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .expense-main {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .expense-category-icon {
            font-size: 1.5rem;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: linear-gradient(45deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
        }

        .expense-amount {
            font-size: 1.4rem;
            font-weight: 700;
            color: #e74c3c;
        }

        .expense-meta {
            color: var(--text-secondary);
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .expense-actions {
            display: flex;
            gap: 0.5rem;
        }

        .expense-actions .btn {
            padding: 0.5rem 1rem;
            font-size: 0.8rem;
            min-width: auto;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin: 1rem 0;
        }

        .settings-panel {
            background: var(--card-bg);
            padding: 2rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
        }

        .settings-grid {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 1rem;
            align-items: end;
        }

        .no-expenses {
            text-align: center;
            color: var(--text-secondary);
            font-style: italic;
            padding: 3rem;
            background: #f8fafc;
            border-radius: 8px;
            border: 2px dashed var(--border-color);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--card-bg);
            padding: 1.5rem;
            border-radius: var(--border-radius);
            text-align: center;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            transform: translateX(100%);
            transition: var(--transition);
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: var(--success-gradient);
        }

        .notification.error {
            background: var(--danger-gradient);
        }

        .quick-actions {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .quick-action {
            background: var(--card-bg);
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .quick-action:hover {
            background: #f8fafc;
            transform: translateY(-2px);
        }

        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
            
            .right-panel {
                order: -1;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            h1 {
                font-size: 2.5rem;
            }
            
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .settings-grid {
                grid-template-columns: 1fr;
            }
            
            .expense-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }
            
            .expense-actions {
                width: 100%;
                justify-content: flex-end;
            }
            
            .expense-filters {
                flex-direction: column;
                width: 100%;
            }
            
            .expense-list-header {
                flex-direction: column;
                align-items: stretch;
            }
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Enhanced Animations */
        .bounce-in {
            animation: bounceIn 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes bounceIn {
            0% { transform: scale(0.3) rotate(-5deg); opacity: 0; }
            50% { transform: scale(1.05) rotate(2deg); }
            70% { transform: scale(0.9) rotate(-1deg); }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }

        .slide-in-right {
            animation: slideInRight 0.4s ease-out;
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Enhanced Card Styles */
        .card-enhanced {
            background: var(--card-bg);
            border-radius: var(--border-radius-lg);
            padding: 2rem;
            box-shadow: var(--shadow-md);
            transition: var(--transition);
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        .card-enhanced::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--primary-gradient);
            opacity: 0;
            transition: var(--transition);
        }

        .card-enhanced:hover::before {
            opacity: 1;
        }

        .card-enhanced:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: var(--shadow-xl);
        }

        /* Modern Toggle Switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--border-color);
            transition: var(--transition);
            border-radius: 30px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background: white;
            transition: var(--transition);
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        input:checked + .toggle-slider {
            background: var(--primary-gradient);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(30px);
        }

        /* Enhanced Progress Bar */
        .progress-container {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50px;
            height: 16px;
            margin: 1rem 0;
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-inner);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.7));
            border-radius: 50px;
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 8px;
        }

        .progress-text {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.9);
            padding: 2px 6px;
            border-radius: 10px;
            margin-right: 4px;
        }

        /* Modern Input Styles */
        .input-group {
            position: relative;
            margin-bottom: 1.5rem;
        }

        .input-group input,
        .input-group select {
            width: 100%;
            padding: 1rem 1rem 1rem 3rem;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: var(--transition);
            background: var(--card-bg);
            font-family: inherit;
        }

        .input-group input:focus,
        .input-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            transform: translateY(-2px);
        }

        .input-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.2rem;
            color: var(--text-secondary);
            z-index: 10;
        }

        /* Enhanced Expense Item */
        .expense-item-enhanced {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            margin-bottom: 1rem;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .expense-item-enhanced::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: var(--primary-gradient);
            transform: scaleY(0);
            transition: var(--transition);
        }

        .expense-item-enhanced:hover::before {
            transform: scaleY(1);
        }

        .expense-item-enhanced:hover {
            background: var(--hover-bg);
            transform: translateX(8px);
            box-shadow: var(--shadow-md);
        }

        /* Floating Action Button */
        .fab {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--primary-gradient);
            color: white;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: var(--shadow-lg);
            transition: var(--transition);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .fab:hover {
            transform: scale(1.1) rotate(90deg);
            box-shadow: var(--shadow-xl);
        }

        /* Enhanced Statistics Cards */
        .stat-card-enhanced {
            background: var(--card-bg);
            padding: 2rem;
            border-radius: var(--border-radius-lg);
            text-align: center;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .stat-card-enhanced::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--primary-gradient);
            opacity: 0;
            transition: var(--transition);
            z-index: 1;
        }

        .stat-card-enhanced:hover::before {
            opacity: 0.05;
        }

        .stat-card-enhanced:hover {
            transform: translateY(-4px) scale(1.05);
            box-shadow: var(--shadow-lg);
        }

        .stat-card-enhanced > * {
            position: relative;
            z-index: 2;
        }

        .stat-icon {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            display: block;
        }

        /* Dark Mode Support */
        .dark-mode {
            --background: #1a202c;
            --card-bg: #2d3748;
            --text-primary: #f7fafc;
            --text-secondary: #a0aec0;
            --border-color: #4a5568;
            --hover-bg: #4a5568;
        }

        /* Modern Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
        }

        .modal-content {
            background: var(--card-bg);
            margin: 5% auto;
            padding: 2rem;
            border-radius: var(--border-radius-xl);
            width: 90%;
            max-width: 600px;
            box-shadow: var(--shadow-xl);
            animation: modalFadeIn 0.3s ease-out;
        }

        @keyframes modalFadeIn {
            from { opacity: 0; transform: scale(0.8) translateY(-50px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        /* Recurring Expense Styles */
        .recurring-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            background: var(--success-gradient);
            color: white;
            padding: 0.2rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }

        .recurring-item {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 1rem;
            margin-bottom: 1rem;
            transition: var(--transition);
        }

        .recurring-item:hover {
            background: var(--hover-bg);
            transform: translateX(4px);
        }

        .recurring-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .recurring-frequency {
            background: var(--primary-gradient);
            color: white;
            padding: 0.2rem 0.6rem;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .due-soon {
            background: var(--warning-gradient);
            color: var(--text-primary);
        }

        .overdue {
            background: var(--danger-gradient);
            color: white;
            animation: pulse 2s infinite;
        }

        .category-management {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 1rem;
            margin: 1rem 0;
        }

        .category-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        .category-item:last-child {
            border-bottom: none;
        }

        /* Tracker Type Selector */
        .tracker-type-selector {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            margin: 1.5rem 0;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: var(--border-radius);
            backdrop-filter: blur(10px);
        }

        .tracker-type-selector label {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 1rem;
        }

        .tracker-type-selector select {
            padding: 0.75rem 1rem;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            background: var(--card-bg);
            color: var(--text-primary);
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            min-width: 180px;
        }

        .tracker-type-selector select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin: 2rem 0 1rem 0;
            flex-wrap: wrap;
        }

        .nav-tab {
            padding: 1rem 2rem;
            border: none;
            border-radius: var(--border-radius);
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-secondary);
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            backdrop-filter: blur(10px);
            border: 2px solid transparent;
        }

        .nav-tab:hover {
            background: rgba(102, 126, 234, 0.1);
            color: var(--text-primary);
            transform: translateY(-2px);
        }

        .nav-tab.active {
            background: var(--primary-gradient);
            color: white;
            box-shadow: var(--shadow-md);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .nav-tab.active:hover {
            transform: translateY(-2px) scale(1.02);
        }

        /* Tab Content */
        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease-in;
        }

        .tab-content.active {
            display: block;
        }

        /* Enhanced Budget Summary */
        .budget-summary {
            background: var(--primary-gradient);
            color: white;
            padding: 2rem;
            border-radius: var(--border-radius-lg);
            margin-bottom: 2rem;
            text-align: center;
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow-xl);
        }

        .budget-summary::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, rgba(255, 255, 255, 0.1) 25%, transparent 25%, transparent 75%, rgba(255, 255, 255, 0.1) 75%);
            background-size: 20px 20px;
            animation: move 2s linear infinite;
        }

        @keyframes move {
            0% { background-position: 0 0; }
            100% { background-position: 20px 20px; }
        }

        .budget-summary > * {
            position: relative;
            z-index: 2;
        }

        .budget-amount {
            font-size: 3rem;
            font-weight: 700;
            margin: 1rem 0;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .budget-status {
            font-size: 1.2rem;
            margin-bottom: 1rem;
            opacity: 0.9;
        }

        .budget-progress-main {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50px;
            height: 20px;
            margin: 1.5rem 0;
            overflow: hidden;
            position: relative;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .budget-fill-main {
            height: 100%;
            background: linear-gradient(90deg, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.7));
            border-radius: 50px;
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 12px;
        }

        .budget-text-main {
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.9);
            padding: 4px 8px;
            border-radius: 12px;
            margin-right: 8px;
            text-shadow: none;
        }

        .warning-budget {
            background: var(--danger-gradient);
            animation: pulse 2s infinite;
        }

        /* Quick Stats Grid */
        .quick-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }

        .quick-stat-card {
            background: var(--card-bg);
            padding: 1.5rem;
            border-radius: var(--border-radius-lg);
            text-align: center;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .quick-stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--primary-gradient);
            opacity: 0;
            transition: var(--transition);
        }

        .quick-stat-card:hover::before {
            opacity: 1;
        }

        .quick-stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .quick-stat-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            display: block;
        }

        .quick-stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .quick-stat-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-weight: 500;
        }

        /* Smart Suggestions */
        .smart-suggestions {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-lg);
            padding: 2rem;
            margin: 2rem 0;
            box-shadow: var(--shadow-md);
            position: relative;
            overflow: hidden;
        }

        .smart-suggestions::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--success-gradient);
            opacity: 0.8;
        }

        .suggestions-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .suggestions-icon {
            font-size: 1.8rem;
        }

        .suggestions-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .suggestion-item {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            padding: 1rem;
            background: rgba(76, 175, 80, 0.05);
            border-left: 4px solid #4caf50;
            border-radius: 0 var(--border-radius) var(--border-radius) 0;
            margin-bottom: 1rem;
            transition: var(--transition);
        }

        .suggestion-item:hover {
            background: rgba(76, 175, 80, 0.1);
            transform: translateX(4px);
        }

        .suggestion-item.priority {
            background: rgba(255, 193, 7, 0.1);
            border-left-color: #ffc107;
        }

        .suggestion-item.warning {
            background: rgba(244, 67, 54, 0.1);
            border-left-color: #f44336;
        }

        .suggestion-icon {
            font-size: 1.5rem;
            flex-shrink: 0;
            margin-top: 0.25rem;
        }

        .suggestion-content {
            flex: 1;
        }

        .suggestion-text {
            font-size: 1rem;
            line-height: 1.5;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .suggestion-amount {
            font-size: 1.2rem;
            font-weight: 700;
            color: #4caf50;
        }

        .suggestion-meta {
            font-size: 0.85rem;
            color: var(--text-secondary);
            font-style: italic;
        }

        .savings-goal {
            background: linear-gradient(135deg, #4caf50, #8bc34a);
            color: white;
            padding: 1.5rem;
            border-radius: var(--border-radius-lg);
            margin: 1rem 0;
            text-align: center;
        }

        .savings-amount {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .no-suggestions {
            text-align: center;
            color: var(--text-secondary);
            font-style: italic;
            padding: 2rem;
        }

        /* Responsive Enhancements */
        @media (max-width: 768px) {
            .fab {
                bottom: 1rem;
                right: 1rem;
                width: 50px;
                height: 50px;
                font-size: 1.2rem;
            }
            
            .card-enhanced:hover {
                transform: translateY(-4px) scale(1.01);
            }
            
            .input-group input,
            .input-group select {
                padding: 1rem;
            }
            
            .input-icon {
                display: none;
            }
            
            .recurring-item-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
            
            .nav-tabs {
                gap: 0.25rem;
                margin: 1rem 0;
            }
            
            .nav-tab {
                padding: 0.75rem 1rem;
                font-size: 0.9rem;
                min-width: auto;
            }
            
            .budget-amount {
                font-size: 2rem;
            }
            
            .budget-summary {
                padding: 1.5rem;
            }
            
            .quick-stats {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>💰 Expense Tracker</h1>
            <p class="subtitle" id="appSubtitle">Track, manage, and optimize your spending</p>
            
            <!-- Tracker Type Selector -->
            <div class="tracker-type-selector">
                <label for="trackerType">Tracker Mode:</label>
                <select id="trackerType" onchange="changeTrackerType()">
                    <option value="personal">👤 Personal</option>
                    <option value="family">👨‍👩‍👧‍👦 Family</option>
                    <option value="group">👥 Group/Shared</option>
                </select>
            </div>
            
            <!-- Navigation Tabs -->
            <div class="nav-tabs">
                <button class="nav-tab active" onclick="switchTab('main')">📋 Expenses</button>
                <button class="nav-tab" onclick="switchTab('dashboard')">📊 Dashboard</button>
                <button class="nav-tab" onclick="switchTab('settings')">⚙️ Settings</button>
            </div>
            
            <div style="margin-top: 1rem; display: flex; align-items: center; justify-content: center; gap: 1rem;">
                <span style="font-size: 0.9rem; color: var(--text-secondary);">Dark Mode</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="darkModeToggle" onchange="toggleDarkMode()">
                    <span class="toggle-slider"></span>
                </label>
            </div>
        </div>

        <!-- Main Tab Content -->
        <div id="mainTab" class="tab-content active">
            <!-- Budget Summary -->
            <div class="budget-summary" id="budgetSummaryMain">
                <h2 style="margin: 0 0 1rem 0; font-size: 1.5rem;">💰 Monthly Budget Overview</h2>
                <div class="budget-amount" id="budgetAmountMain">€0</div>
                <div class="budget-status" id="budgetStatusMain">Set your monthly budget to get started</div>
                <div class="budget-progress-main">
                    <div class="budget-fill-main" id="budgetFillMain">
                        <span class="budget-text-main" id="budgetTextMain">0%</span>
                    </div>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 1rem; flex-wrap: wrap; gap: 1rem;">
                    <div>
                        <strong>Spent: </strong><span id="spentAmountMain">€0</span>
                    </div>
                    <div>
                        <strong>Remaining: </strong><span id="remainingAmountMain">€0</span>
                    </div>
                </div>
            </div>

            <!-- Quick Stats -->
            <div class="quick-stats">
                <div class="quick-stat-card">
                    <span class="quick-stat-icon">📊</span>
                    <div class="quick-stat-value" id="monthlyTotalMain">€0</div>
                    <div class="quick-stat-label">This Month</div>
                </div>
                <div class="quick-stat-card">
                    <span class="quick-stat-icon">📅</span>
                    <div class="quick-stat-value" id="avgDailyMain">€0</div>
                    <div class="quick-stat-label">Daily Average</div>
                </div>
                <div class="quick-stat-card">
                    <span class="quick-stat-icon">📝</span>
                    <div class="quick-stat-value" id="expenseCountMain">0</div>
                    <div class="quick-stat-label">Expenses</div>
                </div>
                <div class="quick-stat-card">
                    <span class="quick-stat-icon">🏆</span>
                    <div class="quick-stat-value" id="topCategoryMain">-</div>
                    <div class="quick-stat-label">Top Category</div>
                </div>
            </div>

            <!-- Smart Suggestions -->
            <div class="smart-suggestions" id="smartSuggestions">
                <div class="suggestions-header">
                    <span class="suggestions-icon">💡</span>
                    <span class="suggestions-title">Smart Money Suggestions</span>
                </div>
                <div id="suggestionsContent">
                    <div class="no-suggestions">Add some expenses and set a budget to see personalized suggestions!</div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="quick-actions">
                <div class="quick-action" onclick="showForm('Groceries')">
                    <span>🛒</span>
                    <span>Quick Groceries</span>
                </div>
                <div class="quick-action" onclick="showForm('Utilities')">
                    <span>⚡</span>
                    <span>Quick Utilities</span>
                </div>
                <div class="quick-action" onclick="showForm('Transportation')">
                    <span>🚗</span>
                    <span>Quick Transport</span>
                </div>
                <div class="quick-action" onclick="showForm('Mortgage')">
                    <span>🏡</span>
                    <span>Quick Mortgage</span>
                </div>
                <div class="quick-action" onclick="showForm('Car Loan/Lease')">
                    <span>🚙</span>
                    <span>Quick Car Loan</span>
                </div>
                <div class="quick-action" onclick="showInsights()">
                    <span>💡</span>
                    <span>Insights</span>
                </div>
                <div class="quick-action" onclick="showRecurringModal()">
                    <span>🔄</span>
                    <span>Recurring</span>
                </div>
            </div>

            <div class="main-grid">
                <div class="left-panel">
                    <!-- Add Expense Form -->
                    <div class="expense-form card-enhanced">
                        <h2><span class="card-icon">➕</span> Add New Expense</h2>
                        <form id="expenseForm">
                            <div class="form-grid">
                                <div class="input-group">
                                    <span class="input-icon">💰</span>
                                    <label for="amount">Amount (€)</label>
                                    <input type="number" id="amount" step="0.01" required placeholder="0.00">
                                </div>
                                
                                <div class="input-group">
                                    <span class="input-icon">📋</span>
                                    <label for="category">Category</label>
                                    <select id="category" required onchange="handleCategoryChange()">
                                        <option value="">Select category</option>
                                        <option value="Rent">🏠 Rent</option>
                                        <option value="Mortgage">🏡 Mortgage</option>
                                        <option value="Utilities">⚡ Utilities</option>
                                        <option value="Groceries">🛒 Groceries</option>
                                        <option value="Transportation">🚗 Transportation</option>
                                        <option value="Car Loan/Lease">🚙 Car Loan/Lease</option>
                                        <option value="Healthcare">🏥 Healthcare</option>
                                        <option value="Entertainment">🎬 Entertainment</option>
                                        <option value="Dining">🍽️ Dining</option>
                                        <option value="Shopping">🛍️ Shopping</option>
                                        <option value="Education">📚 Education</option>
                                        <option value="Insurance">🛡️ Insurance</option>
                                        <option value="Other Loan">💳 Other Loan</option>
                                        <option value="Other">📝 Other</option>
                                        <option value="__ADD_NEW__">➕ Add New Category</option>
                                    </select>
                                </div>
                                
                                <!-- Custom Category Input (Hidden by default) -->
                                <div class="input-group" id="customCategoryGroup" style="display: none;">
                                    <span class="input-icon">✨</span>
                                    <label for="customCategory">New Category Name</label>
                                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                                        <input type="text" id="customCategory" placeholder="Enter new category name">
                                        <input type="text" id="customCategoryIcon" placeholder="🏷️" maxlength="2" style="width: 60px; text-align: center;">
                                        <button type="button" onclick="addCustomCategory()" class="btn btn-success" style="min-width: auto; padding: 0.5rem 1rem;">Add</button>
                                        <button type="button" onclick="cancelCustomCategory()" class="btn btn-secondary" style="min-width: auto; padding: 0.5rem 1rem;">Cancel</button>
                                    </div>
                                </div>
                                
                                <div class="input-group" id="personGroup">
                                    <span class="input-icon">👥</span>
                                    <label for="person" id="personLabel">Person</label>
                                    <select id="person" required>
                                        <option value="">Select person</option>
                                        <option value="You">👤 You</option>
                                        <option value="Partner">👥 Partner</option>
                                        <option value="Both">💏 Both</option>
                                    </select>
                                </div>
                                
                                <div class="input-group">
                                    <span class="input-icon">📅</span>
                                    <label for="date">Date</label>
                                    <input type="date" id="date" required>
                                </div>
                                
                                <div class="input-group" style="grid-column: 1 / -1;">
                                    <span class="input-icon">📝</span>
                                    <label for="description">Description (optional)</label>
                                    <input type="text" id="description" placeholder="e.g., Weekly grocery shopping">
                                </div>
                                
                                <!-- Recurring Expense Options -->
                                <div class="input-group" style="grid-column: 1 / -1;">
                                    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                                        <label class="toggle-switch">
                                            <input type="checkbox" id="isRecurring" onchange="toggleRecurringOptions()">
                                            <span class="toggle-slider"></span>
                                        </label>
                                        <label for="isRecurring" style="margin: 0; cursor: pointer; font-weight: 500;">🔄 Make this a recurring expense</label>
                                    </div>
                                    
                                    <div id="recurringOptions" style="display: none;">
                                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                            <div>
                                                <label for="recurringFrequency">Frequency</label>
                                                <select id="recurringFrequency">
                                                    <option value="weekly">📅 Weekly</option>
                                                    <option value="biweekly">📅 Bi-weekly</option>
                                                    <option value="monthly" selected>📅 Monthly</option>
                                                    <option value="quarterly">📅 Quarterly</option>
                                                    <option value="yearly">📅 Yearly</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label for="recurringEndDate">End Date (optional)</label>
                                                <input type="date" id="recurringEndDate">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="btn-actions">
                                <button type="button" id="cancelEdit" onclick="cancelEdit()" style="display: none;" class="btn btn-secondary">✖️ Cancel</button>
                                <button type="submit" class="btn bounce-in">💾 Save Expense</button>
                            </div>
                        </form>
                    </div>
                </div>

                <div class="right-panel">
                    <!-- Expense List -->
                    <div class="expense-list">
                        <div class="expense-list-header">
                            <h2><span class="card-icon">📋</span> <span id="expenseListTitle">Recent Expenses</span></h2>
                            
                            <!-- Smart Search Bar -->
                            <div class="search-container">
                                <div class="search-input-wrapper">
                                    <span class="search-icon">🔍</span>
                                    <input type="text" id="searchInput" placeholder="Search expenses..." onkeyup="handleSearch()" autocomplete="off">
                                    <button id="clearSearch" onclick="clearSearch()" style="display: none;">✖️</button>
                                </div>
                                <div id="searchResults" class="search-results"></div>
                            </div>
                            
                            <!-- View Mode Toggle -->
                            <div class="view-mode-toggle">
                                <button id="recentModeBtn" class="view-mode-btn active" onclick="setViewMode('recent')">
                                    <span class="view-icon">📅</span>
                                    <span>Recent (30 days)</span>
                                </button>
                                <button id="allModeBtn" class="view-mode-btn" onclick="setViewMode('all')">
                                    <span class="view-icon">📋</span>
                                    <span>All Expenses</span>
                                </button>
                            </div>
                            
                            <div class="expense-filters">
                                <div class="filter-group">
                                    <label>Filter by Category</label>
                                    <select id="categoryFilter" onchange="filterExpenses()">
                                        <option value="">All Categories</option>
                                        <option value="Rent">🏠 Rent</option>
                                        <option value="Mortgage">🏡 Mortgage</option>
                                        <option value="Utilities">⚡ Utilities</option>
                                        <option value="Groceries">🛒 Groceries</option>
                                        <option value="Transportation">🚗 Transportation</option>
                                        <option value="Car Loan/Lease">🚙 Car Loan/Lease</option>
                                        <option value="Healthcare">🏥 Healthcare</option>
                                        <option value="Entertainment">🎬 Entertainment</option>
                                        <option value="Dining">🍽️ Dining</option>
                                        <option value="Shopping">🛍️ Shopping</option>
                                        <option value="Education">📚 Education</option>
                                        <option value="Insurance">🛡️ Insurance</option>
                                        <option value="Other Loan">💳 Other Loan</option>
                                        <option value="Other">📝 Other</option>
                                    </select>
                                </div>
                                <div class="filter-group" id="personFilterGroup">
                                    <label id="personFilterLabel">Filter by Person</label>
                                    <select id="personFilter" onchange="filterExpenses()">
                                        <option value="">All People</option>
                                        <option value="You">👤 You</option>
                                        <option value="Partner">👥 Partner</option>
                                        <option value="Both">💏 Both</option>
                                    </select>
                                </div>
                                <button class="btn btn-success" onclick="exportToCSV()">📥 Export CSV</button>
                            </div>
                        </div>
                        
                        <!-- Pagination Controls -->
                        <div id="paginationTop" class="pagination-container" style="display: none;">
                            <div class="pagination-info">
                                <span id="paginationInfo">Showing 0 expenses</span>
                            </div>
                            <div class="pagination-controls">
                                <button id="prevPageBtn" onclick="changePage(-1)" disabled>← Previous</button>
                                <span id="pageInfo">Page 1 of 1</span>
                                <button id="nextPageBtn" onclick="changePage(1)" disabled>Next →</button>
                            </div>
                        </div>
                        
                        <div id="expensesList">
                            <div class="no-expenses">No expenses added yet. Add your first expense above!</div>
                        </div>
                        
                        <!-- Bottom Pagination -->
                        <div id="paginationBottom" class="pagination-container" style="display: none;">
                            <div class="pagination-controls">
                                <button onclick="changePage(-1)">← Previous</button>
                                <span id="pageInfoBottom">Page 1 of 1</span>
                                <button onclick="changePage(1)">Next →</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dashboard Tab Content -->
        <div id="dashboardTab" class="tab-content">
            <div class="dashboard">
                <div class="card budget-card" id="budgetCard">
                    <h2><span class="card-icon">🎯</span> Monthly Budget</h2>
                    <div class="total-display" id="budgetAmount">€0</div>
                    <div class="progress-container">
                        <div class="progress-fill" id="budgetFill">
                            <span class="progress-text" id="progressText">0%</span>
                        </div>
                    </div>
                    <div id="budgetStatus">Set your monthly budget</div>
                </div>

                <div class="card">
                    <h2><span class="card-icon">📊</span> This Month's Total</h2>
                    <div class="total-display" id="monthlyTotal">€0</div>
                    <div id="expenseCount">0 expenses</div>
                </div>

                <div class="card">
                    <h2><span class="card-icon">📈</span> Expense Breakdown</h2>
                    <div class="chart-container">
                        <canvas id="expenseChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Enhanced Statistics -->
            <div class="stats-grid">
                <div class="stat-card-enhanced">
                    <span class="stat-icon">📊</span>
                    <div class="stat-value" id="avgDaily">€0</div>
                    <div class="stat-label">Avg Daily</div>
                </div>
                <div class="stat-card-enhanced">
                    <span class="stat-icon">🏆</span>
                    <div class="stat-value" id="topCategory">-</div>
                    <div class="stat-label">Top Category</div>
                </div>
                <div class="stat-card-enhanced">
                    <span class="stat-icon">⏰</span>
                    <div class="stat-value" id="daysLeft">0</div>
                    <div class="stat-label">Days Left</div>
                </div>
                <div class="stat-card-enhanced">
                    <span class="stat-icon">📈</span>
                    <div class="stat-value" id="weeklyAvg">€0</div>
                    <div class="stat-label">Weekly Avg</div>
                </div>
            </div>
        </div>

        <!-- Settings Tab Content -->
        <div id="settingsTab" class="tab-content">
            <div class="settings-panel">
                <h2><span class="card-icon">⚙️</span> Settings & Configuration</h2>
                <div class="settings-grid">
                    <div class="form-group">
                        <label for="monthlyBudget">Monthly Budget (€)</label>
                        <input type="number" id="monthlyBudget" placeholder="1500" min="0">
                    </div>
                    <button class="btn" onclick="setBudget()">💾 Set Budget</button>
                </div>
                
                <div style="margin-top: 2rem;">
                    <h3>⌨️ Keyboard Shortcuts</h3>
                    <div class="keyboard-shortcuts">
                        <div class="shortcut-item">
                            <span class="shortcut-key">Ctrl + N</span>
                            <span class="shortcut-desc">New Expense (scroll to form)</span>
                        </div>
                        <div class="shortcut-item">
                            <span class="shortcut-key">Ctrl + I</span>
                            <span class="shortcut-desc">Show Insights</span>
                        </div>
                        <div class="shortcut-item">
                            <span class="shortcut-key">Ctrl + R</span>
                            <span class="shortcut-desc">Recurring Expenses</span>
                        </div>
                        <div class="shortcut-item">
                            <span class="shortcut-key">Ctrl + E</span>
                            <span class="shortcut-desc">Export CSV</span>
                        </div>
                        <div class="shortcut-item">
                            <span class="shortcut-key">Ctrl + D</span>
                            <span class="shortcut-desc">Dashboard Tab</span>
                        </div>
                        <div class="shortcut-item">
                            <span class="shortcut-key">Ctrl + M</span>
                            <span class="shortcut-desc">Main Tab</span>
                        </div>
                        <div class="shortcut-item">
                            <span class="shortcut-key">Ctrl + F</span>
                            <span class="shortcut-desc">Focus Search</span>
                        </div>
                        <div class="shortcut-item">
                            <span class="shortcut-key">Ctrl + S</span>
                            <span class="shortcut-desc">Save Form</span>
                        </div>
                        <div class="shortcut-item">
                            <span class="shortcut-key">Esc</span>
                            <span class="shortcut-desc">Close Modals/Clear Search</span>
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 2rem;">
                    <h3>🗑️ Data Management</h3>
                    <div style="display: flex; gap: 1rem; margin-top: 1rem; flex-wrap: wrap;">
                        <button class="btn btn-warning" onclick="exportToCSV()">📥 Export All Data</button>
                        <button class="btn btn-danger" onclick="clearAllData()">🗑️ Clear All Data</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="notification"></div>
    
    <!-- Floating Action Button -->
    <button class="fab" onclick="scrollToForm()" title="Add New Expense">
        ➕
    </button>
    
    <!-- Insights Modal -->
    <div id="insightsModal" class="modal">
        <div class="modal-content">
            <h2>📊 Spending Insights</h2>
            <div id="insightsContent">
                <div class="insight-item">
                    <h3>💡 Smart Recommendations</h3>
                    <div id="recommendations"></div>
                </div>
                <div class="insight-item" style="margin-top: 2rem;">
                    <h3>📈 Spending Trends</h3>
                    <div id="trends"></div>
                </div>
            </div>
            <div style="text-align: center; margin-top: 2rem;">
                <button class="btn" onclick="closeInsights()">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Recurring Expenses Modal -->
    <div id="recurringModal" class="modal">
        <div class="modal-content">
            <h2>🔄 Recurring Expenses</h2>
            <div id="recurringContent">
                <div style="margin-bottom: 2rem;">
                    <h3>📋 Active Recurring Expenses</h3>
                    <div id="recurringList"></div>
                </div>
                <div>
                    <h3>⚡ Quick Actions</h3>
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap; margin-top: 1rem;">
                        <button class="btn btn-success" onclick="processRecurringExpenses()">📅 Process Due Expenses</button>
                        <button class="btn btn-warning" onclick="checkRecurringExpenses()">🔍 Check for Due Expenses</button>
                    </div>
                </div>
            </div>
            <div style="text-align: center; margin-top: 2rem;">
                <button class="btn" onclick="closeRecurringModal()">Close</button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let expenses = JSON.parse(localStorage.getItem('familyExpenses')) || [];
        let monthlyBudget = parseFloat(localStorage.getItem('monthlyBudget')) || 0;
        let editingExpenseId = null;
        let expenseChart = null;
        let filteredExpenses = [...expenses];
        let customCategories = JSON.parse(localStorage.getItem('customCategories')) || [];
        let recurringExpenses = JSON.parse(localStorage.getItem('recurringExpenses')) || [];
        let trackerType = localStorage.getItem('trackerType') || 'personal';
        let savingsGoal = parseFloat(localStorage.getItem('savingsGoal')) || 0;

        // Category icons mapping
        const categoryIcons = {
            'Rent': '🏠',
            'Mortgage': '🏡',
            'Utilities': '⚡',
            'Groceries': '🛒',
            'Transportation': '🚗',
            'Car Loan/Lease': '🚙',
            'Healthcare': '🏥',
            'Entertainment': '🎬',
            'Dining': '🍽️',
            'Shopping': '🛍️',
            'Education': '📚',
            'Insurance': '🛡️',
            'Other Loan': '💳',
            'Other': '📝'
        };

        // Global variables for new features
        let currentPage = 1;
        let itemsPerPage = 10;
        let currentViewMode = 'recent'; // 'recent' or 'all'
        let searchTerm = '';
        let totalFilteredExpenses = 0;

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('date').valueAsDate = new Date();
            document.getElementById('monthlyBudget').value = monthlyBudget;
            
            // Load dark mode preference
            const isDarkMode = localStorage.getItem('darkMode') === 'true';
            if (isDarkMode) {
                document.body.classList.add('dark-mode');
                document.getElementById('darkModeToggle').checked = true;
            }
            
            // Load custom categories
            loadCustomCategories();
            
            // Load tracker type
            loadTrackerType();
            
            // Check for due recurring expenses on load
            checkRecurringExpenses();
            
            updateDashboard();
            filterAndRenderExpenses(); // Use new system
            
            // Setup keyboard shortcuts
            setupKeyboardShortcuts();
            
            document.getElementById('expenseForm').addEventListener('submit', handleExpenseSubmit);
            
            // Add loading states
            document.querySelectorAll('button').forEach(btn => {
                btn.addEventListener('click', function() {
                    if (this.type !== 'submit') {
                        this.classList.add('loading');
                        setTimeout(() => this.classList.remove('loading'), 300);
                    }
                });
            });
            
            // Add input animations
            document.querySelectorAll('input, select').forEach(input => {
                input.addEventListener('focus', function() {
                    this.parentElement.classList.add('bounce-in');
                });
                input.addEventListener('blur', function() {
                    this.parentElement.classList.remove('bounce-in');
                });
            });
        });

        // Show notification
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // Quick form population
        function showForm(category) {
            document.getElementById('category').value = category;
            document.getElementById('amount').focus();
        }

        // Clear all data
        function clearAllData() {
            if (confirm('Are you sure you want to clear all expenses and budget data? This action cannot be undone.')) {
                localStorage.removeItem('familyExpenses');
                localStorage.removeItem('monthlyBudget');
                expenses = [];
                monthlyBudget = 0;
                filteredExpenses = [];
                document.getElementById('monthlyBudget').value = '';
                updateDashboard();
                renderExpensesList();
                showNotification('All data cleared successfully', 'success');
            }
        }

        // Set monthly budget
        function setBudget() {
            const budgetInput = document.getElementById('monthlyBudget');
            const budget = parseFloat(budgetInput.value) || 0;
            
            if (budget < 0) {
                showNotification('Budget cannot be negative', 'error');
                return;
            }
            
            monthlyBudget = budget;
            localStorage.setItem('monthlyBudget', monthlyBudget);
            updateDashboard();
            showNotification('Budget updated successfully!', 'success');
        }

        // Handle expense form submission
        function handleExpenseSubmit(e) {
            e.preventDefault();
            
            const amount = parseFloat(document.getElementById('amount').value);
            const category = document.getElementById('category').value;
            const person = document.getElementById('person').value;
            const description = document.getElementById('description').value;
            const date = document.getElementById('date').value;
            
            if (amount <= 0) {
                showNotification('Amount must be greater than 0', 'error');
                return;
            }
            
            const isRecurring = document.getElementById('isRecurring').checked;
            const recurringFrequency = document.getElementById('recurringFrequency').value;
            const recurringEndDate = document.getElementById('recurringEndDate').value;

            const expense = {
                id: editingExpenseId || Date.now(),
                amount: amount,
                category: category,
                person: trackerType === 'personal' ? 'You' : person,
                description: description,
                date: date,
                timestamp: new Date().toISOString(),
                isRecurring: isRecurring,
                recurringFrequency: isRecurring ? recurringFrequency : null,
                recurringEndDate: isRecurring && recurringEndDate ? recurringEndDate : null,
                lastProcessedDate: isRecurring ? date : null
            };
            
            if (editingExpenseId) {
                const index = expenses.findIndex(e => e.id === editingExpenseId);
                expenses[index] = expense;
                
                // Update recurring expense if it exists
                if (expense.isRecurring) {
                    const recurringIndex = recurringExpenses.findIndex(r => r.originalExpenseId === editingExpenseId);
                    if (recurringIndex !== -1) {
                        recurringExpenses[recurringIndex] = createRecurringTemplate(expense);
                        localStorage.setItem('recurringExpenses', JSON.stringify(recurringExpenses));
                    }
                }
                
                editingExpenseId = null;
                document.getElementById('cancelEdit').style.display = 'none';
                showNotification('Expense updated successfully!', 'success');
            } else {
                expenses.push(expense);
                
                // Create recurring template if this is a recurring expense
                if (isRecurring) {
                    const recurringTemplate = createRecurringTemplate(expense);
                    recurringExpenses.push(recurringTemplate);
                    localStorage.setItem('recurringExpenses', JSON.stringify(recurringExpenses));
                    showNotification('Recurring expense created successfully!', 'success');
                } else {
                    showNotification('Expense added successfully!', 'success');
                }
            }
            
            localStorage.setItem('familyExpenses', JSON.stringify(expenses));
            filteredExpenses = [...expenses];
            updateDashboard();
            filterAndRenderExpenses(); // Use new pagination system
            resetForm();
        }

        // Update dashboard statistics and charts
        function updateDashboard() {
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            const monthlyExpenses = expenses.filter(expense => {
                const expenseDate = new Date(expense.date);
                return expenseDate.getMonth() === currentMonth && expenseDate.getFullYear() === currentYear;
            });
            
            const monthlyTotal = monthlyExpenses.reduce((total, expense) => total + expense.amount, 0);
            
            // Update budget display
            document.getElementById('budgetAmount').textContent = `€${monthlyBudget.toFixed(2)}`;
            document.getElementById('monthlyTotal').textContent = `€${monthlyTotal.toFixed(2)}`;
            document.getElementById('expenseCount').textContent = `${monthlyExpenses.length} expense${monthlyExpenses.length !== 1 ? 's' : ''}`;
            
            // Update budget progress
            const budgetFill = document.getElementById('budgetFill');
            const budgetCard = document.getElementById('budgetCard');
            const budgetStatus = document.getElementById('budgetStatus');
            const progressText = document.getElementById('progressText');
            
            if (monthlyBudget > 0) {
                const percentage = Math.min((monthlyTotal / monthlyBudget) * 100, 100);
                budgetFill.style.width = `${percentage}%`;
                progressText.textContent = `${Math.round(percentage)}%`;
                
                const remaining = monthlyBudget - monthlyTotal;
                if (remaining >= 0) {
                    budgetStatus.textContent = `€${remaining.toFixed(2)} remaining`;
                    budgetCard.classList.remove('budget-warning');
                } else {
                    budgetStatus.textContent = `€${Math.abs(remaining).toFixed(2)} over budget`;
                    budgetCard.classList.add('budget-warning');
                }
            } else {
                budgetFill.style.width = '0%';
                progressText.textContent = '0%';
                budgetStatus.textContent = 'Set your monthly budget';
            }
            
            // Update statistics
            const avgDaily = monthlyExpenses.length > 0 ? monthlyTotal / new Date().getDate() : 0;
            document.getElementById('avgDaily').textContent = `€${avgDaily.toFixed(2)}`;
            
            // Calculate weekly average
            const weeklyAvg = monthlyExpenses.length > 0 ? monthlyTotal / (new Date().getDate() / 7) : 0;
            document.getElementById('weeklyAvg').textContent = `€${weeklyAvg.toFixed(2)}`;
            
            // Calculate top category
            const categoryTotals = {};
            monthlyExpenses.forEach(expense => {
                categoryTotals[expense.category] = (categoryTotals[expense.category] || 0) + expense.amount;
            });
            
            let topCategory = '-';
            const categories = Object.keys(categoryTotals);
            if (categories.length > 0) {
                topCategory = categories.reduce((a, b) => 
                    categoryTotals[a] > categoryTotals[b] ? a : b);
            }
            document.getElementById('topCategory').textContent = topCategory;
            
            // Days left in month
            const today = new Date();
            const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
            const daysLeft = lastDay - today.getDate();
            document.getElementById('daysLeft').textContent = daysLeft;
            
            // Update chart
            updateExpenseChart(monthlyExpenses);
        }

        // Update expense chart
        function updateExpenseChart(monthlyExpenses) {
            const ctx = document.getElementById('expenseChart').getContext('2d');
            
            // Calculate category totals
            const categoryTotals = {};
            monthlyExpenses.forEach(expense => {
                categoryTotals[expense.category] = (categoryTotals[expense.category] || 0) + expense.amount;
            });
            
            const labels = Object.keys(categoryTotals);
            const data = Object.values(categoryTotals);
            const colors = [
                '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
                '#FF9F40', '#FF6384', '#C9CBCF', '#4BC0C0', '#FF6384', '#36A2EB'
            ];
            
            if (expenseChart) {
                expenseChart.destroy();
            }
            
            if (labels.length === 0) {
                return;
            }
            
            expenseChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors.slice(0, labels.length),
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true
                            }
                        }
                    }
                }
            });
        }

        // HTML escape function to prevent XSS
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, function(m) { return map[m]; });
        }

        // Render expenses list (enhanced with search highlighting and pagination)
        function renderExpensesList(expensesToRender = null) {
            const expensesList = document.getElementById('expensesList');
            const expenses = expensesToRender || filteredExpenses;
            
            if (expenses.length === 0) {
                let message = 'No expenses found';
                if (searchTerm) {
                    message = `No expenses found matching "${searchTerm}"`;
                } else if (currentViewMode === 'recent') {
                    message = 'No expenses in the last 30 days';
                } else {
                    message = 'No expenses added yet. Add your first expense above!';
                }
                expensesList.innerHTML = `<div class="no-expenses">${message}</div>`;
                return;
            }
            
            // Sort expenses by date (newest first)
            const sortedExpenses = [...expenses].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            expensesList.innerHTML = sortedExpenses.map(expense => {
                const icon = categoryIcons[expense.category] || '📝';
                const formattedDate = new Date(expense.date).toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric'
                });
                
                // Escape user input to prevent XSS and apply search highlighting
                const safeCategory = escapeHtml(expense.category);
                const safeDescription = expense.description ? escapeHtml(expense.description) : '';
                const safePerson = escapeHtml(expense.person);
                
                // Apply search highlighting
                const highlightedCategory = highlightSearchTerms(safeCategory, searchTerm);
                const highlightedDescription = safeDescription ? highlightSearchTerms(safeDescription, searchTerm) : '';
                const highlightedPerson = highlightSearchTerms(safePerson, searchTerm);
                const highlightedDate = highlightSearchTerms(formattedDate, searchTerm);
                const highlightedAmount = highlightSearchTerms(`€${expense.amount.toFixed(2)}`, searchTerm);
                
                return `
                    <div class="expense-item-enhanced slide-in-right">
                        <div class="expense-details">
                            <div class="expense-main">
                                <div class="expense-category-icon">${icon}</div>
                                <div>
                                    <strong>${highlightedCategory}</strong>
                                    ${highlightedDescription ? `- ${highlightedDescription}` : ''}
                                    ${expense.isRecurring ? '<span class="recurring-indicator">🔄 Recurring</span>' : ''}
                                </div>
                            </div>
                            <div class="expense-meta">
                                <span>👤 ${highlightedPerson}</span>
                                <span>📅 ${highlightedDate}</span>
                            </div>
                        </div>
                        <div class="expense-amount">${highlightedAmount}</div>
                        <div class="expense-actions">
                            <button class="btn btn-warning" onclick="editExpense(${expense.id})" title="Edit expense">✏️</button>
                            <button class="btn btn-danger" onclick="deleteExpense(${expense.id})" title="Delete expense">🗑️</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Filter expenses (updated for new features)
        function filterExpenses() {
            currentPage = 1; // Reset pagination when filters change
            filterAndRenderExpenses();
        }

        // Edit expense (enhanced with recurring support)
        function editExpense(id) {
            const expense = expenses.find(e => e.id === id);
            if (!expense) return;
            
            document.getElementById('amount').value = expense.amount;
            document.getElementById('category').value = expense.category;
            document.getElementById('person').value = expense.person;
            document.getElementById('description').value = expense.description;
            document.getElementById('date').value = expense.date;
            
            // Handle recurring options
            if (expense.isRecurring) {
                document.getElementById('isRecurring').checked = true;
                document.getElementById('recurringOptions').style.display = 'block';
                document.getElementById('recurringFrequency').value = expense.recurringFrequency || 'monthly';
                document.getElementById('recurringEndDate').value = expense.recurringEndDate || '';
            } else {
                document.getElementById('isRecurring').checked = false;
                document.getElementById('recurringOptions').style.display = 'none';
            }
            
            editingExpenseId = id;
            document.getElementById('cancelEdit').style.display = 'inline-flex';
            
            // Scroll to form
            document.querySelector('.expense-form').scrollIntoView({ behavior: 'smooth' });
            showNotification('Editing expense...', 'success');
        }

        // Cancel edit
        function cancelEdit() {
            editingExpenseId = null;
            document.getElementById('cancelEdit').style.display = 'none';
            document.getElementById('expenseForm').reset();
            document.getElementById('date').valueAsDate = new Date();
            showNotification('Edit cancelled', 'success');
        }

        // Delete expense
        function deleteExpense(id) {
            if (confirm('Are you sure you want to delete this expense?')) {
                expenses = expenses.filter(e => e.id !== id);
                            filteredExpenses = filteredExpenses.filter(e => e.id !== id);
            localStorage.setItem('familyExpenses', JSON.stringify(expenses));
            updateDashboard();
            filterAndRenderExpenses(); // Use new pagination system
            showNotification('Expense deleted successfully!', 'success');
            }
        }

        // Export to CSV
        function exportToCSV() {
            if (expenses.length === 0) {
                showNotification('No expenses to export', 'error');
                return;
            }
            
            const headers = ['Date', 'Category', 'Amount', 'Person', 'Description'];
            const csvContent = [
                headers.join(','),
                ...expenses.map(expense => [
                    expense.date,
                    expense.category,
                    expense.amount,
                    expense.person,
                    `"${expense.description || ''}"`
                ].join(','))
            ].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `family-expenses-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            window.URL.revokeObjectURL(url);
            
            showNotification('Expenses exported successfully!', 'success');
        }

        // Dark mode toggle
        function toggleDarkMode() {
            const isDarkMode = document.getElementById('darkModeToggle').checked;
            document.body.classList.toggle('dark-mode', isDarkMode);
            localStorage.setItem('darkMode', isDarkMode);
            
            if (isDarkMode) {
                showNotification('Dark mode enabled 🌙', 'success');
            } else {
                showNotification('Light mode enabled ☀️', 'success');
            }
        }

        // Scroll to form function
        function scrollToForm() {
            document.querySelector('.expense-form').scrollIntoView({ 
                behavior: 'smooth',
                block: 'center'
            });
            document.getElementById('amount').focus();
        }

        // Show insights modal
        function showInsights() {
            generateInsights();
            document.getElementById('insightsModal').style.display = 'block';
        }

        // Close insights modal
        function closeInsights() {
            document.getElementById('insightsModal').style.display = 'none';
        }

        // Generate spending insights
        function generateInsights() {
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            const monthlyExpenses = expenses.filter(expense => {
                const expenseDate = new Date(expense.date);
                return expenseDate.getMonth() === currentMonth && expenseDate.getFullYear() === currentYear;
            });

            const recommendations = document.getElementById('recommendations');
            const trends = document.getElementById('trends');

            // Generate recommendations
            let recommendationText = '';
            if (monthlyExpenses.length === 0) {
                recommendationText = '💡 Start tracking your expenses to get personalized insights!';
            } else {
                const monthlyTotal = monthlyExpenses.reduce((total, expense) => total + expense.amount, 0);
                const avgDaily = monthlyTotal / new Date().getDate();
                
                if (monthlyBudget > 0) {
                    const budgetUsed = (monthlyTotal / monthlyBudget) * 100;
                    if (budgetUsed > 80) {
                        recommendationText = '⚠️ You\'ve used over 80% of your budget. Consider reducing non-essential expenses.';
                    } else if (budgetUsed < 50) {
                        recommendationText = '✅ Great job! You\'re well within your budget. Consider saving the extra amount.';
                    } else {
                        recommendationText = '📊 You\'re on track with your budget. Keep monitoring your spending.';
                    }
                } else {
                    recommendationText = '🎯 Set a monthly budget to get better insights and recommendations.';
                }

                // Category-based recommendations
                const categoryTotals = {};
                monthlyExpenses.forEach(expense => {
                    categoryTotals[expense.category] = (categoryTotals[expense.category] || 0) + expense.amount;
                });

                const topCategory = Object.keys(categoryTotals).reduce((a, b) => 
                    categoryTotals[a] > categoryTotals[b] ? a : b, '');
                
                if (topCategory && categoryTotals[topCategory] > monthlyTotal * 0.4) {
                    recommendationText += `<br><br>💰 ${topCategory} represents a large portion of your spending. Look for ways to optimize these expenses.`;
                }
            }

            recommendations.innerHTML = recommendationText;

            // Generate trends
            let trendsText = '';
            if (monthlyExpenses.length >= 5) {
                const last7Days = monthlyExpenses.filter(expense => {
                    const expenseDate = new Date(expense.date);
                    const today = new Date();
                    const diffTime = Math.abs(today - expenseDate);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    return diffDays <= 7;
                });

                const recentTotal = last7Days.reduce((total, expense) => total + expense.amount, 0);
                const recentAvg = recentTotal / 7;
                const monthlyAvg = monthlyExpenses.reduce((total, expense) => total + expense.amount, 0) / new Date().getDate();

                if (recentAvg > monthlyAvg * 1.2) {
                    trendsText = '📈 Your spending has increased in the last week. Consider reviewing recent purchases.';
                } else if (recentAvg < monthlyAvg * 0.8) {
                    trendsText = '📉 Your spending has decreased in the last week. Great job on controlling expenses!';
                } else {
                    trendsText = '📊 Your spending pattern is consistent with your monthly average.';
                }

                // Most active day
                const dayTotals = {};
                monthlyExpenses.forEach(expense => {
                    const day = new Date(expense.date).toLocaleDateString('en-US', { weekday: 'long' });
                    dayTotals[day] = (dayTotals[day] || 0) + expense.amount;
                });

                const mostActiveDay = Object.keys(dayTotals).reduce((a, b) => 
                    dayTotals[a] > dayTotals[b] ? a : b, '');

                if (mostActiveDay) {
                    trendsText += `<br><br>📅 ${mostActiveDay} is your most expensive day of the week.`;
                }
            } else {
                trendsText = '📊 Add more expenses to see detailed spending trends and patterns.';
            }

            trends.innerHTML = trendsText;
        }

        // Enhanced form validation
        function validateExpenseForm() {
            const amount = parseFloat(document.getElementById('amount').value);
            const category = document.getElementById('category').value;
            const person = document.getElementById('person').value;
            const date = document.getElementById('date').value;

            if (!amount || amount <= 0) {
                showNotification('Please enter a valid amount greater than 0', 'error');
                return false;
            }

            if (amount > 10000) {
                if (!confirm('This is a large amount (€' + amount.toFixed(2) + '). Are you sure this is correct?')) {
                    return false;
                }
            }

            if (!category) {
                showNotification('Please select a category', 'error');
                return false;
            }

            // Only validate person if not personal tracker
            if (trackerType !== 'personal' && !person) {
                const personType = trackerType === 'family' ? 'family member' : 'group member';
                showNotification(`Please select a ${personType}`, 'error');
                return false;
            }

            if (!date) {
                showNotification('Please select a date', 'error');
                return false;
            }

            // Check if date is in the future
            const selectedDate = new Date(date);
            const today = new Date();
            today.setHours(23, 59, 59, 999); // Set to end of today

            if (selectedDate > today) {
                if (!confirm('The selected date is in the future. Do you want to continue?')) {
                    return false;
                }
            }

            return true;
        }

        // Auto-save functionality
        let autoSaveTimer;
        function autoSave() {
            clearTimeout(autoSaveTimer);
            autoSaveTimer = setTimeout(() => {
                const formData = {
                    amount: document.getElementById('amount').value,
                    category: document.getElementById('category').value,
                    person: document.getElementById('person').value,
                    date: document.getElementById('date').value,
                    description: document.getElementById('description').value
                };
                
                if (formData.amount || formData.category || formData.person || formData.description) {
                    localStorage.setItem('expenseFormDraft', JSON.stringify(formData));
                }
            }, 1000);
        }

        // Load draft on page load
        function loadDraft() {
            const draft = localStorage.getItem('expenseFormDraft');
            if (draft) {
                const formData = JSON.parse(draft);
                document.getElementById('amount').value = formData.amount || '';
                document.getElementById('category').value = formData.category || '';
                document.getElementById('person').value = formData.person || '';
                document.getElementById('date').value = formData.date || new Date().toISOString().split('T')[0];
                document.getElementById('description').value = formData.description || '';
                
                if (formData.amount || formData.category || formData.person || formData.description) {
                    showNotification('Draft restored from previous session', 'success');
                }
            }
        }

        // Clear draft
        function clearDraft() {
            localStorage.removeItem('expenseFormDraft');
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl/Cmd + N: Focus on new expense form
            if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
                e.preventDefault();
                scrollToForm();
            }
            
            // Ctrl/Cmd + I: Show insights
            if ((e.ctrlKey || e.metaKey) && e.key === 'i') {
                e.preventDefault();
                showInsights();
            }
            
            // Ctrl/Cmd + R: Show recurring expenses
            if ((e.ctrlKey || e.metaKey) && e.key === 'r') {
                e.preventDefault();
                showRecurringModal();
            }
            
            // Ctrl/Cmd + D: Switch to dashboard
            if ((e.ctrlKey || e.metaKey) && e.key === 'd') {
                e.preventDefault();
                document.querySelector('.nav-tab[onclick*="dashboard"]').click();
            }
            
            // Ctrl/Cmd + 1: Switch to main tab
            if ((e.ctrlKey || e.metaKey) && e.key === '1') {
                e.preventDefault();
                document.querySelector('.nav-tab[onclick*="main"]').click();
            }
            
            // Ctrl/Cmd + 2: Switch to dashboard tab
            if ((e.ctrlKey || e.metaKey) && e.key === '2') {
                e.preventDefault();
                document.querySelector('.nav-tab[onclick*="dashboard"]').click();
            }
            
            // Ctrl/Cmd + 3: Switch to settings tab
            if ((e.ctrlKey || e.metaKey) && e.key === '3') {
                e.preventDefault();
                document.querySelector('.nav-tab[onclick*="settings"]').click();
            }
            
            // Escape: Close modal
            if (e.key === 'Escape') {
                closeInsights();
                closeRecurringModal();
            }
        });

        // Update the form submission to include validation
        const originalHandleExpenseSubmit = handleExpenseSubmit;
        handleExpenseSubmit = function(e) {
            e.preventDefault();
            
            if (!validateExpenseForm()) {
                return;
            }
            
            // Clear draft after successful submission
            clearDraft();
            
            // Call original function
            originalHandleExpenseSubmit.call(this, e);
        };

        // Add auto-save listeners
        document.addEventListener('DOMContentLoaded', function() {
            loadDraft();
            
            // Add auto-save to form inputs
            document.querySelectorAll('#expenseForm input, #expenseForm select').forEach(input => {
                input.addEventListener('input', autoSave);
                input.addEventListener('change', autoSave);
            });
        });

        // Custom Categories Functions
        function loadCustomCategories() {
            const categorySelect = document.getElementById('category');
            const categoryFilter = document.getElementById('categoryFilter');
            
            // Remove existing custom categories
            const customOptions = categorySelect.querySelectorAll('.custom-category');
            customOptions.forEach(option => option.remove());
            
            const customFilterOptions = categoryFilter.querySelectorAll('.custom-category');
            customFilterOptions.forEach(option => option.remove());
            
            // Add custom categories
            customCategories.forEach(category => {
                // Add to main select
                const option = document.createElement('option');
                option.value = category.name;
                option.textContent = `${category.icon} ${category.name}`;
                option.className = 'custom-category';
                categorySelect.insertBefore(option, categorySelect.querySelector('option[value="__ADD_NEW__"]'));
                
                // Add to filter select
                const filterOption = document.createElement('option');
                filterOption.value = category.name;
                filterOption.textContent = `${category.icon} ${category.name}`;
                filterOption.className = 'custom-category';
                categoryFilter.appendChild(filterOption);
                
                // Add to category icons mapping
                categoryIcons[category.name] = category.icon;
            });
        }

        function handleCategoryChange() {
            const categorySelect = document.getElementById('category');
            const customCategoryGroup = document.getElementById('customCategoryGroup');
            
            if (categorySelect.value === '__ADD_NEW__') {
                customCategoryGroup.style.display = 'block';
                document.getElementById('customCategory').focus();
            } else {
                customCategoryGroup.style.display = 'none';
            }
        }

        function addCustomCategory() {
            const nameInput = document.getElementById('customCategory');
            const iconInput = document.getElementById('customCategoryIcon');
            const categoryName = nameInput.value.trim();
            const categoryIcon = iconInput.value.trim() || '🏷️';
            
            if (!categoryName) {
                showNotification('Please enter a category name', 'error');
                return;
            }
            
            // Check if category already exists
            const existingCategory = customCategories.find(cat => cat.name.toLowerCase() === categoryName.toLowerCase());
            if (existingCategory) {
                showNotification('Category already exists', 'error');
                return;
            }
            
            // Add new custom category
            const newCategory = {
                name: categoryName,
                icon: categoryIcon,
                id: Date.now()
            };
            
            customCategories.push(newCategory);
            localStorage.setItem('customCategories', JSON.stringify(customCategories));
            
            // Reload categories in selects
            loadCustomCategories();
            
            // Select the new category
            document.getElementById('category').value = categoryName;
            
            // Hide custom category input
            cancelCustomCategory();
            
            showNotification(`Category "${categoryName}" added successfully!`, 'success');
        }

        function cancelCustomCategory() {
            document.getElementById('customCategoryGroup').style.display = 'none';
            document.getElementById('category').value = '';
            document.getElementById('customCategory').value = '';
            document.getElementById('customCategoryIcon').value = '';
        }

        function deleteCustomCategory(categoryName) {
            if (confirm(`Are you sure you want to delete the category "${categoryName}"?`)) {
                customCategories = customCategories.filter(cat => cat.name !== categoryName);
                localStorage.setItem('customCategories', JSON.stringify(customCategories));
                loadCustomCategories();
                showNotification(`Category "${categoryName}" deleted`, 'success');
            }
        }

        // Recurring Expenses Functions
        function toggleRecurringOptions() {
            const isRecurring = document.getElementById('isRecurring').checked;
            const recurringOptions = document.getElementById('recurringOptions');
            
            recurringOptions.style.display = isRecurring ? 'block' : 'none';
        }

        function createRecurringTemplate(expense) {
            return {
                id: Date.now(),
                originalExpenseId: expense.id,
                amount: expense.amount,
                category: expense.category,
                person: expense.person,
                description: expense.description,
                frequency: expense.recurringFrequency,
                startDate: expense.date,
                endDate: expense.recurringEndDate,
                lastProcessedDate: expense.date,
                isActive: true,
                created: new Date().toISOString()
            };
        }

        function calculateNextDueDate(lastDate, frequency) {
            const lastProcessed = new Date(lastDate);
            const nextDue = new Date(lastProcessed);
            
            switch (frequency) {
                case 'weekly':
                    nextDue.setDate(nextDue.getDate() + 7);
                    break;
                case 'biweekly':
                    nextDue.setDate(nextDue.getDate() + 14);
                    break;
                case 'monthly':
                    nextDue.setMonth(nextDue.getMonth() + 1);
                    break;
                case 'quarterly':
                    nextDue.setMonth(nextDue.getMonth() + 3);
                    break;
                case 'yearly':
                    nextDue.setFullYear(nextDue.getFullYear() + 1);
                    break;
            }
            
            return nextDue;
        }

        function checkRecurringExpenses() {
            const today = new Date();
            const dueExpenses = [];
            
            recurringExpenses.forEach(recurring => {
                if (!recurring.isActive) return;
                
                // Check if end date has passed
                if (recurring.endDate && new Date(recurring.endDate) < today) {
                    recurring.isActive = false;
                    return;
                }
                
                const nextDue = calculateNextDueDate(recurring.lastProcessedDate, recurring.frequency);
                
                if (nextDue <= today) {
                    dueExpenses.push(recurring);
                }
            });
            
            if (dueExpenses.length > 0) {
                showNotification(`${dueExpenses.length} recurring expense(s) are due!`, 'warning');
            }
            
            // Save any inactive updates
            localStorage.setItem('recurringExpenses', JSON.stringify(recurringExpenses));
            
            return dueExpenses;
        }

        function processRecurringExpenses() {
            const dueExpenses = checkRecurringExpenses();
            
            if (dueExpenses.length === 0) {
                showNotification('No recurring expenses are due', 'success');
                return;
            }
            
            let processedCount = 0;
            
            dueExpenses.forEach(recurring => {
                const nextDue = calculateNextDueDate(recurring.lastProcessedDate, recurring.frequency);
                
                // Create new expense
                const newExpense = {
                    id: Date.now() + Math.random(),
                    amount: recurring.amount,
                    category: recurring.category,
                    person: recurring.person,
                    description: `${recurring.description} (Recurring)`,
                    date: nextDue.toISOString().split('T')[0],
                    timestamp: new Date().toISOString(),
                    isRecurring: true,
                    recurringFrequency: recurring.frequency,
                    parentRecurringId: recurring.id
                };
                
                expenses.push(newExpense);
                
                // Update last processed date
                recurring.lastProcessedDate = nextDue.toISOString().split('T')[0];
                processedCount++;
            });
            
            // Save updated data
            localStorage.setItem('familyExpenses', JSON.stringify(expenses));
            localStorage.setItem('recurringExpenses', JSON.stringify(recurringExpenses));
            
            // Refresh display
            filteredExpenses = [...expenses];
            updateDashboard();
            filterAndRenderExpenses(); // Use new pagination system
            
            showNotification(`Processed ${processedCount} recurring expense(s)`, 'success');
        }

        function showRecurringModal() {
            renderRecurringList();
            document.getElementById('recurringModal').style.display = 'block';
        }

        function closeRecurringModal() {
            document.getElementById('recurringModal').style.display = 'none';
        }

        function renderRecurringList() {
            const recurringList = document.getElementById('recurringList');
            
            if (recurringExpenses.length === 0) {
                recurringList.innerHTML = '<p style="text-align: center; color: var(--text-secondary); font-style: italic;">No recurring expenses set up yet.</p>';
                return;
            }
            
            const activeRecurring = recurringExpenses.filter(r => r.isActive);
            
            if (activeRecurring.length === 0) {
                recurringList.innerHTML = '<p style="text-align: center; color: var(--text-secondary); font-style: italic;">No active recurring expenses.</p>';
                return;
            }
            
            recurringList.innerHTML = activeRecurring.map(recurring => {
                const nextDue = calculateNextDueDate(recurring.lastProcessedDate, recurring.frequency);
                const today = new Date();
                const daysUntilDue = Math.ceil((nextDue - today) / (1000 * 60 * 60 * 24));
                
                let statusClass = 'recurring-frequency';
                let statusText = `Next: ${nextDue.toLocaleDateString()}`;
                
                if (daysUntilDue < 0) {
                    statusClass = 'recurring-frequency overdue';
                    statusText = `Overdue by ${Math.abs(daysUntilDue)} day(s)`;
                } else if (daysUntilDue <= 3) {
                    statusClass = 'recurring-frequency due-soon';
                    statusText = `Due in ${daysUntilDue} day(s)`;
                }
                
                const icon = categoryIcons[recurring.category] || '📝';
                
                return `
                    <div class="recurring-item">
                        <div class="recurring-item-header">
                            <div>
                                <strong>${icon} ${recurring.category}</strong>
                                <span style="margin-left: 0.5rem; color: var(--text-secondary);">€${recurring.amount.toFixed(2)}</span>
                            </div>
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                <span class="${statusClass}">${statusText}</span>
                                <button class="btn btn-danger" onclick="deactivateRecurring(${recurring.id})" style="min-width: auto; padding: 0.25rem 0.5rem; font-size: 0.8rem;">Stop</button>
                            </div>
                        </div>
                        <div style="font-size: 0.9rem; color: var(--text-secondary);">
                            ${recurring.description} • ${recurring.frequency} • 👤 ${recurring.person}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function deactivateRecurring(recurringId) {
            if (confirm('Are you sure you want to stop this recurring expense?')) {
                const recurring = recurringExpenses.find(r => r.id === recurringId);
                if (recurring) {
                    recurring.isActive = false;
                    localStorage.setItem('recurringExpenses', JSON.stringify(recurringExpenses));
                    renderRecurringList();
                    showNotification('Recurring expense stopped', 'success');
                }
            }
        }

        // Enhanced form reset
        function resetForm() {
            document.getElementById('expenseForm').reset();
            document.getElementById('date').valueAsDate = new Date();
            document.getElementById('isRecurring').checked = false;
            document.getElementById('recurringOptions').style.display = 'none';
            document.getElementById('customCategoryGroup').style.display = 'none';
        }



        // Tab switching functionality
        function switchTab(tabName) {
            // Hide all tab contents
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all nav tabs
            const navTabs = document.querySelectorAll('.nav-tab');
            navTabs.forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            // Add active class to clicked nav tab
            event.target.classList.add('active');
            
            // Update dashboard if switching to dashboard tab
            if (tabName === 'dashboard') {
                updateDashboard();
            }
        }

        // Update main page budget summary
        function updateMainBudgetSummary() {
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            const monthlyExpenses = expenses.filter(expense => {
                const expenseDate = new Date(expense.date);
                return expenseDate.getMonth() === currentMonth && expenseDate.getFullYear() === currentYear;
            });
            
            const monthlyTotal = monthlyExpenses.reduce((total, expense) => total + expense.amount, 0);
            const remaining = monthlyBudget - monthlyTotal;
            
            // Update main page elements
            document.getElementById('budgetAmountMain').textContent = `€${monthlyBudget.toFixed(2)}`;
            document.getElementById('spentAmountMain').textContent = `€${monthlyTotal.toFixed(2)}`;
            document.getElementById('remainingAmountMain').textContent = `€${remaining.toFixed(2)}`;
            document.getElementById('monthlyTotalMain').textContent = `€${monthlyTotal.toFixed(2)}`;
            document.getElementById('expenseCountMain').textContent = monthlyExpenses.length;
            
            // Update budget status and progress
            const budgetSummary = document.getElementById('budgetSummaryMain');
            const budgetFillMain = document.getElementById('budgetFillMain');
            const budgetTextMain = document.getElementById('budgetTextMain');
            const budgetStatusMain = document.getElementById('budgetStatusMain');
            
            if (monthlyBudget > 0) {
                const percentage = Math.min((monthlyTotal / monthlyBudget) * 100, 100);
                budgetFillMain.style.width = `${percentage}%`;
                budgetTextMain.textContent = `${Math.round(percentage)}%`;
                
                if (remaining >= 0) {
                    budgetStatusMain.textContent = `€${remaining.toFixed(2)} remaining this month`;
                    budgetSummary.classList.remove('warning-budget');
                } else {
                    budgetStatusMain.textContent = `€${Math.abs(remaining).toFixed(2)} over budget this month`;
                    budgetSummary.classList.add('warning-budget');
                }
            } else {
                budgetFillMain.style.width = '0%';
                budgetTextMain.textContent = '0%';
                budgetStatusMain.textContent = 'Set your monthly budget in Settings to track progress';
                budgetSummary.classList.remove('warning-budget');
            }
            
            // Update quick stats
            const avgDaily = monthlyExpenses.length > 0 ? monthlyTotal / new Date().getDate() : 0;
            document.getElementById('avgDailyMain').textContent = `€${avgDaily.toFixed(2)}`;
            
            // Calculate top category for main page
            const categoryTotals = {};
            monthlyExpenses.forEach(expense => {
                categoryTotals[expense.category] = (categoryTotals[expense.category] || 0) + expense.amount;
            });
            
            let topCategory = '-';
            const categories = Object.keys(categoryTotals);
            if (categories.length > 0) {
                topCategory = categories.reduce((a, b) => 
                    categoryTotals[a] > categoryTotals[b] ? a : b);
            }
            document.getElementById('topCategoryMain').textContent = topCategory;
        }

        // Keyboard shortcuts
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', function(e) {
                // Check if user is typing in an input field
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
                    // Allow Ctrl+S for save even in input fields
                    if (e.ctrlKey && e.key === 's') {
                        e.preventDefault();
                        document.getElementById('expenseForm').dispatchEvent(new Event('submit'));
                        return;
                    }
                    return;
                }
                
                if (e.ctrlKey) {
                    switch(e.key) {
                        case 'n':
                        case 'N':
                            e.preventDefault();
                            scrollToForm();
                            break;
                        case 'i':
                        case 'I':
                            e.preventDefault();
                            showInsights();
                            break;
                        case 'r':
                        case 'R':
                            e.preventDefault();
                            showRecurringModal();
                            break;
                        case 'e':
                        case 'E':
                            e.preventDefault();
                            exportToCSV();
                            break;
                        case 'd':
                        case 'D':
                            e.preventDefault();
                            switchTab('dashboard');
                            break;
                        case 'm':
                        case 'M':
                            e.preventDefault();
                            switchTab('main');
                            break;
                        case 'f':
                        case 'F':
                            e.preventDefault();
                            document.getElementById('searchInput').focus();
                            break;
                    }
                }
                
                // ESC key to close modals or clear search
                if (e.key === 'Escape') {
                    closeInsights();
                    closeRecurringModal();
                    if (searchTerm) {
                        clearSearch();
                    }
                }
            });
        }

        // Smart Search Functions
        function handleSearch() {
            const input = document.getElementById('searchInput');
            searchTerm = input.value.toLowerCase().trim();
            const clearBtn = document.getElementById('clearSearch');
            
            if (searchTerm) {
                clearBtn.style.display = 'block';
            } else {
                clearBtn.style.display = 'none';
            }
            
            currentPage = 1; // Reset to first page when searching
            filterAndRenderExpenses();
        }

        function clearSearch() {
            document.getElementById('searchInput').value = '';
            document.getElementById('clearSearch').style.display = 'none';
            searchTerm = '';
            currentPage = 1;
            filterAndRenderExpenses();
        }

        function highlightSearchTerms(text, term) {
            if (!term) return text;
            const regex = new RegExp(`(${term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
            return text.replace(regex, '<span class="search-highlight">$1</span>');
        }

        // View Mode Functions
        function setViewMode(mode) {
            currentViewMode = mode;
            currentPage = 1; // Reset pagination
            
            // Update button states
            document.getElementById('recentModeBtn').classList.toggle('active', mode === 'recent');
            document.getElementById('allModeBtn').classList.toggle('active', mode === 'all');
            
            // Update title
            const title = document.getElementById('expenseListTitle');
            title.textContent = mode === 'recent' ? 'Recent Expenses (30 days)' : 'All Expenses';
            
            filterAndRenderExpenses();
        }

        function getViewModeExpenses() {
            if (currentViewMode === 'recent') {
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                return expenses.filter(expense => new Date(expense.date) >= thirtyDaysAgo);
            }
            return expenses;
        }

        // Enhanced Filter and Render Function
        function filterAndRenderExpenses() {
            let baseExpenses = getViewModeExpenses();
            
            // Apply existing filters
            const categoryFilter = document.getElementById('categoryFilter').value;
            const personFilter = document.getElementById('personFilter').value;
            
            filteredExpenses = baseExpenses.filter(expense => {
                const categoryMatch = !categoryFilter || expense.category === categoryFilter;
                const personMatch = !personFilter || expense.person === personFilter;
                
                // Search filter
                let searchMatch = true;
                if (searchTerm) {
                    const searchFields = [
                        expense.category?.toLowerCase(),
                        expense.description?.toLowerCase(),
                        expense.person?.toLowerCase(),
                        expense.amount?.toString(),
                        new Date(expense.date).toLocaleDateString().toLowerCase()
                    ].filter(Boolean);
                    
                    searchMatch = searchFields.some(field => field.includes(searchTerm));
                }
                
                return categoryMatch && personMatch && searchMatch;
            });
            
            totalFilteredExpenses = filteredExpenses.length;
            renderExpensesWithPagination();
        }

        // Pagination Functions
        function renderExpensesWithPagination() {
            const totalPages = Math.ceil(totalFilteredExpenses / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedExpenses = filteredExpenses.slice(startIndex, endIndex);
            
            // Update pagination controls
            updatePaginationControls(totalPages);
            
            // Render expenses
            renderExpensesList(paginatedExpenses);
            
            // Show/hide pagination based on total items
            const showPagination = totalFilteredExpenses > itemsPerPage;
            document.getElementById('paginationTop').style.display = showPagination ? 'flex' : 'none';
            document.getElementById('paginationBottom').style.display = showPagination ? 'flex' : 'none';
        }

        function updatePaginationControls(totalPages) {
            const prevBtn = document.getElementById('prevPageBtn');
            const nextBtn = document.getElementById('nextPageBtn');
            const pageInfo = document.getElementById('pageInfo');
            const pageInfoBottom = document.getElementById('pageInfoBottom');
            const paginationInfo = document.getElementById('paginationInfo');
            
            // Update page info
            pageInfo.textContent = `Page ${currentPage} of ${totalPages || 1}`;
            pageInfoBottom.textContent = `Page ${currentPage} of ${totalPages || 1}`;
            
            // Update pagination info
            const startItem = totalFilteredExpenses === 0 ? 0 : (currentPage - 1) * itemsPerPage + 1;
            const endItem = Math.min(currentPage * itemsPerPage, totalFilteredExpenses);
            paginationInfo.textContent = `Showing ${startItem}-${endItem} of ${totalFilteredExpenses} expenses`;
            
            // Update button states
            prevBtn.disabled = currentPage <= 1;
            nextBtn.disabled = currentPage >= totalPages;
            
            // Update bottom pagination buttons
            const bottomPrevBtn = document.querySelector('#paginationBottom button:first-child');
            const bottomNextBtn = document.querySelector('#paginationBottom button:last-child');
            bottomPrevBtn.disabled = currentPage <= 1;
            bottomNextBtn.disabled = currentPage >= totalPages;
        }

        function changePage(direction) {
            const totalPages = Math.ceil(totalFilteredExpenses / itemsPerPage);
            const newPage = currentPage + direction;
            
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                renderExpensesWithPagination();
                
                // Scroll to top of expense list
                document.getElementById('expensesList').scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'start' 
                });
            }
        }

        // Enhanced updateDashboard to also update main page
        const originalUpdateDashboard = updateDashboard;
        updateDashboard = function() {
            // Call original dashboard update
            originalUpdateDashboard();
            
            // Also update main page summary
            updateMainBudgetSummary();
        };

        // Scroll to form function (updated for new layout)
        function scrollToForm() {
            // Switch to main tab if not already there
            if (!document.getElementById('mainTab').classList.contains('active')) {
                switchTab('main');
                // Update the active nav tab manually since event.target won't work here
                document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
                document.querySelector('.nav-tab[onclick*="main"]').classList.add('active');
            }
            
            setTimeout(() => {
                document.querySelector('.expense-form').scrollIntoView({ 
                    behavior: 'smooth',
                    block: 'center'
                });
                document.getElementById('amount').focus();
            }, 100);
        }

        // Tracker Type Management
        function loadTrackerType() {
            document.getElementById('trackerType').value = trackerType;
            updateTrackerInterface();
        }

        function changeTrackerType() {
            trackerType = document.getElementById('trackerType').value;
            localStorage.setItem('trackerType', trackerType);
            updateTrackerInterface();
            updateMainBudgetSummary(); // Refresh suggestions
        }

        function updateTrackerInterface() {
            const personGroup = document.getElementById('personGroup');
            const personSelect = document.getElementById('person');
            const personLabel = document.getElementById('personLabel');
            const personFilterGroup = document.getElementById('personFilterGroup');
            const personFilter = document.getElementById('personFilter');
            const personFilterLabel = document.getElementById('personFilterLabel');
            const appSubtitle = document.getElementById('appSubtitle');

            // Clear existing options
            personSelect.innerHTML = '<option value="">Select...</option>';
            personFilter.innerHTML = '<option value="">All...</option>';

            if (trackerType === 'personal') {
                appSubtitle.textContent = 'Track, manage, and optimize your personal spending';
                personGroup.style.display = 'none'; // Hide person selector for personal
                personFilterGroup.style.display = 'none';
            } else if (trackerType === 'family') {
                appSubtitle.textContent = 'Track, manage, and optimize your family\'s spending';
                personGroup.style.display = 'block';
                personFilterGroup.style.display = 'block';
                personLabel.textContent = 'Family Member';
                personFilterLabel.textContent = 'Filter by Family Member';
                
                // Family options
                personSelect.innerHTML = `
                    <option value="">Select family member</option>
                    <option value="You">👤 You</option>
                    <option value="Partner">💕 Partner</option>
                    <option value="Child1">👧 Child 1</option>
                    <option value="Child2">👦 Child 2</option>
                    <option value="Family">👨‍👩‍👧‍👦 Whole Family</option>
                `;
                personFilter.innerHTML = `
                    <option value="">All Family Members</option>
                    <option value="You">👤 You</option>
                    <option value="Partner">💕 Partner</option>
                    <option value="Child1">👧 Child 1</option>
                    <option value="Child2">👦 Child 2</option>
                    <option value="Family">👨‍👩‍👧‍👦 Whole Family</option>
                `;
            } else if (trackerType === 'group') {
                appSubtitle.textContent = 'Track, manage, and optimize your group\'s shared spending';
                personGroup.style.display = 'block';
                personFilterGroup.style.display = 'block';
                personLabel.textContent = 'Group Member';
                personFilterLabel.textContent = 'Filter by Group Member';
                
                // Group options
                personSelect.innerHTML = `
                    <option value="">Select group member</option>
                    <option value="You">👤 You</option>
                    <option value="Member1">👥 Member 1</option>
                    <option value="Member2">👥 Member 2</option>
                    <option value="Member3">👥 Member 3</option>
                    <option value="Group">👥 Whole Group</option>
                `;
                personFilter.innerHTML = `
                    <option value="">All Group Members</option>
                    <option value="You">👤 You</option>
                    <option value="Member1">👥 Member 1</option>
                    <option value="Member2">👥 Member 2</option>
                    <option value="Member3">👥 Member 3</option>
                    <option value="Group">👥 Whole Group</option>
                `;
            }

            // Update form validation
            if (trackerType === 'personal') {
                personSelect.removeAttribute('required');
            } else {
                personSelect.setAttribute('required', 'required');
            }
        }

        // Smart Suggestions Engine
        function generateSmartSuggestions() {
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            const monthlyExpenses = expenses.filter(expense => {
                const expenseDate = new Date(expense.date);
                return expenseDate.getMonth() === currentMonth && expenseDate.getFullYear() === currentYear;
            });

            const monthlyTotal = monthlyExpenses.reduce((total, expense) => total + expense.amount, 0);
            const remaining = monthlyBudget - monthlyTotal;
            const daysLeft = new Date(currentYear, currentMonth + 1, 0).getDate() - new Date().getDate();
            const dailyBudgetLeft = daysLeft > 0 ? remaining / daysLeft : 0;

            const suggestions = [];

            if (monthlyBudget === 0) {
                suggestions.push({
                    type: 'setup',
                    icon: '🎯',
                    text: 'Set a monthly budget to get personalized money-saving suggestions and track your financial goals.',
                    action: 'Go to Settings to set your budget',
                    priority: 'high'
                });
                return suggestions;
            }

            if (monthlyExpenses.length === 0) {
                suggestions.push({
                    type: 'start',
                    icon: '🚀',
                    text: 'Start tracking your expenses to receive intelligent insights and savings recommendations.',
                    action: 'Add your first expense above',
                    priority: 'normal'
                });
                return suggestions;
            }

            // Budget-based suggestions
            if (remaining > 0) {
                const savingsPercentage = (remaining / monthlyBudget) * 100;
                
                if (savingsPercentage >= 30) {
                    suggestions.push({
                        type: 'savings',
                        icon: '💰',
                        text: `Excellent! You have €${remaining.toFixed(2)} left this month. Consider putting ${Math.floor(savingsPercentage * 0.6)}% into savings.`,
                        amount: `€${(remaining * 0.6).toFixed(2)}`,
                        action: 'Build your emergency fund or invest for the future',
                        priority: 'high'
                    });
                } else if (savingsPercentage >= 15) {
                    suggestions.push({
                        type: 'savings',
                        icon: '💡',
                        text: `Good job! You have €${remaining.toFixed(2)} remaining. Try to save at least €${(remaining * 0.5).toFixed(2)} of this.`,
                        amount: `€${(remaining * 0.5).toFixed(2)}`,
                        action: 'Start building your savings habit',
                        priority: 'normal'
                    });
                } else if (savingsPercentage >= 5) {
                    suggestions.push({
                        type: 'caution',
                        icon: '⚠️',
                        text: `You have €${remaining.toFixed(2)} left for ${daysLeft} days. That's €${dailyBudgetLeft.toFixed(2)} per day. Be mindful of spending.`,
                        action: 'Focus on essential expenses only',
                        priority: 'warning'
                    });
                }

                // Daily spending recommendations
                if (daysLeft > 0) {
                    suggestions.push({
                        type: 'daily',
                        icon: '📅',
                        text: `With €${remaining.toFixed(2)} left for ${daysLeft} days, aim to spend no more than €${dailyBudgetLeft.toFixed(2)} per day.`,
                        amount: `€${dailyBudgetLeft.toFixed(2)}/day`,
                        action: 'Track daily to stay on target',
                        priority: 'normal'
                    });
                }
            } else if (remaining < 0) {
                suggestions.push({
                    type: 'overspent',
                    icon: '🚨',
                    text: `You're €${Math.abs(remaining).toFixed(2)} over budget this month. Focus on essential expenses and plan better for next month.`,
                    action: 'Review your expenses and adjust next month\'s budget',
                    priority: 'urgent'
                });
            }

            // Category-based suggestions
            const categoryTotals = {};
            monthlyExpenses.forEach(expense => {
                categoryTotals[expense.category] = (categoryTotals[expense.category] || 0) + expense.amount;
            });

            const sortedCategories = Object.entries(categoryTotals).sort((a, b) => b[1] - a[1]);
            
            if (sortedCategories.length > 0) {
                const topCategory = sortedCategories[0];
                const topCategoryPercentage = (topCategory[1] / monthlyTotal) * 100;

                if (topCategoryPercentage > 40) {
                    suggestions.push({
                        type: 'category',
                        icon: '📊',
                        text: `${topCategory[0]} accounts for ${topCategoryPercentage.toFixed(1)}% of your spending (€${topCategory[1].toFixed(2)}). Look for ways to optimize this category.`,
                        action: 'Consider alternatives or negotiate better rates',
                        priority: 'normal'
                    });
                }
            }

            // Savings goal suggestions
            if (remaining > 50 && savingsGoal === 0) {
                suggestions.push({
                    type: 'goal',
                    icon: '🎯',
                    text: 'Consider setting a savings goal! Even saving €50-100 per month can build a substantial emergency fund.',
                    action: 'Set a monthly savings target',
                    priority: 'normal'
                });
            }

            // Tracker-specific suggestions
            if (trackerType === 'family') {
                const familyMembers = [...new Set(monthlyExpenses.map(e => e.person).filter(p => p))];
                if (familyMembers.length > 1) {
                    suggestions.push({
                        type: 'family',
                        icon: '👨‍👩‍👧‍👦',
                        text: `Track spending by family member to identify patterns and teach financial responsibility to everyone.`,
                        action: 'Review individual spending habits',
                        priority: 'normal'
                    });
                }
            } else if (trackerType === 'group') {
                suggestions.push({
                    type: 'group',
                    icon: '👥',
                    text: 'Consider setting up group savings goals or shared expenses to make financial planning easier for everyone.',
                    action: 'Discuss group financial goals',
                    priority: 'normal'
                });
            }

            return suggestions;
        }

        function renderSmartSuggestions() {
            const suggestions = generateSmartSuggestions();
            const suggestionsContent = document.getElementById('suggestionsContent');

            if (suggestions.length === 0) {
                suggestionsContent.innerHTML = '<div class="no-suggestions">All good! No suggestions at this time.</div>';
                return;
            }

            suggestionsContent.innerHTML = suggestions.map(suggestion => {
                let itemClass = 'suggestion-item';
                if (suggestion.priority === 'urgent' || suggestion.priority === 'high') {
                    itemClass += ' priority';
                } else if (suggestion.priority === 'warning') {
                    itemClass += ' warning';
                }

                return `
                    <div class="${itemClass}">
                        <span class="suggestion-icon">${suggestion.icon}</span>
                        <div class="suggestion-content">
                            <div class="suggestion-text">${suggestion.text}</div>
                            ${suggestion.amount ? `<div class="suggestion-amount">${suggestion.amount}</div>` : ''}
                            <div class="suggestion-meta">${suggestion.action}</div>
                        </div>
                    </div>
                `;
            }).join('');

            // Add savings goal display if applicable
            if (monthlyBudget > 0 && expenses.length > 0) {
                const remaining = monthlyBudget - expenses.filter(expense => {
                    const expenseDate = new Date(expense.date);
                    const now = new Date();
                    return expenseDate.getMonth() === now.getMonth() && expenseDate.getFullYear() === now.getFullYear();
                }).reduce((total, expense) => total + expense.amount, 0);

                if (remaining > 0) {
                    const recommendedSavings = Math.max(remaining * 0.2, 10);
                    suggestionsContent.innerHTML += `
                        <div class="savings-goal">
                            <div class="savings-amount">💰 €${recommendedSavings.toFixed(2)}</div>
                            <div>Recommended monthly savings from remaining budget</div>
                        </div>
                    `;
                }
            }
        }

        // Enhanced updateMainBudgetSummary to include suggestions
        const originalUpdateMainBudgetSummary = updateMainBudgetSummary;
        updateMainBudgetSummary = function() {
            // Call original function
            originalUpdateMainBudgetSummary();
            
            // Generate and render suggestions
            renderSmartSuggestions();
        };

        // Close modal when clicking outside
        window.onclick = function(event) {
            const insightsModal = document.getElementById('insightsModal');
            const recurringModal = document.getElementById('recurringModal');
            
            if (event.target === insightsModal) {
                closeInsights();
            } else if (event.target === recurringModal) {
                closeRecurringModal();
            }
        };

        // PWA Installation and Notification Management
        let deferredPrompt;
        let swRegistration = null;
        let notificationPermission = 'default';

        // Register Service Worker and setup PWA features
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', async () => {
                try {
                    swRegistration = await navigator.serviceWorker.register('/sw.js');
                    console.log('✅ Service Worker registered:', swRegistration);
                    
                    // Check for updates
                    swRegistration.addEventListener('updatefound', () => {
                        const newWorker = swRegistration.installing;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                showUpdateNotification();
                            }
                        });
                    });
                } catch (error) {
                    console.error('❌ Service Worker registration failed:', error);
                }
            });
        }

        // PWA Install prompt
        window.addEventListener('beforeinstallprompt', (e) => {
            console.log('💾 PWA install prompt available');
            e.preventDefault();
            deferredPrompt = e;
            showInstallButton();
        });

        // Handle successful PWA installation
        window.addEventListener('appinstalled', () => {
            console.log('✅ PWA installed successfully');
            hideInstallButton();
            showNotification('App installed! You can now use Expense Tracker offline.', 'success');
        });

        // Show/hide install button
        function showInstallButton() {
            // Create install button if it doesn't exist
            if (!document.getElementById('installButton')) {
                const installBtn = document.createElement('button');
                installBtn.id = 'installButton';
                installBtn.className = 'btn btn-primary install-button';
                installBtn.innerHTML = '📱 Install App';
                installBtn.onclick = installPWA;
                installBtn.style.cssText = `
                    position: fixed;
                    bottom: 20px;
                    right: 20px;
                    z-index: 1000;
                    display: flex;
                    align-items: center;
                    gap: 0.5rem;
                    box-shadow: var(--shadow-lg);
                    animation: bounce 2s infinite;
                `;
                document.body.appendChild(installBtn);
            }
        }

        function hideInstallButton() {
            const installBtn = document.getElementById('installButton');
            if (installBtn) {
                installBtn.remove();
            }
        }

        // Install PWA
        async function installPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                
                if (outcome === 'accepted') {
                    console.log('✅ User accepted PWA install');
                } else {
                    console.log('❌ User declined PWA install');
                }
                
                deferredPrompt = null;
                hideInstallButton();
            }
        }

        // Notification Permission Management
        async function requestNotificationPermission() {
            if (!('Notification' in window)) {
                console.log('❌ This browser does not support notifications');
                return false;
            }

            if (Notification.permission === 'granted') {
                return true;
            }

            if (Notification.permission === 'denied') {
                showNotification('Notifications are blocked. Please enable them in your browser settings.', 'error');
                return false;
            }

            try {
                const permission = await Notification.requestPermission();
                notificationPermission = permission;
                
                if (permission === 'granted') {
                    console.log('✅ Notification permission granted');
                    setupPushNotifications();
                    return true;
                } else {
                    console.log('❌ Notification permission denied');
                    return false;
                }
            } catch (error) {
                console.error('❌ Error requesting notification permission:', error);
                return false;
            }
        }

        // Setup Push Notifications
        async function setupPushNotifications() {
            if (!swRegistration) {
                console.log('❌ Service Worker not registered');
                return;
            }

            try {
                // Setup local notifications
                setupLocalNotifications();
                
            } catch (error) {
                console.error('❌ Error setting up push notifications:', error);
            }
        }

        // Setup local notifications for budget alerts and reminders
        function setupLocalNotifications() {
            // Check budget status daily
            setInterval(checkBudgetAndNotify, 24 * 60 * 60 * 1000); // 24 hours
            
            // Check for recurring expense reminders
            setInterval(checkRecurringReminders, 60 * 60 * 1000); // 1 hour
        }

        // Check budget and send notification if needed
        function checkBudgetAndNotify() {
            if (Notification.permission !== 'granted') return;

            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            const monthlyExpenses = expenses.filter(expense => {
                const expenseDate = new Date(expense.date);
                return expenseDate.getMonth() === currentMonth && expenseDate.getFullYear() === currentYear;
            });

            const monthlyTotal = monthlyExpenses.reduce((total, expense) => total + expense.amount, 0);
            const budgetUsedPercentage = monthlyBudget > 0 ? (monthlyTotal / monthlyBudget) * 100 : 0;

            if (budgetUsedPercentage >= 80 && budgetUsedPercentage < 100) {
                new Notification('Budget Alert', {
                    body: `You've used ${Math.round(budgetUsedPercentage)}% of your monthly budget.`,
                    icon: '/icons/icon-192x192.png',
                    tag: 'budget-warning'
                });
            } else if (budgetUsedPercentage >= 100) {
                new Notification('Budget Exceeded!', {
                    body: `You've exceeded your monthly budget by €${Math.abs(monthlyBudget - monthlyTotal).toFixed(2)}.`,
                    icon: '/icons/icon-192x192.png',
                    tag: 'budget-exceeded'
                });
            }
        }

        // Handle URL parameters for deep linking
        function handleURLParameters() {
            const urlParams = new URLSearchParams(window.location.search);
            
            if (urlParams.get('action') === 'add') {
                scrollToForm();
            } else if (urlParams.get('tab')) {
                const tab = urlParams.get('tab');
                if (tab === 'dashboard' || tab === 'settings') {
                    switchTab(tab);
                }
            } else if (urlParams.get('action') === 'recurring') {
                showRecurringModal();
            }
        }

        // Show update notification when new version is available
        function showUpdateNotification() {
            showNotification('🔄 New version available! Refresh to update.', 'info');
        }

        // Enhanced DOMContentLoaded to include PWA features
        document.addEventListener('DOMContentLoaded', function() {
            // Handle URL parameters for deep linking
            handleURLParameters();
            
            // Setup notification permission request
            if ('Notification' in window && Notification.permission === 'default') {
                // Show notification permission request after user interacts with the app
                setTimeout(() => {
                    if (expenses.length > 0 || monthlyBudget > 0) {
                        requestNotificationPermission();
                    }
                }, 30000); // Wait 30 seconds before asking
            }
            
            // Check if running as PWA
            if (window.matchMedia('(display-mode: standalone)').matches || 
                window.navigator.standalone === true) {
                console.log('✅ Running as PWA');
                document.body.classList.add('pwa-mode');
            }
            
            // Online/offline status handling
            window.addEventListener('online', () => {
                showNotification('You\'re back online!', 'success');
            });
            
            window.addEventListener('offline', () => {
                showNotification('You\'re offline. Changes will sync when you\'re back online.', 'info');
            });
        });
    </script>
</body>
</html>
